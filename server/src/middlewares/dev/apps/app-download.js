var StatusMessage,__awaiter=this&&this.__awaiter||function(t,o,a,c){return new(a=a||Promise)(function(n,e){function i(t){try{r(c.next(t))}catch(t){e(t)}}function s(t){try{r(c.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?n(t.value):((e=t.value)instanceof a?e:new a(function(t){t(e)})).then(i,s)}r((c=c.apply(t,o||[])).next())})},__generator=this&&this.__generator||function(i,s){var r,o,a,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},l={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function t(n){return function(t){var e=[n,t];if(r)throw new TypeError("Generator is already executing.");for(;c=l&&e[l=0]?0:c;)try{if(r=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,(e=a?[2&e[0],a.value]:e)[0]){case 0:case 1:a=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,o=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(a=0<(a=c.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3]))c.label=e[1];else if(6===e[0]&&c.label<a[1])c.label=a[1],a=e;else{if(!(a&&c.label<a[2])){a[2]&&c.ops.pop(),c.trys.pop();continue}c.label=a[2],c.ops.push(e)}}e=s.call(i,c)}catch(t){e=[6,t],o=0}finally{r=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}}},path=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.getDownloadStatus=getDownloadStatus,exports.DownloadAppZip=DownloadAppZip,exports.download=download,exports.zipApp=zipApp,require("path")),fs=require("fs-extra"),AdmZip=require("adm-zip"),child_process_1=require("child_process"),uuid_1=require("uuid"),i18n_utils_1=(require("isomorphic-form-data"),require("../../../global"),require("../i18n-utils")),utils_1=require("../../utils"),utils_2=require("./utils"),lodash=require("lodash"),downloadTimes=(!function(t){t.Start="Start",t.CopyingCode="Copying code",t.CompilingWidget="Compiling the custom widgets",t.GeneratingZip="Generating a zip file",t.Fail="Fail",t.Completed="completed"}(StatusMessage=StatusMessage||{}),0),prodDistFolder="dist-prod",isReleasePackage=fs.existsSync(path.join(utils_2.CLIENT_PATH,utils_2.DIST_FOLDER,"widgets/widgets-info-existed.json")),ANALYSIS_URI="widgets/arcgis/analysis/",CHART_URI="widgets/common/chart/",EntryDependency={"widgets/arcgis/analysis/":[{pkgFolder:"arcgis-amd-packages/arcgis-analysis-components",i18nFolder:["arcgis-amd-packages/arcgis-analysis-components"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["t9n"],e=void 0===e?[]:e)}},{pkgFolder:"arcgis-amd-packages/arcgis-analysis-core",i18nFolder:["arcgis-amd-packages/arcgis-analysis-core"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["t9n"],e=void 0===e?[]:e)}},{pkgFolder:"arcgis-amd-packages/arcgis-analysis-raster-function-utils",i18nFolder:["arcgis-amd-packages/arcgis-analysis-raster-function-utils"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["strings"],e=void 0===e?[]:e)}},{pkgFolder:"arcgis-amd-packages/arcgis-analysis-shared-utils",i18nFolder:["arcgis-amd-packages/arcgis-analysis-shared-utils"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["t9n"],e=void 0===e?[]:e)}},{pkgFolder:"arcgis-amd-packages/arcgis-analysis-tool-app",i18nFolder:["arcgis-amd-packages/arcgis-analysis-tool-app"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["strings","t9n"],e=void 0===e?[]:e)}},{pkgFolder:"arcgis-amd-packages/arcgis-analysis-assets",i18nFolder:["arcgis-amd-packages/arcgis-analysis-assets/t9n","arcgis-amd-packages/arcgis-analysis-assets/assets/t9n"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["t9n"],e=void 0===e?[]:e)}},{pkgFolder:"arcgis-amd-packages/arcgis-app-assets",i18nFolder:["arcgis-amd-packages/arcgis-app-assets/i18n"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["i18n"],e=void 0===e?[]:e)}},{pkgFolder:"arcgis-amd-packages/arcgis-geoenrichment-components-assets",isHasI18nFolder:!0,i18nFolder:["arcgis-amd-packages/arcgis-geoenrichment-components-assets/t9n"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["_"],e=void 0===e?[]:e,"")}},{pkgFolder:"arcgis-amd-packages/arcgis-raster-function-editor-assets",i18nFolder:["arcgis-amd-packages/arcgis-raster-function-editor-assets/t9n"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["t9n"],e=void 0===e?[]:e)}}],"widgets/common/chart/":[{pkgFolder:"arcgis-charts-components",i18nFolder:["arcgis-charts-components/assets"],i18nFilterFunction:function(t,e){return i18nFilterFunction(t,["t9n"],e=void 0===e?[]:e)}}]},i18nFilterFunction=function(n,t,e,i){void 0===e&&(e=[]),void 0===i&&(i=".");var s=!1,s=t.every(function(t){return!n.includes("".concat(t).concat(i))});return e.map(function(e){t.forEach(function(t){n.includes("".concat(t).concat(i).concat(e))&&(s=!0)})}),s};function getDownloadStatus(i,t){return __awaiter(this,void 0,void 0,function(){var e,n;return __generator(this,function(t){switch(t.label){case 0:return e=i.params.appId,n=i.query.uuid,[4,getDownloadStatusByAppId(e,n)];case 1:return e=t.sent(),n=downloadTimes,"001"!==e.code&&null!=e&&e.code||(n=null),i.body={status:e,cdnNumber:n},[2]}})})}function getDownloadStatusByAppId(i,s){return __awaiter(this,void 0,void 0,function(){var e,n;return __generator(this,function(t){return null!=(e=getPathOfDownloadStatus(i,s))&&e.startsWith(utils_2.SERVER_PATH)?(n={},fs.existsSync(e)&&(n=JSON.parse(fs.readFileSync(e,"utf8"))||{}),[2,Promise.resolve(n)]):[2]})})}function DownloadAppZip(c,t){return __awaiter(this,void 0,void 0,function(){var e,n,i,s,r,o,a;return __generator(this,function(t){switch(t.label){case 0:return[4,(0,utils_1.checkToken)(c.query.token)];case 1:return(e=t.sent(),n=c.params.appId,i=c.query.uuid,null!=(s=path.join(utils_2.SERVER_PATH,"temp"))&&s.startsWith(utils_2.SERVER_PATH))?(r=path.join(s,"".concat(n,"-").concat(i,".zip")),null!=s&&s.startsWith(s)?[4,getDownloadStatusByAppId(n,i)]:[2]):[2];case 2:return o=t.sent(),removeDownloadStatus(n,i),e?"006"===o.code?c.body="The app has not been packaged yet.":null!=r&&r.startsWith(s)&&(fs.existsSync(r)?(a=new AdmZip(r),c.response.set("Content-disposition","attachment; filename="+(o.fileName||n)+".zip"),c.body=a.toBuffer(),removeTemporaryAppInTempFolder(n,i)):c.body="No app zip."):c.body="Please log in.",[2]}})})}function download(s,r){return __awaiter(this,void 0,void 0,function(){var e,n,i;return __generator(this,function(t){switch(t.label){case 0:return[4,(0,utils_1.checkToken)(s.query.token)];case 1:if(!t.sent())return s.body="Please log in.",[2];e=s.params.appId,i=s.query.locale?null==(i=s.query.locale)?void 0:i.split(","):[],n=(0,uuid_1.v1)(),removeDownloadStatus(e,n),setDownloadStatus(e,"001",n);try{s.body={uuid:n,message:"Create zip for app..."},createZipForApp(e,null,n,{locales:i})}catch(t){console.error(t)}return[4,r()];case 2:return t.sent(),[2]}})})}function zipApp(t,e,n){return __awaiter(this,arguments,void 0,function(e,n,i,s){var r,o,a;return void 0===s&&(s={}),__generator(this,function(t){switch(t.label){case 0:return(t.trys.push([0,2,,3]),fs.existsSync(n))?(console.log("".concat(n," exists, please use a new name.")),[2]):(s.locales||(s.locales=[]),r=(0,uuid_1.v1)(),[4,createZipForApp(e,i,r,s)]);case 1:return(o=t.sent(),a=o.message,o=o.zip,a)?(console.log(a),[2]):(o&&o.writeZip(n,function(t){removeTemporaryAppInTempFolder(e,r),t?console.error(t):console.log("Done.")}),[3,3]);case 2:return a=t.sent(),console.error(a),[3,3];case 3:return[2]}})})}function createZipForApp(S,E,j,w){return __awaiter(this,void 0,void 0,function(){var e,n,i,s,r,o,a,c,l,u,p,d,f,h,_,g,y,m,v,F;return __generator(this,function(t){switch(t.label){case 0:return(e=path.join(utils_2.SERVER_PATH,"temp"),n=path.join(utils_2.SERVER_PATH,"public/apps",S),i=path.join(e,"".concat(S,"-").concat(j)),null!=e&&e.startsWith(utils_2.SERVER_PATH)&&null!=n&&n.startsWith(utils_2.SERVER_PATH)&&null!=i&&i.startsWith(utils_2.SERVER_PATH))?(s=w.locales,fs.existsSync(n)?(a=(o=JSON).parse,[4,fs.readFile(path.join(n,"config.json"),"utf-8")]):[2,(0,i18n_utils_1.getMessage)("notFound",s[0]||"en").then(function(t){return setDownloadStatus(S,"006",j,t),{message:t,fileName:null,zip:null}})]):[2];case 1:return r=a.apply(o,[t.sent()]),w.configModifier&&(r=modifyAppConfig(r,w)),u=(l=JSON).parse,[4,fs.readFile(path.join(n,"info.json"),"utf-8")];case 2:return(c=u.apply(l,[t.sent()]),null!=(p=path.join(n,"download-times.json"))&&p.startsWith(utils_2.SERVER_PATH))?fs.existsSync(p)?(f=parseInt,[4,fs.readFile(p,"utf-8")]):[3,4]:[2];case 3:return d=f.apply(void 0,[t.sent()]),[3,5];case 4:d=0,t.label=5;case 5:return downloadTimes=d,h=++downloadTimes,fs.writeFileSync(p,h+"","utf-8"),!0===r.__not_publish?[2,(0,i18n_utils_1.getMessage)("notPublished",s[0]||"en").then(function(t){return setDownloadStatus(S,"006",j,t),{message:t,fileName:null,zip:null}})]:[4,fs.pathExists(i)];case 6:return t.sent()?[4,fs.remove(i)]:[3,8];case 7:t.sent(),t.label=8;case 8:return[4,fs.ensureDir(i)];case 9:return t.sent(),setDownloadStatus(S,"002",j),[4,compileWidgets(r)];case 10:return t.sent(),setDownloadStatus(S,"003",j),[4,copyAppCode(i,r,c.title,s,h)];case 11:return t.sent(),g=(_=JSON).parse,[4,fs.readFile((0,utils_1.getBuilderSettingFilePath)(),"utf-8")];case 12:return(F=g.apply(_,[t.sent()]),null!=(F=F.devEnv[global.hostEnv])&&F.isWebTier?r.attributes.isWebTier=!0:r.attributes.isWebTier=!1,r.attributes.clientId=E||"",F=c.typeKeywords.includes(utils_2.TYPE_KEYWORDS_OF_EXPRESS_APP),r.attributes.express=F,r.attributes.title=c.title,r.attributes.description=c.snippet,r.attributes.type=c.type,r.attributes.thumbnail=(null==c?void 0:c.thumbnail)||null,null!=(F=path.join(i,getCDNString(h)))&&F.startsWith(utils_2.SERVER_PATH))?[4,fs.writeFile(path.join(F,"config.json"),JSON.stringify(r,null,2),"utf-8")]:[2];case 13:return t.sent(),[4,fs.copy(path.join(n,"resources"),path.join(F,"resources"))];case 14:return(t.sent(),fs.existsSync(path.join(n,"thumbnail")))?[4,fs.copy(path.join(n,"thumbnail"),path.join(F,"thumbnail"))]:[3,16];case 15:t.sent(),t.label=16;case 16:return(setDownloadStatus(S,"004",j),(y=new AdmZip).addLocalFolder(i),m=encodeURI(c.title),null!=(v=path.join(e,"".concat(S,"-").concat(j,".zip")))&&v.startsWith(utils_2.SERVER_PATH))?fs.existsSync(v)?[4,fs.remove(v)]:[3,18]:[2];case 17:t.sent(),t.label=18;case 18:return fs.writeFile(v,y.toBuffer()),setDownloadStatus(S,"005",j,null,m),[2,Promise.resolve({message:null,fileName:m,zip:y})]}})})}function modifyAppConfig(e,n){if("function"==typeof n.configModifier)try{e=n.configModifier(e)}catch(t){console.error("Modify app config error.",t)}else Object.keys(n.configModifier).forEach(function(t){void 0===lodash.get(e,t)?console.error("The ".concat(t," is not found in the app config.")):lodash.set(e,t,n.configModifier[t])});return e}function copyAppCode(r,o,a,c,l){return __awaiter(this,void 0,void 0,function(){var e,n,i,s;return __generator(this,function(t){switch(t.label){case 0:return null!=r&&r.startsWith(utils_2.SERVER_PATH)?(e=path.join(utils_2.CLIENT_PATH,utils_2.DIST_FOLDER),n=path.join(utils_2.CLIENT_PATH,prodDistFolder),[4,fs.copy(path.join(e,"experience/index.html"),path.join(r,"index.html"))]):[2];case 1:return t.sent(),[4,fs.copy(path.join(e,"experience/web.config"),path.join(r,"web.config"))];case 2:return t.sent(),[4,fixIndexFile(path.join(r,"index.html"),a,l)];case 3:return(t.sent(),"production"===process.env.NODE_ENV&&fs.existsSync(path.join(e,"service-worker.prod.js")))?[4,fs.copy(path.join(e,"service-worker.prod.js"),path.join(r,"service-worker.js"))]:[3,5];case 4:return t.sent(),[3,7];case 5:return[4,fs.copy(path.join(e,"service-worker.js"),path.join(r,"service-worker.js"))];case 6:t.sent(),t.label=7;case 7:return null!=(i=path.join(r,getCDNString(l)))&&i.startsWith(utils_2.SERVER_PATH)?[4,fs.copy(path.join(e,"experience/index.js"),path.join(i,"index.js"))]:[2];case 8:return t.sent(),[4,fs.copy(path.join(e,"experience/assets"),path.join(i,"assets"))];case 9:return t.sent(),[4,fs.copy(path.join(e,"service-worker-registration.js"),path.join(i,"service-worker-registration.js"))];case 10:return t.sent(),[4,fixServiceWorkerFile(path.join(i,"service-worker-registration.js"))];case 11:return t.sent(),[4,copyJimuFolder(i,c)];case 12:return t.sent(),[4,copyCalciteComponents(e,i,c)];case 13:return t.sent(),[4,copyArcgisMapComponents(e,i,c)];case 14:return t.sent(),[4,fs.copy(path.join(e,o.theme),path.join(i,o.theme))];case 15:return t.sent(),[4,copyOnDemandPackages(o,e,i,c)];case 16:return t.sent(),s=(0,utils_2.getWidgetsUriFromAppConfig)(o),[4,copyWidgets(e,i,n,s,c)];case 17:return(t.sent(),"production"===process.env.NODE_ENV&&fs.existsSync(path.join(n,utils_2.WIDGET_INFO_PATH)))?[4,fs.copy(path.join(n,utils_2.WIDGET_INFO_PATH),path.join(i,utils_2.WIDGET_INFO_PATH))]:[3,19];case 18:return t.sent(),[3,21];case 19:return fs.existsSync(path.join(e,utils_2.WIDGET_INFO_PATH))?[4,fs.copy(path.join(e,utils_2.WIDGET_INFO_PATH),path.join(i,utils_2.WIDGET_INFO_PATH))]:[3,21];case 20:t.sent(),t.label=21;case 21:return"production"===process.env.NODE_ENV&&fs.existsSync(path.join(n,utils_2.WIDGET_CHUNKS_PATH))?[4,fs.copy(path.join(n,utils_2.WIDGET_CHUNKS_PATH),path.join(i,utils_2.WIDGET_CHUNKS_PATH))]:[3,23];case 22:return t.sent(),[3,25];case 23:return fs.existsSync(path.join(e,utils_2.WIDGET_CHUNKS_PATH))?[4,fs.copy(path.join(e,utils_2.WIDGET_CHUNKS_PATH),path.join(i,utils_2.WIDGET_CHUNKS_PATH))]:[3,25];case 24:t.sent(),t.label=25;case 25:return fs.existsSync(path.join(e,utils_2.WIDGET_SHARED_CODE_PATH))?[4,fs.copy(path.join(e,utils_2.WIDGET_SHARED_CODE_PATH),path.join(i,utils_2.WIDGET_SHARED_CODE_PATH))]:[3,27];case 26:t.sent(),t.label=27;case 27:return"production"===process.env.NODE_ENV&&fs.existsSync(path.join(n,utils_2.WIDGET_SHARED_CODE_PATH))?[4,fs.copy(path.join(n,utils_2.WIDGET_SHARED_CODE_PATH),path.join(i,utils_2.WIDGET_SHARED_CODE_PATH))]:[3,29];case 28:t.sent(),t.label=29;case 29:return[4,Promise.all(s.coreWidgetsUri.concat(s.customWidgetsUri).map(function(t){var e=path.join(i,t,"src"),t=path.join(i,t,"tests"),n=[];return fs.existsSync(e)&&n.push(fs.remove(e)),fs.existsSync(t)&&n.push(fs.remove(t)),Promise.all(n)}))];case 30:return t.sent(),[2]}})})}function copyFilesWithLocales(a){return __awaiter(this,void 0,void 0,function(){var e,n,i,s,r,o;return __generator(this,function(t){return e=a.distPath,n=a.cdnFolder,r=a.folderName,i=a.keywordsOfI18nFiles,s=initLocalesToArcGisLocale(a.locales),r=getAllFilesInDir(r,e,n),o=[],r.forEach(function(t){var e=t.distPath,n=t.name,t=t.cdnPath;checkIsCopyFiles(n,s,i)&&o.push(fs.copy(e,t,{overwrite:!0}))}),[2,Promise.all(o)]})})}function copyCalciteComponents(e,n,i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,copyFilesWithLocales({distPath:e,cdnFolder:n,folderName:"calcite-components",locales:i,keywordsOfI18nFiles:"messages_"})]})})}function copyArcgisMapComponents(e,n,i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,copyFilesWithLocales({distPath:e,cdnFolder:n,folderName:"arcgis-map-components",locales:i,keywordsOfI18nFiles:"t9n."})]})})}function checkIsCopyFiles(e,t,n){var i=!e.includes(".json")||!e.includes(n);return!(t&&0!==(null==t?void 0:t.length)&&!i)||(t.map(function(t){e.includes("".concat(t,".json"))&&(i=!0)}),i)}function copyOnDemandPackages(a,c,l,u){return __awaiter(this,void 0,void 0,function(){var e,n,i,s,r,o;return __generator(this,function(t){switch(t.label){case 0:return null!=l&&l.startsWith(utils_2.SERVER_PATH)?(u=initLocalesToArcGisLocale(u),n=(0,utils_2.getWidgetsUriFromAppConfig)(a),e=n.customWidgetsUri,n=n.coreWidgetsUri,i=n.concat(e),0===(null==e?void 0:e.length)&&0===(null==n?void 0:n.length)?[2,Promise.resolve([])]:(s=[],null!=i&&i.forEach(function(t){t!==ANALYSIS_URI&&t!==CHART_URI||(s=s.concat(EntryDependency[t]))}),r=[],s.forEach(function(n){n.i18nFolder.includes(n.pkgFolder)&&u&&0!==(null==u?void 0:u.length)||r.push(fs.copy(path.join(c,n.pkgFolder),path.join(l,n.pkgFolder),{filter:function(t,e){return copyOnDemandPackageFilter(t,e,n,c,u)},overwrite:!0}))}),[4,Promise.all(r)])):[2];case 1:return(t.sent(),0<(null==u?void 0:u.length))?(o=[],s.forEach(function(i){var t;0<(null==(t=i.i18nFolder)?void 0:t.length)&&i.i18nFolder.forEach(function(t){getAllFilesInDir(t,c,l).forEach(function(t){var e=t.distPath,n=t.name,t=t.cdnPath;i.i18nFilterFunction(n,u)&&o.push(fs.copy(e,t,{overwrite:!0}))})})}),[4,Promise.all(o)]):[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})}function getAllFilesInDir(n,i,s,r){return void 0===r&&(r=[]),fs.existsSync(path.join(i,n))?(fs.readdirSync(path.join(i,n)).forEach(function(t){var e=path.join(n,t);fs.statSync(path.join(i,e)).isDirectory()?getAllFilesInDir(e,i,s,r):r.push({name:t,distPath:path.join(i,e),cdnPath:path.join(s,e)})}),r):[]}function copyOnDemandPackageFilter(e,t,n,i,s){var r;return!s||0===(null==s?void 0:s.length)||!n.i18nFolder&&0===n.i18nFolder.length||(s=n.i18nFolder,r=!0,s.forEach(function(t){isFolderInFolder(e,path.join(i,t))&&(r=!1)}),r)}function isFolderInFolder(t,e){e=path.relative(e,t);return!e.startsWith("..")&&!path.isAbsolute(e)}function initLocalesToArcGisLocale(t){return t.map(function(t){var e;return t.includes("-")?(e=t.split("-"),"".concat(e[0],"-").concat(e[1].toUpperCase())):t})}function compileWidgets(e){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return"production"!==process.env.NODE_ENV||!isReleasePackage||0===(0,utils_2.getWidgetsUriFromAppConfig)(e).customWidgetsUri.length?[2,Promise.resolve()]:((0,child_process_1.execSync)("npm run build:prod",{cwd:utils_2.CLIENT_PATH}),[2])})})}function fixIndexFile(n,i,s){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return null!=n&&n.startsWith(utils_2.SERVER_PATH)?[4,fs.readFile(n,"utf-8")]:[2];case 1:return e=(e=t.sent()).replace(/<base.*\/>/,'<base href="./'.concat(getCDNString(s),'/"/>')).replace('"isOutOfExb": false','"isOutOfExb": true').replace('"isDevEdition": false','"isDevEdition": true').replace('"useStructuralUrl": true','"useStructuralUrl": false').replace(/"buildNumber": ".*"/,'"buildNumber": "'.concat(s,'"')).replace('"appFolderName": "experience"','"appFolderName": "."').replace('<script src="../jimu-core/init.js"><\/script>','<script src="./jimu-core/init.js"><\/script>').replace("<title>Experience</title>","<title>".concat(i,"</title>")),[4,fs.writeFile(n,e,"utf-8")];case 2:return t.sent(),[2]}})})}function fixServiceWorkerFile(n){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return null!=n&&n.startsWith(utils_2.SERVER_PATH)?[4,fs.readFile(n,"utf-8")]:[2];case 1:return e=(e=t.sent()).replace("register(window.jimuConfig.mountPath + 'service-worker.js')","register('../../service-worker.js')"),[4,fs.writeFile(n,e,"utf-8")];case 2:return t.sent(),[2]}})})}function getCDNString(t){return"cdn/".concat(t)}function translationsFolderFilter(t,e,n){return!n||0===(null==n?void 0:n.length)||!t.includes("translations")||!fs.existsSync(path.join(t,"default.ts"))}function copyJimuFolder(s,r){return __awaiter(this,void 0,void 0,function(){var e,n,i;return __generator(this,function(t){switch(t.label){case 0:return(e=path.join(utils_2.CLIENT_PATH,utils_2.DIST_FOLDER),null!=s&&s.startsWith(utils_2.SERVER_PATH))?(i=(n=["jimu-core","jimu-ui","jimu-layouts","jimu-arcgis","jimu-theme","jimu-for-builder"]).map(function(t){return fs.copy(path.join(e,t),path.join(s,t),{filter:function(t,e){return translationsFolderFilter(t,e,r)}})}),[4,Promise.all(i)]):[2];case 1:return(t.sent(),0<(null==r?void 0:r.length))?[4,copyJimuTranslations(s,r,n)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})}function copyJimuTranslations(s,r,e){return __awaiter(this,void 0,void 0,function(){var n,i;return __generator(this,function(t){return n=path.join(utils_2.CLIENT_PATH,utils_2.DIST_FOLDER),i=[],r&&null!=s&&s.startsWith(utils_2.SERVER_PATH)&&(e.forEach(function(e){var t="".concat(e,"/lib/translations/default.ts");fs.existsSync(path.join(n,t))&&i.push(fs.copy(path.join(n,t),path.join(s,t))),r.forEach(function(t){t="".concat(e,"/lib/translations/").concat(t,".js");fs.existsSync(path.join(n,t))&&i.push(fs.copy(path.join(n,t),path.join(s,t)))})}),Promise.all(i)),[2]})})}function copyWidgets(e,n,i,s,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,copyWidgetOrTranslationsByUri(e,n,i,s,r)];case 1:return(t.sent(),0<(null==r?void 0:r.length))?[4,copyWidgetOrTranslationsByUri(e,n,i,s,r,!0)]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}})})}function copyWidgetOrTranslationsByUri(t,e,n,i,s){return __awaiter(this,arguments,void 0,function(n,i,s,e,r,o){var a;return void 0===o&&(o=!1),__generator(this,function(t){switch(t.label){case 0:return a=[],e.coreWidgetsUri.forEach(function(t){t=(o?copyWidgetTranslations:copyWidget)(n,i,r,t);a=a.concat(t)}),e.customWidgetsUri.forEach(function(t){var e="production"===process.env.NODE_ENV&&isReleasePackage?s:n,e=(o?copyWidgetTranslations:copyWidget)(e,i,r,t);a=a.concat(e)}),[4,Promise.all(a)];case 1:return t.sent(),[2]}})})}function copyWidget(t,e,n,i){var s=[];if(null!=e&&e.startsWith(utils_2.SERVER_PATH))return s.push(fs.copy(path.join(t,i),path.join(e,i),{filter:function(t,e){return translationsFolderFilter(t,e,n)},overwrite:!0})),s}function copyWidgetTranslations(n,i,t,s){var e,r,o=[];if(null!=i&&i.startsWith(utils_2.SERVER_PATH))return t&&(e="dist/runtime/translations/default.ts",fs.existsSync(path.join(n,s,r="dist/setting/translations/default.ts"))&&o.push(fs.copy(path.join(n,s,r),path.join(i,s,r),{overwrite:!0})),fs.existsSync(path.join(n,s,e))&&o.push(fs.copy(path.join(n,s,e),path.join(i,s,e),{overwrite:!0})),t.forEach(function(t){var e="dist/runtime/translations/".concat(t,".js"),t="dist/setting/translations/".concat(t,".js");fs.existsSync(path.join(n,s,e))&&o.push(fs.copy(path.join(n,s,e),path.join(i,s,e),{overwrite:!0})),fs.existsSync(path.join(n,s,t))&&o.push(fs.copy(path.join(n,s,t),path.join(i,s,t),{overwrite:!0}))})),o}function setDownloadStatus(r,o,a,c,l){return __awaiter(this,void 0,void 0,function(){var e,n,i,s;return __generator(this,function(t){switch(t.label){case 0:if(!r||!o)return[2];switch(o){case"001":e=StatusMessage.Start;break;case"002":e=StatusMessage.CopyingCode;break;case"003":e=StatusMessage.CompilingWidget;break;case"004":e=StatusMessage.GeneratingZip;break;case"005":e=StatusMessage.Completed;break;case"006":e=StatusMessage.Fail}return[4,getDownloadStatusByAppId(r,a)];case 1:return i=t.sent(),n=null==i?void 0:i.hasCustomWidget,i.hasOwnProperty("hasCustomWidget")?[3,3]:[4,checkIsHasCustomWidgets(r)];case 2:n=t.sent(),t.label=3;case 3:return(i={message:e,code:o},c&&(i.error=c),l&&(i.fileName=l),i.hasCustomWidget=n,null!=(s=getPathOfDownloadStatus(r,i.uuid=a))&&s.startsWith(utils_2.SERVER_PATH))?(fs.writeFileSync(s,JSON.stringify(i,null,2)),[2,i]):[2]}})})}function getPathOfDownloadStatus(t,e){var n=path.join(utils_2.SERVER_PATH,"temp");if(null!=n&&n.startsWith(utils_2.SERVER_PATH))return fs.ensureDirSync(n),t="download-status-".concat(t,"-").concat(e),path.join(n,t)}function removeDownloadStatus(t,e){t=getPathOfDownloadStatus(t,e);null!=t&&t.startsWith(utils_2.SERVER_PATH)&&fs.existsSync(t)&&fs.removeSync(t)}function removeTemporaryAppInTempFolder(t,e){var n=path.join(utils_2.SERVER_PATH,"temp"),i=path.join(n,"".concat(t,"-").concat(e)),t=path.join(n,"".concat(t,"-").concat(e,".zip"));null!=n&&n.startsWith(utils_2.SERVER_PATH)&&null!=i&&i.startsWith(n)&&null!=t&&t.startsWith(n)&&(fs.existsSync(i)&&fs.removeSync(i),fs.existsSync(t))&&fs.removeSync(t)}function checkIsHasCustomWidgets(o){return __awaiter(this,void 0,void 0,function(){var e,n,i,s,r;return __generator(this,function(t){switch(t.label){case 0:return null!=(e=path.join(utils_2.SERVER_PATH,"public/apps",o))&&e.startsWith(utils_2.SERVER_PATH)?(i=(n=JSON).parse,[4,fs.readFile(path.join(e,"config.json"),"utf-8")]):[2,Promise.resolve(!1)];case 1:return(e=i.apply(n,[t.sent()]))?(s=(0,utils_2.getWidgetsUriFromAppConfig)(e),r=!1,0<s.customWidgetsUri.length&&(r=!0),[2,Promise.resolve(r)]):[2,Promise.resolve(!1)]}})})}