define(["exports","./index-60d8a971","./index2-31657c04","./t9n-c044c603","./expressions-daccc1d3","./utils-c381fe27","./analysis-query-entry2-6efeefcb"],(function(e,t,s,i,n,a,o){"use strict";const r="flex-container",l="half-width",u="single-value",h=t.proxyCustomElement(class extends t.H{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.analysisExpressionChange=t.createEvent(this,"analysisExpressionChange",7),this.analysisExpressionRemoveClick=t.createEvent(this,"analysisExpressionRemoveClick",7),this.defaultMaxDropdownItems=2e3,this.removePopover=()=>{this.uniqueValuesPopover?.remove(),this.uniqueValuesPopover=void 0},this.handleUniqueValuesListChange=e=>{const t=e.detail.selectedValues,s=this.parseStringInput(t[0],this.expression.dataType);this.expression=new n.ExpressionController(this.expression).changeValue(s),this.analysisExpressionChange.emit(),this.removePopover()},this.onRemoveClick=e=>{this.analysisExpressionRemoveClick.emit(),e.stopPropagation()},this.onFieldSelect=e=>{const t=e.target.selectedOption.value,s=this.fields?.find((e=>e.name===t));void 0!==s&&(this.expression=new n.ExpressionController(this.expression).changeField(s,this.options),this.loadFieldValues(s.name)),this.analysisExpressionChange.emit()},this.getFieldValuesByUniqueValues=async e=>{const t=`${this.target.id}-${e}`,i=await this.cache.getOrPut((()=>s.getUniqueValues({layer:this.target,fieldName:e})),t);return(i?.uniqueValueInfos??[]).map((e=>({value:e.value,label:e.label??e.value,count:!0===this.options?.hideUniqueValueCounts?void 0:e.count})))},this.onOperatorSelect=e=>{const t=e.target.selectedOption.value;this.expression=new n.ExpressionController(this.expression).changeOperator(t),this.analysisExpressionChange.emit()},this.onValueInputChange=e=>{const t=e.target.value;this.expression.value=this.parseStringInput(t,this.expression.dataType),this.analysisExpressionChange.emit()},this.onValueComboboxChange=e=>{const t=e.target.value,s=Array.isArray(t)?t[0]:t;this.expression.value=this.parseStringInput(s,this.expression.dataType),this.analysisExpressionChange.emit()},this.onValuesComboboxChange=e=>{n.assert("multi-value"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value,i=(Array.isArray(t)?t:[t]).map((e=>this.parseStringInput(e,this.expression.dataType)));this.expression.value=i.filter((e=>!1===s.isEmptyDataItem(e))),this.analysisExpressionChange.emit()},this.onValueDateChange=()=>{const e=this.parseDateValueFromInputs(this.valueDateInputElement,this.valueTimeInputElement);this.expression.value=e,this.analysisExpressionChange.emit()},this.onDateOnlyRangeChange=e=>{n.assert("range"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value;this.expression.value=[this.parseStringInput(t[0],"date-only"),this.parseStringInput(t[1],"date-only")],this.analysisExpressionChange.emit()},this.onRangeStartDateChange=()=>{n.assert("range"===this.expression.type,"Incorrect render function for expression type.");const e=this.parseDateValueFromInputs(this.startDateInputElement,this.startTimeInputElement);this.expression.value[0]=e,this.analysisExpressionChange.emit()},this.onRangeEndDateChange=()=>{n.assert("range"===this.expression.type,"Incorrect render function for expression type.");const e=this.parseDateValueFromInputs(this.endDateInputElement,this.endTimeInputElement);this.expression.value[1]=e,this.analysisExpressionChange.emit()},this.onRangeStartInputChange=e=>{n.assert("range"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value;this.expression.value[0]=this.parseStringInput(t,this.expression.dataType),this.analysisExpressionChange.emit()},this.onRangeEndInputChange=e=>{n.assert("range"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value;this.expression.value[1]=this.parseStringInput(t,this.expression.dataType),this.analysisExpressionChange.emit()},this.onDistanceInputChange=e=>{n.assert("distance"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.value;this.expression=new n.ExpressionController(this.expression).changeValue({distance:this.parseStringInput(t,"double"),unit:this.expression.value.unit}),this.analysisExpressionChange.emit()},this.onDistanceUnitChange=e=>{n.assert("distance"===this.expression.type,"Incorrect render function for expression type.");const t=e.target.selectedOption.value;this.expression.value.unit=t,this.analysisExpressionChange.emit()},this.parseStringInput=(e,t)=>{let i;return i=s.isEmptyDataItem(e)?void 0:n.isFloatFieldType(t)?""===e?void 0:parseFloat(e):n.isIntFieldType(t)?""===e?void 0:parseInt(e):e,i},this.parseDateValueFromInputs=(e,t)=>{const s=e?.valueAsDate,i=t?.value?t.value.split(":"):[0,0];return new Date(s.getFullYear(),s.getMonth(),s.getDate(),Number(i[0]),Number(i[1]))},this.fields=void 0,this.fieldValues=[],this.loadingMessage=void 0,this.expression=void 0,this.target=void 0,this.options=void 0,this.cache=void 0}get maxDropdownItems(){return this.options?.maxDropdownItems??this.defaultMaxDropdownItems}get selectedField(){return this.fields?.find((e=>e.name===this.expression?.field))}async loadFields(e){this.loadAbortController?.abort(),this.loadAbortController=new AbortController;try{await(e?.load(this.loadAbortController.signal))}catch(e){}const t=e?.fields??[];this.fields=t.filter((t=>n.isSupportedField(t,this.options,e)))}async componentWillLoad(){this.strings=i.getStrings(),await this.loadFields(this.target),this.loadFieldValues(this.expression.field)}render(){switch(this.expression.type){case"value":return t.h("analysis-query-entry",{kind:"expression",appearance:"inline",onAnalysisQueryEntryRemove:this.onRemoveClick},t.h("div",{class:u},this.renderFieldSelect("auto"),this.renderOperatorSelect("auto"),this.renderValueInput()));case"multi-value":return t.h("analysis-query-entry",{kind:"expression",appearance:"section",onAnalysisQueryEntryRemove:this.onRemoveClick},t.h("div",{class:r},this.renderFieldSelect("half"),this.renderOperatorSelect("half")),this.renderValuesInput());case"range":return t.h("analysis-query-entry",{kind:"expression",appearance:"section",onAnalysisQueryEntryRemove:this.onRemoveClick},t.h("div",{class:r},this.renderFieldSelect("half"),this.renderOperatorSelect("half")),this.renderRangeInputs());case"distance":return t.h("analysis-query-entry",{kind:"expression",appearance:"inline",onAnalysisQueryEntryRemove:this.onRemoveClick},t.h("div",{class:u},this.renderFieldSelect("auto"),this.renderOperatorSelect("auto"),this.renderDistanceInputs()))}}renderFieldSelect(e="auto"){return t.h("calcite-select",{class:"field-select",label:this.strings.fieldSelect,width:e,onCalciteSelectChange:this.onFieldSelect},this.fields?.map((e=>t.h("calcite-option",{value:e.name,selected:e.name===this.expression?.field},e.alias))))}renderOperatorSelect(e="auto"){const s=function(e){switch(e.dataType){case"string":return n.StringOperators;case"small-integer":case"integer":case"big-integer":case"single":case"double":case"long":case"oid":return n.NumericOperators;case"date":return n.DateOperators;case"date-only":return n.DateOnlyOperators;case"geometry":return n.GeometryOperators;case"boolean":return n.BooleanOperators}}(this.expression),i=void 0!==this.getSelectedFieldDomainOptions(),a=s.filter((e=>!(i&&n.isRangeOperator(e)))).filter((e=>!0===this.options?.useIntervalQueries||!["in_the_last","not_in_the_last"].includes(e)));return t.h("calcite-select",{class:"operator-select",label:this.strings.expressionOperatorSelect,key:this.expression.operator,width:e,onCalciteSelectChange:this.onOperatorSelect},a.map((e=>{const s=this.strings.operators[e],i="is_true"===e||"is_false"===e?s.toLocaleLowerCase():s;return t.h("calcite-option",{value:e,selected:this.expression?.operator===e},i)})))}createUniqueValuesPopover(e=!1,t=!1){this.uniqueValuesPopover&&this.removePopover(),this.uniqueValuesPopover=document.createElement("calcite-popover"),this.uniqueValuesPopover.autoClose=!0,this.uniqueValuesPopover.focusTrapDisabled=!0,this.uniqueValuesPopover.placement="bottom-end",this.uniqueValuesPopover.offsetDistance=0,this.uniqueValuesPopover.offsetSkidding=0,this.uniqueValuesPopover.pointerDisabled=!0,this.uniqueValuesPopover.open=!0,this.uniqueValuesPopover.referenceElement=this.numberInputElement;const s=this.numberInputElement.getBoundingClientRect().width;this.uniqueValuesPopover.style.width=`${s}px`,this.uniqueValuesPopover.addEventListener("calcitePopoverClose",this.removePopover);let i=this.expression.dataType;"oid"===this.expression.dataType&&(i=!0==(void 0===this.fieldValues.find((e=>"string"==typeof e.value)))?"integer":this.expression.dataType);const n=document.createElement("arcgis-filter-unique-list");let a=!1,o=this.fieldValues;o.length>this.maxDropdownItems&&(a=!0,o=o.slice(0,this.maxDropdownItems));const r={uid:`arcgis-filter-unique-list_${this.expression.field}`,uniqueValues:o,partialUniqueValues:a,selectedValues:[this.expression.value],layerFieldType:i,isDate:e,props:{},multiple:t,strings:{searchValues:this.strings.searchValues,sortByCount:this.strings.sortByCount,sortAlphabetical:this.strings.sortAlphabetical,sortAscending:this.strings.sortNumericAscending,sortSelected:this.strings.sortSelected,errors:{tooManyUniqueValues:this.strings.tooManyValuesToDisplay}},sortBy:"name",maxHeight:300};Object.assign(n,r),n.addEventListener("arcgisFilterUniqueListChanged",this.handleUniqueValuesListChange),this.uniqueValuesPopover.appendChild(n),document.body.append(this.uniqueValuesPopover)}renderValueInput(){n.assert("value"===this.expression.type,"Incorrect render function for expression type.");const{dataType:e,value:s,operator:i}=this.expression;let o;if(n.isNoValueOperator(i))o=null;else if(n.isFloatFieldType(e)||n.isIntFieldType(e)){const i=n.isFloatFieldType(e)?"any":1,r=this.getSelectedFieldMinMax();o=t.h("calcite-input-number",{step:i,placeholder:this.strings.inputPlaceholderText,value:void 0===s?void 0:`${s}`,onCalciteInputNumberChange:this.onValueInputChange,min:r?.min,max:r?.max,ref:e=>{void 0!==e&&(this.numberInputElement=e)}},t.h("calcite-button",{slot:"action",label:this.strings.chooseFromUniqueValues,appearance:"outline",kind:"neutral",scale:a.UIDefaults.MediumScale,iconEnd:"chevron-down",onClick:()=>{this.uniqueValuesPopover?this.removePopover():this.createUniqueValuesPopover()}}))}else o="date-only"===e?t.h("div",{class:r},t.h("calcite-input-date-picker",{placement:"bottom-start",overlayPositioning:"fixed",value:s,onCalciteInputDatePickerChange:this.onValueInputChange})):"date"===e?this.renderValueDateInput():t.h("calcite-combobox",{class:"value-select",label:this.strings.choiceList,allowCustomValues:!0,scale:a.UIDefaults.MediumScale,selectionMode:"single",key:this.expression.operator,value:void 0===s?void 0:`${s}`,placeholder:this.strings.inputPlaceholderText,onCalciteComboboxChange:this.onValueComboboxChange,overlayPositioning:"fixed"},this.renderComboboxItems());return o}renderValuesInput(){n.assert("multi-value"===this.expression.type,"Incorrect render function for expression type.");const e=this.expression.validValues.map((e=>`${e}`));return t.h("calcite-combobox",{label:this.strings.multiInputPlaceholderText,onCalciteComboboxChange:this.onValuesComboboxChange,allowCustomValues:!0,selectionMode:"multiple",scale:a.UIDefaults.MediumScale,value:e,key:this.expression.operator,overlayPositioning:"fixed",placeholder:this.strings.inputPlaceholderText,clearDisabled:!0},this.renderComboboxItems())}renderComboboxItems(){const e=[];let s="multi-value"===this.expression.type?this.expression.value:[this.expression.value];s=s.filter((e=>void 0!==e));for(const i of s){const s=`${i}`;e.push(t.h("calcite-combobox-item",{key:s,value:s,textLabel:s,selected:!0}))}if(void 0!==this.loadingMessage)e.push(t.h("calcite-combobox-item",{key:this.loadingMessage,value:void 0,textLabel:this.loadingMessage,selected:!1,disabled:!0}));else{const i=new Set(s),n=this.maxDropdownItems+s.length;for(const s of this.fieldValues)if(i.has(s.value)||e.push(t.h("calcite-combobox-item",{key:s.label,value:`${s.value}`,textLabel:s.label})),e.length>=n){e.push(t.h("calcite-combobox-item",{key:this.strings.tooManyValuesToDisplay,value:void 0,textLabel:this.strings.tooManyValuesToDisplay,selected:!1,disabled:!0}));break}}return t.h(t.Fragment,null,e)}renderValueDateInput(){n.assert("value"===this.expression.type,"Incorrect render function for expression type.");const{operator:e,value:s}=this.expression,i=s,a=this.parseTimeValue(i),o=["is_on","is_not_on"].includes(e);return t.h("div",{class:r},t.h("calcite-input-date-picker",{key:"value-date",placement:"bottom",class:o?r:l,layout:"vertical",overlayPositioning:"fixed",valueAsDate:i,onCalciteInputDatePickerChange:this.onValueDateChange,ref:e=>{this.valueDateInputElement=e}}),!o&&t.h("calcite-input-time-picker",{key:"value-time",placement:"bottom",class:l,overlayPositioning:"fixed",value:a,onCalciteInputTimePickerChange:this.onValueDateChange,ref:e=>{this.valueTimeInputElement=e}}))}renderRangeInputs(){n.assert("range"===this.expression.type,"Incorrect render function for expression type.");const{dataType:e,value:s}=this.expression;let i;if(n.isFloatFieldType(e)||n.isIntFieldType(e)){const a=n.isFloatFieldType(e)?"any":1,o=this.getSelectedFieldMinMax();i=t.h("div",{class:r},t.h("calcite-input-number",{step:a,class:l,value:void 0===s[0]?"":`${s[0]}`,onCalciteInputNumberChange:this.onRangeStartInputChange,min:o?.min,max:o?.max}),t.h("calcite-input-number",{step:a,class:l,value:void 0===s[1]?"":`${s[1]}`,onCalciteInputNumberChange:this.onRangeEndInputChange,min:o?.min,max:o?.max}))}else if("date-only"===e){const e=[s[0]??"",s[1]??""];i=t.h("calcite-input-date-picker",{placement:"bottom-start",overlayPositioning:"fixed",value:e,range:!0,onCalciteInputDatePickerChange:this.onDateOnlyRangeChange})}else i="date"===e?this.renderRangeDateInputs():t.h("p",null,"Not supported yet.");return i}renderRangeDateInputs(){n.assert("range"===this.expression.type,"Incorrect render function for expression type.");const{value:e}=this.expression,s=e[0],i=e[1],a=this.parseTimeValue(s),o=this.parseTimeValue(i);return t.h("div",{class:r},t.h("calcite-input-date-picker",{key:"start-date",class:l,placement:"bottom",overlayPositioning:"fixed",valueAsDate:s,onCalciteInputDatePickerChange:this.onRangeStartDateChange,ref:e=>{this.startDateInputElement=e}}),t.h("calcite-input-time-picker",{key:"start-time",class:l,placement:"bottom",overlayPositioning:"fixed",value:a,onCalciteInputTimePickerChange:this.onRangeStartDateChange,ref:e=>{this.startTimeInputElement=e}}),t.h("calcite-input-date-picker",{key:"end-date",class:l,placement:"bottom",overlayPositioning:"fixed",valueAsDate:i,onCalciteInputDatePickerChange:this.onRangeEndDateChange,ref:e=>{this.endDateInputElement=e}}),t.h("calcite-input-time-picker",{key:"end-time",class:l,placement:"bottom",overlayPositioning:"fixed",value:o,onCalciteInputTimePickerChange:this.onRangeEndDateChange,ref:e=>{this.endTimeInputElement=e}}))}renderDistanceInputs(){n.assert("distance"===this.expression.type,"Incorrect render function for expression type."),n.assert("date"===this.expression.dataType||"date-only"===this.expression.dataType,"Incorrect data type.");const{distance:e,unit:s}=this.expression.value;return t.h(t.Fragment,null,t.h("calcite-input-number",{step:1,placeholder:this.strings.inputPlaceholderText,value:void 0===e?void 0:`${e}`,onCalciteInputNumberChange:this.onDistanceInputChange,class:"value-sm",min:0}),t.h("calcite-select",{label:this.strings.expressionDateUnitSelect,onCalciteSelectChange:this.onDistanceUnitChange},n.DistanceUnitsByType[this.expression.dataType].map((n=>t.h("calcite-option",{value:n,selected:n===s},i.getUnitLabel(n,e))))))}async loadFieldValues(e){let t=this.getSelectedFieldDomainOptions()??[];if(t.length<1)try{this.loadingMessage=this.strings.loadingFieldValues,t=await this.getFieldValuesByUniqueValues(e)}catch{return this.fieldValues=[],void(this.loadingMessage=this.strings.errorRetrievingFieldValues)}this.fieldValues=t.filter((e=>!1===s.isEmptyDataItem(e.value))),this.loadingMessage=this.fieldValues.length<1?this.strings.noFieldValuesRetrieved:void 0}getSelectedFieldMinMax(){let e;const t=this.selectedField?.domain;return"range"===t?.type&&(e={min:t.minValue,max:t.maxValue}),e}getSelectedFieldDomainOptions(){let e;const t=this.selectedField?.name,i=this.selectedField?.domain;if("coded-value"===i?.type)e=i.codedValues.map((e=>({label:e.name,value:e.code})));else if(void 0!==t&&t===this.target?.typeIdField)e=this.target?.types.map((e=>({label:e.name,value:e.id})));else if(void 0!==t&&!1===s.isEmptyDataItem(this.target?.types)){const s=new Map;for(const e of this.target.types){const i=e.domains[t];if("coded-value"===i?.type)for(const e of i.codedValues){const t=s.get(e.code);void 0===t?s.set(e.code,[e.name]):t.includes(e.name)||t.push(e.name)}}if(s.size>0){e=[];for(const[t,i]of s)e.push({label:i.join(" | "),value:t})}}return e}parseTimeValue(e){return e instanceof Date?e.toTimeString().substring(0,5):void 0}get hostElement(){return this}static get watchers(){return{target:["loadFields"]}}static get style(){return":root{--analysis-quarter-spacing:0.25rem;--analysis-half-spacing:0.5rem;--analysis-three-quarter-spacing:0.75rem;--analysis-full-spacing:1rem;--analysis-component-default-width:100%;--analysis-ui-border-input:#d4d4d4;--analysis-label-font-size:var(--calcite-font-size--2);--analysis-popover-content-min-height-s:7.5rem;--analysis-popover-content-min-height-m:8.75rem;--analysis-popover-content-max-height:60vh;--analysis-popover-content-height:45vh}.flex-container{display:flex}.half-width{width:50%}.single-value{display:flex}.single-value .field-select{max-inline-size:45%}.single-value .operator-select{flex-grow:1}.single-value .value-select{--calcite-combobox-input-height:1rem;min-width:150px}.single-value .value-sm{width:10rem}"}},[1,"analysis-attribute-expression",{expression:[1040],target:[16],options:[16],cache:[16],fields:[32],fieldValues:[32],loadingMessage:[32]},void 0,{target:["loadFields"]}]);function p(){"undefined"!=typeof customElements&&["analysis-attribute-expression","analysis-query-entry"].forEach((e=>{switch(e){case"analysis-attribute-expression":customElements.get(e)||customElements.define(e,h);break;case"analysis-query-entry":customElements.get(e)||o.defineCustomElement()}}))}p(),e.AnalysisAttributeExpression=h,e.defineCustomElement=p}));