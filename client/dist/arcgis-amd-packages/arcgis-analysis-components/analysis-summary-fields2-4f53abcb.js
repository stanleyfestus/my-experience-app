define(["exports","./index-60d8a971","./index2-31657c04","./utils-c381fe27","./analysis-chip-group2-3b7294c8","./analysis-label2-5082e9b8","./analysis-summary-fields-popover2-89ee90ce"],(function(e,t,s,i,a,l,o){"use strict";const r=t.proxyCustomElement(class extends t.H{constructor(){super(),this.__registerHost(),this.__attachShadow(),this.analysisSummaryFieldsChange=t.createEvent(this,"analysisSummaryFieldsChange",7),this.analysisHelpClick=t.createEvent(this,"analysisHelpClick",7),this.valueMap=new Map,this.useInitialSelectedStatistics=!1,this.selection=new Set,this.updateValueMap=(e,t)=>{if(!1===this.valueMap.has(e))this.valueMap.set(e,[t]);else{const s=this.valueMap.get(e)??[];!1===s.includes(t)&&(s.push(t),this.valueMap.set(e,s))}},this.popoverAction=()=>{this.fieldPopoverOpen=!0,!0===this.fieldPopoverOpen?this.createSummaryFieldsPopover():void 0!==this.summaryFieldsPopover&&(this.summaryFieldsPopover.open=!1,this.validate())},this.createSummaryFieldsPopover=()=>{void 0===this.summaryFieldsPopover&&(this.summaryFieldsPopover=document.createElement("analysis-summary-fields-popover"),this.summaryFieldsPopover.addEventListener("analysisSummaryFieldSelectionDone",this.onAnalysisSummaryFieldSelectionDone),this.summaryFieldsPopover.addEventListener("analysisSummaryFieldPopoverClose",this.closePopover)),!1===document.body.contains(this.summaryFieldsPopover)&&(document.body.appendChild(this.summaryFieldsPopover),this.summaryFieldsPopover.open=!0),this.summaryFieldsPopover.referenceElement=this.fieldButton,this.summaryFieldsPopover.open=!0,this.summaryFieldsPopover.layer=this.layer,this.summaryFieldsPopover.usePopupTemplatesInfo=this.usePopupTemplatesInfo,this.summaryFieldsPopover.selection=new Set(this.selection.keys()),this.summaryFieldsPopover.allowDateType=this.allowDateType,this.summaryFieldsPopover.allowStringType=this.allowStringType,this.summaryFieldsPopover.allowDateOnlyType=this.allowDateOnlyType,this.summaryFieldsPopover.allowTimeOnlyType=this.allowTimeOnlyType,this.summaryFieldsPopover.layerInputLocalizedLabel=this.layerInputLocalizedLabel,this.summaryFieldsPopover.noFieldsText=this.noFieldsText,this.summaryFieldsPopover.noLayersText=this.noLayersText,this.summaryFieldsPopover.showFieldDescription=this.showFieldDescription},this.closePopover=()=>{void 0!==this.summaryFieldsPopover&&!0===document.body.contains(this.summaryFieldsPopover)&&(document.body.removeChild(this.summaryFieldsPopover),this.summaryFieldsPopover?.remove(),this.summaryFieldsPopover=void 0,this.fieldPopoverOpen=!1)},this.onAnalysisSummaryFieldSelectionDone=e=>{this.selection=e.detail,this.fieldPopoverOpen=!1,0===this.selection.size?(this.valueMap=new Map,this.value=void 0):(Array.from(this.valueMap.keys()).map((e=>{!1===this.selection.has(e)&&this.removeFromValueMap(e)})),Array.from(this.selection).map((e=>{const t=this.layer.fieldsIndex.get(e),{statistics:s}=this.updateStatisticTypes(t.type);this.useInitialSelectedStatistics=!0,!1===this.valueMap.has(e)&&this.updateValueMap(t.name,s[0])})),this.updateValue()),this.analysisSummaryFieldsChange.emit(),this.validate()},this.onAnalysisChipGroupSelectionChange=e=>{const t=e.target,s=t.selectedChips,i=t.parentElement,a=i.description??i.id;!0===this.useInitialSelectedStatistics&&(this.useInitialSelectedStatistics=!1),this.valueMap.set(a,s),this.updateValue(),this.analysisSummaryFieldsChange.emit()},this.closeField=e=>{const t=e.target.parentElement.id;if(this.selection.delete(t),this.removeFromValueMap(t),void 0!==this.value){let e;e=!0===this.storeAsGPValue?this.value.filter((e=>e.onStatisticField.name!==t)):"string"===this.valueFormat?this.value.filter((e=>e.split(" ")[0]!==t)):this.value.filter((e=>e.onStatisticField!==t)),this.value=[...e],this.analysisSummaryFieldsChange.emit()}this.validate()},this.validate=()=>{this.errorMessage=void 0;const e=!this.required||this.valueMap.size>0,t=Array.from(this.valueMap.values()).every((e=>e.length>0));e&&t||(this.errorMessage=this.validationParams?.requiredMessage??this.strings.isRequired)},this.renderErrorMessage=()=>void 0!==this.errorMessage?t.h("calcite-input-message",{status:s.UIInputStatus.INVALID,scale:i.UIDefaults.Scale,icon:"exclamationMarkTriangle"},this.errorMessage):null,this.renderFields=()=>{const e={badInputMessage:this.strings.statisticNotSelected,...this.validationParams};return t.h("calcite-list",null,[...this.valueMap.keys()].map((s=>{const i=this.layer.fieldsIndex?.get(s),a=i?.alias??s,l=this.valueMap.get(s),{statistics:o,labels:r}=this.updateStatisticTypes(i?.type??"integer");return t.h("calcite-list-item",{class:"calcite-list-item",label:a,key:s,id:s,description:i?.name},t.h("analysis-chip-group",{slot:"content-bottom",onAnalysisChipGroupSelectionChange:this.onAnalysisChipGroupSelectionChange,required:!0,scale:"s",class:"calcite-chip",chipLabel:r,value:o,label:this.strings.statistic,selectionMode:"multi",selectAllEnabled:!0,initialChipSelection:this.useInitialSelectedStatistics?l:[],selectedChips:l,validationParams:e}),t.h("calcite-action",{text:"",slot:"actions-end",icon:"trash",onClick:this.closeField}))})))},this.layer=void 0,this.label=void 0,this.valueFormat=void 0,this.storeAsGPValue=!1,this.value=void 0,this.required=!1,this.usePopupTemplatesInfo=!0,this.allowDateType=!1,this.allowDateOnlyType=!1,this.allowTimeOnlyType=!1,this.allowStringType=!1,this.showFirstLastStatistics=!1,this.alwaysShowAnyCountStatistics=!1,this.validationParams=void 0,this.layerInputLocalizedLabel=void 0,this.noFieldsText=void 0,this.noLayersText=void 0,this.showFieldDescription=!1,this.fieldPopoverOpen=!1,this.errorMessage=void 0}valueChange(){this.valueFormat=void 0!==this.value&&this.value.length>0&&"object"==typeof this.value[0]?"object":this.valueFormat??"string",void 0!==this.value&&0===this.valueMap.size&&void 0!==this.valueFormat&&(this.selection=new Set,this.value.forEach((e=>{let t,s;if("string"===this.valueFormat){const i=e.split(" ");t=i[0],s=i[1]}else{const i=e;t="string"==typeof i.onStatisticField?i.onStatisticField:i.onStatisticField.name,s=i.statisticType}this.updateValueMap(t,s),this.selection.add(t)})))}async layerChange(e,t){if(void 0!==e&&void 0===t&&!1===this.useInitialSelectedStatistics&&void 0!==this.value?(this.valueChange(),this.useInitialSelectedStatistics=!0):(this.valueMap=new Map,this.selection=new Set,void 0!==t&&t.id!==e?.id&&(this.value=void 0,this.analysisSummaryFieldsChange.emit())),!1===e?.loaded){this.abortController?.abort();try{this.abortController=new AbortController,await(e?.load(this.abortController.signal))}catch(e){s.wasAborted(e)||(this.errorMessage=this.strings.fieldLoadingErrorText)}}this.closePopover()}disconnectedCallback(){this.closePopover()}async componentWillLoad(){({strings:this.strings}=await s.fetchComponentLocaleStrings(this.hostElement,t.getAssetPath("."))),void 0===this.layer&&void 0===this.usePopupTemplatesInfo||await this.layerChange(this.layer),void 0!==this.layer&&void 0!==this.value&&(this.valueChange(),this.useInitialSelectedStatistics=!0)}async checkValidity(){return this.validate(),Promise.resolve(void 0===this.errorMessage)}updateValue(){const e=[];this.valueMap.forEach(((t,i)=>{t.forEach((t=>{let a;if(!0===this.storeAsGPValue){const a={onStatisticField:s.getFieldJSONByKey(this.layer,i),statisticType:t};e.push(a)}else"string"===this.valueFormat?(a=`${i} ${t}`,e.push(a)):(a={onStatisticField:i,statisticType:t},e.push(a))}))})),this.value=[...e]}removeFromValueMap(e){const t=this.valueMap;t.delete(e),this.valueMap=new Map(t)}updateStatisticTypes(e){let t=[],a=[];return!0===s.isNumericField(e)?(t=[i.StatisticType.Sum,i.StatisticType.Minimum,i.StatisticType.Maximum,i.StatisticType.Mean,i.StatisticType.StdDev],a=[this.strings.sum,this.strings.min,this.strings.max,this.strings.mean,this.strings.standardDeviation]):"date"===e&&!0===this.allowDateType?(t=[i.StatisticType.Minimum,i.StatisticType.Maximum],a=[this.strings.min,this.strings.max]):"string"===e&&!0===this.allowStringType?(t=[i.StatisticType.Any,i.StatisticType.Count],a=[this.strings.any,this.strings.count]):("date-only"===e&&!0===this.allowDateOnlyType||"time-only"===e&&!0===this.allowTimeOnlyType)&&(t=[i.StatisticType.Minimum,i.StatisticType.Maximum],a=[this.strings.min,this.strings.max]),!0===this.alwaysShowAnyCountStatistics&&"string"!==e?(t=[...t,i.StatisticType.Any,i.StatisticType.Count],a=[...a,this.strings.any,this.strings.count]):!0===this.showFirstLastStatistics&&(t=[...t,i.StatisticType.First,i.StatisticType.Last],a=[...a,this.strings.first,this.strings.last]),{statistics:t,labels:a}}render(){return t.h(t.Host,{key:"e05f1418b16453c794a95dc960346092bd9dd787"},void 0!==this.label&&""!==this.label?t.h("analysis-label",{label:this.label,required:this.required,onAnalysisLabelHelpActionClick:()=>this.analysisHelpClick.emit()}):null,void 0!==this.valueMap&&this.valueMap.size>0&&this.renderFields(),t.h("calcite-button",{key:"5ab4180ec93e9e3118f57eb70915c0880ff40e1d",appearance:"outline",kind:"neutral","icon-start":"plus",width:"full",scale:i.UIDefaults.Scale,ref:e=>{this.fieldButton=e},onClick:this.popoverAction},this.strings.field),this.renderErrorMessage())}static get assetsDirs(){return["t9n"]}get hostElement(){return this}static get watchers(){return{value:["valueChange"],layer:["layerChange"],usePopupTemplatesInfo:["layerChange"]}}static get style(){return":root{--analysis-quarter-spacing:0.25rem;--analysis-half-spacing:0.5rem;--analysis-three-quarter-spacing:0.75rem;--analysis-full-spacing:1rem;--analysis-component-default-width:100%;--analysis-ui-border-input:#d4d4d4;--analysis-label-font-size:var(--calcite-font-size--2);--analysis-popover-content-min-height-s:7.5rem;--analysis-popover-content-min-height-m:8.75rem;--analysis-popover-content-max-height:60vh;--analysis-popover-content-height:45vh}:host{display:flex;flex-direction:column;margin-bottom:var(--analysis-half-spacing)}.label{margin-top:0}.calcite-chip{margin:var(--analysis-quarter-spacing)}.calcite-list-item{border:2px solid var(--calcite-color-border-1);margin-bottom:var(--analysis-quarter-spacing);margin-top:var(--analysis-quarter-spacing);border-radius:var(--analysis-quarter-spacing);overflow:hidden}.calcite-switch{border:2px solid var(--calcite-color-border-1);margin-bottom:var(--analysis-quarter-spacing);margin-top:var(--analysis-quarter-spacing);padding:var(--analysis-quarter-spacing);padding-top:var(--analysis-three-quarter-spacing);border-radius:var(--analysis-quarter-spacing);overflow:hidden}"}},[1,"analysis-summary-fields",{layer:[16],label:[513],valueFormat:[1537,"value-format"],storeAsGPValue:[4,"store-as-g-p-value"],value:[1040],required:[516],usePopupTemplatesInfo:[516,"use-popup-templates-info"],allowDateType:[516,"allow-date-type"],allowDateOnlyType:[516,"allow-date-only-type"],allowTimeOnlyType:[516,"allow-time-only-type"],allowStringType:[516,"allow-string-type"],showFirstLastStatistics:[516,"show-first-last-statistics"],alwaysShowAnyCountStatistics:[516,"always-show-any-count-statistics"],validationParams:[16],layerInputLocalizedLabel:[1,"layer-input-localized-label"],noFieldsText:[1,"no-fields-text"],noLayersText:[1,"no-layers-text"],showFieldDescription:[4,"show-field-description"],fieldPopoverOpen:[32],errorMessage:[32],checkValidity:[64]},void 0,{value:["valueChange"],layer:["layerChange"],usePopupTemplatesInfo:["layerChange"]}]);function n(){"undefined"!=typeof customElements&&["analysis-summary-fields","analysis-chip-group","analysis-label","analysis-summary-fields-popover"].forEach((e=>{switch(e){case"analysis-summary-fields":customElements.get(e)||customElements.define(e,r);break;case"analysis-chip-group":customElements.get(e)||a.defineCustomElement();break;case"analysis-label":customElements.get(e)||l.defineCustomElement();break;case"analysis-summary-fields-popover":customElements.get(e)||o.defineCustomElement()}}))}n(),e.AnalysisSummaryFields=r,e.defineCustomElement=n}));