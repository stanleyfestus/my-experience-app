define(["exports","./index-60d8a971","./index2-31657c04","./analysis-expression-group2-c43af168","./utils-c381fe27","./analysis-attribute-expression2-5251ae6f","./analysis-label2-5082e9b8","./analysis-query-builder2-d6563e02","./analysis-query-entry2-6efeefcb","./analysis-query-modal2-ef038098","./analysis-query-target-select2-d19b2afa","./analysis-spatial-expression2-00a2b684"],(function(e,s,t,a,i,r,l,o,n,u,h,d){"use strict";const y="mb-half",c=s.proxyCustomElement(class extends s.H{constructor(){super(),this.__registerHost(),this.analysisQueryInputChange=s.createEvent(this,"analysisQueryInputChange",7),this.analysisHelpClick=s.createEvent(this,"analysisHelpClick",7),this.openModal=()=>{this.queryModal=document.createElement("analysis-query-modal"),this.queryModal.target=this.layer??this.expressionGroup?.layer??this.combinedLayers[0],this.queryModal.expressionGroup=this.expressionGroup,this.queryModal.layers=this.combinedLayers,this.queryModal.recordsTerm=this.recordsTerm,this.queryModal.mode=this.mode,this.queryModal.open=!0,this.queryModal.options=this.options,this.hasValue&&void 0!==this.value&&(this.queryModal.value=this.value),this.queryModal.addEventListener("analysisQueryModalAdd",this.onQueryModalAddClick),this.queryModal.addEventListener("analysisQueryModalError",this.onQueryModalError),this.queryModal.addEventListener("analysisQueryModalDismissed",this.onQueryModalDismissed),document.body.appendChild(this.queryModal)},this.closeModal=()=>{this.queryModal?.removeEventListener("analysisQueryModalAdd",this.onQueryModalAddClick),this.queryModal?.removeEventListener("analysisQueryModalError",this.onQueryModalError),this.queryModal?.removeEventListener("analysisQueryModalDismissed",this.onQueryModalDismissed),this.queryModal?.remove()},this.onQueryModalError=e=>{this.errorMessage=e.detail},this.onQueryModalAddClick=async e=>{const s=e.detail;this.value=await this.serializeExpressionGroup(s),this.analysisQueryInputChange.emit(this.value),this.validate()},this.serializeExpressionGroup=async e=>{let s;if("sql"===this.mode)s=e?.toSQL(this.options);else{const t=await(e?.toJSON(this.combinedLayers,this.mapView));void 0!==t?.expressions&&void 0!==t?.inputLayers&&(s={expressions:t?.expressions,inputLayers:t?.inputLayers})}return s},this.onQueryModalDismissed=()=>{this.closeModal(),this.validate()},this.onDeleteQuery=()=>{this.value=void 0,this.analysisQueryInputChange.emit(void 0),this.validate()},this.combinedLayers=void 0,this.valueLabel=void 0,this.errorMessage=void 0,this.loading=!0,this.expressionGroup=void 0,this.label=void 0,this.required=!1,this.mode="analysis",this.value=void 0,this.mapLayers=[],this.recordsTerm="features",this.disabledTooltip=void 0,this.options=void 0,this.mapView=void 0,this.layer=void 0}async valueChange(){if("analysis"===this.mode){const e=await this.loadGPQueryLayers(this.value,this.combinedLayers);this.combinedLayers=this.combineLayers(e.result??[],this.combinedLayers)}const e=await this.parseCurrentValue();this.expressionGroup=e.result,this.maybeSetFirstError([e]),this.setValueLabel()}setValueLabel(){const e="features"===this.recordsTerm?this.strings.featureValueHeader:this.strings.recordsValueHeader,s=this.expressionGroup?.layer;this.valueLabel=void 0!==s?t.formatMessage(e,{layer:s.title}):t.formatMessage(e,{layer:""})}async mapLayersChange(e){const s=await this.loadSupportedMapLayers(e),t=this.expressionGroup?.getUsedLayers(this.combinedLayers);this.combinedLayers=this.combineLayers(t??[],s.result??[]),this.maybeSetFirstError([s])}async targetLayerChange(e){if(void 0===e)return;const s=await this.loadTargetLayer(e),t=await this.parseCurrentValue();if(void 0===s.error&&void 0!==t.result){const e=await this.serializeExpressionGroup(t.result);this.value!==e?(this.value=e,this.analysisQueryInputChange.emit(this.value)):(this.expressionGroup=t.result,this.setValueLabel())}this.maybeSetFirstError([s,t])}get hasError(){return!1===t.isEmptyDataItem(this.errorMessage)}get hasValue(){let e;if("string"==typeof this.value)e=""!==this.value;else if(void 0!==this.value){const{expressions:s,inputLayers:t}=this.value;e=void 0!==s&&s.length>0&&void 0!==t&&t.length>0}else e=!1;return e}get canCreateQuery(){const e=void 0===this.layer||void 0!==this.layer.loadError&&null!==this.layer.loadError,s=void 0===this.combinedLayers||0===this.combinedLayers.length;return!(e&&s)}async componentWillLoad(){({strings:this.strings}=await t.fetchComponentLocaleStrings(this.hostElement,s.getAssetPath("."))),this.loading=!0,this.loadInitialState().finally((()=>this.loading=!1))}async loadInitialState(){const e=await this.loadTargetLayer(this.layer),s=await this.loadSupportedMapLayers(this.mapLayers),t=s.result??[],a=await this.loadGPQueryLayers(this.value,t),i=a.result??[];void 0!==a.error&&(this.value=void 0,this.analysisQueryInputChange.emit()),this.combinedLayers=this.combineLayers(i,t);const r=[e,s,a].some((e=>void 0!==e.error)),l=await this.parseCurrentValue();if(void 0!==l.result&&(this.expressionGroup=l.result,this.setValueLabel(),!r)){const e=await this.serializeExpressionGroup(this.expressionGroup);this.value!==e&&(this.value=e,this.analysisQueryInputChange.emit(this.value))}this.maybeSetFirstError([e,s,a,l])}componentDidRender(){void 0!==this.tooltipRef&&null!==this.tooltipRef&&void 0!==this.addButtonRef&&(this.tooltipRef.referenceElement=this.addButtonRef)}disconnectedCallback(){this.closeModal()}async checkValidity(){return Promise.resolve(this.validate())}render(){return!0===this.loading?this.renderLoadingState():this.hasValue?this.renderValueState():this.renderInitialState()}renderLoadingState(){return s.h(s.Host,null,s.h("calcite-label",{scale:i.UIDefaults.Scale},void 0!==this.label&&""!==this.label?s.h("analysis-label",{label:this.label,required:this.required,onAnalysisLabelHelpActionClick:()=>this.analysisHelpClick.emit()}):null,s.h("calcite-button",{appearance:"outline",kind:"neutral","icon-start":"plus",width:"full",scale:i.UIDefaults.Scale,onClick:()=>{},loading:!0,disabled:!0},this.strings.createQuery)))}renderInitialState(){return s.h(s.Host,null,s.h("calcite-label",{scale:i.UIDefaults.Scale},void 0!==this.label&&""!==this.label?s.h("analysis-label",{label:this.label,required:this.required,onAnalysisLabelHelpActionClick:()=>this.analysisHelpClick.emit()}):null,s.h("calcite-button",{appearance:"outline",kind:"neutral","icon-start":"plus",width:"full",scale:i.UIDefaults.Scale,onClick:()=>{this.canCreateQuery&&this.openModal()},disabled:!1===this.canCreateQuery,ref:e=>this.addButtonRef=e},this.strings.createQuery),!1===this.canCreateQuery&&s.h("calcite-tooltip",{label:this.disabledTooltip??this.strings.disabledTooltip,referenceElement:this.addButtonRef,ref:e=>this.tooltipRef=e,overlayPositioning:"fixed"},this.disabledTooltip??this.strings.disabledTooltip)),s.h("calcite-input-message",{class:y,hidden:!this.hasError,icon:"exclamationMarkTriangle",status:t.UIInputStatus.INVALID,scale:i.UIDefaults.Scale},!1===this.hasError?this.strings.isRequired:this.errorMessage))}renderValueState(){return s.h(s.Host,null,s.h("calcite-label",{scale:i.UIDefaults.Scale},void 0!==this.label&&""!==this.label?s.h("analysis-label",{label:this.label,required:this.required,onAnalysisLabelHelpActionClick:()=>this.analysisHelpClick.emit()}):null,s.h("calcite-list",{onClick:()=>this.openModal(),class:`border ${y}`},s.h("calcite-list-item",{value:"query",label:this.valueLabel,description:this.strings.editDescription,disabled:"sql"===this.mode&&!this.canCreateQuery},s.h("calcite-action",{slot:"actions-end",icon:"pencil",text:this.strings.editAction})))),s.h("calcite-button",{class:y,appearance:"outline",kind:"neutral","icon-start":"trash",width:"full",scale:i.UIDefaults.Scale,onClick:this.onDeleteQuery},this.strings.deleteQuery),s.h("calcite-input-message",{class:y,status:"invalid",scale:i.UIDefaults.Scale,hidden:!this.hasError,icon:"exclamationMarkTriangle"},this.errorMessage))}async loadTargetLayer(e){let s;try{await(e?.load()),s={result:void 0===e?void 0:e}}catch(e){const s="records"===this.recordsTerm?"targetDatasetLoadError":"layersLoadError";return{error:this.strings[s]}}return s}async loadSupportedMapLayers(e){let s;if(void 0===e)s={result:[]};else{const a=e.filter(t.isUrlFeatureLayer).filter((e=>!e.isTable));await Promise.allSettled(a.map((e=>e.load())));const i=a.filter((e=>e.loaded));s=i.length!==a.length?{result:i,error:this.strings.layersLoadError}:{result:i}}return s}async loadGPQueryLayers(e,s){let a;if("string"!=typeof e&&Array.isArray(e?.inputLayers)){const r=(s??[]).reduce(((e,s)=>(e.set(i.formatLayerUrlAndId(s),s),e)),new Map),l=e.inputLayers.filter((e=>!r.has(e.url)));try{const e=await t.loadFeatureLayers(l);l.forEach(((s,t)=>r.set(s.url,e[t])))}catch{return{error:this.strings.layersLoadError}}a={result:e.inputLayers.map((e=>r.get(e.url))).filter((e=>void 0!==e))}}else a={result:[]};return a}combineLayers(e,s){const t=new Set,a=[];for(const r of[...e,...s]){const e=i.formatLayerUrlAndId(r);t.has(e)||(t.add(e),a.push(r))}return a}async parseCurrentValue(){let e,s;return"analysis"===this.mode&&"object"==typeof this.value?({group:e,errorKey:s}=await a.ExpressionGroup.fromJSON(this.value.expressions,this.combinedLayers)):"sql"===this.mode&&"string"==typeof this.value&&({group:e,errorKey:s}=await a.ExpressionGroup.fromSQL(this.value,this.layer,this.options)),void 0!==s?{result:e,error:this.strings[s]}:{result:e}}validate(){let e;return!this.hasValue&&this.required?(e=!1,this.errorMessage=this.strings.isRequired):(e=!0,this.errorMessage=void 0),e}maybeSetFirstError(e){const s=e.find((e=>void 0!==e.error));void 0!==s&&(this.errorMessage=s.error)}static get assetsDirs(){return["t9n"]}get hostElement(){return this}static get watchers(){return{value:["valueChange"],mapLayers:["mapLayersChange"],layer:["targetLayerChange"]}}static get style(){return":root{--analysis-quarter-spacing:0.25rem;--analysis-half-spacing:0.5rem;--analysis-three-quarter-spacing:0.75rem;--analysis-full-spacing:1rem;--analysis-component-default-width:100%;--analysis-ui-border-input:#d4d4d4;--analysis-label-font-size:var(--calcite-font-size--2);--analysis-popover-content-min-height-s:7.5rem;--analysis-popover-content-min-height-m:8.75rem;--analysis-popover-content-max-height:60vh;--analysis-popover-content-height:45vh}.border{border:1px solid var(--calcite-color-border-input)}.mb-half{margin-bottom:var(--analysis-half-spacing)}"}},[0,"analysis-query-input",{label:[513],required:[516],mode:[513],value:[1025],mapLayers:[16],recordsTerm:[1,"records-term"],disabledTooltip:[1,"disabled-tooltip"],options:[16],mapView:[16],layer:[16],combinedLayers:[32],valueLabel:[32],errorMessage:[32],loading:[32],expressionGroup:[32],checkValidity:[64]},void 0,{value:["valueChange"],mapLayers:["mapLayersChange"],layer:["targetLayerChange"]}]);function p(){"undefined"!=typeof customElements&&["analysis-query-input","analysis-attribute-expression","analysis-expression-group","analysis-label","analysis-query-builder","analysis-query-entry","analysis-query-modal","analysis-query-target-select","analysis-spatial-expression"].forEach((e=>{switch(e){case"analysis-query-input":customElements.get(e)||customElements.define(e,c);break;case"analysis-attribute-expression":customElements.get(e)||r.defineCustomElement();break;case"analysis-expression-group":customElements.get(e)||a.defineCustomElement();break;case"analysis-label":customElements.get(e)||l.defineCustomElement();break;case"analysis-query-builder":customElements.get(e)||o.defineCustomElement();break;case"analysis-query-entry":customElements.get(e)||n.defineCustomElement();break;case"analysis-query-modal":customElements.get(e)||u.defineCustomElement();break;case"analysis-query-target-select":customElements.get(e)||h.defineCustomElement();break;case"analysis-spatial-expression":customElements.get(e)||d.defineCustomElement()}}))}p(),e.AnalysisQueryInput=c,e.defineCustomElement=p}));