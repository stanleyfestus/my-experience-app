/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-3d141c.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-3d141c"],{29983:(e,t,a)=>{a.r(t),a.d(t,{arcgis_field_calculate:()=>y});var i=a(20536),l=a(37568),r=a(88492),n=a(98034),o=a(25972),s=a(91102),c=a(91616);a(73807),a(74129),a(34752),a(10699),a(98072),a(99004),a(44090),a(38973),a(369);async function d(){var e;const{layer:t}=r.f,a=t.portalItem.portal;return null!==(e=await(0,o.g)(a,4))&&void 0!==e?e:a.credential.token}async function u(e,t){const{modules:a}=r.f;var i=e.url,l=e.content||{},n=await d(),o=function(e){const{modules:t}=r.f;var a=t.urlUtils.urlToObject(e);for(var i in a.query=a.query||{},a.query)a.query.hasOwnProperty(i)&&(Array.isArray(a.query[i])||(a.query[i]=a.query[i].replace(/(&lt;|&gt;|<|>|%3C|%3E)/g,"")));return a}(i).query||{};l.get("f")||o.f||l.append("f","json"),l.set("token",n);const s={body:l,timeout:(null==t?void 0:t.timeout)||0,method:"post",responseType:"json"};try{return(await a.esriRequest(e.url,s)).data}catch(e){throw console.error(e),e}}async function p(){const{layer:e}=r.f,t=`${e.portalItem.url}/${e.layerId}/append`,a=function(){const{originalField:e,layer:t,registeredResultId:a}=r.f,i=[{source:e.name,name:e.name},{source:t.objectIdField,name:t.objectIdField}],l=[e.name,t.objectIdField],n={fieldMappings:JSON.stringify(i),upsert:!0,skipUpdates:!1,useGlobalIds:!1,skipInserts:!0,updateGeometry:!1,appendFields:JSON.stringify(l),appendUploadId:a,appendUploadFormat:"csv",rollbackOnFailure:!0,upsertMatchingField:t.objectIdField,appendSourceInfo:"{}"};let o=new FormData;for(const e in n)o.append(e,n[e]);return o}();try{const e=await u({url:t,content:a});await f(e.statusUrl+="?f=json",500)}catch(e){throw e}}async function h(e){const{arcadeExecutor:t,layer:a}=r.f;try{return await t.executeAsync({$feature:e,$datastore:a.url},{spatialReference:a.spatialReference,rawOutput:!0})}catch(t){throw"arcade"==t.calcErrorType?Object.assign(Object.assign({},t),{feature:e}):t}}async function f(e,t){const{modules:a}=r.f,i=["processing","partial","Pending","InProgress","EXECUTING"],l=["completed","Completed","COMPLETED"];try{let r=(await a.esriRequest(e,{responseType:"json"})).data;return i.includes(r.status)?(await(0,c.t)(t),f(e,t+250)):r.status&&!l.includes(r.status)||r.code>400||""===r.status?Promise.reject():r.recordCount}catch(e){throw e}}function m(e,t,a){a&&e.unshift(a);const i=JSON.stringify(e),l=("object"!=typeof(r=i)?JSON.parse(r):r).map((e=>Object.values(e).toString())).join("\n");var r;const n=t+".csv"||0,o=new Blob([l],{type:"text/csv;charset=utf-8;"}),s=document.createElement("form");s.enctype="multipart/form-data";const c=new FormData(s);return c.append("file",o,n),c}function g(e,t){const{arcadeExecutor:a,isTable:i,layer:l,modules:n}=r.f,o=[l.objectIdField].concat(a.fieldsUsed),s=a.geometryUsed&&"hasM"in l&&l.hasM,c=a.geometryUsed&&"hasZ"in l&&l.hasZ,d=new n.Query({start:e,returnGeometry:a.geometryUsed,returnM:s,returnZ:c,outFields:o,where:t});let u=0;const p=function(){var e,t;const{layer:a}=r.f,i=a.sourceJSON;return(null===(e=i.advancedQueryCapabilities)||void 0===e?void 0:e.supportsQueryWithResultType)&&(null===(t=i.advancedQueryCapabilities)||void 0===t?void 0:t.supportsMaxRecordCountFactor)&&i.supportedQueryFormats.includes("PBF")&&i.supportsQuantizationEditMode}(),h={format:p?"pbf":"json"};return u=a.geometryUsed||i?l.sourceJSON.standardMaxRecordCount:l.sourceJSON.standardMaxRecordCountNoGeometry,d.resultType="standard",d.maxRecordCountFactor=1,d.num=u,{query:d,options:h,maxSize:u}}async function b(e,t){const{layer:a,originalField:i}=r.f;try{const l=await async function(e){const{arcadeExecutor:t,features:a,layer:i}=r.f,l=[];if(t.isAsync)for(const t of e)try{const e=await h(t),r=t.attributes[i.objectIdField];let n={objectId:r,ArcadeField:e};a[r]||(a[r]={feature:t,calculatedValue:e,tableFeature:!1,passed:!1}),n=v(n),l.push(n)}catch(e){throw"arcade"==e.calcErrorType?Object.assign(Object.assign({},e),{feature:t}):e}else for(const r of e)try{const e=t.execute({$feature:r,$datastore:i.url},{spatialReference:i.spatialReference,rawOutput:!0}),n=r.attributes[i.objectIdField];let o={objectId:n,ArcadeField:e};a[n]||(a[n]={feature:r,calculatedValue:e,tableFeature:!1,passed:!1}),o=v(o),l.push(o)}catch(e){throw"arcade"==e.calcErrorType?Object.assign(Object.assign({},e),{feature:r}):e}return l}(e);return null===l?null:1===t?m(l,`uploadFile${t}`,{objectId:a.objectIdField,ArcadeField:i.name}):m(l,`uploadFile${t}`)}catch(e){throw e}}function v(e){const{features:t,originalField:a}=r.f;let i=e.ArcadeField;const l=e.objectId,n=(0,r.v)(i);if(null===i&&(i=""),/<\/?[a-z][\s\S]*>/i.test(i)&&(i=(0,s.s)(i)),t[l].calculatedValue=i,t[l].passed=n.isFieldValid,!n.isFieldValid)throw t[l].error=n.errorMessage,{calcErrorType:"arcade",message:n.errorMessage,objectId:l};var o;return"esri.arcade.arcadedate"===(null==i?void 0:i.declaredRootClass)?i=i.toISOString():"esri.core.sql.timeonly"===(null==i?void 0:i.declaredRootClass)?i=i.toStorageString():"esri.core.sql.dateonly"===(null==i?void 0:i.declaredRootClass)&&(i=i.toStorageFormat()),-1!==a.type.toLowerCase().indexOf("string")&&("string"==typeof(o=i)&&(o=o.replace(/"/g,'""')),i='"'+o+'"'),e.ArcadeField=i,e}const y=class{constructor(e){(0,i.r)(this,e),this.arcgisFieldCalculateClose=(0,i.c)(this,"arcgisFieldCalculateClose",7),this.arcgisFieldCalculateDataUpdate=(0,i.c)(this,"arcgisFieldCalculateDataUpdate",7),this.filterPanelWhere=null,this.testFeatureFilterWhere=null,this.debouncedEditorScriptChange=(0,c.d)((()=>{this.handleEditorScriptChange()}),500),this.fieldName=void 0,this.layer=void 0,this.config=void 0,this.editorOpen=!1,this.filterPanelOpen=!1,this.view="both",this.calculationState="none"}async componentWillLoad(){var e,t;await this.loadStore();const{arcadeSupported:a,isTable:i,layer:l,modules:n,strings:o}=r.f;if(!(("feature"===l.type||"oriented-imagery"===l.type)&&l.sourceJSON.supportsCalculate&&(null===(t=null===(e=l.portalItem)||void 0===e?void 0:e.typeKeywords)||void 0===t?void 0:t.indexOf("Hosted Service"))>-1&&["admin","update"].indexOf(l.portalItem.itemControl)>-1))return console.error(o.fieldCalcNotAllowed),Promise.reject();if(a&&(this.arcadeProfile=n.arcade.createArcadeProfile("field-calculation")),!i){const e=l.portalItem.portal,t=e.useVectorBasemaps?e.defaultVectorBasemap:e.defaultBasemap;this.map=new n.Map({basemap:t}),this.map.add(l)}}componentDidLoad(){var e;const{arcadeSupported:t,isTable:a,modules:i}=r.f;a||(this.mapAndTableActionNode.active=!0),t&&(this.lruCache=new i.RecentlyUsedCache),null===(e=this.tableNode)||void 0===e||e.setMode("features")}async componentDidRender(){if("map"!==this.view&&this.tableNode){"features"===await this.tableNode.getMode()?this.featuresChipNode.selected=!0:this.previewChipNode.selected=!0}}render(){return(0,i.h)(i.H,{key:"dc50af05a9b23e303b6ff96a4c4fde1c8ca67361"},(0,i.h)("calcite-dialog",{key:"7f72a1f9ecaf172229df4d98962493bda1dc292d",class:"field-calc-modal",open:!0,modal:!0,placement:"cover",escapeDisabled:!0,outsideCloseDisabled:!0,closeDisabled:!0,onCalciteDialogOpen:e=>{e.stopImmediatePropagation(),this.closeActionNode.setFocus()},ref:e=>this.dialogNode=e},this.renderModalHeader(),(0,i.h)("calcite-shell",{key:"9a18c7f57bf542b5572a04276c607d7ab51d683b",class:"shell"},this.renderShellContent()),this.renderFooter()))}renderModalHeader(){const{layer:e,originalField:t,strings:a}=r.f;return(0,i.h)(i.F,null,(0,i.h)("div",{class:"title",slot:"header-content"},`${e.title} : ${t.alias||t.name}`),(0,i.h)("calcite-action-bar",{slot:"header-actions-end","expand-disabled":"true",layout:"horizontal"},"none"===this.calculationState&&this.renderViewActions(),(0,i.h)("calcite-action",{icon:"x",text:a.close,label:a.close,onClick:()=>this.arcgisFieldCalculateClose.emit(),ref:e=>{this.closeActionNode=e}})))}renderViewActions(){const{isTable:e,strings:t}=r.f;return(0,i.h)(i.F,null,(0,i.h)("calcite-action",{id:"table-action",disabled:e,icon:"table",text:t.table,label:t.table,onClick:()=>this.changeView("table"),ref:e=>this.tableActionNode=e}),(0,i.h)("calcite-tooltip",{class:"field-calc-tooltip",referenceElement:"table-action",placement:"bottom"},(0,i.h)("span",null,t.table)),(0,i.h)("calcite-action",{id:"map-action",disabled:e,icon:"map",text:t.map,label:t.map,onClick:()=>this.changeView("map"),ref:e=>this.mapActionNode=e}),(0,i.h)("calcite-tooltip",{class:"field-calc-tooltip",referenceElement:"map-action",placement:"bottom"},(0,i.h)("span",null,t.map)),(0,i.h)("calcite-action",{id:"map-and-table-action",disabled:e,icon:"widgets-group",text:t.mapAndTable,onClick:()=>this.changeView("both"),ref:e=>this.mapAndTableActionNode=e}),(0,i.h)("calcite-tooltip",{class:"field-calc-tooltip",referenceElement:"map-and-table-action",placement:"bottom"},(0,i.h)("span",null,t.mapAndTable)))}renderShellContent(){return"none"===this.calculationState?(0,i.h)(i.F,null,this.renderCalculatePanel(),(0,i.h)("calcite-panel",{class:"panel-border table-panel"},this.renderTableActions(),this.renderTable(),this.renderMap())):this.renderRunningCalculations()}renderRunningCalculations(){const{strings:e}=r.f,t={hidden:"none"===this.calculationState};return(0,i.h)(i.F,null,(0,i.h)("calcite-panel",{class:t},"running"===this.calculationState?(0,i.h)("div",{class:"calculating-values-content"},(0,i.h)("div",{class:"calculating-values-label"},e.calculatingValues),(0,i.h)("calcite-loader",{label:e.calculatingValues,scale:"l",type:"determinate",value:0,text:`0 / ${r.f.filteredFeatureCount}`,ref:e=>this.loaderNode=e})):"success"===this.calculationState?(0,i.h)("div",{class:"calculation-finish"},(0,i.h)("svg",{class:"calculation-success-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 64 64"},(0,i.h)("path",{d:"M52.745 9.436L23.35 38.869l-9.32-9.57-7.305 7.466 16.63 16.552 26.707-26.708 9.895-10.032zm-3.252 16.61l-26.14 26.141L7.85 36.757l6.176-6.313 9.314 9.564 29.408-29.444 6.076 6.02z"})),(0,i.h)("p",{class:"calculation-success-label"},e.calculationsComplete),(0,i.h)("p",null),(0,i.h)("calcite-button",{appearance:"outline-fill",iconStart:"download-to",onClick:()=>this.downloadScript()},e.downloadScript)):"error"===this.calculationState?(0,i.h)("div",{class:"calculation-finish"},(0,i.h)("svg",{class:"calculation-error-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 48 48"},(0,i.h)("path",{d:"M26.158 7.927a1.9 1.9 0 0 0-3.315 0L5.4 39.072A1.9 1.9 0 0 0 7.06 41.9h34.88a1.9 1.9 0 0 0 1.659-2.828zm16.733 32.63a1.107 1.107 0 0 1-.95.543H7.06a1.101 1.101 0 0 1-.961-1.638L23.54 8.318a1.1 1.1 0 0 1 1.919 0L42.9 39.462a1.106 1.106 0 0 1-.01 1.094zM24.1 20h.8v11h-.8zm0 14h.8v3h-.8z"})),(0,i.h)("p",{class:"calculation-success-label"},this.calculationErrorMessage),(0,i.h)("p",null),(0,i.h)("calcite-button",{appearance:"outline-fill",iconStart:"arrow-left",iconFlipRtl:"start",onClick:()=>{this.calculationState="none",this.editorOpen=!0,(0,i.f)(this.hostElement),setTimeout((()=>{var e;(null===(e=r.f.arcadeExecutor)||void 0===e?void 0:e.geometryUsed)&&this.tableNode.enableGeometry(),this.tableNode.updateTableFilter(this.testFeatureFilterWhere,this.filterPanelWhere),this.changeView("both"),this.tableNode.setMode("preview"),this.previewChipNode.selected=!0,r.f.autoPreviewEnabled=!0}),300)}},e.back)):null))}renderTableActions(){var e;if("map"===this.view)return;const{autoPreviewEnabled:t,strings:a}=r.f;return(0,i.h)("div",{slot:"header-content",class:"panel-header"},(0,i.h)("calcite-chip-group",{label:"chips","selection-mode":"single-persist",disabled:!this.editorOpen},(0,i.h)("div",null,(0,i.h)("calcite-button",{appearance:"outline",kind:"neutral","icon-start":"filter",onClick:e=>{e.stopPropagation(),e.preventDefault(),this.openFilterPopover(e.currentTarget)}},a.testFeaturesFilter)),(0,i.h)("calcite-chip",{icon:"table",label:a.testFeatures,value:a.testFeatures,onClick:()=>this.tableNode.setMode("features"),ref:e=>this.featuresChipNode=e},a.testFeatures),(0,i.h)("calcite-chip",{icon:"compare",label:a.previewValues,value:a.previewValues,onClick:async()=>{this.tableNode.setMode("preview")},ref:e=>this.previewChipNode=e},a.previewValues)),(0,i.h)("div",{class:"auto-preview"},a.autoPreview,(0,i.h)("calcite-switch",{checked:t,disabled:(null===(e=r.f.arcadeExecutor)||void 0===e?void 0:e.isAsync)||!1,onCalciteSwitchChange:e=>{r.f.autoPreviewEnabled=e.target.checked,r.f.autoPreviewEnabled&&this.debouncedEditorScriptChange()},ref:e=>this.autoPreviewSwitchNode=e})))}renderTable(){const{layer:e,strings:t}=r.f,a={"layer-table":!0,hidden:"map"===this.view};return(0,i.h)(i.F,null,(0,i.h)("calcite-panel",{heading:e.title,class:a},(0,i.h)("calcite-label",{class:"feature-count",layout:"inline",slot:"header-actions-end"},(0,i.h)("calcite-icon",{scale:"s",icon:"test-data"}),t.testFeatures,":",(0,i.h)("div",{ref:e=>this.testFeatureCountNode=e})),(0,i.h)("arcgis-field-calculate-table",{onArcgisFieldCalculateTableRecordCountUpdate:e=>{this.testFeatureCountNode.innerHTML=`${e.detail}`},ref:e=>this.tableNode=e})))}renderMap(){const{isTable:e}=r.f;if(!e)return(0,i.h)("calcite-panel",{class:""+("table"===this.view?"hidden":"")},(0,i.h)("div",{class:"viewDiv",ref:e=>{e&&(e.style.width="100%",e.style.height="100%",this.createMapViewAndPopupTemplate(e))}}))}renderCalculatePanel(){const{layer:e,modules:t}=r.f;return(0,i.h)("calcite-shell-panel",{slot:"panel-start",resizable:!0,class:"panel-border calculate-panel ",widthScale:"l"},(0,i.h)("arcgis-field-calculate-editor",{editorOpen:this.editorOpen,onArcgisFieldCalculateEditorScriptChange:async()=>{var a,i;try{if(r.f.invalidScript=!1,"Arcade"===r.f.selectedLanguage){this.lruCache.clear();const e=t.arcade.createArcadeProfile("field-calculation");r.f.arcadeExecutor=await t.arcade.createArcadeExecutor(r.f.currentScript,e,{lruCache:this.lruCache}),r.f.layer.outFields=r.f.arcadeExecutor.fieldsUsed,this.autoPreviewSwitchNode&&(this.autoPreviewSwitchNode.disabled=null===(a=r.f.arcadeExecutor)||void 0===a?void 0:a.isAsync),(null===(i=r.f.arcadeExecutor)||void 0===i?void 0:i.geometryUsed)&&this.tableNode.enableGeometry()}else if("SQL"===r.f.selectedLanguage){const a=await d(),i=await fetch(`${e.url}/${e.layerId}/validateSQL?sql=${encodeURIComponent(r.f.currentScript)}&sqlType=expression&f=json&token=${a}`);(await i.json()).isValidSQL?(r.f.sqlEngine=await t.sql.parseWhereClause(r.f.currentScript,e.fieldsIndex),r.f.sqlEngine.currentUser=e.portalItem.portal.user.username):this.handleInvalidScript()}await this.debouncedEditorScriptChange()}catch(e){this.handleInvalidScript()}},onArcgisFieldCalculateEditorFilterChange:async e=>{const{features:t}=r.f;if(this.filterPanelOpen){this.filterPanelWhere=e.detail,this.createFeatureEffect(!1),this.filterPanelWhere?r.f.filteredFeatureCount=await(0,r.g)(this.filterPanelWhere):r.f.filteredFeatureCount=r.f.totalFeatureCount;for(const e in t)t[e].tableFeature=!1;this.featureRatioNode.innerHTML=`${r.f.filteredFeatureCount} / ${r.f.totalFeatureCount}`,await this.tableNode.updateTableFilter(this.testFeatureFilterWhere,this.filterPanelWhere)}},onArcgisFieldCalculateEditorOpenScrim:()=>this.openScrim(),onArcgisFieldCalculateEditorLanguageSelected:()=>{this.openFilterPanel(),this.tableNode.refresh(!0)},ref:e=>this.calculationPanelNode=e}))}renderFooter(){const{totalFeatureCount:e,filteredFeatureCount:t,strings:a}=r.f;return(0,i.h)(i.F,null,(0,i.h)("div",{slot:"footer-start",class:"modal-footer"},this.renderBackButton()),(0,i.h)("div",{slot:"footer-end",class:"footer-buttons-end modal-footer"},(0,i.h)("calcite-label",{class:"meter-label",alignment:"center",layout:"inline-space-between"},a.selectedFeatures,(0,i.h)("calcite-meter",{class:"meter",label:a.selectedFeatures,min:0,max:e,value:t,fillType:"single"})),(0,i.h)("calcite-label",{class:"feature-ratio",layout:"inline-space-between",ref:e=>this.featureRatioNode=e},t," / ",e),this.renderCancelButton(),this.renderNextButton(),this.renderRunCalculationsButton()))}renderBackButton(){const{strings:e}=r.f;return"none"===this.calculationState&&(this.editorOpen||this.filterPanelOpen)?(0,i.h)("calcite-button",{class:"button-margin",slot:"back",width:"full",alignment:"center",appearance:"transparent",iconStart:"arrow-left",iconFlipRtl:"start",onClick:()=>{this.editorOpen?(this.closeEditor(),this.openFilterPanel()):this.filterPanelOpen&&this.closeFilterPanel()}},e.back):null}renderNextButton(){const{filteredFeatureCount:e,selectedLanguage:t,strings:a}=r.f;return this.editorOpen||"none"!==this.calculationState?null:(0,i.h)("calcite-button",{class:"button-margin",disabled:!e||!t,width:"full",alignment:"center",appearance:"solid",iconEnd:"arrow-right",iconFlipRtl:"end",onClick:()=>{this.filterPanelOpen?(this.closeFilterPanel(),this.openEditor()):this.openFilterPanel()}},a.next)}renderRunCalculationsButton(){const{strings:e}=r.f;return this.editorOpen&&"none"===this.calculationState?(0,i.h)("calcite-button",{class:"button-margin",width:"full",alignment:"center",appearance:"solid",iconStart:"calculator",onClick:()=>this.handleRunCalculations()},e.runCalculation):null}renderCancelButton(){const{strings:e}=r.f,t=["success","error"].includes(this.calculationState);return(0,i.h)("calcite-button",{disabled:"running"===this.calculationState,class:"cancel-button",width:"full",appearance:t?"solid":"outline-fill",alignment:"center",onClick:()=>this.arcgisFieldCalculateClose.emit()},t?e.close:e.cancel)}changeView(e){const{isTable:t}=r.f;t||(this.view=e,this.mapActionNode.active="map"===this.view,this.tableActionNode.active="table"===this.view,this.mapAndTableActionNode.active="both"===this.view,this.filterPopoverNode&&"map"===this.view&&(document.body.removeChild(this.filterPopoverNode),this.filterPopoverNode=null))}closeEditor(){this.editorOpen=!1,this.calculationPanelNode.closeEditor()}async handleEditorScriptChange(){const{arcadeExecutor:e,layer:t,sqlEngine:a}=r.f;e||a?((null==e?void 0:e.isAsync)&&(r.f.autoPreviewEnabled=!1,this.autoPreviewSwitchNode&&(this.autoPreviewSwitchNode.checked=!1,this.autoPreviewSwitchNode.disabled=!0)),t.outFields=(null==e?void 0:e.fieldsUsed)||a.fieldNames,await this.tableNode.calculateValues()):this.tableNode.refresh(!0)}closeFilterPanel(){const{layer:e}=r.f;this.filterPanelOpen=!1,this.calculationPanelNode.closeFilterPanel(),this.calculationPanelNode.filterPanelWhere=this.filterPanelWhere,e.definitionExpression=this.filterPanelWhere}createMapViewAndPopupTemplate(e){var t;const{layer:a,modules:i}=r.f;(null===(t=r.f.mapView)||void 0===t?void 0:t.container)!=e&&(r.f.mapView=new i.MapView({map:this.map,popup:new i.Popup({dockEnabled:!0,dockOptions:{buttonEnabled:!1,position:"top-left",breakpoint:!1},viewModel:{includeDefaultActions:!1}}),container:e,constraints:{snapToZoom:!1},extent:a.fullExtent}),a.popupTemplate=new i.PopupTemplate({title:a.displayField?`{${a.displayField}}`:`{${a.objectIdField}}`,content:r.p,lastEditInfoEnabled:!1}))}createFeatureEffect(e){const{layer:t,modules:a}=r.f;this.filterPanelWhere?t.featureEffect=new a.FeatureEffect({filter:{where:this.filterPanelWhere},excludedEffect:`grayscale(100%) opacity(${e?0:80}%) brightness(100%)`}):t.featureEffect=null}downloadScript(){const{currentScript:e}=r.f,t=document.createElement("a"),a=new Blob([e],{type:"text/plain"});t.href=URL.createObjectURL(a),t.download="script.txt",t.click(),URL.revokeObjectURL(t.href)}async handleRunCalculations(){const{arcadeExecutor:e,autoPreviewEnabled:t,features:a,selectedLanguage:i,strings:l,sqlEngine:n}=r.f,o=await this.tableNode.noRowsVisible(),s=!Object.values(a).find((e=>e.tableFeature&&!e.passed));let c=!n&&!(o||s&&e);if(!s&&!o&&((null==e?void 0:e.isAsync)||!t)&&!n){c=!await this.calculationPanelNode.isTestResultValid()}if(c){const e=document.createElement("calcite-alert");e.classList.add("error-alert"),e.kind="warning",e.icon="exclamation-mark-triangle-f",e.label=l.errorAlertTitle;const t=document.createElement("div");t.slot="title",t.innerHTML=l.errorAlertTitle;const a=document.createElement("div");a.slot="message",a.innerHTML=l.errorAlertMessage;const i=document.createElement("calcite-link");return i.slot="link",i.innerHTML=l.errorAlertLink,i.onclick=()=>{"map"===this.view&&this.changeView("both"),this.tableNode.setMode("preview"),this.previewChipNode.selected=!0},e.append(t,a,i),e.open=!0,e.slot="alerts",void this.dialogNode.append(e)}"Arcade"===i?this.runCalculationsArcade():"SQL"===i&&this.runCalculationsSQL()}handleInvalidScript(){const{features:e}=r.f;r.f.arcadeExecutor=void 0,r.f.sqlEngine=void 0,r.f.invalidScript=!0,(0,r.u)(),this.tableNode.refresh(!0);for(const t in e)e[t].error=void 0,e[t].calculatedValue=void 0}async loadStore(){var e,t,a;const[i]=await(0,l.g)(this.hostElement);(0,r.c)(r.f),r.f.layer=this.layer.clone(),r.f.layer.featureReduction=null,r.f.layer.effect=null,r.f.layer.featureEffect=null,r.f.layer.visible=!0,r.f.layer.definitionExpression=null,await r.f.layer.load(),r.f.originalField=this.layer.fields.filter((e=>e.name===this.fieldName))[0],r.f.strings=i,r.f.numRecords=40,r.f.config=this.config,r.f.features={},r.f.autoPreviewEnabled=!0;const o=r.f.layer.portalItem.portal,s=o.isPortal||"multitenant"!==o.portalMode,c=r.f.layer.sourceJSON,d=null===(e=c.capabilities)||void 0===e?void 0:e.includes("Uploads"),u=!s||d;r.f.arcadeSupported=!(null===(t=c.capabilities)||void 0===t?void 0:t.includes("Sync"))&&!(null===(a=c.capabilities)||void 0===a?void 0:a.includes("ChangeTracking"))&&u,r.f.isTable="feature"===r.f.layer.type&&r.f.layer.isTable,await async function(){const[e,t,a,i,l,o,s,c,d,u,p,h,f,m,g,b,v,y,w,F,C,E]=await(0,n.l)(["esri/portal/PortalItem","esri/layers/Layer","esri/Map","esri/views/MapView","esri/widgets/FeatureTable","esri/widgets/FeatureTable/support/TableTemplate","esri/popup/support/FieldInfoFormat","esri/support/popupUtils","esri/core/reactiveUtils","esri/rest/support/Query","esri/arcade","esri/layers/support/arcadeUtils","esri/widgets/Popup","esri/PopupTemplate","esri/layers/support/FeatureEffect","esri/request","esri/core/urlUtils","esri/identity/IdentityManager","esri/core/Collection","esri/intl","esri/arcade/featureset/support/RecentlyUsedCache","esri/core/sql"]);r.f.modules={PortalItem:e,Layer:t,Map:a,MapView:i,FeatureTable:l,TableTemplate:o,FieldInfoFormat:s,popupUtils:c,reactiveUtils:d,Query:u,arcade:p,arcadeUtils:h,Popup:f,PopupTemplate:m,FeatureEffect:g,esriRequest:b,urlUtils:v,IdentityManager:y,Collection:w,intl:F,RecentlyUsedCache:C,sql:E}}(),r.f.totalFeatureCount=await(0,r.g)(),r.f.filteredFeatureCount=r.f.totalFeatureCount}openEditor(){var e;this.editorOpen=!0,null===(e=this.calculationPanelNode)||void 0===e||e.openEditor()}openFilterPanel(){const{layer:e}=r.f;this.filterPanelOpen=!0,this.calculationPanelNode.openFilterPanel(),e.definitionExpression=null,this.createFeatureEffect(!1)}async openFilterPopover(e){const{strings:t}=r.f;if(this.filterPopoverNode)return;this.filterPopoverNode=document.createElement("calcite-popover"),this.filterPopoverNode.style.width="30%",this.filterPopoverNode.placement="bottom-start",this.filterPopoverNode.pointerDisabled=!0,this.filterPopoverNode.label=t.testFeaturesFilter,this.filterPopoverNode.triggerDisabled=!0,this.filterPopoverNode.referenceElement=e,this.filterPopoverNode.addEventListener("calcitePopoverClose",(()=>{this.filterPopoverNode=null}));const a=document.createElement("arcgis-filter"),i=(await this.tableNode.getLayer()).clone();await i.load(),a.panelMaxHeight="50vh",a.layer=i,a.dismissible=!1,a.withinModal=!0,a.hideLayerTitle=!0,a.tipMsg=t.testFeatureFilterTipMsg,a.addEventListener("arcgisFilterCancel",(()=>{document.body.removeChild(this.filterPopoverNode),this.testFeatureFilterWhere=null,this.filterPopoverNode=null,e.setFocus()})),a.addEventListener("arcgisFilterWhereChange",(e=>{this.testFeatureFilterWhere=e.detail})),a.addEventListener("arcgisFilterSave",(()=>{document.body.removeChild(this.filterPopoverNode),this.tableNode.updateTableFilter(this.testFeatureFilterWhere,this.filterPanelWhere),this.filterPopoverNode=null,e.setFocus()})),this.filterPopoverNode.appendChild(a),document.body.appendChild(this.filterPopoverNode),this.filterPopoverNode.open=!0,a.setFocus()}openScrim(){const{strings:e}=r.f,t=document.createElement("calcite-scrim");t.style.zIndex="900";const a=document.createElement("div"),i=document.createElement("div");i.innerHTML=e.scrimTitle;const l=document.createElement("div");l.innerHTML=e.scrimDescription;const n=document.createElement("div");n.style.display="flex",n.style.justifyContent="center",n.style.columnGap="5px";const o=document.createElement("calcite-button");o.style.minWidth="100px",o.innerHTML=e.back,o.iconFlipRtl="start",o.iconStart="arrow-left",o.appearance="outline-fill",o.onclick=async()=>{document.body.removeChild(t),await this.tableNode.refresh(!1)};const s=document.createElement("calcite-button");s.style.minWidth="100px",s.innerHTML=e.close,s.onclick=async()=>{document.body.removeChild(t),this.arcgisFieldCalculateClose.emit()},n.append(o,s),a.append(i,l,n),a.style.textAlign="center",i.style.fontSize="32px",l.style.marginBottom="20px",t.append(a),document.body.append(t)}async runCalculationsArcade(){const{features:e,layer:t,strings:a}=r.f;this.calculationState="running";try{const e=await async function(){const{layer:e}=r.f,t=`${e.portalItem.url}/uploads/register`,a=new FormData;return a.append("itemName",`${e.portalItem.id}.csv`),a.append("description","Arcade Calculate"),await u({url:t,content:a})}();if(!e.success)return this.calculationState="error",void(this.calculationErrorMessage=a.calculationErrorGeneral);r.f.registeredResultId=e.item.itemID;const i=0,l=1,n=await this.queryAndUploadProcess(l,i),o=`${t.portalItem.url}/uploads/${r.f.registeredResultId}/commit`;let s=new FormData;s.append("parts",this.allPartsInString(n)),s.append("f","json"),await u({url:o,content:s}),this.loaderNode.type="indeterminate",this.loaderNode.text="",await p(),this.calculationState="success",this.arcgisFieldCalculateDataUpdate.emit()}catch(i){if(this.calculationState="error","arcade"===i.calcErrorType){this.calculationErrorMessage=i.message;const a=i.feature.attributes[t.objectIdField];this.testFeatureFilterWhere=`${t.objectIdField} = ${a}`,e[a]||(e[a]={}),e[a].passed=!1}else this.calculationErrorMessage=a.calculationErrorGeneral,console.error(i)}}async runCalculationsSQL(){const{currentScript:e,filteredFeatureCount:t,layer:a,originalField:i,strings:l}=r.f;this.calculationState="running";try{const r=`[{ "field": "${i.name}", "sqlExpression": "${encodeURIComponent(e)}" }]`,n=await d(),o=await fetch(`${a.url}/${a.layerId}/calculate?where=${this.filterPanelWhere||"1=1"}&calcExpression=${r}&async=true&f=json&token=${n}`,{method:"POST"}),s=await o.json();if(s.error)this.calculationState="error",this.calculationErrorMessage=l.calculationErrorGeneral;else{await f(s.statusUrl+="?f=json",500)===t?this.calculationState="success":(this.calculationState="error",this.calculationErrorMessage=l.calculationErrorGeneral)}}catch(e){console.error(e),this.calculationState="error",this.calculationErrorMessage=l.calculationErrorGeneral}}allPartsInString(e){let t="",a="";for(let i=1;i<=e;i++)a+=t+i,t=",";return a}async queryAndUploadProcess(e,t){const{layer:a,registeredResultId:i}=r.f;let l=e||1,n=t||0;const o=g(t||0,this.filterPanelWhere),s=o.maxSize;try{let t=await a.queryFeatures(o.query),r=await b(t.features,e);r.append("f","json"),r.append("partId",l);const c=`${a.portalItem.url}/uploads/${i}/uploadPart`;if(await u({url:c,content:r},{timeout:0}),!t.exceededTransferLimit)return r=void 0,t=void 0,this.updateProgressBar(l,s),l;n+=s,l++,r=void 0,t=void 0,this.updateProgressBar(l-1,s),await this.queryAndUploadProcess(l,n)}catch(e){throw e}}updateProgressBar(e,t){if(!this.loaderNode)return;const{filteredFeatureCount:a}=r.f;t<1&&(t=1);const i=a/t,l=Math.min(100,Math.floor(e/i*100)),n=e*t>a?a:e*t;this.loaderNode.value=l,this.loaderNode.text=`${n} / ${a}`}static get assetsDirs(){return["assets"]}get hostElement(){return(0,i.d)(this)}};y.style=".auto-preview{display:flex;align-items:center;gap:12px;margin:auto;margin-left:10px}.button-margin{margin:auto}.calculate-panel{z-index:var(--calcite-z-index-header)1}.field-calc-modal{--calcite-dialog-content-space:0px}.calculation-error-icon{fill:var(--calcite-color-status-danger);width:64px;height:64px}.calculation-finish{text-align:center;margin:auto}.calculation-success-icon{fill:var(--calcite-color-status-success);width:64px;height:64px}.calculation-success-label{text-align:center;font-size:20px;font-style:normal;font-weight:400}.calculating-values-content{height:100%;align-content:center}.calculating-values-label{font-size:var(--calcite-font-size-xxl);text-align:center;margin-bottom:-50px}.cancel-button{margin:auto;margin-right:10px}.error-alert{z-index:1000;position:static}.feature-count{margin-right:10px;margin-top:auto}.feature-ratio{margin-right:20px;margin-top:15px;text-wrap:nowrap}.field-calc-tooltip{z-index:401}.footer-buttons-end{justify-content:flex-end}.hidden{display:none}.layer-table{border-radius:var(--calcite-corner-radius-round);width:auto;height:100%;margin:20px;box-shadow:var(--calcite-shadow-sm)}.mapView{width:100%;height:100%}.meter{width:200px;margin-right:5px;--calcite-color-brand:#6a6a6a}.meter-label{text-wrap:nowrap;margin-top:15px}.modal-footer{display:flex;align-items:center}.panel-border{border:1px solid #e0e0e0}.panel-header{display:inline-flex;margin-left:10px}.popup-icon{width:64px;height:auto;text-align:center}.popup-error-icon{--calcite-ui-icon-color:var(--calcite-color-status-warning)}.shell{position:relative}.table-panel{z-index:399}.title{font-size:var(--calcite-font-size-xxl);font-weight:var(--calcite-font-weight-bold)}"}}]);