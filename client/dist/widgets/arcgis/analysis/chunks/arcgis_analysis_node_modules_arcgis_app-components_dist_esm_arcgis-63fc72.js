/*! For license information please see arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-63fc72.js.LICENSE.txt */
"use strict";(self.webpackChunkexb_client=self.webpackChunkexb_client||[]).push([["vendors-extensions_widgets_arcgis_analysis_node_modules_arcgis_app-components_dist_esm_arcgis-63fc72"],{19780:(e,t,i)=>{i.r(t),i.d(t,{arcgis_field_delete:()=>c});var s=i(20536),l=i(98072),a=i(37568),n=i(98034),o=i(38973),r=i(93511),d=i(25972);i(74129),i(91102),i(73807),i(34752),i(99004),i(44090),i(10699),i(78231),i(369);const c=class{constructor(e){(0,s.r)(this,e),this.arcgisFieldDeleteFieldDeleted=(0,s.c)(this,"arcgisFieldDeleteFieldDeleted",7),this.arcgisFieldDeleteModalClose=(0,s.c)(this,"arcgisFieldDeleteModalClose",7),this.layerFieldsMap=new Map,this.arcadeExpMap=new Map,this.fieldIsDeletable=!1,this.layer=void 0,this.mapView=void 0,this.config=void 0,this.fieldName=void 0,this.deleteInProgress=!1,this.currentLayerInfo=void 0}async componentWillLoad(){var e;const{layer:t,mapView:i,fieldName:s}=this,[n]=await(0,a.g)(this.hostElement);this.strings=n,s&&(this.layerField=t.fields.find((e=>e.name===s)),this.fieldIsDeletable=await(0,r.a)(i,t,this.layerField),this.fieldIsDeletable&&(await this.loadAllModules(),this.layerFieldsMap=await(0,l.e)(t),this.arcadeExpMap=(0,l.f)(t.popupTemplate),this.token=null!==(e=await(0,d.g)(t.portalItem.portal,4))&&void 0!==e?e:t.portalItem.portal.credential.token))}render(){const{strings:e,fieldIsDeletable:t,deleteInProgress:i}=this;return t?(0,s.h)(s.H,null,(0,s.h)("calcite-dialog",{class:""+(i?"delete-in-progress-dialog":""),widthScale:"s",ref:e=>this.dialogNode=e,open:!0,modal:!0,outsideCloseDisabled:!0,escapeDisabled:!0,onCalciteDialogClose:()=>this.arcgisFieldDeleteModalClose.emit(),heading:e.deleteField},(0,s.h)("div",{class:"content-wrapper"},this.renderDeleteLoader(),this.renderWarning(),(0,s.h)("calcite-label",null,e.deletePrompt),this.renderFieldPreview()),this.renderCancelButton(),this.renderDeleteButton())):(console.error("Field cannot be deleted"),null)}renderDeleteLoader(){const{strings:e,deleteInProgress:t}=this;return(0,s.h)("div",{class:"loader-container "+(t?"active":"")},(0,s.h)("calcite-loader",{class:"loader",label:e.deletingField,hidden:!t}),(0,s.h)("div",{class:"loader-text"},e.deletingField))}renderWarning(){const{config:e,strings:t}=this,{helpBase:i,helpMap:l}=e;return(0,s.h)("calcite-notice",{class:"warning",open:!0,icon:"exclamation-mark-triangle",scale:"s",kind:"warning"},(0,s.h)("div",{slot:"message",class:"warning-message"},t.deleteWarning),(0,s.h)("calcite-link",{slot:"link",target:"_blank",href:`${i}${l[120004852]}`},t.learnMore))}renderFieldPreview(){const{fieldName:e,layerField:t,layerFieldsMap:i,arcadeExpMap:a}=this;return(0,s.h)("calcite-list",null,(0,s.h)("calcite-list-item",{label:this.getFieldLabel(),description:`{${e}}`,value:e,disabled:!t.editable},(0,s.h)("div",{slot:"actions-end",class:"field-icons"},(0,s.h)(r.F,{fieldType:(0,l.b)(e,i,a)}))))}renderCancelButton(){const{strings:e}=this;return(0,s.h)("calcite-button",{onClick:()=>this.dialogNode.open=!1,slot:"footer-end",appearance:"outline",ref:e=>this.cancelNode=e},e.cancel)}renderDeleteButton(){const{strings:e}=this;return(0,s.h)("calcite-button",{kind:"danger",slot:"footer-end",onClick:async e=>{e.target.disabled=!0,this.cancelNode.disabled=!0,this.dialogNode.closeDisabled=!0,this.deleteInProgress=!0,await this.deleteField()}},e.deleteField)}async loadAllModules(){const[e,t,i,s,l]=await(0,n.l)(["esri/request","esri/layers/support/FeatureTemplate","esri/Graphic","esri/layers/support/arcadeUtils","esri/layers/support/fieldUtils"]);this.modules={request:e,FeatureTemplate:t,Graphic:i,arcadeUtils:s,fieldUtils:l}}getFieldLabel(){var e,t;const{layer:i,fieldName:s,arcadeExpMap:a}=this,n=null===(t=(null!==(e=i.popupTemplate)&&void 0!==e?e:i.createPopupTemplate()).fieldInfos)||void 0===t?void 0:t.find((e=>e.fieldName===s));return(0,l.c)(n,a)}async deleteField(){const{layer:e,modules:t,fieldName:i,token:s}=this,{request:l}=t,a=`${e.url.replace("/rest/services","/rest/admin/services")}/${e.layerId}/deleteFromDefinition`,n={fields:[{name:i}]},o={deleteFromDefinition:JSON.stringify(n)};await l(a,{query:Object.assign(Object.assign({},o),{f:"json",token:s,async:!1}),method:"post",responseType:"json"}).then((async t=>{var s,a;if(null===(s=t.data)||void 0===s?void 0:s.success){const t=`${e.url}/${e.layerId}`;"feature"===e.type&&(null===(a=e.floorInfo)||void 0===a?void 0:a.floorField)===i&&(e.floorInfo=null),await l(t,{query:{f:"json"},responseType:"json"}).then((async e=>{var t;const s=e.data;this.currentLayerInfo=e.data,s&&(this.updateTypesAndTemplatesOnLayer(),(null===(t=s.templates)||void 0===t?void 0:t.length)?s.templates.forEach((e=>{delete e.prototype.attributes[i]})):s.types.forEach((e=>{e.templates.forEach((e=>{delete e.prototype.attributes[i]}))})),this.updateFeatureService(s,l))}))}}),(()=>this.handleError()))}updateTypesAndTemplatesOnLayer(){var e;const{currentLayerInfo:t}=this,i=t;if(null===(e=i.templates)||void 0===e?void 0:e.length){const e=this.updateTemplatesList(i.templates);i.templates=e}else if(i.types){const e=i.types;i.types=[],e.forEach((e=>{e.templates=this.updateTemplatesList(e.templates),this.addType(i,e)}))}}updateTemplatesList(e){const{currentLayerInfo:t,modules:i,strings:s}=this,l=[];return(null!=e?e:[]).forEach((e=>{var a;const n=new i.FeatureTemplate;n.description=null!==(a=e.description)&&void 0!==a?a:"",n.name=e.name||s.newFeature,n.drawingTool=e.drawingTool||"point";const o={};t.fields.forEach((t=>{let i=!1;for(const s in e.prototype.attributes)if(s===t.name){i=!0,o[t.name]=e.prototype.attributes[t.name];break}!i&&t.editable&&(o[t.name]=t.defaultValue||null)}));const r=new i.Graphic({attributes:o});n.prototype=r,l.push(n)})),l}addType(e,t){if(e.types){e.types.some((e=>e.id===t.id))||e.types.push(t)}else e.types=[t]}async updateFeatureService(e,t){const{layer:i,fieldName:s,token:l}=this,a={templates:e.templates,types:e.types},n=`${i.url.replace("/rest/services","/rest/admin/services")}/${i.layerId}/updateDefinition`,r={f:"json",updateDefinition:JSON.stringify(a)};await t(n,{query:Object.assign(Object.assign({},r),{f:"json",token:l}),method:"post",responseType:"json"}).then((async e=>{var a,n,r,d;if(null===(a=e.data)||void 0===a?void 0:a.success){const e=`${(0,o.g)(i.portalItem.portal)}content/items/${i.portalItem.id}/data`;(null===(n=i.popupTemplate)||void 0===n?void 0:n.fieldInfos)&&(i.popupTemplate.fieldInfos=i.popupTemplate.fieldInfos.filter((e=>e.fieldName!==s))),null===(d=null===(r=i.popupTemplate)||void 0===r?void 0:r.content)||void 0===d||d.forEach(((e,t)=>{var l,a,n;"fields"===e.type&&e.fieldInfos&&((null===(l=i.popupTemplate)||void 0===l?void 0:l.content)[t].fieldInfos=null===(n=(null===(a=i.popupTemplate)||void 0===a?void 0:a.content)[t].fieldInfos)||void 0===n?void 0:n.filter((e=>e.fieldName!==s)))})),await t(e,{query:{f:"json"},method:"get",responseType:"json",token:l}).then((async e=>{var a,n;const r=e.data;if((null==r?void 0:r.layers)||(null==r?void 0:r.tables)){const e=i.isTable,d=e?r.tables:r.layers,c=null==d?void 0:d.find((e=>e.id===i.layerId));if((null===(a=null==c?void 0:c.attributeTableInfo)||void 0===a?void 0:a.attributeTableElements)&&(c.attributeTableInfo.attributeTableElements=c.attributeTableInfo.attributeTableElements.filter((e=>!("field"===e.type&&e.fieldName===s))),c.attributeTableInfo.orderByFields=c.attributeTableInfo.orderByFields.filter((e=>e.field!==s))),null==c?void 0:c.popupInfo){c.popupInfo.fieldInfos=c.popupInfo.fieldInfos.filter((e=>e.fieldName!==s)),null===(n=c.popupInfo.popupElements)||void 0===n||n.forEach(((e,t)=>{"fields"===e.type&&e.fieldInfos&&(c.popupInfo.popupElements[t].fieldInfos=c.popupInfo.popupElements[t].fieldInfos.filter((e=>e.fieldName!==s)))}));const a=`${(0,o.g)(i.portalItem.portal)}content/users/${i.portalItem.owner}/items/${i.portalItem.id}/update`,r={};e?r.tables=d:r.layers=d;const p={f:"json",text:JSON.stringify(r)};await t(a,{query:Object.assign(Object.assign({f:"json"},p),{token:l}),method:"post",responseType:"json"}).then((e=>{var t;(null===(t=e.data)||void 0===t?void 0:t.success)?this.handleSuccess():this.handleError()}),(()=>this.handleError()))}else this.handleSuccess()}else 200!==e.httpStatus||e.data&&"{}"!==JSON.stringify(e.data)?this.handleError():this.handleSuccess()}),(()=>this.handleError()))}}),(()=>this.handleError()))}handleSuccess(){this.arcgisFieldDeleteFieldDeleted.emit(),this.dialogNode.open=!1,this.displaySuccessAlert()}handleError(){this.dialogNode.open=!1,this.displayErrorAlert()}displaySuccessAlert(){var e;const{strings:t}=this;this.successAlertNode&&(null===(e=this.successAlertNode.parentElement)||void 0===e||e.removeChild(this.successAlertNode),this.successAlertNode=null);const i=this.successAlertNode=document.createElement("calcite-alert");i.kind="success",i.icon="check-circle";const s=document.createElement("div");s.slot="message",s.innerHTML=t.fieldDeleted,i.append(s),i.open=!0,i.autoClose=!0,document.body.append(i)}displayErrorAlert(){var e;const{strings:t}=this;this.errorAlertNode&&(null===(e=this.errorAlertNode.parentElement)||void 0===e||e.removeChild(this.errorAlertNode),this.errorAlertNode=null);const i=this.errorAlertNode=document.createElement("calcite-alert");i.kind="danger",i.icon="exclamation-mark-triangle";const s=document.createElement("div");s.slot="message",s.innerHTML=t.fieldDeletionUnsuccessful,i.append(s),i.open=!0,i.autoClose=!0,document.body.append(i),setTimeout((()=>i.setFocus()),1e3)}get hostElement(){return(0,s.d)(this)}};c.style=".delete-in-progress-dialog{--calcite-dialog-background-color:var(--arcgis-app-background)}.content-wrapper{position:relative}.field-icons{padding:0 var(--arcgis-app-cap-spacing);display:flex;align-items:center}.warning{border-bottom:1px solid var(--calcite-color-border-3);margin-bottom:12px}.warning-message{font-size:var(--calcite-font-size--1);font-weight:var(--calcite-font-weight-bold)}.loader-container{position:absolute;top:0px;right:0px;z-index:40;display:none;height:100%;width:100%;overflow:hidden;background:rgba(255, 255, 255, 0.95);padding:0px}.active{display:flex;flex-direction:column;place-content:center;align-items:center;justify-items:center}.loader{padding:0px}.loader-text{text-align:center;font-size:1rem;font-weight:500;margin-right:6.25rem;margin-left:6.25rem}"}}]);