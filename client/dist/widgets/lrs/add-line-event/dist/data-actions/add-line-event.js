System.register(["jimu-core","widgets/shared-code/lrs"],(function(e,t){var n={},r={};return{setters:[function(e){n.AbstractDataAction=e.AbstractDataAction,n.DataLevel=e.DataLevel,n.DataSourceStatus=e.DataSourceStatus,n.DataSourceTypes=e.DataSourceTypes,n.MutableStoreManager=e.MutableStoreManager,n.getAppStore=e.getAppStore,n.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules},function(e){r.QueryRouteMeasures=e.QueryRouteMeasures,r.getDateWithTZOffset=e.getDateWithTZOffset,r.getRouteFromEndMeasures=e.getRouteFromEndMeasures,r.isDefined=e.isDefined,r.queryRouteIdOrName=e.queryRouteIdOrName}],execute:function(){e((()=>{"use strict";var e={79244:e=>{e.exports=n},47626:e=>{e.exports=r}},t={};function i(n){var r=t[n];if(void 0!==r)return r.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{void 0!==m&&m.toStringTag&&Object.defineProperty(e,m.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};i.r(o),i.d(o,{default:()=>V});const a="object"==typeof global&&global&&global.Object===Object&&global;var s="object"==typeof self&&self&&self.Object===Object&&self;const u=a||s||Function("return this")();var l=/\s/;const d=function(e){for(var t=e.length;t--&&l.test(e.charAt(t)););return t};var c=/^\s+/;const f=function(e){return e?e.slice(0,d(e)+1).replace(c,""):e};const g=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var m=u.Symbol;const v=m;var D=Object.prototype,p=D.hasOwnProperty,h=D.toString,S=v?v.toStringTag:void 0;const y=function(e){var t=p.call(e,S),n=e[S];try{e[S]=void 0;var r=!0}catch(e){}var i=h.call(e);return r&&(t?e[S]=n:delete e[S]),i};var N=Object.prototype.toString;const b=function(e){return N.call(e)};var O=v?v.toStringTag:void 0;const M=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":O&&O in Object(e)?y(e):b(e)};const I=function(e){return null!=e&&"object"==typeof e};const R=function(e){return"symbol"==typeof e||I(e)&&"[object Symbol]"==M(e)};var j=/^[-+]0x[0-9a-f]+$/i,P=/^0b[01]+$/i,T=/^0o[0-7]+$/i,F=parseInt;const A=function(e){if("number"==typeof e)return e;if(R(e))return NaN;if(g(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=g(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=f(e);var n=P.test(e);return n||T.test(e)?F(e.slice(2),n?2:8):j.test(e)?NaN:+e};var w=1/0;const L=function(e){return e?(e=A(e))===w||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0};const k=function(e){var t=L(e),n=t%1;return t==t?n?t-n:t:0};const x=function(e,t){for(var n=-1,r=null==e?0:e.length,i=Array(r);++n<r;)i[n]=t(e[n],n,e);return i};const J=Array.isArray;var E=v?v.prototype:void 0,_=E?E.toString:void 0;const G=function e(t){if("string"==typeof t)return t;if(J(t))return x(t,e)+"";if(R(t))return _?_.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n};const W=function(e){return null==e?"":G(e)};var Z=u.isFinite,C=Math.min;const q=function(e){var t=Math[e];return function(e,n){if(e=A(e),(n=null==n?0:C(k(n),292))&&Z(e)){var r=(W(e)+"e").split("e"),i=t(r[0]+"e"+(+r[1]+n));return+((r=(W(i)+"e").split("e"))[0]+"e"+(+r[1]-n))}return t(e)}}("round");var Q=i(79244),$=i(47626),B=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(e){o(e)}}function s(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))};class V extends Q.AbstractDataAction{isSupported(e,t){return B(this,void 0,void 0,(function*(){var n;if(e.length>1)return!1;const r=e[0],i=r.records[0];if(!(0,$.isDefined)(i))return!1;const o=i.getData(),a=JSON.parse(JSON.stringify(o)),{dataSource:s,records:u}=r,l=s.type===Q.DataSourceTypes.FeatureLayer||s.type===Q.DataSourceTypes.SceneLayer,d=s.isDataSourceSet(),c=t!==Q.DataLevel.Records,f=r.dataSource,g=(null==f?void 0:f.supportSpatialInfo)&&(null==f?void 0:f.supportSpatialInfo()),m=t===Q.DataLevel.Records&&0===(null==u?void 0:u.length),v=!s.isInAppConfig()&&!l;if(d||c||m||v||!g)return!1;let D=s;if((s.id.includes("output_point")||s.id.includes("output_line"))&&(D=s.getOriginDataSources()[0]),!(0,$.isDefined)(D))return!1;const p=U(),h=null===(n=null==p?void 0:p.widgets)||void 0===n?void 0:n[this.widgetId];let S,y;if(h.config.lrsLayers.forEach((e=>{(0,$.isDefined)(D)&&e.id===D.id&&(S=e.networkInfo)})),!S)return!1;if(!(0,$.isDefined)(S.eventLayers)||0===S.eventLayers.length)return!1;const N=S.eventLayers;if(h.config.lrsLayers.forEach((e=>{N.forEach((t=>{String(e.originName)===t&&(y=e.eventInfo)}))})),!y)return!1;const b=Object.keys(a).find((e=>e===S.routeIdFieldSchema.name)),O=Object.keys(a).find((e=>e===S.fromDateFieldSchema.name)),M=Object.keys(a).find((e=>e===S.toDateFieldSchema.name)),I=Object.keys(a).find((e=>{var t;return e===(null===(t=S.lineIdFieldSchema)||void 0===t?void 0:t.name)}));if(!(0,$.isDefined)(b))return!1;if(r.records.length>2)return!1;let R=null,j=!1;if(yield(0,Q.loadArcGISJSAPIModules)(["esri/geometry/Polyline"]).then((e=>{[R]=e})).then((()=>{const e=i.getGeometry();0===new R(e).paths.length&&(j=!0)})),j)return!1;let P=!1;if(s.id.includes("output_line")&&(P=!0),P&&1!==r.records.length)return!1;if(!s||s.getStatus()===Q.DataSourceStatus.NotReady)return!1;if(!P&&2===r.records.length&&!(0,$.isDefined)(I))return!1;if(!P&&2===r.records.length){const e=r.records[0],t=r.records[1],n=e.getData(),i=t.getData(),o=JSON.parse(JSON.stringify(n)),a=JSON.parse(JSON.stringify(i));if(String(o[I])!==String(a[I]))return!1;if(String(o[b])===String(a[b])&&Number(o[O])!==Number(a[O])&&Number(o[M])!==Number(a[M]))return!1}return!0}))}onExecute(e,t){return B(this,void 0,void 0,(function*(){var t;const n=e[0],{records:r,dataSource:i}=n,o=U(),a=null===(t=null==o?void 0:o.widgets)||void 0===t?void 0:t[this.widgetId],s=a.config.hideMeasures;let u,l=i;if((i.id.includes("output_point")||i.id.includes("output_line"))&&(l=i.getOriginDataSources()[0]),!(0,$.isDefined)(l))return!1;a.config.lrsLayers.forEach((e=>{(0,$.isDefined)(l)&&e.id===l.id&&(u=e.networkInfo)}));const d=r[0],c=d.getData();let f=JSON.parse(JSON.stringify(c));const g=Object.keys(f).find((e=>{var t;return e===(null===(t=u.lineOrderFieldSchema)||void 0===t?void 0:t.name)}));let m=null,v=!1;n.records.length>1&&(m=r[1],v=!0);let D=null;if((0,$.isDefined)(m)){const e=m.getData();D=JSON.parse(JSON.stringify(e));const t=f[g],n=D[g];if((0,$.isDefined)(t)&&(0,$.isDefined)(n)&&Number(t)>Number(n)){const e=f;f=D,D=e}}const p={routeId:"",routeName:"",fromMeasure:NaN,toMeasure:NaN,fromDate:void 0,toDate:void 0,selectedMeasure:NaN,selectedFromDate:void 0,selectedToDate:void 0},h=Object.keys(f).find((e=>e===u.routeIdFieldSchema.name)),S=Object.keys(f).find((e=>{var t;return e===(null===(t=u.routeNameFieldSchema)||void 0===t?void 0:t.name)})),y=Object.keys(f).find((e=>e===u.fromDateFieldSchema.name)),N=Object.keys(f).find((e=>e===u.toDateFieldSchema.name)),b=Object.keys(f).find((e=>{var t;return e===(null===(t=u.lineIdFieldSchema)||void 0===t?void 0:t.name)})),O=Object.keys(f).find((e=>{var t;return e===(null===(t=u.lineNameFieldSchema)||void 0===t?void 0:t.name)})),M=(0,$.isDefined)(f[y])?(0,$.getDateWithTZOffset)(f[y],l):null,I=(0,$.isDefined)(D)&&(0,$.isDefined)(D[y])?(0,$.getDateWithTZOffset)(D[y],l):null,R=(0,$.isDefined)(f[N])?(0,$.getDateWithTZOffset)(f[N],l):null,j=(0,$.isDefined)(D)&&(0,$.isDefined)(D[N])?(0,$.getDateWithTZOffset)(D[N],l):null;p.fromDate=M,p.toRouteFromDate=v?I:M,p.selectedFromDate=M,p.toDate=R,p.toRouteToDate=v?j:R,p.selectedToDate=R,p.routeId=(0,$.isDefined)(f[h])?String(f[h]):null,p.toRouteId=v?(0,$.isDefined)(D[h])?String(D[h]):null:(0,$.isDefined)(f[h])?String(f[h]):null,p.routeName=(0,$.isDefined)(f[S])?String(f[S]):null,p.toRouteName=v?(0,$.isDefined)(D[S])?String(D[S]):null:(0,$.isDefined)(f[S])?String(f[S]):null,p.lineId=(0,$.isDefined)(f[b])?String(f[b]):null,p.toLineId=(0,$.isDefined)(f[b])?String(f[b]):null,p.routeLineOrder=(0,$.isDefined)(f[g])?Number(f[g]):null,p.toRouteLineOrder=v?(0,$.isDefined)(D[g])?Number(D[g]):null:(0,$.isDefined)(f[g])?Number(f[g]):null,p.lineName=(0,$.isDefined)(f[O])?String(f[O]):null,p.toLineName=(0,$.isDefined)(f[O])?String(f[O]):null;const P=Object.fromEntries(Object.entries(f).map((([e,t])=>[e.toLowerCase(),t])));if(p.fromMeasure=(0,$.isDefined)(P.measure)?Number(P.measure):NaN,p.toRouteFromMeasure=(0,$.isDefined)(P.measure)?Number(P.measure):NaN,p.selectedMeasure=(0,$.isDefined)(P.measure)?Number(P.measure):NaN,p.toMeasure=(0,$.isDefined)(P.tomeasure)?Number(P.tomeasure):NaN,p.toRouteToMeasure=(0,$.isDefined)(P.tomeasure)?Number(P.tomeasure):NaN,p.selectedToMeasure=(0,$.isDefined)(P.tomeasure)?Number(P.tomeasure):NaN,p.validRoute=!0,p.validToRoute=!0,!s&&(0,$.isDefined)(f.Measure)){let e=null;yield(0,Q.loadArcGISJSAPIModules)(["esri/geometry/Polyline"]).then((t=>{[e]=t})).then((()=>{const t=d.getGeometry(),n=new e(t);if(n.paths.length>0){const e=n.getPoint(0,0),t=n.paths[n.paths.length-1].length-1,r=n.getPoint(n.paths.length-1,t);p.selectedPoint=e,p.selectedToPoint=r}}))}let T=null,F=null;if((0,$.isDefined)(u)){const e=u.useRouteName?p.routeName:p.routeId;if(yield(0,$.queryRouteIdOrName)(e.trim(),u,l,!1,!0,"",p.fromDate).then((e=>B(this,void 0,void 0,(function*(){if((0,$.isDefined)(e)&&(yield Promise.all(e.features.map((e=>B(this,void 0,void 0,(function*(){T=e.geometry}))))),(0,$.isDefined)(T))){const e=(0,$.getRouteFromEndMeasures)(T);if((0,$.isDefined)(e)){const t=yield(0,$.QueryRouteMeasures)(l,u,e,p.fromDate,p.routeId),n=Math.min(...t),r=Math.max(...t);p.fromMeasure=q(n,u.measurePrecision),p.toRouteFromMeasure=q(n,u.measurePrecision),p.toMeasure=q(r,u.measurePrecision),p.toRouteToMeasure=p.toMeasure}if(s&&T.paths.length>0){const e=T.getPoint(0,0),t=T.paths[T.paths.length-1].length-1,n=T.getPoint(T.paths.length-1,t);p.selectedPoint=e,p.selectedToPoint=n,p.selectedMeasure=p.fromMeasure,p.selectedToMeasure=p.toRouteToMeasure}}})))),v){const e=u.useRouteName?p.toRouteName:p.toRouteId;yield(0,$.queryRouteIdOrName)(e.trim(),u,l,!1,!0,"",p.toRouteFromDate).then((e=>B(this,void 0,void 0,(function*(){if((0,$.isDefined)(e)&&(yield Promise.all(e.features.map((e=>B(this,void 0,void 0,(function*(){F=e.geometry}))))),(0,$.isDefined)(F))){const e=(0,$.getRouteFromEndMeasures)(F);if((0,$.isDefined)(e)){const t=yield(0,$.QueryRouteMeasures)(l,u,e,p.toRouteFromDate,p.toRouteId),n=Math.min(...t),r=Math.max(...t);p.toRouteFromMeasure=q(n,u.measurePrecision),p.toRouteToMeasure=q(r,u.measurePrecision)}if(s&&F.paths.length>0){const e=F.paths[F.paths.length-1].length-1,t=F.getPoint(F.paths.length-1,e);p.selectedToPoint=t,p.selectedToMeasure=p.toRouteToMeasure}}}))))}}return p.selectedPolyline=(0,$.isDefined)(T)?T:null,p.selectedToPolyline=(0,$.isDefined)(T)?T:null,v&&(p.selectedToPolyline=(0,$.isDefined)(F)?F:null),Q.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedNetworkDataSource",l),Q.MutableStoreManager.getInstance().updateStateValue(this.widgetId,"selectedRouteInfo",p),!0}))}}function U(){var e,t,n;return window.jimuConfig.isBuilder?null===(t=null===(e=(0,Q.getAppStore)().getState())||void 0===e?void 0:e.appStateInBuilder)||void 0===t?void 0:t.appConfig:null===(n=(0,Q.getAppStore)().getState())||void 0===n?void 0:n.appConfig}return o})())}}}));