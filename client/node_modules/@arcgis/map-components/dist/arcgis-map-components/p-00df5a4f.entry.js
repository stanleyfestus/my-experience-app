/*!
 * All material copyright Esri, All Rights Reserved, unless otherwise specified.
 * See https://js.arcgis.com/4.31/esri/copyright.txt for details.
 * v4.31.0-next.58
 */
import{r as e,c as i,h as s,F as t,g as o}from"./p-8305d662.js";import{l as r}from"./p-c956d5f4.js";import{h as n,al as a}from"./p-3c121fb0.js";import{u as c,m as l}from"./p-79d1b680.js";import{u as h}from"./p-5bfa67be.js";import"./p-cf4815f5.js";const d=l(a),g=class{constructor(s){e(this,s),this.arcgisReady=i(this,"arcgisReady",7),this.arcgisVersioningStateChanged=i(this,"arcgisVersioningStateChanged",7),this.manager=h(this),this.reactiveUtils=r(n),this.viewModel=d(this),this.messages=c({blocking:!0}),this.allowEditingDisabled=!1,this.autoDestroyDisabled=!1,this.closable=!1,this.icon=void 0,this.label=void 0,this.mode=void 0,this.pageSize=5,this.position="top-right",this.referenceElement=void 0,this.state=this.viewModel.state,this.versioningStates=this.viewModel.versioningStates,this.view=this.viewModel.view}async componentWillLoad(){const{watch:e}=this.reactiveUtils;this.manager.onLifecycle((()=>[e((()=>this.viewModel.state),(e=>{const{flowElement:i}=this,s=i?.getElementsByTagName("arcgis-version-management-version-properties")[0],t=i?.getElementsByTagName("arcgis-version-management-version-list")[0];if("disabled"===e)return s&&this._removeVersionPropertiesFlowItem(i),void(t&&this._removeVersionListFlowItem(i));t&&(t.versionListElementProps={...t.versionListElementProps,executionError:this.viewModel.executionError},t.versionListElementProps={...t.versionListElementProps,state:e}),s&&(s.versionPropertiesElementProps={...s.versionPropertiesElementProps,state:e})}))]))}async destroy(){await this.manager.destroy()}render(){const{allowEditingDisabled:e,closable:i,flowElement:o,label:r,messages:n,pageSize:a,viewModel:c,viewModel:{loadError:l,state:h}}=this,d=Array.from(c.serviceNameLookup,(([e,i])=>({url:e,name:i}))),g="disabled"!==h?s(t,null,d.map((t=>{const l={allowEditing:!e,closable:i,currentUser:c.userLookup.get(t.url),currentVersionIdentifier:c.versioningStateLookup.get(t.url).currentVersionInfo.versionIdentifier,executionError:void 0,flowElement:o,hasAdvEditingUte:c.advancedEditingUserTypeExtensionLookup.get(t.url),heading:r,isVersioningApiAvailable:(c.serverVersionLookup.get(t.url)??0)>=11.2,pageSize:a,serviceName:t.name,state:h,serviceUrl:t.url,strings:n,versionInfos:c.versioningStateLookup.get(t.url)?.versionInfos??[]};return s("arcgis-version-management-service-item",{serviceItemElementProps:l,onArcgisGetVersions:async e=>{await this._refreshVersionList(e.detail.serviceUrl)},onArcgisFlowItemBack:()=>{this._removeVersionListFlowItem(o)},onArcgisFlowItemClose:()=>{this._handleFlowItemClose()},onArcgisManageVersion:e=>{this._handleManageVersionAction(e,o)},onArcgisNewVersion:e=>{const i=this._createVersionPropertiesFlowItem(e.detail.serviceUrl,void 0);o?.appendChild(i)}})}))):void 0,m="disabled"===h?s("calcite-notice",{class:"notice",closable:!1,kind:"warning",open:!0,scale:"s",slot:"footer",width:"full"},s("div",{slot:"message"},this._getLoadError(l))):void 0;return s("calcite-flow",{ref:e=>{this.flowElement=e},class:"dialog"===this.mode?"":"calcite-flow-widget"},s("calcite-flow-item",{closable:this.closable,heading:r??void 0,onCalciteFlowItemClose:()=>{this._handleFlowItemClose()}},s("calcite-panel",{loading:"loading"===h||"executing"===h},g,m)))}_createVersionPropertiesFlowItem(e,i){const{closable:s,flowElement:t,viewModel:o,viewModel:{state:r}}=this,n=document.createElement("arcgis-version-management-version-properties");return n.versionPropertiesElementProps={closable:s,currentUser:o.userLookup.get(e),hasAdvEditingUte:o.advancedEditingUserTypeExtensionLookup.get(e),serviceUrl:e,state:r,strings:this.messages,versionInfo:i},n.addEventListener("arcgisCreateVersion",(i=>{const{createVersionParameters:s,switchToVersion:r}=i.detail;o.createVersion(s).then((async i=>{i&&this.arcgisVersioningStateChanged.emit({type:"version-created",versionIdentifier:i.versionIdentifier,versioningState:o.versioningStateLookup.get(e)}),r&&await this.viewModel.changeVersion(e,i.versionIdentifier.name,i.versionIdentifier.guid).then((s=>{s&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:i.versionIdentifier,versioningState:o.versioningStateLookup.get(e)})})),await this._refreshVersionList(e)})).finally((()=>{this._removeVersionPropertiesFlowItem(t)}))})),n.addEventListener("arcgisAlterVersion",(async i=>{const{flowElement:s}=this,{alterVersionParameters:t}=i.detail;await o.alterVersion(t).then((async i=>{i&&this.arcgisVersioningStateChanged.emit({type:"version-changed",versionIdentifier:t.versionIdentifier,versioningState:o.versioningStateLookup.get(e)}),await this._refreshVersionList(e)})).finally((()=>{this._removeVersionPropertiesFlowItem(s)}))})),n.addEventListener("arcgisFlowItemBack",(()=>{this._removeVersionPropertiesFlowItem(this.flowElement)})),n.addEventListener("calciteFlowItemBack",(e=>{e.preventDefault(),this._removeVersionPropertiesFlowItem(this.flowElement)})),n.addEventListener("calciteFlowItemClose",(()=>{this._handleFlowItemClose()})),n}_getLoadError(e){const{messages:i}=this;switch(e){case"no-feature-services":return i.loadErrors.noFeatureServices;case"no-view-property":return i.loadErrors.noViewProperty;default:return e}}_handleFlowItemClose(){const e=document.querySelector("arcgis-version-management"),i=e.parentElement;i?.removeChild(e)}async _handleManageVersionAction(e,i){const{actionType:s,serviceUrl:t,versionInfo:o}=e.detail,{viewModel:r}=this;switch(s){case"changeVersion":r.changeVersion(t,o.versionIdentifier.name,o.versionIdentifier.guid).then((e=>{e&&this.arcgisVersioningStateChanged.emit({type:"version-switched",versionIdentifier:o.versionIdentifier,versioningState:r.versioningStateLookup.get(t)});const s=i?.getElementsByTagName("arcgis-version-management-version-list")[0];s&&s&&(s.versionListElementProps={...s.versionListElementProps,currentVersionIdentifier:r.versioningStateLookup.get(t).currentVersionInfo.versionIdentifier})}));break;case"deleteVersion":r.deleteVersion(t,o.versionIdentifier.name,o.versionIdentifier.guid).then((async e=>{e&&this.arcgisVersioningStateChanged.emit({type:"version-deleted",versionIdentifier:o.versionIdentifier,versioningState:r.versioningStateLookup.get(t)}),await this._refreshVersionList(t)}));break;case"editVersion":{const e=this._createVersionPropertiesFlowItem(t,o);i.appendChild(e);break}}}async _refreshVersionList(e){const{flowElement:i,viewModel:s}=this;if(i){const t=await s.getVersionInfos(e),o=i.getElementsByTagName("arcgis-version-management-service-item");for(const i of o)i.serviceItemElementProps.serviceUrl===e&&(i.serviceItemElementProps={...i.serviceItemElementProps,versionInfos:t});const r=i.getElementsByTagName("arcgis-version-management-version-list")[0];r&&(r.versionListElementProps={...r.versionListElementProps,currentVersionIdentifier:s.versioningStateLookup.get(e).currentVersionInfo.versionIdentifier,versionInfos:t})}}_removeVersionListFlowItem(e){for(const i of e.childNodes)"ARCGIS-VERSION-MANAGEMENT-VERSION-LIST"===i.nodeName.toUpperCase()&&e.removeChild(i),"CALCITE-FLOW-ITEM"===i.nodeName.toUpperCase()&&(i.hidden=!1)}_removeVersionPropertiesFlowItem(e){for(const i of e.childNodes)"ARCGIS-VERSION-MANAGEMENT-VERSION-PROPERTIES"===i.nodeName.toUpperCase()&&e.removeChild(i),"ARCGIS-VERSION-MANAGEMENT-VERSION-LIST"===i.nodeName.toUpperCase()&&(i.getElementsByTagName("calcite-flow-item")[0].hidden=!1)}static get assetsDirs(){return["assets"]}get el(){return o(this)}};g.style=".calcite-flow-widget{width:350px}calcite-block{margin:0}calcite-pagination{justify-content:center}";export{g as arcgis_version_management}