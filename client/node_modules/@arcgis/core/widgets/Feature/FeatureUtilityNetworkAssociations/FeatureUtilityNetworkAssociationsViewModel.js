/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../Graphic.js";import o from"../../../core/Accessor.js";import{ClonableMixin as r}from"../../../core/Clonable.js";import s from"../../../core/Collection.js";import{IdentifiableMixin as a}from"../../../core/Identifiable.js";import{ignoreAbortErrors as n,debounce as i}from"../../../core/promiseUtils.js";import l from"../../../core/ReactiveMap.js";import{watch as u,initial as c}from"../../../core/reactiveUtils.js";import{property as d}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as y}from"../../../core/accessorSupport/decorators/subclass.js";import h from"../../../layers/FeatureLayer.js";import{AssociationOpenStatus as p,AssociationTypeDict as m}from"../../../networks/support/typeUtils.js";import g from"../../../rest/networks/support/Association.js";import b from"../../../rest/networks/support/NetworkElement.js";import I from"../../../rest/support/Query.js";import{featureUtilityNetworkFields as A}from"./resources.js";import{findUtilityNetwork as w}from"../support/featureUtils.js";const f=100;let _=class extends(r(a(o))){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._queryController=async t=>{this._cancelQuery();const e=new AbortController;this._queryAbortController=e,await n(this._query(t)),this._queryAbortController===e&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await n(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=i(this._queryController,f),this._queryFeatureCountDebounced=i(this._queryFeatureCountController,f)}initialize(){this.associationTypes?.forEach((t=>{t.open=!1})),this.addHandles([...this.associationTypes?.map((t=>u((()=>t.open),(()=>{t.open&&this._queryDebounced(t)}))))??[],u((()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery]),(()=>this._queryFeatureCountDebounced()),c)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&!!this.associationTypes&&"string"==typeof this.globalId}get canQuery(){const t=this.layer?.capabilities?.query;return!!this.associationTypes&&"string"==typeof this.globalId&&!!t?.supportsPagination}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){const{layer:t}=this;return"subtype-sublayer"===t?.type&&t?.parent?t.parent.globalIdField??null:t?.globalIdField??null}get state(){const{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:o,canQuery:r,_loaded:s,canLoad:a}=this;return e||a&&!s?"loading":t||o?"querying":r&&0!==this.featureCount?"ready":"disabled"}get utilityNetwork(){const{layer:t,map:e}=this;return t?.loaded&&e?"subtype-sublayer"===t?.type&&t?.parent?w(e,t.parent)??null:w(e,t)??null:null}get associationsLayer(){const{utilityNetwork:t}=this;return t?.loaded?new h({url:t.networkSystemLayers.associationsTableUrl,gdbVersion:t.gdbVersion}):null}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new s}get structureAssociations(){return this._get("structureAssociations")||new s}get contentAssociations(){return this._get("contentAssociations")||new s}get containerAssociations(){return this._get("containerAssociations")||new s}get connectivityAssociations(){return this._get("connectivityAssociations")||new s}get associationFeatures(){return this._get("associationFeatures")||new l}get associationViewModels(){return this._get("associationViewModels")||new Map}refresh(){this._queryFeatureCountDebounced()}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach((t=>t.destroyAll()))}_generateGlobalIdWhereClause(t,e){const{globalId:o,networkSourceIdsInUse:r}=this,{associatedNetworkSourceId:s}=t,a=e.fieldsIndex.get(A.fromGlobalId),n=e.fieldsIndex.get(A.toGlobalId),i=e.fieldsIndex.get(A.fromNetworkSourceId),l=e.fieldsIndex.get(A.toNetworkSourceId),u=null!=s,c=`(${Array.from(r.values())})`,d=u?` AND ${l.name} = ${s} AND ${l.name} IN ${c}`:"",y=u?` AND ${i.name} = ${s} AND ${i.name} IN ${c}`:"";switch(t.type){case"connectivity":return`((${a.name} = '${o}'${d}) OR (${n.name} = '${o}'${y}))`;case"attachment":case"content":return`${a.name} = '${o}'${d}`;case"container":case"structure":return`${n.name} = '${o}'${y}`;default:return""}}_generateNetworkSourceIdWhereClause(t){const{networkSourceIdsInUse:e}=this,o=`(${Array.from(e.values())})`,r=t.fieldsIndex.get(A.fromNetworkSourceId),s=t.fieldsIndex.get(A.toNetworkSourceId);return`(${r.name} IN ${o} AND ${s.name} IN ${o})`}_generateAssociationTypeWhereClause(t,e){const o=e.fieldsIndex.get(A.associationType);switch(t.type){case"attachment":case"structure":return`${o.name} = 3`;case"connectivity":return`${o.name} IN  (1, 4, 5, 6)`;case"container":case"content":return`${o.name} = 2`;default:return""}}_generateWhereClause(t,e){const o=e.fieldsIndex.get(A.status),r=`(${p.join(",")})`,s=`${o.name} IN ${r}`;return`(${this._generateGlobalIdWhereClause(t,e)} AND ${s} AND ${this._generateAssociationTypeWhereClause(t,e)})`}async _loadUtiltyNetworks(){const t=this.map;if(!t)return;await Promise.allSettled(t.utilityNetworks?.map((async t=>{await t.load()}))??[]);const e=t=>{if("layerId"in t&&o.isUtilityLayer(t)){const e=o.getSourceIdByLayerId(t.layerId);null!==e&&this.networkSourceIdsInUse.add(e)}},o=this.utilityNetwork;this._set("networkSourceIdsInUse",new Set),t.allLayers.forEach(e),t.allTables.forEach(e)}async _findLayersBySourceId(t){const{utilityNetwork:e,map:o}=this,r=t=>{const o=t;if(!t.url)return!1;if(o.layerId===s){return t.url.replace(/\/\d+$/,"")===e?.featureServiceUrl}return!1};await(e?.load());const s=e.getLayerIdBySourceId(t),a=o.allLayers.filter(r),n=o.allTables.filter(r),i=a.concat(n).toArray();return await Promise.allSettled(i.map((t=>t.load()))),i}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach((t=>t.removeAll())),this.associationFeatures.clear()}_getAssociationsByType(t){switch(t){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}_createAssociationFromFeature(t,e){if(!t)return null;const o=m.get(e.attributes[t.fieldsIndex.get(A.associationType).name]);return new g({globalId:e.attributes[t.fieldsIndex.get(A.globalId).name],fromNetworkElement:new b({globalId:e.attributes[t.fieldsIndex.get(A.fromGlobalId).name],networkSourceId:e.attributes[t.fieldsIndex.get(A.fromNetworkSourceId).name],terminalId:e.attributes[t.fieldsIndex.get(A.fromTerminalId).name]}),toNetworkElement:new b({globalId:e.attributes[t.fieldsIndex.get(A.toGlobalId).name],networkSourceId:e.attributes[t.fieldsIndex.get(A.toNetworkSourceId).name],terminalId:e.attributes[t.fieldsIndex.get(A.toTerminalId).name]}),associationType:o,status:e.attributes[t.fieldsIndex.get(A.status).name],isContentVisible:e.attributes[t.fieldsIndex.get(A.isContentVisible).name],percentAlong:e.attributes[t.fieldsIndex.get(A.percentAlong).name]})}async _queryLayer(t,e,o,r,s){const a=t.fieldsIndex.get(A.assetGroup),n=t.fieldsIndex.get(A.assetType),i=null!=o,l=null!=r,u="("+e.map((t=>`'${t}'`)).join(", ")+")",c=i?` AND ${a?.name} = ${o}`:"",d=i&&l?` AND ${n?.name} = ${r}`:"",y=`${t.globalIdField} IN ${u}`+c+d,h=new I({outFields:["*"],cacheHint:this.supportsCacheHint,where:y});return await this._queryAll(h,t,{signal:s?.signal})}async _createAssociationFeatureObjects(t,e,o,r,s,a){if(0===t.length)return[];const n=new Map;for(const[l,u]of e){const t=await this._findLayersBySourceId(l);for(const e of t){(await this._queryLayer(e,u,r,s,a)).forEach((t=>{if(t.getEffectivePopupTemplate()&&t.layer){const o=n.get(t.attributes[e.globalIdField])??[];o.push(t),n.set(t.attributes[e.globalIdField],o)}}))}}const i=[];return t.toArray().forEach((t=>{const e=t.fromNetworkElement.globalId===o?t.toNetworkElement:t.fromNetworkElement;(n.get(e.globalId)??[]).forEach((o=>{const r=this.utilityNetwork?.getTerminalById(e?.terminalId)?.name;i.push({association:t,feature:o,terminalName:r})}))})),i}_parseFeatureObjects(t,e){t.forEach((t=>{const o=t?.feature,r=o.layer,a=e.get(r)??new s;a.add(t),e.set(r,a)}))}async _queryAll(t,e,o){const r=[];let s=0,a=!1;t.num=e.sourceJSON?.maxRecordCount??2e3;do{t.start=s;const n=await e.queryFeatures(t,o);r.push(...n.features),a=n.exceededTransferLimit,a&&(s+=n.features.length)}while(a);return r}async _queryAssociatedFeatureCount(t){const{layer:e,globalId:o,supportsCacheHint:r,associationTypes:s,associationsLayer:a,utilityNetwork:n,canQuery:i}=this;if(await Promise.allSettled([e?.load(),n?.load(),a?.load()]),this._clearAssociations(),!(i&&e&&s&&a))return;const l=a.fieldsIndex.get(A.toGlobalId).name,u=a.fieldsIndex.get(A.fromGlobalId).name,c=s.map((t=>this._generateWhereClause(t,a))),d=this._generateNetworkSourceIdWhereClause(a),y=c.join(" OR "),h=new I({outFields:["*"],cacheHint:r,returnGeometry:!1,where:`(${y}) AND (${d})`}),p=await this._queryAll(h,a,{signal:t?.signal}),m=new Map;s.forEach((t=>{m.set(t.type,[])})),p.forEach((t=>{const e=a.fieldsIndex.get(A.associationType);switch(t.attributes[e.name]){case 1:case 4:case 5:case 6:t.attributes[u]===o?m.get("connectivity").push(t.attributes[l]):m.get("connectivity").push(t.attributes[u]),this.connectivityAssociations.add(this._createAssociationFromFeature(a,t));break;case 2:t.attributes[u]===o?(m.get("content").push(t.attributes[l]),this.contentAssociations.add(this._createAssociationFromFeature(a,t))):(m.get("container").push(t.attributes[u]),this.containerAssociations.add(this._createAssociationFromFeature(a,t)));break;case 3:t.attributes[u]===o?(m.get("attachment").push(t.attributes[l]),this.attachmentsAssociations.add(this._createAssociationFromFeature(a,t))):(m.get("structure").push(t.attributes[u]),this.structureAssociations.add(this._createAssociationFromFeature(a,t)))}}));const g=s.map((async e=>{const{associatedNetworkSourceId:o,associatedAssetGroup:r,associatedAssetType:s}=e,a=m.get(e.type),n=null!=r?await this._countAssociatedFeatures(o,a,r,s,t):a.length;switch(e.type){case"attachment":this._set("attachmentsFeatureCount",n);break;case"structure":this._set("structureFeatureCount",n);break;case"content":this._set("contentFeatureCount",n);break;case"container":this._set("containerFeatureCount",n);break;case"connectivity":this._set("connectivityFeatureCount",n)}}));await Promise.allSettled(g)}async _countAssociatedFeatureCount(t,e,o,r,s){const a=t.fieldsIndex.get(A.assetGroup),n=t.fieldsIndex.get(A.assetType),i=null!=r,l="("+e.map((t=>`'${t}'`)).join(", ")+")",u=` AND ${a?.name} = ${o}`,c=i?` AND ${n?.name} = ${r}`:"",d=`${t.globalIdField} IN ${l}`+u+c;return t.queryFeatureCount({where:d,outFields:["*"],returnGeometry:!1},{signal:s?.signal})}async _countAssociatedFeatures(t,e,o,r,s){if(0===e.length)return 0;const a=(await this._findLayersBySourceId(t)).map((async t=>this._countAssociatedFeatureCount(t,e,o,r,s)));return(await Promise.all(a)).reduce(((t,e)=>t+e),0)}async _queryAssociatedFeatures(t,e){const{layer:o,globalId:r,associationTypes:s,associationsLayer:a,utilityNetwork:n,canQuery:i,associationFeatures:l}=this;if(await Promise.allSettled([o?.load(),n?.load(),a?.load()]),!(i&&o&&s&&a))return;const u=this._getAssociationsByType(t.type),{associatedAssetGroup:c,associatedAssetType:d}=t,y=new Map;u.forEach((t=>{const{networkSourceId:e,elementGlobalId:o}=t.fromNetworkElement.globalId===r?{networkSourceId:t.toNetworkElement.networkSourceId,elementGlobalId:t.toNetworkElement.globalId}:{networkSourceId:t.fromNetworkElement.networkSourceId,elementGlobalId:t.fromNetworkElement.globalId},s=y.get(e)||[];s.push(o),y.set(e,s)}));const h=await this._createAssociationFeatureObjects(u,y,r,c,d,e);this._parseFeatureObjects(h,l)}async _queryFeatureCount(){await this._loadUtiltyNetworks();const{_queryFeatureCountAbortController:t,canQuery:e}=this;e?(await this._queryAssociatedFeatureCount(t),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(t){await this._loadUtiltyNetworks();const{_queryAbortController:e}=this;this.featureCount&&(this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.destroyed||await this._queryAssociatedFeatures(t,{signal:e?.signal}))}};t([d()],_.prototype,"_loaded",void 0),t([d()],_.prototype,"_queryAbortController",void 0),t([d()],_.prototype,"_queryPageAbortController",void 0),t([d()],_.prototype,"_queryFeatureCountAbortController",void 0),t([d({readOnly:!0})],_.prototype,"supportsCacheHint",null),t([d({readOnly:!0})],_.prototype,"canLoad",null),t([d({readOnly:!0})],_.prototype,"canQuery",null),t([d()],_.prototype,"networkSourceIdsInUse",void 0),t([d()],_.prototype,"description",void 0),t([d({type:e})],_.prototype,"graphic",void 0),t([d()],_.prototype,"layer",void 0),t([d()],_.prototype,"map",void 0),t([d({readOnly:!0})],_.prototype,"objectId",null),t([d({readOnly:!0})],_.prototype,"objectIdField",null),t([d({readOnly:!0})],_.prototype,"globalId",null),t([d({readOnly:!0})],_.prototype,"globalIdField",null),t([d()],_.prototype,"featureCount",void 0),t([d()],_.prototype,"associationTypes",void 0),t([d()],_.prototype,"showAllEnabled",void 0),t([d()],_.prototype,"state",null),t([d()],_.prototype,"title",void 0),t([d({readOnly:!0})],_.prototype,"utilityNetwork",null),t([d({readOnly:!0})],_.prototype,"associationsLayer",null),t([d({readOnly:!0})],_.prototype,"attachmentsFeatureCount",void 0),t([d({readOnly:!0})],_.prototype,"structureFeatureCount",void 0),t([d({readOnly:!0})],_.prototype,"attachmentsAssociations",null),t([d({readOnly:!0})],_.prototype,"structureAssociations",null),t([d({readOnly:!0})],_.prototype,"contentFeatureCount",void 0),t([d({readOnly:!0})],_.prototype,"containerFeatureCount",void 0),t([d({readOnly:!0})],_.prototype,"contentAssociations",null),t([d({readOnly:!0})],_.prototype,"containerAssociations",null),t([d({readOnly:!0})],_.prototype,"connectivityFeatureCount",void 0),t([d({readOnly:!0})],_.prototype,"connectivityAssociations",null),t([d({readOnly:!0})],_.prototype,"associationFeatures",null),t([d({readOnly:!0})],_.prototype,"associationViewModels",null),_=t([y("esri.widgets.Feature.FeatureUtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],_);const F=_;export{F as default};
