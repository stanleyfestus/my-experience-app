/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../Graphic.js";import{addMany as t}from"../../core/arrayUtils.js";import{createTask as r}from"../../core/asyncUtils.js";import"../../core/has.js";import{makeHandle as i,handlesGroup as a,abortHandle as n}from"../../core/handleUtils.js";import{clone as s}from"../../core/lang.js";import{whenOrAbort as l,throwIfAborted as o,debounce as c}from"../../core/promiseUtils.js";import{watch as u,whenOnce as p}from"../../core/reactiveUtils.js";import{px2pt as y}from"../../core/screenUtils.js";import{diff as f}from"../../core/accessorSupport/diffUtils.js";import{featureHasFields as d,fixFields as m,getDisplayFieldName as g}from"../../layers/support/fieldUtils.js";import{calculateTolerance as b}from"../../renderers/support/clickToleranceUtils.js";import{meterIn as h}from"../../renderers/support/lengthUtils.js";import{getTransformationType as w,TransformationType as v}from"../../renderers/visualVariables/support/sizeVariableUtils.js";import{getRotationAngle as S,getSize as I}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{to3D as j}from"../../symbols/support/symbolConversion.js";import{getDisplayedSymbol as U}from"../../symbols/support/symbolUtils.js";import{GraphicState as V}from"../../views/3d/layers/graphics/GraphicState.js";import{createQueryGeometry as T}from"../../views/support/drapedUtils.js";import{hitTestSelectSimilarDistance as z,filterGraphicHits as F}from"../../views/support/hitTestSelectUtils.js";import{getAllTemplatesForLayer as L}from"../support/templateUtils.js";function x(e){return"update"===e.type}function k(e){const t=e.sourceLayer;if(!t||"feature"!==t.type||!R(t.renderer))return{rotation:null,size:null};let r=null,i=null;const a=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&null!=S(t,e)));1===a.length&&(r=A(a[0],t));const n=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&w(t)===v.RealWorldSize&&null!=I(t,e)));return 1===n.length&&(i=C(n[0],t)),{rotation:r,size:i}}function A(e,t){const r="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,a=t.fields&&t.fields.filter((e=>e.name===i)),n=a&&1===a.length?a[0].type:"double",s={initial:0,current:0};return{field:i,fieldType:n,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-r*e,M((s.current+360)%360,n)),setInitialValue:e=>{s.initial=e,s.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}function E(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}async function P(e,t,r){if(null==t)return 0;const{symbol:i}=j(t);if(null==i||"web-style"===i.type||"cim"===i.type)return 0;const a=i.symbolLayers.at(0);if(!a)return 0;switch(a.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("../../symbols/support/symbolLayerUtils.js");return a.size||Math.min(ae.icon,(await e(a,ae.icon))[0])||ae.icon}case"text":return a.size||ae.text;case"line":return a.size||ae.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("../../symbols/support/symbolLayerUtils.js");return E(await t(a,e.scale/ae.viewScaleSizeFactor),r)}case"path":return(null!=a.width?a.width:a.height)||e.scale/ae.viewScaleSizeFactor;case"extrude":return a.size||e.scale/ae.viewScaleSizeFactor;default:return 0}}function C(e,t){const r=e.field,i=e.axis,a=t.fields&&t.fields.filter((e=>e.name===r)),n=a&&1===a.length?a[0].type:"double",s={initial:0,current:0},l=h[e.valueUnit]??1;let o;return o="area"===e.valueRepresentation?e=>(e*l/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*l/2:e=>e*l,{field:r,fieldType:n,getDefault:async(e,t)=>M(o(await P(t,e,i)),n),getValue:(e,t)=>(s.initial||(s.initial=t.pixelSizeAt(t.center)),s.current=s.initial*e,M(s.current,n)),setInitialValue:e=>{s.initial=e,s.current=0},isUpdatingInteractively:!1,displayUnit:le(e.valueUnit),axis:e.axis}}function M(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}function R(e){switch(e?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function O(e,t,r){const i=await U(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t,scale:r});null!=f(e.symbol,i)&&(e.symbol=i)}function G(e){if(!e)throw new Error("no geometry type");return"multipatch"===e?"mesh":e}async function D(e,t,r){const a=t.layer,n=Z(t);let s=null;const{view:l}=e,o="2d"===l?.type;if(await q(e,a,n,r,o?l.scale:null),o){const t=c((t=>q(e,a,n,r,t)));s=u((()=>l.scale),(e=>t(e)))}const{data:p,editing:y}=a.capabilities;return e.layer.elevationInfo=a.elevationInfo,null==t.geometryToPlace?await e.create(G(a.geometryType),{graphicProperties:{attributes:n,sourceLayer:a},hasZ:p.supportsZ,defaultZ:(o?y.zDefault:null)??e.defaultCreateOptions.defaultZ}):await e.place(t.geometryToPlace,{graphicProperties:{attributes:n,sourceLayer:a}}),s??i()}function Z(e){return{...e.template?.prototype.attributes,...e.attributeOverrides}}async function q(t,r,i,a,n){const s=new e({sourceLayer:r,attributes:i}),{rotation:l,size:o}=k(s);let c=await U(s,{useSourceLayer:!0,webStyleCache:a,scale:n}),u=!1;for(const e of[o,l]){if(null==e)continue;null==i[e.field]&&(i[e.field]=await e.getDefault(c,t.view),u=!0)}switch(u&&(c=await U(s,{useSourceLayer:!0,webStyleCache:a,scale:n})),c?.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=c;break;case"simple-line":case"line-3d":t.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":t.pointSymbol=c;break;case"mesh-3d":t.meshSymbol=c}Q(t.tooltipOptions,o,l)}function Q(e,t,r){e.visualVariables=null!=t||null!=r?{size:null!=t?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:null!=r?{valueType:r.fieldType,rotationType:r.rotationType??"geographic"}:null}:null}function B(e,t){return e?.find((e=>e.layer===t))}async function W(e,t,r,i){switch(t.type){case"3d":return H(e,t,r,i);case"2d":return J(e,t,r,i)}}async function H(e,r,i,a){if(0===e.length)return[];const{updatable:n,graphicsByLayer:s}=await i.async((async()=>{const{results:t}=await l(z(r,i),a),n=new Map,s=e=>{const t=e.layer,r=n.get(t);if(!r){const e=new Array;return n.set(t,e),e}return r};F(t).forEach((({graphic:e})=>s(e).push(e)));const o=e.filter((({capabilities:e,layer:t})=>e.update.enabled&&n.has(t)));return 0!==o.length&&i.stopPropagation(),{updatable:o,graphicsByLayer:n}}));return l(Promise.allSettled(n.map((async({layer:e})=>{const r=s.get(e),i=K(e);if(r.every((e=>d(i,e))))return r;const n=[];for(const a of r){n.push(a.getObjectId());const e=Object.keys(a.attributes);t(i,e)}const l=e.createQuery();return l.returnGeometry=!1,l.objectIds=n,l.outFields=m(e.fieldsIndex,i),e.queryFeatures(l,{signal:a}).then((({features:e})=>e))}))),a)}async function J(e,t,r,i){if(0===e.length)return[];const{mapPoint:a}=r;if(null==a)return[];let n=null;const s=await r.async((async()=>{const{results:a}=await l(t.hitTest(r),i);if(0===a.length)return[];const s=new Set;n=F(a),n.forEach((({graphic:e})=>e&&s.add(e.layer)));const o=e.filter((e=>s.has(e.layer)&&e.supportsUpdateWorkflow));return o.length>0&&r.stopPropagation(),o}));return l(Promise.allSettled(s.map((async({layer:e})=>{const s=e.createQuery();s.returnGeometry=!1,s.outFields=K(e);const l="renderer"in e?b({renderer:e.renderer,pointerType:r.pointerType}):0;s.geometry=T(a,l,t),s.outSpatialReference=t.spatialReference;const{features:o}=await e.queryFeatures(s,{signal:i});return n?.forEach((({graphic:t})=>{t.layer!==e||o.some((e=>e.getObjectId()===t.getObjectId()))||o.push(t)})),o}))),i)}function K(e){return m(e.fieldsIndex,[e.objectIdField,g({displayField:"displayField"in e?e.displayField:null,fields:e.fields})])}async function N(e,t,r){const{sourceLayer:i}=e,a=i.createQuery();a.objectIds=[e.getAttribute(i.objectIdField)],a.outFields=["*"],a.returnM=i.capabilities.data.supportsM,a.returnZ=i.capabilities.data.supportsZ,"scene"===i.type&&null!=i.infoFor3D||(a.outSpatialReference=t);const n=await i.queryFeatures(a,{signal:r});o(r);return n.features[0]}async function X(e){const{graphic:t,sketchViewModel:r,sourceLayer:i,visualVariables:a,webStyleCache:n}=e;let s=!1;const{rotation:l,size:o}=a;if([l,o].forEach((async e=>{if(null==e)return;const i=t.getAttribute(e.field);if(null!=i)e.setInitialValue(i);else{const i=await e.getDefault(t.symbol,r.view);e.setInitialValue(i),t.setAttribute(e.field,i),s=!0}})),s){const e="2d"===r.view?.type?r.view.scale:null;await O(t,n,e)}const c={multipleSelectionEnabled:!1};return"point"===i.geometryType&&(c.enableRotation=null!=l,c.enableScaling=null!=o),Q(r.tooltipOptions,o,l),r.layer.elevationInfo=i.elevationInfo,r.update(t,c)}function Y(e){return null==e||"rotate-start"!==e.type&&"rotate"!==e.type&&"rotate-stop"!==e.type?null:e}function $(e){return null==e||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}async function _(e,t,r,i,a){if(null==t.geometry||"point"!==t.geometry?.type)return;const n=i.rotation,s=Y(r.toolEventInfo);if(null!=n&&null!=s){const{field:r,getValue:i}=n;"rotate-stop"===s.type?(n.isUpdatingInteractively=!1,n.setInitialValue(t.getAttribute(r))):(n.isUpdatingInteractively=!0,t.setAttribute(r,i(s.angle,e)))}const l=i.size,o=$(r.toolEventInfo);if(null!=l&&null!=o){const{field:r,getValue:i}=l;"scale-stop"===o.type?(l.isUpdatingInteractively=!1,l.setInitialValue(t.getAttribute(r))):(l.isUpdatingInteractively=!0,t.setAttribute(r,i(o.xScale,e)))}await O(t,a,"2d"===e.type?e.scale:null)}async function ee({feature:e,featureClone:t,visualVariableAttributes:r,sketchViewModel:s,view:l,onUpdate:o,webStyleCache:y,addUpdatingPromise:f,addHandle:d}){await O(t,y,"2d"===l.type?l.scale:null);let m=null;if("2d"===s?.view?.type){const e=c((e=>O(t,y,e)));m=u((()=>s?.view?.scale),(t=>e(t)))}const g=t.sourceLayer,b=ue(l,g);await X({graphic:t,sketchViewModel:s,sourceLayer:g,visualVariables:r,webStyleCache:y});let h=null;b.then((e=>h=e)).catch((()=>{}));const w=r.size,v=r.rotation,S=u((()=>e.attributes),(async e=>{let r=!1;for(const i in e){const a=e[i];a!==t.getAttribute(i)&&(t.setAttribute(i,a),null==w||w.isUpdatingInteractively||w.field!==i||w.setInitialValue(a),null==v||v.isUpdatingInteractively||v.field!==i||v.setInitialValue(a),(null==h||h.requiredFields.includes(i))&&(r=!0))}r&&await O(t,y,"2d"===l.type?l.scale:null)})),I=s.on("update",(async e=>{const t=e.graphics[0],i={graphic:t,sketchViewModel:s,sourceLayer:g,visualVariables:r,webStyleCache:y};if("complete"===e.state){if(null===l.activeTool)return X(i);const e=new AbortController,t=n(e);return d(t),f(p((()=>null===l.activeTool),e.signal).then((()=>(e.abort(),X(i)))))}await _(l,t,e,r,y),o(ye(t),e)})),j=s.on(["undo","redo"],(async e=>{o(ye(e.graphics[0]),e)}));return a([j,I,i((()=>s.cancel())),S,m])}async function te(e,t,n){const s=e.view;e.layer.add(n);const l=t.sourceLayer,c=t.layer,u=t.getAttribute(c.objectIdField);let y=null;function f(e){y?.abort(),y=r((async t=>{const r=await ue(s,l);o(t),r.setVisibility?.(u,e)}))}return await ie(s,n),f(!1),a([re(s,n,(e=>f(!e))),i((async()=>{f(!0);try{const e=await ue(s,l);await p((()=>!e.updating))}finally{e.layer.remove(n)}}))])}function re(e,t,r){if("3d"===e.type){const i=new V({graphic:t});return a([e.trackGraphicState(i),u((()=>i.displaying),r)])}return u((()=>t.visible),r)}async function ie(e,t){if("3d"===e.type){const r=new V({graphic:t}),i=e.trackGraphicState(r);await p((()=>r.displaying||r.error)),i.remove()}else await p((()=>t.visible))}const ae={icon:y(24),text:y(12),line:y(1),viewScaleSizeFactor:100};function ne(e,t,r){let i=!1;return e.filter((e=>!!i||(i=e===t,i))).map((e=>r[e]()))}function se(e,t){e.viewModel.syncFeatureTemplates();const r=e.creationInfo;if("awaiting-feature-creation-info"===t[0].id&&r){const e=r.layer,i=L(e);1===i.length&&"scene"!==e.type&&(r.template=i[0],t.shift())}return t}function le(e){return"unknown"===e?null:e}function oe(e){e.filesEnabled=!0,e.mode="view",e.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}const ce=e=>/-stop/.test(e)||/vertex-/.test(e),ue=(e,t)=>{const r="subtype-sublayer"===t.type?t.parent:t;return e.whenLayerView(r)};function pe(e){return"createInteractiveEditSession"in e}function ye(e){const t=e.geometry;if("mesh"===t?.type){const r=e.cloneShallow();return r.attributes=s(e.attributes),r.geometry=t.cloneShallow(),r.geometry.transform=t.transform?.clone()??null,r}return e.clone()}function fe(e){const t=e.cursor;return e.cursor="progress",i((()=>e.cursor=t))}export{se as avoidFeatureTemplateSelectionWithOnlyOneItem,pe as canCreateInteractiveEditSession,ye as cloneGraphicExceptMesh,ne as createWorkflowSteps,W as fetchCandidates,N as fetchFullFeature,B as findLayerInfo,Z as getCreationAttributes,k as getVisualVariableAttributes,ce as isTerminalUpdateEventType,x as isUpdateWorkflow,oe as prepareAttachmentsForCreateFeaturesWorkflow,ee as setUpGeometryUpdate,fe as showProgressCursor,ae as sizeDefaults,le as sizeVariableUnitToLengthUnit,D as startCreatingNewFeature,X as startUpdatingFeature,te as swapForEditingSession,O as updateGraphicSymbolWhenRequired,_ as visualVariableInteractiveUpdate,ue as whenEditorLayerView,ie as whenGraphicDisplayed};
