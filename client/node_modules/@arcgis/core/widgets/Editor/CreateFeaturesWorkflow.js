/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import{remove as a}from"../../core/arrayUtils.js";import i from"../../core/Error.js";import{makeHandle as r,handlesGroup as s,abortHandle as n}from"../../core/handleUtils.js";import"../../core/has.js";import{removeMaybe as o,destroyMaybe as l}from"../../core/maybe.js";import{debounce as c}from"../../core/promiseUtils.js";import{watch as d,initial as h,whenOnce as u,syncAndInitial as p}from"../../core/reactiveUtils.js";import{generateBracedUUID as f}from"../../core/uuid.js";import{property as m}from"../../core/accessorSupport/decorators/property.js";import"../../core/Logger.js";import{subclass as g}from"../../core/accessorSupport/decorators/subclass.js";import w from"../../layers/GraphicsLayer.js";import{isTable as y}from"../../layers/support/layerUtils.js";import{getDrawHelpMessage as v}from"../../views/draw/support/helpMessageUtils.js";import{ViewEventPriorities as _}from"../../views/input/InputManager.js";import F from"../../views/interactive/sketch/SketchOptions.js";import M from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as b}from"./CreateFeaturesWorkflowData.js";import{isModelUpload as I,handleModelUpload as A}from"./modelUploadUtils.js";import k from"./Workflow.js";import{startCreatingNewFeature as V,findLayerInfo as C,updateGraphicSymbolWhenRequired as S,isTerminalUpdateEventType as H,getVisualVariableAttributes as j,startUpdatingFeature as U,createWorkflowSteps as O,avoidFeatureTemplateSelectionWithOnlyOneItem as E,prepareAttachmentsForCreateFeaturesWorkflow as D,showProgressCursor as T,visualVariableInteractiveUpdate as P}from"./workflowUtils.js";import G from"../FeatureForm/FeatureFormViewModel.js";import L from"../Sketch/SketchViewModel.js";var W;const x=Symbol(),N=Symbol(),z=Symbol(),R=Symbol();let Z=W=class extends k{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this.data=void 0,this.isNested=!1,this._getDrawMeshHelpMessage=void 0,this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._featureFormViewModel=new G,this._sketchViewModel=null,this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[],this._isActive=!0,this._updateGraphicDebounced=c(((e,t,a)=>S(e,t,a)))}initialize(){this.isNested&&(this._isActive=!1),this._initializeSketchViewModel()}destroy(){this._sketchViewModel.destroy()}get featureFormViewModel(){return this._featureFormViewModel}get hasPendingEdits(){if(this.pendingFeatures.some((e=>!!this.data.getEditsForPendingFeature(e)?.modified)))return!0;const{creationInfo:e,upload:t}=this.data,a=this._sketchViewModel,{activeComponent:i}=a,r=a.createGraphic?.geometry?.type;return!("polyline"!==r&&"polygon"!==r&&"multipoint"!==r||"draw-2d"!==i?.type&&"draw-3d"!==i?.type)&&i.drawOperation.committedVertices.length>0||(!(!t||"pending"!==t.state&&"success"!==t.state)||!!e?.geometryToPlace)}get helpMessage(){const{creationInfo:e,viewModel:t}=this.data;if("creating-features"!==this.stepId||!e)return;const a=e.layer.geometryType,i=this._sketchViewModel.createGraphic;if("mesh"===a){this._getDrawMeshHelpMessage||import("../../views/draw/support/helpMessageUtils3d.js").then((e=>{this._getDrawMeshHelpMessage=e.getDrawMeshHelpMessage}));const{view:e}=t;return"3d"===e?.type?this._getDrawMeshHelpMessage?.(i,e):void 0}return v(a,i?.geometry)}get layer(){return this.data.creationInfo?.layer}get numPendingFeatures(){return this.pendingFeatures.length}get parent(){return this.data.parent}get parentLayer(){return this.parent?.data.editorItem.layer}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){return this.data.editorItem?.capabilities.create.reliesOnOwnerAdminPrivileges??!1}get shouldShowAttachments(){return this.data.editorItem?.capabilities.create.attachments.enabled??!1}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get sketchViewModel(){return this._sketchViewModel}get test(){}async enter(){this._isActive=!0,"awaiting-feature-creation-info"!==this.stepId&&this._setUpCreatingFeaturesStep()}exit(){this._isActive=!1,this.removeHandles([z])}async updatePendingFeature(e,t){return this._preventDefaultActionOnCancel=!0,this._sketchViewModel.cancel(),a(this._lastActiveGraphics,e),this._startUpdating({feature:e,webStyleCache:t})}async start(){return await super.start(),y(this.data.creationInfo?.layer)?null:{enter:async()=>{},exit:async()=>{},viewModel:this._sketchViewModel}}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:a,isNested:i,creationInfo:r,parent:s,snappingManager:n,startAt:o,viewModel:l}=e,c=e.sketchOptions??new F,d=r?.layer,h=d?l.findEditorItemForLayer(d):void 0,u=new W({data:new b({creationInfo:r,editorItem:h,parent:s,sketchOptions:c,snappingManager:n,viewModel:l}),isNested:i,onCommit:async e=>{const{creationInfo:i}=e;if(!i)return;const r=e.pendingFeatures.toArray(),{layer:s}=i,n=s.capabilities?.editing.supportsGlobalId&&"globalIdField"in s,o=u._attachmentFileInfos;if(n){const e=B(r,s,o);return void await a(s,e,{globalIdUsed:!0})}const l=await a(s,{addFeatures:r});if(o.size>0){const e=l?.addFeatureResults??[];await t(s,K(r,e,s,o))}}});return u._set("steps",this._createWorkflowSteps(u,o)),u}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",r((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,r((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){o(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){this.removeHandles(N);const{creationInfo:t}=this.data;if(!t)return;this.createFeatureState="create-new";const a=await V(this._sketchViewModel,t,e);this.addHandles(a,N)}async _startUpdating({feature:e,webStyleCache:t,initialFeature:a=e}){const{data:i,pendingFeatures:r}=this;r.includes(e)||i.addPendingFeature(e,a);const{_featureFormViewModel:n,_sketchViewModel:l}=this,{creationInfo:c,viewModel:h}=i,{attachmentsViewModel:u,layerInfos:p,view:f}=h;if(!f||!c)return;const m=c.layer,g=C(p,m),w=g?.formTemplate,v=f.spatialReference;n.set({arcadeEditType:"INSERT",feature:e,formTemplate:w,spatialReference:v,map:f.map}),"add"!==u.mode&&"edit"!==u.mode||h.activeWorkflow?.previous(),u.graphic=e,u.fileInfos.removeAll(),u.mode="view";if((this._attachmentFileInfos.get(e)||[]).forEach((({file:e,form:t})=>u.addFile(e,t))),this._removeHighlight(e),await S(e,t,"2d"===f.type?f.scale:null),this.removeHandles(N),o(this._featureFormHandle),"2d"===f.type){const a=d((()=>f.scale),(a=>this._updateGraphicDebounced(e,t,a)));this.addHandles(a,N)}const _=i.getEditsForPendingFeature(e);return this._featureFormHandle=s([n.on("value-change",(async()=>{_?.updateAttributes(n.getValues()),await S(e,t,"2d"===f.type?f.scale:null)})),l.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&H(e.toolEventInfo.type))&&n.notifyFeatureGeometryChanged()})),d((()=>n.feature?.sourceLayer),(t=>e.sourceLayer=t))]),this.createFeatureState="update-pending",this._visualVariableAttributes=j(e),y(m)?void 0:U({graphic:e,sketchViewModel:l,sourceLayer:m,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:a}=e,i=O(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){const{creationInfo:t,viewModel:i}=a,{view:r}=i;r&&(I(t)?e.addHandles(await A({view:r,data:a,next:()=>e.next(),cancel:()=>i.cancelWorkflow({warnIfNoWorkflow:!1})}),this.id):(a.parent&&t&&(e.addHandles(i.lockFeatureTemplatesViewModel(),this.id),i.featureTemplatesViewModel.layers=[t.layer]),e.addHandles(i.featureTemplatesViewModel.on("select",(({item:t})=>{t&&(a.creationInfo={...a.creationInfo,layer:t.layer,template:t.template},e.next())})),this.id)))},async tearDown(){e.removeHandles([this.id,N])}}),"creating-features":()=>({id:"creating-features",async setUp(){e._isActive&&await e._setUpCreatingFeaturesStep()},async tearDown(t){const{viewModel:i}=a;t.canceled&&(e.removeHandles([z,x,N,R]),i.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear())}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}})});return E(a,i)}static _configureSketchViewModel(e,t){const{data:i}=e,{creationInfo:n,viewModel:o}=i,{view:l}=o,c=e._sketchViewModel;let d=null;const h=[];if(!l)return r();"2d"===l.type&&n&&h.push(e._fadeExistingFeatures(n.layer));const p=async a=>{if("cancel"===a.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(null==l.activeTool){if(e._lastActiveGraphics.length<1)return e._startCreating(t);const a=e._lastActiveGraphics.pop();return e._startUpdating({feature:a,webStyleCache:t})}return e._waitForActiveToolCleared().then((()=>e._startCreating(t)))}if("complete"===a.state&&a.graphic){const i=a.graphic.clone();return i.geometry=null,e._startUpdating({feature:a.graphic,webStyleCache:t,initialFeature:i})}},f=async a=>{const{attachmentsViewModel:i}=o,{_featureFormViewModel:r}=e,s=a.graphics[0];if("complete"===a.state){s!==d&&(e._lastActiveGraphics.push(s),e._highlight(s)),d=null;const{hasPendingSubtypeChoice:c,submittable:h}=r;if(e.numPendingFeatures===n?.maxFeatures||c||!h){!h&&r.submit();const a=e._lastActiveGraphics.pop();return null===o.view?.activeTool?e._startUpdating({feature:a,webStyleCache:t}):e._waitForActiveToolCleared().then((()=>e._startUpdating({feature:a,webStyleCache:t})))}if("add"!==i.mode&&"edit"!==i.mode||o.activeWorkflow?.previous(),a.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e.addHandles([T(l),l.on("click",(e=>e.preventDefault()))],x),await u((()=>!r.updating)),e.removeHandles(x),null!=o.view?.activeTool)return e._waitForActiveToolCleared().then((()=>{const a=e._lastActiveGraphics.pop();if(a)return e._startUpdating({feature:a,webStyleCache:t})}));e._startCreating(t)}"start"===a.state&&e._removeHighlight(s);const c=e._visualVariableAttributes;await P(l,s,a,c,t);const h=s.attributes,{rotation:p,size:f}=c;if(null!=p){const{field:e}=p;r.setValue(e,h[e])}if(null!=f){const{field:e}=f;r.setValue(e,h[e])}},m=t=>{const r=t.graphics[0];i.removePendingFeature(r),a(e._lastActiveGraphics,r),d=r},g=async a=>{if(I(n))return;const{results:i}=await l.hitTest(a,{include:c.layer}),r=i.find((e=>"graphic"===e.type&&e.graphic.sourceLayer===n?.layer));if(!r)return;const s=r.graphic;if("transform"===c.activeTool||"reshape"===c.activeTool){if(c.updateGraphics.at(0)===s)return;const{submittable:a,hasPendingSubtypeChoice:i}=e._featureFormViewModel;if(!a||i)return;await e.updatePendingFeature(s,t)}};h.push(c.on("create",(t=>e._updatingHandles.addPromise(p(t)))),c.on("update",(t=>e._updatingHandles.addPromise(f(t)))),c.on("delete",(e=>m(e))),l.on("immediate-click",(t=>e._updatingHandles.addPromise(g(t))),_.TOOL),r((()=>{e._preventDefaultActionOnCancel=!0,c.cancel()})),q(c,i));const w=s(h);return c.addHandles(w),w}_initializeSketchViewModel(){const{data:e}=this,{view:t}=e.viewModel,a=new w({elevationInfo:e.creationInfo?.layer.elevationInfo,internal:!0,listMode:"hide"}),i=new L({layer:a,sketchOptions:e.sketchOptions,snappingManager:e.snappingManager,updateOnGraphicClick:!1,view:t});this._sketchViewModel=i,t?.map.add(a),this.addHandles(r((()=>{t?.destroyed||t?.map.remove(a),a.destroy()})))}async _setUpCreatingFeaturesStep(){if(this.hasHandles(z))return;const{data:e}=this,{creationInfo:a,viewModel:n}=e,{attachmentsViewModel:l,view:c}=n;if(!c||!a?.layer)throw new i("missing-parameters","CreateFeaturesWorkflow requires a view and creationInfo.");this._preventDefaultActionOnCancel=!1;const{initialFeature:u,layer:p}=a,f=this._sketchViewModel,m=new Map,g=[];this._lastActiveGraphics=[],this._featureFormHandle=o(this._featureFormHandle),this._visualVariableAttributes={rotation:null,size:null},this.data.editorItem=n.findEditorItemForLayer(a.layer),D(l),g.push(d((()=>l.mode),(e=>{switch(e){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}})));const w=T(c);g.push(w);const v=y(a.layer);try{if(v){const e=u??new t({attributes:{...a.template?.prototype.attributes,...a.attributeOverrides},sourceLayer:p});await this._startUpdating({feature:e,webStyleCache:m})}else g.push(W._configureSketchViewModel(this,m)),u?(f.layer.add(u),await this._startUpdating({feature:u,webStyleCache:m})):await this._startCreating(m)}finally{w.remove()}const _=r((()=>{for(const t of e.pendingFeatures)f.layer.remove(t),e.removePendingFeature(t)})),F=d((()=>c?.timeZone),(e=>this._featureFormViewModel.timeZone=e),h),M=r((()=>{I(a)&&n.cancelWorkflow({warnIfNoWorkflow:!1})}));this._featureFormHandle&&g.push(this._featureFormHandle),this.addHandles(g,this._handleKeys.beforeCommit),this.addHandles([r((()=>l.fileInfos.removeAll())),s(g),M,_,F],z)}async _waitForActiveToolCleared(){const e=this.data.viewModel.view;if(null==e?.activeTool)return;const t=new AbortController;this.addHandles(n(t),R),await u((()=>null==e?.activeTool),t.signal),t.abort()}};function q(e,t){let a=null;const i=()=>e.snappingOptions.featureSources,n=()=>(a=new M({layer:e.layer}),i().add(a),a),o=()=>{null!=a&&(i().remove(a),a=l(a))};return s([d((()=>{const e=t.creationInfo?.layer,a=i().find((t=>t.layer===e));return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{if(!e)return o();a??=n(),a.enabled=t}),p),r(o)])}function K(e,t,a,i){const r=[];return t.forEach(((t,s)=>{if(!t.error){const n=e[s],o=i.get(n)||[];n.attributes[a.objectIdField]=t.objectId,o.forEach((({form:e})=>r.push({feature:n,attachment:e})))}})),r}function B(e,t,a){const i=[],r=t.globalIdField;return e.forEach(((t,s)=>{e[s].attributes[r]??=f(),(a?.get(t)||[]).forEach((({file:e})=>i.push({feature:t,attachment:{globalId:f(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}e([m()],Z.prototype,"createFeatureState",void 0),e([m()],Z.prototype,"data",void 0),e([m({constructOnly:!0})],Z.prototype,"isNested",void 0),e([m()],Z.prototype,"featureFormViewModel",null),e([m()],Z.prototype,"hasPendingEdits",null),e([m()],Z.prototype,"_getDrawMeshHelpMessage",void 0),e([m()],Z.prototype,"helpMessage",null),e([m()],Z.prototype,"layer",null),e([m()],Z.prototype,"parent",null),e([m()],Z.prototype,"parentLayer",null),e([m()],Z.prototype,"keyboardCancellationEnabled",null),e([m()],Z.prototype,"reliesOnOwnerAdminPrivileges",null),e([m()],Z.prototype,"shouldShowAttachments",null),e([m()],Z.prototype,"shouldAllowAttachmentEditing",null),e([m()],Z.prototype,"sketchViewModel",null),Z=W=e([g("esri.widgets.Editor.CreateFeaturesWorkflow")],Z);const J=Z;export{J as default};
