/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import a from"../../core/Error.js";import{makeHandle as o}from"../../core/handleUtils.js";import i from"../../core/Logger.js";import{abortMaybe as r}from"../../core/maybe.js";import{createResolver as n,onAbort as s,createAbortError as l,throwIfAborted as d,debounce as c}from"../../core/promiseUtils.js";import p from"../../core/Queue.js";import{whenOnce as u,when as w,watch as h,sync as f}from"../../core/reactiveUtils.js";import{last as m}from"../../core/SetUtils.js";import{property as g}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/RandomLCG.js";import{subclass as k}from"../../core/accessorSupport/decorators/subclass.js";import{isEditableLayer as v}from"../../layers/support/editableLayers.js";import{isSubtypeGroupLayer as y,isTable as W}from"../../layers/support/layerUtils.js";import b from"../../views/draw/support/HighlightHelper.js";import{ViewEventPriorities as _}from"../../views/input/InputManager.js";import M from"../../views/interactive/sketch/SketchOptions.js";import C from"./CreateFeaturesWorkflow.js";import{UpdateFeatureWorkflow as S}from"./UpdateFeatureWorkflow.js";import{UpdateRecordWorkflow as F}from"./UpdateRecordWorkflow.js";import A from"./UpdateWorkflowData.js";import j from"./Workflow.js";import{createWorkflowSteps as I,fetchCandidates as U}from"./workflowUtils.js";import{isGraphicForRelatableFeatureSupportedLayer as E}from"../Feature/support/featureUtils.js";import{getAllTemplatesForLayer as P}from"../support/templateUtils.js";var x;const R="esri.widgets.Editor.UpdateWorkflow",O=()=>i.getLogger(R);let V=x=class extends j{constructor(e){super(e),this._workflowStack=new p(m),this._sketchStack=new p(m),this.data=void 0,this.type="update"}get activeEditorItem(){return this.activeWorkflow?.data.editorItem??void 0}get activeFeatureFormViewModel(){return this.activeWorkflow?.featureFormViewModel}get activeSketchViewModel(){return this._sketchStack.peek()?.viewModel}get activeWorkflow(){return this._workflowStack.last()}get updating(){return this._updatingHandles.updating||!!this.activeWorkflow?.updating}get hasPreviousStep(){return this._stepIndex>0||this.nestedWorkflowCount>1||null!=this.activeWorkflow?.featureFormViewModel.relationshipId||"view"!==this.data.viewModel.attachmentsViewModel.mode}get hasUpdatableCandidates(){const{candidates:e,viewModel:t}=this.data;return e.some((({layer:e})=>t.findEditorItemForLayer(e)?.supportsUpdateWorkflow))}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditorItem?.capabilities.attachments.enabled}get shouldAllowAttachmentEditing(){return!!this.activeEditorItem?.capabilities.update.attachments.enabled}get hasPendingEdits(){return Array.from(this._workflowStack).some((e=>e.hasPendingEdits))}get helpMessage(){return this.activeWorkflow?.helpMessage?this.activeWorkflow.helpMessage:"awaiting-feature-to-update"===this.stepId?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditorItem?.hasInvalidFormTemplate}async back(e=()=>Promise.resolve(!0)){const{activeWorkflow:t}=this;if(null==t?.featureFormViewModel.relationshipId)if(t){if(t.hasPendingEdits){if(!await e())return}t.hasPreviousStep?await t.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else t.featureFormViewModel.relationshipId=null}async cancelActiveWorkflow(e){await(this.activeWorkflow?.cancel(e)),await this._popWorkflow()}async commit(){await this._drainWorkflowStack((e=>e.commit())),await super.commit()}static create(e){const{viewModel:t,snappingManager:a,startAt:o,addAttachmentsCallback:i,applyEditsCallback:r}=e,n=e.sketchOptions??new M,s=new x({data:new A({addAttachmentsCallback:i,applyEditsCallback:r,sketchOptions:n,snappingManager:a,viewModel:t}),onCommit:async()=>{}});return s._set("steps",this._createWorkflowSteps(s,o)),s}async save(){this.nestedWorkflowCount>1?(await(this.activeWorkflow?.commit()),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(e){try{const t=await this._createNestedCreateFeaturesWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new a("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:t})}}async startUpdating(e){try{const t=await this._createNestedUpdateWorkflow(e);await this._pushWorkflow(t)}catch(t){throw new a("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:t})}}async deleteActiveFeature(){const{activeWorkflow:e}=this;if(!e)throw new a("editor:nothing-to-delete","There is no feature to delete");T(e)?await e.deleteAndCommit():await e.cancel(),1===this.nestedWorkflowCount?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack((e=>e.cancel({force:!0})))}async _createNestedCreateFeaturesWorkflow(e){const{relatedLayer:t}=e,{addAttachmentsCallback:o,applyEditsCallback:i,sketchOptions:r,snappingManager:n,viewModel:s}=this.data;if(!v(t))throw new a("editor:unsupported-layer","Editing is not supported on the provided layer");const l=this._getCreationInfoForNestedCreateFeaturesWorkflow(e),d=l.template||l.initialFeature?"creating-features":"awaiting-feature-creation-info",c="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0;return C.create({addAttachmentsCallback:o,applyEditsCallback:i,creationInfo:l,isNested:!0,parent:c,sketchOptions:r,snappingManager:n,startAt:d,viewModel:s})}_getCreationInfoForNestedCreateFeaturesWorkflow(e){const{relatedLayer:o}=e;if(!v(o)||y(o))throw new a("editor:unsupported-layer","Editing is not supported on the provided layer");const i={layer:o,maxFeatures:1},r=this._makeRelatedRecordAttributes(e),n=P(o);return n?.length>0?(i.attributeOverrides=r,1===n.length&&(i.template=n[0])):i.initialFeature=new t({sourceLayer:o,attributes:r}),i}async _createNestedUpdateWorkflow(e){const t=W(e.sourceLayer)?F:S,{applyEditsCallback:a,sketchOptions:o,snappingManager:i,viewModel:r}=this.data,n="create-features"!==this.activeWorkflow?.type?this.activeWorkflow:void 0,s=await t.create({feature:e,parent:n,sketchOptions:o,snappingManager:i,viewModel:r,applyEdits:a,relatedRecordCallbacks:{addRelatedRecord:async e=>await this.startCreatingRelatedRecord(e),editRelatedRecord:async({relatedFeature:e})=>await this.startUpdating(e)}});return await u((()=>!s.updating)),s}async _drainWorkflowStack(e){const t=this._workflowStack,a=[];for(;t.length>0;){const o=t.pop();this._sketchStack.pop();const i=e(o).then((()=>o.destroy()));this._updatingHandles.addPromise(i),a.push(i)}await Promise.all(a)}_makeRelatedRecordAttributes(e){const{parentFeature:t,relatedLayer:a,relationshipId:o}=e;if(!E(t))return;const i=a.relationships?.find((e=>e.id===o));if(!i)return void L("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if("origin"===i.role)return void L("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const r=t.sourceLayer;i.relatedTableId!==r.layerId&&L("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const n=r.relationships?.find((e=>e.id===o));if(!n)return void L("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const s=H(r,n),l=t.getAttribute(s);l||L("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field.");const d=H(a,i);return{[d]:l}}async _popWorkflow(){this._workflowStack.pop()?.destroy(),this._sketchStack.pop();const e=await this._reconcileWorkflowStack();if(e.failureCount>0)throw new a("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",e)}async _pushWorkflow(e){const t=this._workflowRequiresSketchViewModel(e);this.activeWorkflow?.exit({removeSketchHandles:t});const o=this._sketchStack,i=await(e?.start()),r=o.peek();i?(r?.exit(),o.push(i)):o.push(this._cloneSketchController(r)),this._workflowStack.push(e);const n=await this._reconcileWorkflowStack();if(n.failureCount>0)throw new a("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",n)}async _reconcileWorkflowStack(){const e=this._workflowStack,t=this._sketchStack;try{const a=e.peek();return await(a?.enter()),await(t.peek()?.enter()),{activeWorkflow:a,failureCount:0}}catch(a){e.pop().destroy(),t.pop();const{activeWorkflow:o,failureCount:i}=await this._reconcileWorkflowStack();return{activeWorkflow:o,failureCount:i+1}}}_cloneSketchController(e){return{enter:e?.enter??(async()=>{}),exit:e?.exit??(async()=>{}),viewModel:e?.viewModel}}_workflowRequiresSketchViewModel(e){const{type:t}=e;return"update-feature"===t||"create-features"===t&&!W(e.data.creationInfo?.layer)}static _createWorkflowSteps(e,t="awaiting-feature-to-update"){const{data:i}=e;return I(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],t,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:t}=i.viewModel,a=i.viewModel.view;a.activeTool=null;let c=null;e.addHandles(o((()=>{c=r(c)})),this.id),i.rootFeature=null,i.candidates=[];const p=a.on("immediate-click",(async o=>{const r=n();e._updatingHandles.addPromise(r.promise);try{t.location=o.mapPoint,t.visible=!0,c?.abort();const{editorItems:r}=i.viewModel;c=new AbortController;const n=await o.async((()=>new Promise(((e,t)=>{s(c?.signal,(()=>t(l()))),e(U(r,a,o,c?.signal))}))));if(d(c),i.candidates=n.filter((e=>"fulfilled"===e.status)).flatMap((e=>e.value)).filter((e=>!e.isAggregate)),t.visible=1===i.candidates.length,0===i.candidates.length)return;o.stopPropagation(),1===i.candidates.length?(i.rootFeature=i.candidates[0],e.go("editing-existing-feature").catch((()=>{})).then((()=>t.visible=!1))):e.next()}finally{r.resolve()}}),_.TOOL),u=w((()=>null!=a.activeTool),(()=>e.cancel({force:!0})),{once:!0});a.focus(),e.addHandles([p,u],this.id)},async tearDown(){0===i.candidates.length&&(i.viewModel.spinnerViewModel.visible=!1),e.removeHandles(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){i.rootFeature=null;const{view:t}=i.viewModel;if(!t)return;const a=new b({view:t});e.addHandles([h((()=>i.rootFeature),((e,t)=>{a.remove(t),a.add(e)}),f),o((()=>a.removeAll()))],this.id)},async tearDown(){e.removeHandles(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:t,viewModel:o}=e.data;if(!t)throw new a("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await e.startUpdating(t),o.spinnerViewModel.visible=!1;const i=c((async()=>{await u((()=>!e.updating)),e.previous()}));e.addHandles([h((()=>e.nestedWorkflowCount),((e,t)=>{0===e&&0!==t&&i()}),f)],this.id)},async tearDown(){await e.cancelAll(),e.removeHandles(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){i.viewModel.attachmentsViewModel.mode="view"}})})}};function H(e,{keyField:t}){return e.getField(t)?.name??t}e([g()],V.prototype,"activeEditorItem",null),e([g()],V.prototype,"activeFeatureFormViewModel",null),e([g()],V.prototype,"activeSketchViewModel",null),e([g()],V.prototype,"activeWorkflow",null),e([g()],V.prototype,"updating",null),e([g()],V.prototype,"data",void 0),e([g()],V.prototype,"hasPreviousStep",null),e([g()],V.prototype,"hasUpdatableCandidates",null),e([g()],V.prototype,"nestedWorkflowCount",null),e([g()],V.prototype,"shouldShowAttachments",null),e([g()],V.prototype,"shouldAllowAttachmentEditing",null),e([g()],V.prototype,"hasPendingEdits",null),e([g()],V.prototype,"helpMessage",null),e([g()],V.prototype,"reliesOnOwnerAdminPrivileges",null),e([g()],V.prototype,"hasInvalidFormTemplate",null),V=x=e([k(R)],V);const L=(e,t)=>O().warn(`editor:${e}`,t,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),T=e=>!!e&&/update-/.test(e.type),D=V;export{D as default};
