/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Collection.js";import s from"../../core/ReactiveMap.js";import r from"../../core/ReactiveSet.js";import{generateUID as i}from"../../core/uid.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as p}from"../../core/support/UpdatingHandles.js";import{extractSubstitutionTemplatesFromString as l}from"../../layers/support/fieldUtils.js";import{prependExpressionPrefix as a,prependFieldPrefix as d,isExpressionReference as u,extractExpressionNameFromString as c,isLegacyFieldMapsExpressionReference as m}from"./featureFormUtils.js";import h from"./InputBase.js";import{compileTextElementMarkdownToHTML as f}from"./support/textManipulationUtils.js";import{renderingSanitizer as x}from"../support/widgetUtils.js";let _=class extends h{constructor(e){super(e),this.group=null,this.id=`TextElementInput-${i()}`,this.type="text",this._expressionReferences=new s,this._expressionsUsed=new r,this._fieldsUsed=new r,this._literalParts=new t,this._templateParts=new t,this._updatingHandles=new p}initialize(){const{rawText:e}=this;e?"markdown"===this.textFormat?this._updatingHandles.addPromise(f(e).then((e=>this._initializeTextParts(e)))):this._initializeTextParts(e):this._literalParts.push("")}get expressionsUsed(){return Array.from(this._expressionsUsed)}get fieldsIndex(){return this.layer.fieldsIndex}set fieldsIndex(e){this._overrideIfSome("fieldsIndex",e)}get fieldsUsed(){return Array.from(this._fieldsUsed)}get rawText(){return this.element.text}get text(){const e=this._templateParts.map((e=>`${this._expressionReferences.get(e)?.lastEvaluatedValue??""}`));return x.sanitize(y(this._literalParts,e))}get textFormat(){return this.element.textFormat}get updating(){return this._updatingHandles.updating||Array.from(this._expressionReferences.values()).some((e=>e?.updating))}setExpressionExecutor(e,t){this._expressionReferences.set(a(e),t)}setFieldExecutor(e,t){this._expressionReferences.set(d(e),t)}_initializeTextParts(e){const{fieldsIndex:t}=this,{literals:s,templates:r}=g(e),i=[],o=[];for(let n=0;n<r.length;n++){const e=s[n],p=l(r[n])[0];if(u(p))this._expressionsUsed.add(c(p)),this._expressionReferences.set(p,null),i.push(e),o.push(p);else if(m(p)){this._expressionsUsed.add(p);const t=a(p);this._expressionReferences.set(t,null),i.push(e),o.push(t)}else if(t?.has(p)){const s=t.normalizeFieldName(p);this._fieldsUsed.add(s);const r=d(s);this._expressionReferences.set(r,null),i.push(e),o.push(r)}else s[n+1]=e.concat(p,s[n+1])}i.push(s.at(-1)),this._literalParts.addMany(i),this._templateParts.addMany(o)}};function g(e){const t=/{[^{]+?}/g,s=[...e.matchAll(t)];let r=0;const i=[],o=[];for(const n of s){const t=n[0];i.push(e.slice(r,n.index)),o.push(t),r=n.index+t.length}return i.push(e.slice(r)),{literals:i,templates:o}}function y(e,t){return t.reduce(((t,s,r)=>t.concat(e.at(r),s)),"").concat(e.at(-1))}e([o()],_.prototype,"expressionsUsed",null),e([o()],_.prototype,"fieldsIndex",null),e([o()],_.prototype,"fieldsUsed",null),e([o()],_.prototype,"group",void 0),e([o()],_.prototype,"id",void 0),e([o()],_.prototype,"rawText",null),e([o()],_.prototype,"text",null),e([o()],_.prototype,"textFormat",null),e([o()],_.prototype,"type",void 0),e([o()],_.prototype,"updating",null),_=e([n("esri.widgets.FeatureForm.TextElementInput")],_);export{_ as TextElementInput,y as assembleStringFromParts,g as splitStringIntoParts};
