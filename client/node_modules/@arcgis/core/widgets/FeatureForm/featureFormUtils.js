/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import"../../intl.js";import{isSome as e}from"../../core/arrayUtils.js";import{neverReached as t}from"../../core/compilerUtils.js";import{equalsShallow as n}from"../../core/lang.js";import r from"../../core/Logger.js";import{templateHasKey as o,replace as i}from"../../core/string.js";import{isFieldElement as l}from"../../form/support/formUtils.js";import{DomainValidationError as s}from"../../layers/support/domainUtils.js";import{isTimeOnlyField as a,NumericRangeValidationError as u,TypeValidationError as m}from"../../layers/support/fieldUtils.js";import{getSubtypesFromLayer as p}from"../../layers/support/layerUtils.js";import{isAnyDateField as d}from"../../smartMapping/support/utils.js";import{getLabelForDateFieldValue as f,getIntlOptionsForField as c}from"../support/dateUtils.js";import{substitute as y}from"../../intl/substitute.js";const b=e=>"field"===e?.type,g=e=>"group"===e?.type,x=e=>"relationship"===e?.type,O=e=>"text"===e.type,T=e=>!g(e)&&null!=e.group,j=e=>e.reduce(((e,t)=>g(t)?[...e,...t.inputs]:[...e,t]),[]),v=e=>j(e).filter(b),F=e=>j(e).filter(x),N=e=>null!=e&&(h(e,"combo-box")||h(e,"radio-buttons")),h=(e,t)=>null!=e&&e.input?.type===t,V=e=>null!=e&&(h(e,"text-box")||h(e,"text-area")),E=({domain:e,inputType:t="text-box",dataType:n})=>"number"===n&&"text-box"===t&&(!e||"coded-value"!==e.type);function U(t){const{attributes:n,fieldsIndex:r,label:i,timeZone:l}=t;if(!n||"object"!=typeof n)return i;const s=Object.keys(n).filter((e=>o(i,e))),a=s.map((e=>n[e])),u=s.map((e=>r.get(e))).filter(e);return D(i,C({values:a,fields:u,timeZone:l}))}const _="expression/",L="expr/",I="field/";function R(e){const[t,n]=e.split(_);return""===t&&n?n:(r.getLogger("esri.widgets.FeatureForm/featureFormUtils").error("extractExpressionNameFromString:invalid-input",`The string ${e} is not a valid expression reference of the form '${_}/expressionName'`),"")}function $(e){return`${_}${e}`}function A(e){return`${I}${e}`}function Z(e){return e.startsWith(_)}function w(e){return e.startsWith(L)}function C(e){const{fields:t,values:n}=e,r=e.timeZone??void 0,o=t.map(((e,t)=>{let o=n[t];if(e.domain&&"coded-value"===e.domain.type){const t=e.domain.codedValues.find((e=>e.code===o));t?.name&&(o=t.name)}return(d(e)||a(e))&&(o=f(e,o,{timeZone:r,...c(e)})),[e.name,o]}));return Object.fromEntries(o)}function D(e,t){return i(i(e,(e=>`{${e.toLowerCase()}}`)),Object.fromEntries(Object.entries(t).map((([e,t])=>[e.toLowerCase(),t]))))}const G=e=>{const t={typeFieldName:null,types:[]};return e?("subtype-sublayer"===e.type?(t.typeFieldName=e.parent?.subtypeField,t.types=e.parent?.subtypes??[]):"subtype-group"===e.type||"feature"===e.type&&e.subtypes?.length?(t.typeFieldName=e.subtypeField,t.types=e.subtypes??[]):"types"in e&&e.types&&(t.typeFieldName=e.typeIdField,t.types=e.types.map((({id:e,name:t,domains:n})=>({code:e,name:t,domains:n})))),null!=t.typeFieldName&&(t.typeFieldName=e.getField(t.typeFieldName)?.name??t.typeFieldName),t):t};var S;!function(e){e.TOO_SHORT="length-validation-error::too-short",e.TOO_LONG="length-validation-error::too-long"}(S||(S={}));const M={type:"number"},H={type:"number",intlOptions:{notation:"scientific"}};function W(e){return e>=1e7||e<=-1e7}function k(e,{validationErrors:t}){return null!=e.max&&null!=e.min?t.outsideRange:null!=e.max?t.outsideRangeMax:t.outsideRangeMin}const q=(e,t,n)=>{const{dataType:r,error:o,minLength:i,value:l,required:a}=e,p=t?.validationErrors;if(!p||!o)return null;if(a&&null===l)return p.cannotBeNull;if(o===s.VALUE_OUT_OF_RANGE||o===u.OUT_OF_RANGE){const{field:o,range:i}=e,l={type:"date",intlOptions:{timeZone:"date"===o.type&&n?n:void 0,...c(o)}},s=k(i,t);return y(s,i,{format:{max:"date"===r?l:null!=i.max&&W(i.max)?H:M,min:"date"===r?l:null!=i.min&&W(i.min)?H:M}})}return o===s.INVALID_CODED_VALUE?p.invalidCodedValue:o===m.INVALID_TYPE?p.invalidType:o===S.TOO_SHORT?y(p.tooShort,{min:i}):(S.TOO_LONG,null)},B=e=>{if(!e)return;const t=e.layer,n=t&&"geometryType"in t?t.geometryType:void 0,r=e.geometry?.type;return"polyline"===r||"polyline"===n?"line":"mesh"===r||"mesh"===n||"multipatch"===n?"cube":"multipoint"===r||"multipoint"===n?"point":r||n||"table"},P=e=>{const t=[];if(e.formTemplate){const{description:n,title:r}=e.formTemplate;e.fields?.forEach((e=>{const i=r&&o(r,e.name),l=n&&o(n,e.name);(i||l)&&t.push(e.name)}))}return t};function Y(e,t){const n=t??("formTemplate"in e&&e.formTemplate);if(n){return(n.elements?.filter(l)??[]).some((({fieldName:t})=>!e.fieldsIndex.get(t)))}return!1}function z(e,t){return null==e||t.onValue!==e&&t.offValue!==e}function J(e,n){switch(n.objectType){case"any":return!0;case"null":return null==e;case"code":return e===n.codedValue?.code;case"range":return null!=e&&null!=n.minValue&&null!=n.maxValue&&+e>=n.minValue&&+e<=n.maxValue;default:return t(n.objectType),!1}}function K(e,t,r){const o=p(e),i=o?.find((e=>e.code===r));if(!i)return!1;const l=o?.find((e=>e.code===t));return!n(i.defaultValues,l?.defaultValues)&&Object.values(i.defaultValues).some((e=>null!=e))}export{S as LengthValidationError,R as extractExpressionNameFromString,v as flattenFieldInputs,j as flattenInputs,F as flattenRelationshipInputs,Y as formTemplateHasInvalidFields,C as getComputedAttributes,q as getErrorMessageForFieldInput,P as getFieldsInTitleAndDesc,B as getIconForFeature,G as getNormalizedFeatureTypeInfo,Z as isExpressionReference,h as isFieldElementWithInputType,N as isFieldElementWithShowNoValueOptionInput,V as isFieldElementWithTextInput,b as isFieldInput,g as isGroupInput,T as isInputInGroupInput,w as isLegacyFieldMapsExpressionReference,E as isNumberFieldInput,x as isRelationshipInput,O as isTextElementInput,U as parseFormTemplateString,$ as prependExpressionPrefix,A as prependFieldPrefix,D as substituteFieldTemplatesInString,K as subtypeChangeShouldPrompt,z as valueIsInvalidSwitchValue,J as valueIsValidContingentValue};
