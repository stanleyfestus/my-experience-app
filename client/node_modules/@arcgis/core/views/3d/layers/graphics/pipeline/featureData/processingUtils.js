/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{create as e}from"../../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{projectBuffer as t}from"../../../../../../geometry/projection/projectBuffer.js";import{projectVectorToVector as r}from"../../../../../../geometry/projection/projectVectorToVector.js";import{center as o}from"../../../../../../geometry/support/aaBoundingRect.js";import{FeatureDataItem as n}from"./interfaces.js";async function a(e,t){const{numFeatures:r,tile:o,partitionInfo:n}=e,{pages:a}=o;if(0===a.length||0===r)return new Uint32Array;const i=new Uint32Array(r);if(n){const e=a.reduce(((e,{featureCount:t})=>e+t),0),t=new Uint32Array(e);let o=0;for(const r of a)o=r.readAllObjectIds(t,o);const c=n.tileIndices;for(let n=0;n<r;++n){const e=t[c[n]];i[n]=e}}else{let e=0;for(const t of a)e=t.readAllObjectIds(i,e)}return i}async function i(e,t){const{numFeatures:r,tile:o,partitionInfo:n}=e,{pages:a}=o;if(0===a.length||0===r)return new Float64Array;const i=new Float64Array(3*r);if(n){const e=a.reduce(((e,{featureCount:t})=>e+t),0),t=new Float64Array(3*e);let o=0;for(const r of a)o=r.readAllCoordinates(t,o);const c=n.tileIndices;for(let n=0;n<r;++n){const e=c[n],r=t[3*e+0],o=t[3*e+1],a=t[3*e+2];i[3*n+0]=r,i[3*n+1]=o,i[3*n+2]=a}}else{let e=0;for(const t of a)e=t.readAllCoordinates(i,e)}return i}async function c(e,r){await e.provision([n.GEOMETRY_MAP_COORDINATES],r);const{numFeatures:o,tile:a,mapCoordinates:i}=e,{pages:c}=a;if(0===c.length||0===o)return new Float64Array;const s=r.viewSpatialReference,f=r.renderSpatialReference,l=new Float64Array(3*o);if(!t(i,s,0,l,f,0,o))throw new Error("Failed to project coordinates");return l}async function s(t,n){const a=n.viewSpatialReference,i=n.renderSpatialReference,c=t.tile.descriptor.extent,s=o(c),f=e();return r([s[0],s[1],0],a,f,i),f}export{i as getMapCoordinates,a as getObjectIds,c as getRenderCoordinates,s as getTileCenterRenderCoordinates};
