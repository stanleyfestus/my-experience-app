/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{i as e}from"../../../../chunks/vec32.js";import{create as t}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{create as i,empty as r,expandWithRect as o,center as s,set as n,toRect as d}from"../../../../geometry/support/aaBoundingBox.js";import{create as a}from"../../../../geometry/support/aaBoundingRect.js";import{demResolutionForBoundingBox as h}from"./graphicUtils.js";import{Object3DState as c}from"../../webgl-engine/lib/basicInterfaces.js";import{DirtyOperation as g,DirtyState as m}from"../../webgl-engine/lib/ModelDirtyTypes.js";class l{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this._drapeSourceRenderer=r,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,g.ADD);if(e||this._addedToStage){for(const e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,m.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,g.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(i=t()){return e(i,0,0,0)}getBoundingBoxObjectSpace(e=i()){return r(e)}addObjectState(e){e.stateType===c.Highlight&&(this.renderGeometries.forEach((t=>{const i=t.geometry.allocateIdAndHighlight(e.highlightGroupName);e.addRenderGeometry(t,i,this)})),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,m.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach((t=>e.removeByObject(t)))}removeRenderGeometryObjectState(e,t){t.channel===c.Highlight&&(e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries([e],m.HIGHLIGHT))}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.geometry.computeAttachmentOrigin(f)&&(e.draped.origin[0]+=f[0],e.draped.origin[1]+=f[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,n,d){r(d);for(let r=0;r<this.renderGeometries.length;r++){const t=this.renderGeometries[r];this._getRenderGeometryProjectedBoundingRect(t,e,u,i),o(d,u)}if(t){let e;s(d,f);const i=h(d,t.service.spatialReference,t);try{e=await t.service.queryElevation(f[0],f[1],n,i,"ground")}catch(a){}null!=e&&(d[2]=Math.min(d[2],e),d[5]=Math.max(d[5],e))}return d}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)n(p,this.boundingBox);else{const t=e.boundingSphere,i=t[3];p[0]=t[0]-i,p[1]=t[1]-i,p[2]=t[2]-i,p[3]=t[0]+i,p[4]=t[1]+i,p[5]=t[2]+i}return t(p,0,2),this.calculateRelativeScreenBounds&&r.push({location:s(p),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),d(p,i)}}const u=a(),p=i(),f=t();export{l as Graphics3DDrapedGraphicLayer};
