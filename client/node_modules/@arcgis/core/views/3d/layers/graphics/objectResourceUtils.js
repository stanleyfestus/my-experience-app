/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{adjustStaticAGOUrl as e}from"../../../../core/devEnvironmentUtils.js";import{hasScaling as t}from"../../../../core/mathUtils.js";import{normalFromMat4 as r,fromMat4 as o}from"../../../../core/libs/gl-matrix-2/math/mat3.js";import{create as s}from"../../../../core/libs/gl-matrix-2/factories/mat3f64.js";import{invert as i}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as n}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{ONES as a}from"../../../../core/libs/gl-matrix-2/factories/vec2f64.js";import{t as l,d as u,E as c,l as m,n as f,m as d}from"../../../../chunks/vec32.js";import{create as p}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{empty as g,expandWithVec3 as x}from"../../../../geometry/support/aaBoundingBox.js";import{newFloatArray as b}from"../../../../geometry/support/FloatArray.js";import{BufferViewVec4f as h,BufferViewVec4u8 as T,BufferViewVec4u16 as y,BufferViewVec3f as w,BufferViewVec3u8 as v,BufferViewVec3u16 as R}from"../../../../geometry/support/buffer/BufferView.js";import{t as j,b as B,n as M,f as S}from"../../../../chunks/vec3.js";import{t as F,b as A}from"../../../../chunks/vec4.js";import{a as E}from"../../../../chunks/vec2.js";import{c as O}from"../../../../chunks/vec33.js";import{a as C}from"../../../../chunks/vec43.js";import{DefaultLoadingContext as L}from"../../glTF/DefaultLoadingContext.js";import{convertPrimitiveToTriangles as I}from"../../glTF/internal/indexUtils.js";import{isEncodedMeshTexture as N}from"../../glTF/internal/resourceUtils.js";import{getTransformMatrix as k}from"../../glTF/internal/TextureTransformUtils.js";import{ProcessedObjectResource as P}from"./ProcessedObjectResource.js";import{load as U,processLoadResult as V}from"./wosrLoader.js";import{NormalType as _}from"../../webgl-engine/core/shaderLibrary/attributes/NormalAttribute.glsl.js";import{Attribute as D}from"../../webgl-engine/lib/Attribute.js";import{AlphaDiscardMode as G,DepthTestFunction as q,CullFaceOptions as W}from"../../webgl-engine/lib/basicInterfaces.js";import{Geometry as H}from"../../webgl-engine/lib/Geometry.js";import{Texture as $}from"../../webgl-engine/lib/Texture.js";import{VertexAttribute as z}from"../../webgl-engine/lib/VertexAttribute.js";import{DefaultMaterial as K}from"../../webgl-engine/materials/DefaultMaterial.js";import{colorGamma as Q}from"../../webgl-engine/materials/DefaultMaterial_COLOR_GAMMA.js";import{esriSymbologyMRRFactors as J,advancedMRRFactors as X,useSchematicPBR as Y,schematicMRRFactors as Z}from"../../webgl-engine/materials/pbrUtils.js";async function ee(t,r){const o=te(e(t));if("wosr"===o.fileType){const e=await(r.cache?r.cache.loadWOSR(o.url,r):U(o.url,r)),{engineResources:t,referenceBoundingBox:s}=V(e,r);return{lods:t,referenceBoundingBox:s,isEsriSymbolResource:!1,isWosr:!0}}let s;if(r.cache)s=await r.cache.loadGLTF(o.url,r,!!r.usePBR);else{const{loadGLTF:e}=await import("../../glTF/loader.js");s=await e(new L(r.streamDataRequester),o.url,r,r.usePBR)}const i=s.model.meta?.ESRI_proxyEllipsoid,n=s.meta.isEsriSymbolResource&&null!=i&&"EsriRealisticTreesStyle"===s.meta.ESRI_webstyle;n&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,ae(s,i));const a=!!r.usePBR,l=s.meta.isEsriSymbolResource?{usePBR:a,isSchematic:!1,treeRendering:n,mrrFactors:J}:{usePBR:a,isSchematic:!1,treeRendering:!1,mrrFactors:X},u={...r.materialParameters,treeRendering:n},{engineResources:c,referenceBoundingBox:m}=re(s,l,u,r,o.specifiedLodIndex);return{lods:c,referenceBoundingBox:m,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function te(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);if(t)return{fileType:"gltf",url:t[1],specifiedLodIndex:null!=t[4]?Number(t[4]):null};return e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function re(e,t,r,o,s){const i=e.model,n=new Array,a=new Map,l=new Map,u=i.lods.length,c=g();return i.lods.forEach(((e,m)=>{const f=!0===o.skipHighLods&&(u>1&&0===m||u>3&&1===m)||!1===o.skipHighLods&&null!=s&&m!==s;if(f&&0!==m)return;const d=new P(e.name,e.lodThreshold,[0,0,0]);e.parts.forEach((e=>{const s=f?new K({},o):oe(i,e,d,t,r,a,l,o),{geometry:n,vertexCount:u}=se(e,s??new K({},o)),p=n.boundingInfo;null!=p&&0===m&&(x(c,p.bbMin),x(c,p.bbMax)),null!=s&&(d.stageResources.geometries.push(n),d.numberOfVertices+=u)})),f||n.push(d)})),{engineResources:n,referenceBoundingBox:c}}function oe(e,t,r,o,s,i,n,l){const u=t.material+(t.attributes.normal?"_normal":"")+(t.attributes.color?"_color":"")+(t.attributes.texCoord0?"_texCoord0":"")+(t.attributes.tangent?"_tangent":""),c=e.materials.get(t.material),m=null!=t.attributes.texCoord0,f=null!=t.attributes.normal;if(null==c)return null;const d=ne(c.alphaMode);if(!i.has(u)){if(m){const t=(t,r=!1)=>{if(null!=t&&!n.has(t)){const o=e.textures.get(t);if(null!=o){const e=o.data;n.set(t,new $(N(e)?e.data:e,{...o.parameters,preMultiplyAlpha:!N(e)&&r,encoding:N(e)&&null!=e.encoding?e.encoding:void 0}))}}};t(c.textureColor,d!==G.Opaque),t(c.textureNormal),t(c.textureOcclusion),t(c.textureEmissive),t(c.textureMetallicRoughness)}const r=c.color[0]**(1/Q),p=c.color[1]**(1/Q),g=c.color[2]**(1/Q),x=c.emissiveFactor[0]**(1/Q),b=c.emissiveFactor[1]**(1/Q),h=c.emissiveFactor[2]**(1/Q),T=null!=c.textureColor&&m?n.get(c.textureColor):null,y=Y({normalTexture:c.textureNormal,metallicRoughnessTexture:c.textureMetallicRoughness,metallicFactor:c.metallicFactor,roughnessFactor:c.roughnessFactor,emissiveTexture:c.textureEmissive,emissiveFactor:c.emissiveFactor,occlusionTexture:c.textureOcclusion}),w=null!=c.normalTextureTransform?.scale?c.normalTextureTransform?.scale:a;i.set(u,new K({...o,transparent:d===G.Blend,customDepthTest:q.Lequal,textureAlphaMode:d,textureAlphaCutoff:c.alphaCutoff,diffuse:[r,p,g],ambient:[r,p,g],opacity:c.opacity,doubleSided:c.doubleSided,doubleSidedType:"winding-order",cullFace:c.doubleSided?W.None:W.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:f?_.Attribute:_.ScreenDerivative,castShadows:!0,receiveShadows:c.receiveShadows,receiveAmbientOcclusion:c.receiveAmbientOcclustion,textureId:null!=T?T.id:void 0,colorMixMode:c.colorMixMode,normalTextureId:null!=c.textureNormal&&m?n.get(c.textureNormal).id:void 0,textureAlphaPremultiplied:null!=T&&!!T.parameters.preMultiplyAlpha,occlusionTextureId:null!=c.textureOcclusion&&m?n.get(c.textureOcclusion).id:void 0,emissiveTextureId:null!=c.textureEmissive&&m?n.get(c.textureEmissive).id:void 0,metallicRoughnessTextureId:null!=c.textureMetallicRoughness&&m?n.get(c.textureMetallicRoughness).id:void 0,emissiveFactor:[x,b,h],mrrFactors:y?Z:[c.metallicFactor,c.roughnessFactor,o.mrrFactors[2]],isSchematic:y,colorTextureTransformMatrix:k(c.colorTextureTransform),normalTextureTransformMatrix:k(c.normalTextureTransform),scale:[w[0],w[1]],occlusionTextureTransformMatrix:k(c.occlusionTextureTransform),emissiveTextureTransformMatrix:k(c.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:k(c.metallicRoughnessTextureTransform),...s},l))}const p=i.get(u);if(r.stageResources.materials.push(p),m){const e=e=>{null!=e&&r.stageResources.textures.push(n.get(e))};e(c.textureColor),e(c.textureNormal),e(c.textureOcclusion),e(c.textureEmissive),e(c.textureMetallicRoughness)}return p}function se(e,s){const i=e.attributes.position.count,n=I(e.indices||i,e.primitiveType),a=b(3*i),{typedBuffer:l,typedBufferStride:u}=e.attributes.position;j(a,l,e.transform,3,u);const c=[[z.POSITION,new D(a,n,3,!0)]];if(null!=e.attributes.normal){const o=b(3*i),{typedBuffer:s,typedBufferStride:a}=e.attributes.normal;r(ie,e.transform),B(o,s,ie,3,a),t(ie)&&M(o,o),c.push([z.NORMAL,new D(o,n,3,!0)])}if(null!=e.attributes.tangent){const r=b(4*i),{typedBuffer:s,typedBufferStride:a}=e.attributes.tangent;o(ie,e.transform),F(r,s,ie,4,a),t(ie)&&M(r,r,4),c.push([z.TANGENT,new D(r,n,4,!0)])}if(null!=e.attributes.texCoord0){const t=b(2*i),{typedBuffer:r,typedBufferStride:o}=e.attributes.texCoord0;E(t,r,2,o),c.push([z.UV0,new D(t,n,2,!0)])}const m=e.attributes.color;if(null!=m){const t=new Uint8Array(4*i);4===m.elementCount?m instanceof h?A(t,m,255):m instanceof T?C(t,m):m instanceof y&&A(t,m,1/256):(t.fill(255),m instanceof w?S(t,m.typedBuffer,255,4,m.typedBufferStride):e.attributes.color instanceof v?O(t,m.typedBuffer,4,e.attributes.color.typedBufferStride):e.attributes.color instanceof R&&S(t,m.typedBuffer,1/256,4,m.typedBufferStride)),c.push([z.COLOR,new D(t,n,4,!0)])}return{geometry:new H(s,c),vertexCount:i}}const ie=s();function ne(e){switch(e){case"BLEND":return G.Blend;case"MASK":return G.Mask;case"OPAQUE":case null:case void 0:return G.Opaque}}function ae(e,t){for(let r=0;r<e.model.lods.length;++r){const o=e.model.lods[r];for(const s of o.parts){const o=s.attributes.normal;if(null==o)return;const a=s.attributes.position,g=a.count,x=p(),b=p(),h=p(),y=new Uint8Array(4*g),v=new Float64Array(3*g),R=i(n(),s.transform);let j=0,B=0;for(let i=0;i<g;i++){a.getVec(i,b),o.getVec(i,x),l(b,b,s.transform),u(h,b,t.center),c(h,h,t.radius);const n=h[2],p=m(h),g=Math.min(.45+.55*p*p,1);c(h,h,t.radius),null!==R&&l(h,h,R),f(h,h),r+1!==e.model.lods.length&&e.model.lods.length>1&&d(h,h,x,n>-1?.2:Math.min(-4*n-3.8,1)),v[j]=h[0],v[j+1]=h[1],v[j+2]=h[2],j+=3,y[B]=255*g,y[B+1]=255*g,y[B+2]=255*g,y[B+3]=255,B+=4}s.attributes.normal=new w(v),s.attributes.color=new T(y)}}}export{ee as fetch,te as parseUrl};
