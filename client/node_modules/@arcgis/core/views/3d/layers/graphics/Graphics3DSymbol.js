/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{isSome as t}from"../../../../core/arrayUtils.js";import{forEach as e}from"../../../../core/asyncUtils.js";import"../../../../core/has.js";import{onAbortOrThrow as r,throwIfAborted as s}from"../../../../core/promiseUtils.js";import{totalSymbolComplexities as a}from"./defaultSymbolComplexity.js";import{Graphics3DGraphic as o}from"./Graphics3DGraphic.js";import{Graphics3DObject3DGraphicLayer as i}from"./Graphics3DObject3DGraphicLayer.js";import{Graphics3DSymbolLayerCreationContext as n}from"./Graphics3DSymbolCreationContext.js";import{ApplyRendererDiffResult as l}from"./interfaces.js";import{Loadable as y,LoadStatus as h}from"./Loadable.js";class m extends y{set symbol(t){this._symbol=t,t.symbolLayers.forEach(((e,r)=>{const s=this.symbolLayers[r];null!=s&&(s.symbol=t,s.symbolLayer=e)}))}get symbol(){return this._symbol}constructor(t,e,r){super(e.schedule),this._symbol=t,this._context=e,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(t){let a=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(a=this._backgroundLayers.concat(a));const o=a.length;for(;this.symbolLayers.length<a.length;)this.symbolLayers.push(null);this.symbolLayers.length=a.length;const i=[],{make:n}=await import("./Graphics3DSymbolLayerFactory.js");for(let e=0;e<o;e++){const s=a.at(e);if(!1===s.enabled)continue;c.renderPriority=1-(1+e)/o,c.renderPriorityStep=1/o,c.ignoreDrivers=s.ignoreDrivers;const l=n(this.symbol,s,this._context,c),y=r(t,(()=>{this.symbolLayers[e]=null,l.destroy()}));y&&i.push(y),this.symbolLayers[e]=l}if(await e(this.symbolLayers,(async(t,e)=>{if(null!=t)try{await t.load(),this._extentPadding+=Math.max(this._extentPadding,t.extentPadding)}catch{this.symbolLayers[e]=null}})),i.forEach((t=>t.remove())),s(t),this.symbolLayers.length&&!this.symbolLayers.some((t=>!!t)))throw new Error}getSymbolLayerSize(t){const e=this.symbolLayers[t];return null!=e?e.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some((t=>t?.queryForSnapping))}createGraphics3DGraphic(t,e){const r=t.graphic,s=this.symbolLayers.map((e=>e?.createGraphics3DGraphic(t)??null)),a=this._context.arcade||this._context.featureExpressionInfoContext?.arcade?.modules||null;return new o(r,e||this,s,t.layer,a)}get complexity(){return a(this.symbolLayers.map((t=>null!=t?t.complexity:null)))}globalPropertyChanged(t,e){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const r=this.symbolLayers[s],a=t=>{const e=t.layers[s];return e instanceof i?e:null};if(null!=r&&!r.globalPropertyChanged(t,e,a))return!1}return!0}applyRendererDiff(t,e){return this.loadStatus!==h.LOADED?l.RecreateSymbol:this.symbolLayers.reduce(((r,s)=>r!==l.RecreateSymbol&&null!=s?Math.min(r,s.applyRendererDiff(t,e)):r),l.FastUpdate)}prepareSymbolPatch(t){if(this.loadStatus===h.FAILED)return;if("partial"!==t.diff.type)return;const e=t.diff.diff;if(!e.symbolLayers||"partial"!==e.symbolLayers.type)return;const r=e.symbolLayers.diff;this.symbolLayers.forEach(((e,s)=>{if(null==e)return;const a=r[s];if(a){const r={diff:a,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};e.prepareSymbolLayerPatch(r),t.symbolStatePatches.push(...r.symbolLayerStatePatches),r.graphics3DGraphicPatches.length&&t.graphics3DGraphicPatches.push(((t,e)=>{const a=t.layers[s];null!=a&&r.graphics3DGraphicPatches.forEach((t=>t(a,e)))}))}}))}updateGeometry(t,e){return this._updateGeometryOrTransform(t,((t,r)=>t.updateGeometry(r,e)))}updateTransform(t,e,r,s){return this._updateGeometryOrTransform(t,((t,a)=>t.updateTransform(a,e,r,s)))}_updateGeometryOrTransform(t,e){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(null==s)continue;const a=t.layers[r];if(!a||!e(s,a))return!1}return!0}onRemoveGraphic(t){for(let e=0;e<this.symbolLayers.length;e++){const r=this.symbolLayers[e];if(null==r)continue;const s=t.layers[e];null!=s&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let t=0,e=0,r=0;return this.symbolLayers.forEach((s=>{null!=s&&(s.loadStatus===h.LOADING?t++:s.isFastUpdatesEnabled()?r++:e++)})),{loading:t,slow:e,fast:r}}async queryForSnapping(e,r,a,o){const i=this.symbolLayers.filter(t).filter((t=>null!=t.queryForSnapping)).map((t=>t.queryForSnapping(e,r,a,o))),n=await Promise.all(i);return s(o),n.flat()}destroy(){if(!this.destroyed){super.destroy();for(const t of this.symbolLayers)null!=t&&t.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const c=new n;export{m as Graphics3DSymbol};
