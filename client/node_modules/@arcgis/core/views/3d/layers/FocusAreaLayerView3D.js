/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import{destroyMaybe as r}from"../../../core/maybe.js";import{watch as o,syncAndInitial as t}from"../../../core/reactiveUtils.js";import{property as s}from"../../../core/accessorSupport/decorators/property.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import{e as n}from"../../../chunks/earcut.js";import{create as c}from"../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{n as a}from"../../../chunks/vec32.js";import{create as m}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{computeTranslationToOriginAndRotation as p}from"../../../geometry/projection/computeTranslationToOriginAndRotation.js";import{newDoubleArray as d}from"../../../geometry/support/DoubleArray.js";import{newIndexArray as h}from"../../../geometry/support/Indices.js";import{t as f}from"../../../chunks/vec3.js";import{ViewingMode as l}from"../../ViewingMode.js";import{LayerView3D as u}from"./LayerView3D.js";import{ElevationContext as g}from"./graphics/ElevationContext.js";import{extrudePolygon as y}from"./graphics/Graphics3DExtrudeSymbolLayer.js";import{computeCentroid as _}from"./graphics/graphicUtils.js";import{geometryToRenderInfo as w}from"../support/renderInfoUtils/polygon.js";import{FocusAreaGeometry as v,FocusAreaRenderNode as j,effectsMapping as N}from"../webgl-engine/effects/focusArea/FocusAreaRenderNode.js";import A from"../../layers/LayerView.js";const x=0,b=1e4;let C=class extends(u(A)){constructor(){super(...arguments),this.type="focusArea-3d",this._elevationContext=new g,this._geometries=new Array}initialize(){this.addHandles([o((()=>this.layer.geometries),((e,r)=>{r=e,this._extrudePolygons(r),this._setFocusAreaRenderNode()}),t),o((()=>this.layer.tmpEffect),((e,r)=>{r=e,this._renderNode&&r&&(this._renderNode.effect=N[r])}),t),o((()=>this.layer.visible),((e,o)=>{e?this._renderNode??=new j({view:this.view,techniques:this.view._stage.renderView.techniques,focusAreaGeometries:this._geometries,effect:N[this.layer.tmpEffect??"none"]}):this._renderNode=r(this._renderNode)}),t)])}destroy(){this._renderNode=r(this._renderNode),this._geometries=[]}_extrudePolygons(e){this._geometries=[];const r=b-x;for(const o of e){const e=c(),t=m(),s=this.view.renderCoordsHelper.viewingMode===l.Global;s||this.view.renderCoordsHelper.worldUpAtPosition(null,t);const i=_(o);if(null==i)return;p(o.spatialReference,[i.x,i.y,0],e,this.view.renderCoordsHelper.spatialReference);const u=a(V,[e[12]-x*t[0],e[13]-x*t[1],e[14]-x*t[2]]),g=c();g[12]=-e[12],g[13]=-e[13],g[14]=-e[14];const j=w(o,this.view.elevationProvider,this.view.renderCoordsHelper,this._elevationContext),{polygons:N,mapPositions:A,position:b}=j;for(const o of N){const i=o.count,c=n(o.mapPositions,o.holeIndices,3);if(0===c.length)continue;const a=c.length,m=6*i,p=h(m+a),l=h(a),_=d(3*m),w=d(3*m),j=d(3*m),N=d(m);y(b,A,c,o,_,j,w,N,p,l,r,t,s),f(_,_,g);const C=new v(_,l,p,r,[e[12]+x*u[0],e[13]+x*u[1],e[14]+x*u[2]]);this._geometries.push(C)}}}_setFocusAreaRenderNode(){this._renderNode?(this._renderNode.focusAreaGeometries=this._geometries,this._renderNode.setExtrudedVolume()):this._renderNode=new j({view:this.view,techniques:this.view._stage.renderView.techniques,focusAreaGeometries:this._geometries,effect:N[this.layer.tmpEffect??"none"]})}};e([s()],C.prototype,"type",void 0),e([s()],C.prototype,"layer",void 0),C=e([i("esri.views.3d.layers.FocusAreaLayerView3D")],C);const V=m(),E=C;export{E as default};
