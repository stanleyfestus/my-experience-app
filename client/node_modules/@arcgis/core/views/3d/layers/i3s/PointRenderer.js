/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import{disposeMaybe as t}from"../../../../core/maybe.js";import s from"../../../../core/PooledArray.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as r}from"../../../../core/accessorSupport/decorators/subclass.js";import{d as n,l as o,h as a,v as h,f as l,k as c}from"../../../../chunks/vec32.js";import{create as d}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{s as u}from"../../../../chunks/vec42.js";import{create as m,offset as p,contains as g,containsPoint as _,set as f,positiveInfinity as P,equals as b}from"../../../../geometry/support/aaBoundingBox.js";import{create as x}from"../../../../geometry/support/plane.js";import{fromPoints as S}from"../../../../geometry/support/ray.js";import{PclTarget as R}from"./Intersector.js";import{PointHighlights as w}from"./PointHighlights.js";import{isDepth as z,ShaderOutput as A}from"../../webgl-engine/core/shaderLibrary/ShaderOutput.js";import{SyncRenderPlugin as j}from"../../webgl-engine/effects/RenderPlugin.js";import{Default3D as y}from"../../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{newIntersectorResult as I}from"../../webgl-engine/lib/Intersector.js";import{IntersectorType as q,StoreResults as E}from"../../webgl-engine/lib/IntersectorInterfaces.js";import{RenderSlot as N}from"../../webgl-engine/lib/RenderSlot.js";import{VertexArrayObject as O}from"../../webgl-engine/lib/VertexArrayObject.js";import{VertexAttribute as v}from"../../webgl-engine/lib/VertexAttribute.js";import{P as L,a as T,g as F}from"../../../../chunks/PointRenderer.glsl.js";import{PointRendererTechnique as H}from"../../webgl-engine/shaders/PointRendererTechnique.js";import{PointRendererTechniqueConfiguration as M}from"../../webgl-engine/shaders/PointRendererTechniqueConfiguration.js";import{BufferObject as G}from"../../../webgl/BufferObject.js";import{DataType as U,PrimitiveType as B,Usage as C}from"../../../webgl/enums.js";import{VertexElementDescriptor as W}from"../../../webgl/VertexElementDescriptor.js";const D=new Map([["positions",[new W(v.POSITION,3,U.FLOAT,0,12)]],["colors",[new W(v.COLOR,3,U.UNSIGNED_BYTE,0,3,!0)]]]);let V=class extends j{constructor(e){super(e),this.type=q.PCL,this.isGround=!1,this._passParameters=new L,this._highlights=new w({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,s)=>this._addHighlight(e,t,s),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.produces=new Map([[N.OPAQUE_MATERIAL,e=>!(z(e)||e===A.Highlight&&this._highlights.empty)],[N.OPAQUE_MATERIAL_WITHOUT_NORMALS,e=>z(e)]]),this.layerUid="",this._slicePlaneEnabled=!1,this._configuration=new M,this._nodes=new s}initializeRenderContext(e){this._context=e,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,s,i){const r=d(),f=d(),P=d(),b=d(),w=x(),z=e.camera.perScreenPixelRatio/2,A=e.camera.near;n(f,i,s);const j=1/o(f);a(f,f,j),h(P,f),u(w,f[0],f[1],f[2],-l(f,s));const y=new Z,q=new Z,N=new Array,O=m(),v=m(this._passParameters.clipBox);p(v,-s[0],-s[1],-s[2],v),this._nodes.forAll((o=>{const a=o.splatSize*this._passParameters.scaleFactor;let h=o.obb.minimumDistancePlane(w),d=o.obb.maximumDistancePlane(w);h-=J(a,h+A,this._passParameters,z,o.isLeaf),d-=J(a,d+A,this._passParameters,z,o.isLeaf);const u=d<0,m=null!=y.dist&&null!=q.dist&&y.dist<h*j&&q.dist>d*j;if(u||m)return;const x=Y(a,d+A,this._passParameters,z,o.isLeaf);if(!o.obb.intersectRay(s,f,x))return;const S=x*x;o.obb.toAaBoundingBox(O),p(O,-s[0],-s[1],-s[2],O);const R=!g(v,O);n(b,o.origin,s);const I=o.coordinates.length/3;for(let n=0;n<I;n++){if(r[0]=b[0]+o.coordinates[3*n],r[1]=b[1]+o.coordinates[3*n+1],r[2]=b[2]+o.coordinates[3*n+2],R&&!_(v,r))continue;const h=l(r,f),d=c(r)-h*h;if(d>S)continue;let u=h+A;const m=J(a,u,this._passParameters,z,o.isLeaf);if(h-m<0)continue;u-=m;const p=Y(a,u,this._passParameters,z,o.isLeaf);if(d>p*p)continue;const g=(h-m)*j,x=e=>(e.point=K(o,n,e.point),e.dist=g,e.normal=P,e.node=o,e.pointId=n,e.layerUid=this.layerUid,e);if((null==y.dist||g<y.dist)&&(null==t||t(s,i,g))&&x(y),e.options.store!==E.MIN&&(null==q.dist||g>q.dist)&&(null==t||t(s,i,g))&&x(q),e.options.store===E.ALL&&(null==t||t(s,i,g))){const e=new Z;N.push(x(e))}}}));const L=e=>{const{layerUid:t,node:s,pointId:i}=e;return new R(e.point,t,i,(()=>this.createGraphic(s,i,e.point)))},T=(e,t)=>{const s=L(t);e.set(this.type,s,t.dist,t.normal)};if($(y)){const t=e.results.min;(null==t.dist||y.dist<t.dist)&&T(t,y)}if($(q)&&e.options.store!==E.MIN){const t=e.results.max;(null==t.dist||q.dist>t.dist)&&T(t,q)}if(e.options.store===E.ALL){const t=S(s,i);for(const s of N){const i=I(t);T(i,s),e.results.all.push(i)}}}acquireTechniques(e){return 0!==this._nodes.length&&(e.output===A.Color||z(e.output)&&e.bind.slot===N.OPAQUE_MATERIAL_WITHOUT_NORMALS||e.output===A.Highlight)?(this._nodes.forAll((t=>this._initNode(e,t))),this._configuration.drawScreenSize=this._passParameters.drawScreenSpace,this._configuration.useFixedSizes=this._passParameters.useFixedSizes,this._configuration.hasSlicePlane=this._slicePlaneEnabled,this._configuration.hasOccludees=e.bind.hasOccludees,this._configuration.clippingEnabled=this._clippingEnabled,this._configuration.output=e.output,this._context.techniques.acquire(H,this._configuration)):null}render(e,t){const{rctx:s,bind:i,output:r}=e,n=s.bindTechnique(t,i,this._passParameters),o=r===A.Highlight;this._nodes.forAll((t=>{0!==t.coordinates.length&&(!o||t.highlights&&t.highlights.some((e=>i.highlightGroupName===e.id.highlightGroupName)))&&(n.bindDraw(i,this._passParameters,t),s.bindVAO(t.vao),o?this._renderHighlightFragments(e,t):s.drawArrays(B.POINTS,0,t.coordinates.length/3))}))}_renderHighlightFragments(e,t){const{highlights:s}=t;if(null==s)return;const{rctx:i,bind:r}=e,{highlightGroupName:n}=r;let o=0,a=s[0].componentIndex,h=a+1;const l=()=>{for(;o<s.length&&s[o].id.highlightGroupName!==n;)a=s[o].componentIndex,++o;h=a+1};l();const c=(e,t)=>{const s=t-e;s>0&&i.drawArrays(B.POINTS,e,s)};for(;o<s.length;){const e=s[o];if(e.id.highlightGroupName!==r.highlightGroupName){c(a,h),++o,l();continue}const t=e.componentIndex;t!==h&&(c(a,h),a=t),h=t+1,++o}c(a,h)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){f(this._passParameters.clipBox,e||P)}get _clippingEnabled(){return!b(this._passParameters.clipBox,P,((e,t)=>e===t))}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let s=null;return this._nodes.filterInPlace((i=>i.id!==e||(s=i,i.vao=t(i.vao),this._highlights.nodeRemoved(i),!1))),this._requestRender(),s}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll((e=>e.vao=t(e.vao))),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e,t){return this._highlights.add(e,t)}_addHighlight(e,t,s){e.addHighlight(t,s),this._requestRender()}_removeHighlight(e,t){e.removeHighlight(t),this._requestRender()}_initNode(e,t){t.vao??=new O(e.rctx,y,D,new Map([["positions",G.createVertex(e.rctx,C.STATIC_DRAW,t.coordinates)],["colors",G.createVertex(e.rctx,C.STATIC_DRAW,t.rgb)]]))}_requestRender(){this._context&&this._context.requestRender()}};e([i({constructOnly:!0})],V.prototype,"createGraphic",void 0),V=e([r("esri.views.3d.layers.i3s.PointRenderer")],V);class k extends T{constructor(e,t,s,i,r,n,o,a,h=null){super(s,r,t),this.id=e,this.obb=i,this.coordinates=n,this.rgb=o,this.attributes=a,this.pointIdFilterMap=h,this.highlights=null}addHighlight(e,t){let{highlights:s}=this;null==s&&(s=[],this.highlights=s);const i=new ee(e,t);s.push(i);const r=X(i);for(let n=s.length-1;n>0&&r<X(s[n-1]);--n)[s[n-1],s[n]]=[s[n],s[n-1]]}removeHighlight(e){const{highlights:t}=this;if(null==t)return;const s=t.filter((t=>t.id!==e));0===s.length&&(this.highlights=null),this.highlights=s}}function Q(e){return e.hasOwnProperty("splatSize")}function Y(e,t,s,i,r){if(s.drawScreenSpace)return s.fixedSize*t*i;const n=F(r)*t*i;return s.useFixedSizes?Math.min(s.fixedSize/2,n):s.screenMinSize>0?Math.min(Math.max(s.screenMinSize*t*i,e/2),n):Math.min(e/2,n)}function J(e,t,s,i,r){return s.drawScreenSpace?0:Y(e,t,s,i,r)}function K(e,t,s){return null==s&&(s=d()),s[0]=e.origin[0]+e.coordinates[3*t],s[1]=e.origin[1]+e.coordinates[3*t+1],s[2]=e.origin[2]+e.coordinates[3*t+2],s}function X(e){return null!=e.componentIndex?e.componentIndex:-1}class Z{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function $(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}class ee{constructor(e,t){this.componentIndex=e,this.id=t}}export{V as PointRenderer,k as PointRendererNode,Q as isPointRendererNode};
