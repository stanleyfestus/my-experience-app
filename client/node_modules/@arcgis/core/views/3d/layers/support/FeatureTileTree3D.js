/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import i from"../../../../core/Collection.js";import{makeHandle as s}from"../../../../core/handleUtils.js";import r from"../../../../core/Logger.js";import{removeMaybe as n}from"../../../../core/maybe.js";import o from"../../../../core/PooledArray.js";import{watch as l,syncAndInitial as h}from"../../../../core/reactiveUtils.js";import{generateUID as a}from"../../../../core/uid.js";import{property as c}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/RandomLCG.js";import{subclass as d}from"../../../../core/accessorSupport/decorators/subclass.js";import{create as p,intersects as u}from"../../../../geometry/support/aaBoundingRect.js";import{FeatureTileDescriptor as _,Visibility as m}from"./FeatureTileDescriptor.js";import{FeatureTileMeasurements3D as f}from"./FeatureTileMeasurements3D.js";import{toBoundingRect as g}from"../../support/extentUtils.js";import{TaskPriority as T,noBudget as y}from"../../../support/Scheduler.js";let E=class extends t{constructor(e){super(e),this.tiles=new i,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new o,this.tileBudget=70}initialize(){const e=()=>this._setDirty(),t=()=>this._reset();this.addHandles([l((()=>this.tilingScheme),t,h),l((()=>this.tileSize),t,h),l((()=>this.cameraOnSurface?.location),e,h),l((()=>this.viewState?.contentCamera),e,h),l((()=>this.focus?.location),e,h),l((()=>this.terrain?.baseOpacity??1),e)]),this._frameWorker=this.scheduler?.registerTask(T.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=n(this._frameWorker)}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;if(!e)return null;return e.clone()}set filterExtent(e){if(null!=e&&!e.spatialReference.equals(this.viewState.spatialReference))return void r.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||null!=t&&e&&t.equals(e))return;const i=null!=e?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const e=p();return g(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}addClient(){const e=a();return this._clients.add(e),1===this._clients.size&&this._setDirty(),s((()=>this._removeClient(e)))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(y))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),null!=this._frameWorker&&(this._frameWorker.priority=T.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||null==this._frameWorker||(this._frameWorker.priority=T.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new f({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,getIsGroundOpaque:()=>1===(this.terrain?.baseOpacity??1)}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const e=this.tilingScheme;return this._rootTileIds.map((t=>new _(t[0],t[1],t[2],e)))}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.shift();if(e.madeProgress(),this._filterExtentRect&&!u(this._filterExtentRect,i.extent))continue;this._tileMeasurements.updateTile(i);const{measures:s}=i;if(s.visibility===m.INVISIBLE)continue;const r=this._newTiles.length+this._pendingTiles.length+1;s.shouldSplit&&r<this.tileBudget?(t.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)}0===this._pendingTiles.length&&(this._updateTiles(this._newTiles.toArray()),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const t=e.filter((e=>{const t=this._idToTile.get(e.id);return t?(t.copyMeasurementsFrom(e),t.used=!0):this._idToTile.set(e.id,e),!t})),i=this.tiles.items.filter((e=>!e.used&&(this._idToTile.delete(e.id),!0)));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles(),this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort(((e,t)=>e.measures.distance-t.measures.distance)),this.tiles.forEach(((e,t)=>e.loadPriority=t))}};e([c({constructOnly:!0})],E.prototype,"scheduler",void 0),e([c({constructOnly:!0})],E.prototype,"renderCoordsHelper",void 0),e([c({constructOnly:!0})],E.prototype,"tilingSchemeOwner",void 0),e([c({constructOnly:!0})],E.prototype,"cameraOnSurface",void 0),e([c({constructOnly:!0})],E.prototype,"focus",void 0),e([c({constructOnly:!0})],E.prototype,"viewState",void 0),e([c({constructOnly:!0})],E.prototype,"terrain",void 0),e([c()],E.prototype,"tiles",void 0),e([c()],E.prototype,"tileSize",void 0),e([c({readOnly:!0})],E.prototype,"tilingScheme",null),e([c()],E.prototype,"filterExtent",null),e([c({readOnly:!0})],E.prototype,"_filterExtentRect",null),e([c({readOnly:!0})],E.prototype,"_rootTileIds",null),e([c({value:!1})],E.prototype,"suspended",null),e([c({readOnly:!0})],E.prototype,"updating",null),E=e([d("esri.views.3d.layers.support.FeatureTileTree3D")],E);export{E as FeatureTileTree3D};
