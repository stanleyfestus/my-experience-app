/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import e from"../../../../core/Accessor.js";import r from"../../../../core/Logger.js";import{removeMaybe as i,destroyMaybe as s}from"../../../../core/maybe.js";import{throwIfAborted as o,throwIfAbortError as n}from"../../../../core/promiseUtils.js";import{initial as l}from"../../../../core/reactiveUtils.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/RandomLCG.js";import{subclass as u}from"../../../../core/accessorSupport/decorators/subclass.js";import{UpdatingHandles as c}from"../../../../core/support/UpdatingHandles.js";import p from"../../../../layers/support/FeatureFilter.js";import{getFloorFilterClause as h}from"../../../../layers/support/floorFilterUtils.js";import{QueryEngine as _}from"../graphics/QueryEngine.js";import{TaskPriority as d}from"../../../support/Scheduler.js";let f=class extends e{constructor(t){super(t),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new c,this._abortController=new AbortController}initialize(){const t=d.FILTER_VISIBILITY,{layer:e,view:r}=this._configuration,{featureStore:i}=this.context,s=this._configuration.hasZ??!1,o=this._configuration.hasM??!1;this._queryEngine=new _({context:{spatialReference:r.spatialReference,layer:e,scheduler:r.resourceController.scheduler,featureStore:i,hasM:o,hasZ:s},priority:t}),this._frameTask=r.resourceController.scheduler.registerTask(t),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this._updateRequested=!0),l),this._updatingHandles.addWhen((()=>!this._frameTask.updating&&this._updateRequested),(()=>{this._frameTask.schedule((()=>this._updateVisibility()),this._abortController.signal),this._updateRequested=!1}),l)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=i(this._frameTask),this._queryEngine=s(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return null==this._compositedFeatureFilter&&null==this._sceneFilter}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return h(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:t,_timeExtent:e,_floorFilter:r}=this;if(null==e&&null==r)return t;const i=t?.clone()??new p;if(null!=e&&(i.timeExtent=i.timeExtent?.intersection(e)??e),null!=r){const t=null==i.where||""===i.where;i.where=t?r:`(${i.where}) AND (${r})`}return i}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async _updateVisibility(){const t=this._compositedFeatureFilter,e=this._sceneFilter,{signal:i}=this._abortController,s=this._frameTask,{context:l}=this;if(o(i),null==t&&null==e||0===l.getFeatureCount())return await s.schedule((()=>this.clear()),i);try{const r=await this._queryEngine.executeQueryForIdSet(t,e,i);return o(i),await s.schedule((()=>{l.updateFeatureVisibilities((t=>r.has(t)))}),i)}catch(a){return n(a),r.getLogger(this).warn(`FeatureFilter query failed: ${a}`,{error:a}),await s.schedule((()=>{l.setAllFeaturesVisibility(!0)}),i)}}};t([a({constructOnly:!0})],f.prototype,"context",void 0),t([a()],f.prototype,"updating",null),t([a()],f.prototype,"defaultVisibility",null),t([a()],f.prototype,"_featureFilter",null),t([a()],f.prototype,"_sceneFilter",null),t([a()],f.prototype,"_floorFilter",null),t([a()],f.prototype,"_timeExtent",null),t([a()],f.prototype,"_compositedFeatureFilter",null),t([a()],f.prototype,"_configuration",null),t([a()],f.prototype,"_updateRequested",void 0),f=t([u("esri.views.3d.layers.support.FeatureVisibilityFilter")],f);export{f as FeatureVisibilityFilter};
