/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import t from"../../../../core/Handles.js";import{deg2rad as i}from"../../../../core/mathUtils.js";import{fromScaling as e,fromTranslation as a,fromZRotation as r,mul as o,fromYRotation as n,multiply as s}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as l}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{g as m,h as p,a as c,G as u,f as h,b as d,n as f,i as _}from"../../../../chunks/vec32.js";import{create as g}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{f as T}from"../../../../chunks/boundedPlane.js";import{fromValues as v}from"../../../../geometry/support/ray.js";import{displayFocusMultiplier as j}from"../Slice/sliceToolConfig.js";import{ArrowManipulator as w}from"./ArrowManipulator.js";import{viewshedToolManipulatorConfiguration as D}from"./ViewshedConfiguration.js";import{screenToCircleAngle as R,getViewshedRotationMatrix as S}from"./viewshedToolUtils.js";import{screenToRenderRay as E}from"../../interactive/editingTools/dragEventPipeline3D.js";import{ManipulatorType as x}from"../../interactive/editingTools/ManipulatorType.js";import{discRadiusSmall as H,discRadius as M}from"../../interactive/editingTools/manipulations/config.js";import{InteractiveManipulation as y}from"../../interactive/editingTools/manipulations/InteractiveManipulation.js";import{createManipulatorDragEventPipeline as P,dragAtLocation as b}from"../../../interactive/dragEventPipeline.js";class A extends y{constructor(i){super(),this._handles=new t,this._tool=i.tool,this._view=i.view;const e=D.scaleOrientHandleRadius;this._manipulatorHeading=new w(this._view,e),this._manipulatorTilt=new w(this._view,e),this._manipulatorDistance=new w(this._view,e),this.forEachManipulator((t=>this._tool.manipulators.add(t)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(t,e){return P(this._manipulatorHeading,((a,r,o,n,s)=>{const l=this._view,{tiltParallelToSurface:h,farDistanceRenderSpace:d,upVector:f,observerRenderSpace:_,targetRenderSpace:g,rightVector:v}=e,j=Math.sin(i(h))*d,w=m(V,_,p(C,f,j)),D=c(C,g,w),S=p(I,v,u(D)),E=T(w,D,S),H=R(r,l,E,e).next((t=>({...t,manipulatorType:x.ROTATE})));t(a,H,o)}))}createTiltDragPipeline(t,i){return P(this._manipulatorTilt,((e,a,r,o,n)=>{const{observerRenderSpace:s,farDistanceRenderSpace:l,upVector:m,targetDirection:c}=i,u=h(c,m),_=d(V,c,m,-u);p(_,f(_,_),l);const g=p(C,m,l),v=T(s,_,g),j=R(a,this._view,v,i).next((t=>({...t,manipulatorType:x.ROTATE})));t(e,j,r)}))}createDistanceDragPipeline(t,i){return P(this._manipulatorDistance,((e,a,r,o,n)=>{const s=v(i.observerRenderSpace,i.targetDirection),l=a.next(b(this._view,e.location)).next(E(this._view,s)).next((t=>({...t,manipulatorType:x.SCALE})));t(e,l,r)}))}updateManipulators(t){const{targetRenderSpace:i}=t;this._manipulatorHeading.renderLocation=i,this._manipulatorTilt.renderLocation=i,this._manipulatorDistance.renderLocation=i;const m=l(),c=t=>{s(m,t,m)},u=D.scaleOrientSize*(H/M);c(e(O,_(V,u,u,u))),c(S(t,O));const h=D.scaleOrientHandleRadius*j*u,d=p(V,t.targetDirection,h);c(a(O,d));const f=r(O,-k);o(f,f,n(L,-k)),this._manipulatorHeading.modelTransform=o(l(),m,f);const g=n(O,k);o(g,g,r(L,Math.PI)),this._manipulatorTilt.modelTransform=s(l(),m,g),this._manipulatorDistance.modelTransform=m}forEachManipulator(t){t(this._manipulatorHeading,x.ROTATE),t(this._manipulatorTilt,x.ROTATE),t(this._manipulatorDistance,x.SCALE)}}const O=l(),L=l(),V=g(),C=g(),I=g(),k=Math.PI/2;export{A as ScaleOrientManipulation};
