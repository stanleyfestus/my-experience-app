/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import"../../../core/has.js";import{disposeMaybe as e,releaseMaybe as t}from"../../../core/maybe.js";import{set as r,copy as s}from"../../../core/libs/gl-matrix-2/math/vec2.js";import{ZEROS as o}from"../../../core/libs/gl-matrix-2/factories/vec2f64.js";import{fromValues as i}from"../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{isBaseLayer as a,isGroupLayer as n}from"../../../layers/support/layerUtils.js";import{BlendLayersPassParameters as u}from"./BlendLayersTechnique.js";import{TextureUpdate as c}from"./interfaces.js";import{LayerClass as l}from"./LayerClass.js";import{NeighborIndex as p}from"./NeighborIndex.js";import{isImageWithType as d}from"./TerrainData.js";import{isBlendableLayerView as h,isVectorTileLayerView as m,isVectorTileRenderInfo as f,isImageryTileRenderInfo as _,isImageSourceRenderInfo as T,isTextureTileRenderInfo as y,isVectorTilePerLayerInfo as b}from"./terrainUtils.js";import{ActivationTime as g}from"./TextureFader.js";import{TextureReference as x}from"./TextureReference.js";import{TileCompositor as I}from"./TileCompositor.js";import{TileRenderInfo as w}from"./TileRenderInfo.js";import A from"./TileTexture.js";import{TileUpdate as P}from"./TileUpdate.js";import{fallsWithinLayerView as k}from"./tileUtils.js";import{blendModeFromString as O}from"../webgl-engine/core/shaderLibrary/output/BlendOptions.js";import{BlendLayersOutput as E}from"../webgl-engine/core/shaderLibrary/terrain/BlendLayersOutput.js";import{createEmptyTexture as D}from"../webgl-engine/lib/glUtil3D.js";import{TextureSamplingMode as j,TextureWrapMode as M,PixelFormat as L}from"../../webgl/enums.js";import{Texture as R}from"../../webgl/Texture.js";import{TextureDescriptor as C}from"../../webgl/TextureDescriptor.js";class N{constructor(e,t,r,s,o,i){this.start=e,this.end=t,this.blendMode=r,this.opacity=s,this.output=o,this.baseOpacity=i}}class U{constructor(e,t,r,s){this._rctx=e,this.tileSize=t,this._techniques=r,this._cache=s,this._passParameters=new u,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._compositor=new I(this._rctx,this._techniques),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._compositor=e(this._compositor),this._backgroundTexture=t(this._backgroundTexture)}get backgroundIsGrid(){return null==this._backgroundColor}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let o=0,i=0,u=this.tileSize,p=!1,d=!1;const f=r.view.state.contentPixelRatio;let _=!1;q.clear(),H.length=0;const T=e.layerInfo[l.MAP];let y=0,b=null;for(;y<T.length;y++){const t=r.layerViewByIndex(y,l.MAP),c=t.layer,g=!k(e,t),x=c.opacity,I=t.fullOpacity;if(d=d||a(c),h(t)){let e="normal"!==t.layer.blendMode;if(n(c.parent)){const t=c.parent.uid;null!=t&&""!==t&&(e=G(c.parent)||e)}e&&(_=e,p=!1)}if((g||0===x)&&!_){T[y].pendingUpdates&=~(P.TEXTURE_NOFADING&P.TEXTURE_FADING);continue}++i;const w=m(t),A=S(e,y,w);if(A){if(T[y].pendingUpdates&=~(P.TEXTURE_NOFADING&P.TEXTURE_FADING),n(c.parent)){const e=c.parent.uid;null!=e&&""!==e&&F(c.parent,y)}w?u=Math.max(u,this.tileSize*f):1===s&&1===I&&(t.isOpaque||this._dataToTexture(A)&&A.sourceLayerInfo.data.descriptor.isOpaque)&&(p=!0),++o,null===b&&(b=y)}}const g=u/this.tileSize,x=this._ensureBackgroundTexture(this.tileSize);0!==o&&null!==b?1===o&&!_&&this._useLayerTexture(e,b)||this._composeLayers(e,t,y-1,d,u,g,!p||_,q,_):v(e,i,x,t!==c.FADING)}_ensureBackgroundTexture(e){return null==this._backgroundTexture&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=o,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,null!=this.backgroundColor),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(e,t){const r=e.surface.layerViewByIndex(t,l.MAP),s=a(r.layer),o=s?e.surface.baseOpacity:1,n=s?1:e.surface.baseOpacity,u=r.fullOpacity,p=S(e,t,!1);return!!this._dataToTexture(p)&&(e.renderData.setTextureReference(new x(p.sourceLayerInfo.data,c.FADING,i(p.offset[0],p.offset[1],p.scale,p.scale),o,n,u)),!0)}_composeLayers(e,t,r,s,i,n,u,c,p){this._compositor.ensureBuffer(i);const d=e.surface.baseOpacity;let T=!1,y=j.LINEAR_MIPMAP_LINEAR,b=!1,g=0;for(let x=r;x>=0;x--){const t=e.surface.layerViewByIndex(x,l.MAP),r=t.layer,I=m(t),w=S(e,x,I),A=r.opacity,P=!k(e,t);if(!w||(0===A||P)&&!p)continue;const D=!a(r)&&!T;D&&(T=!0);let M=!1;c.forEach((e=>{e.start===x&&(e.output=s?E.Composite:u&&D?this.backgroundIsGrid?E.GridComposite:E.ColorComposite:E.Composite,e.baseOpacity=D?d:1,H.push(e),this._compositor.openGroup(i),M=!0)}));const L=0===g,R=M?E.GroupBackgroundComposite:u&&L?this.backgroundIsGrid?E.GridComposite:E.ColorComposite:E.Composite,C=O[h(t)?t.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=D&&!M&&d<1?d:1,this._passParameters.opacity=A,f(w)?b=this._compositor.drawVectorData(this._passParameters,R,i,C,w,n,this.tileSize,b):_(w)?(this._compositor.drawRasterData(this._passParameters,R,i,C,w),B(w)&&(y=j.NEAREST)):this._dataToTexture(w)&&(this._passParameters.texture=w.sourceLayerInfo.data.texture,this._passParameters.offset=w.offset,this._passParameters.scale=w.scale,this._compositor.drawImageData(this._passParameters,R,i,C));H.length>0&&H[H.length-1].end===x;){const e=H.pop();this._passParameters.baseOpacity=e.baseOpacity,this._passParameters.opacity=e.opacity,this._passParameters.offset=o,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,e.output,i,O[e.blendMode])}g++}const I=e.renderData,w=p||T&&d<1,A=I.ensureTexture(i,w,t,(()=>this._buildTexture(i,w,y)));this._compositor.copyFBOToTexture(A),this._compositor.unbind(),I.setTextureReference(new x(A,t,V,T?1:d,0,1))}_dataToTexture(e){if(T(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data,!0),e.tile.setMemoryDirty()}return y(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,r=j.LINEAR_MIPMAP_LINEAR){if(null==e)return null;const s=new C;s.wrapMode=M.CLAMP_TO_EDGE,s.samplingMode=r,s.maxAnisotropy=this._maxAnisotropy,s.preMultiplyAlpha=!0,s.flipped=!0,s.hasMipmap=!0,t||(s.pixelFormat=L.RGB);const o=this._rctx;let i;if("number"==typeof e)s.width=s.height=e,i=this._buildTileTexture(s,e);else if(d(e))s.isOpaque=e.isOpaque,s.isOpaque&&(s.pixelFormat=L.RGB),i=this._buildTileTexture(s,e.element.width,e.element);else try{s.width=e.width,s.height=e.height,i=this._buildTileTexture(s,e.width,e)}catch(n){i=new A(D(o)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const a=o.bindTexture(i.texture,R.TEXTURE_UNIT_FOR_UPDATES);return i.generateMipmap(),o.bindTexture(a,R.TEXTURE_UNIT_FOR_UPDATES),i}_buildTileTexture(e,t,r){const s=`${t} ${e.pixelFormat}`,o=this._cache.pop(s);return o?(o.retain(),o.texture.setData(r),o):new A(new R(this._rctx,e,r),this._cache)}get test(){}}function S(e,t,o){z.layerIndex=t,z.vtlNeighborInfos.clear();const i=e.layerInfo[l.MAP][t];if(r(z.offset,0,0),z.tile=e,z.scale=1,z.sourceLod=e.lij,z.sourceLayerInfo=i,z.isVTLBackground=o,i.data)return o&&e.forEachLoadedNeighbor(((r,s)=>{if(r.level!==e.level)return;const o=r.layerInfo[l.MAP][t];if(!b(o)||i.data===o.data)return;const a=z.vtlNeighborInfos.pushNew();a.offset=X[s],a.sourceLod=r.lij,a.sourceLayerInfo=o})),z;const a=i.upsampleInfo,n=a?.tile?.layerInfo[l.MAP][t];return n?(z.tile=a.tile,s(z.offset,a.offset),z.scale=a.scale,z.sourceLod=a.tile.lij,z.sourceLayerInfo=n,z):o?z:null}function B(e){const t=e.sourceLayerInfo.data;return!!t.source&&"nearest"===t.interpolation}function G(e){let t="normal"!==e.blendMode;return n(e.parent)&&(t=G(e.parent)||t),t}function F(e,t){n(e.parent)&&F(e.parent,t);const r=e.uid;if(null!=r&&""!==r){const s=q.get(r);s?s.start=t:q.set(r,new N(t,t,e.blendMode,e.opacity,E.Composite,1))}}function v(e,t,r,s){const o=e.renderData,i=!s&&null!=o.textureReference&&(e.surface.view.layerViewManager.updating||t>0)?g.Delayed:g.Immediate;o.setTextureReference(new x(r,c.FADING,V,e.surface.baseOpacity,0,1),i)}const q=new Map,H=new Array,z=new w,V=i(0,0,1,1),X=new Array;X[p.NORTH]=[0,-1],X[p.NORTH_EAST]=[-1,-1],X[p.EAST]=[-1,0],X[p.SOUTH_EAST]=[-1,1],X[p.SOUTH]=[0,1],X[p.SOUTH_WEST]=[1,1],X[p.WEST]=[1,0],X[p.NORTH_WEST]=[1,-1];export{N as GroupInfo,U as TileRenderer};
