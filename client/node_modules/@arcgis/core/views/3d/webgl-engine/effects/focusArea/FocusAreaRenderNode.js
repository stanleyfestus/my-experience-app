/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{property as t}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as s}from"../../../../../core/accessorSupport/decorators/subclass.js";import{ColorFormat as r}from"../../../webgl/formats.js";import o from"../../../webgl/RenderNode.js";import{FocusAreaColorTechnique as i}from"./FocusAreaColorTechnique.js";import{FocusAreaMaskTechnique as a}from"./FocusAreaMaskTechnique.js";import{Default3D as n}from"../../lib/DefaultVertexAttributeLocations.js";import{Pos3 as c}from"../../lib/DefaultVertexBufferLayouts.js";import{VertexArrayObject as l}from"../../lib/VertexArrayObject.js";import{F as h}from"../../../../../chunks/FocusAreaColor.glsl.js";import{F as u}from"../../../../../chunks/FocusAreaMask.glsl.js";import{BufferObject as p}from"../../../../webgl/BufferObject.js";import{FramebufferBit as m,CompareFunction as f,Face as d,StencilOperation as g,PrimitiveType as A,Usage as _}from"../../../../webgl/enums.js";let E=class extends o{constructor(e){super(e),this.consumes={required:["final-color"]},this.produces="final-color",this.focusAreaGeometries=new Array,this._vaos=Array(),this._count=new Array,this._origins=new Array,this._colorParameters=new h,this._maskParameters=new u,e.techniques.precompile(a),e.techniques.precompile(i)}initialize(){this.setExtrudedVolume()}destroy(){this._vaos.forEach((e=>e.dispose())),this._vaos=[],this._count=[],this._origins=[]}render(e){const t=this.techniques.acquire(a),s=this.techniques.acquire(i),o=this.bindParameters,n=e.find((({name:e})=>"final-color"===e)),c=n?.getTexture(),l=o.camera,h=l.fullViewport[2],u=l.fullViewport[3],p=this.fboCache.acquire(h,u,"focusArea",r.RGBA),_=this.fboCache.acquire(h,u,this.produces);if(!t.compiled||!s.compiled||!this._vaos||this.effect===b.NONE)return this.requestRender(),t.release(),s.release(),_.release(),p.release(),n;const E=this.renderingContext;p.attachDepth(n.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),E.bindFramebuffer(p.fbo),E.clear(m.COLOR|m.STENCIL),E.setViewport(0,0,h,u),E.gl.clearStencil(0),E.gl.clear(E.gl.STENCIL_BUFFER_BIT),E.setClearStencil(0);for(let r=0;r<this._vaos.length;r++){const e=this._vaos[r],s=this._count[r];e&&(this._maskParameters.origin=this._origins[r],E.bindTechnique(t,o,this._maskParameters),E.setFaceCullingEnabled(!1),E.setStencilTestEnabled(!0),E.setStencilWriteMask(255),E.setStencilFunction(f.ALWAYS,0,255),E.setStencilOpSeparate(d.FRONT,g.KEEP,g.INCR_WRAP,g.KEEP),E.setStencilOpSeparate(d.BACK,g.KEEP,g.DECR_WRAP,g.KEEP),E.setDepthWriteEnabled(!1),E.setColorMask(!1,!1,!1,!1),E.bindVAO(e),E.drawArrays(A.TRIANGLES,0,s),E.setFaceCullingEnabled(!1),E.setDepthTestEnabled(!1),E.setStencilFunction(f.NOTEQUAL,0,255),E.setStencilWriteMask(0),E.setColorMask(!0,!0,!0,!0),E.drawArrays(A.TRIANGLES,0,s))}return t.release(),E.gl.clear(E.gl.STENCIL_BUFFER_BIT),E.bindFramebuffer(_.fbo),this._colorParameters.color=c,this._colorParameters.focusArea=p.getTexture(),this._colorParameters.effect=this.effect,E.bindTechnique(s,o,this._colorParameters),E.screen.draw(),p.release(),s.release(),_.attachDepth(n.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),_}setExtrudedVolume(){const e=this.focusAreaGeometries;this._vaos=[],this._count=[],this._origins=[];for(let t=0;t<e.length;t++){const s=e[t],r=new Array,o=s.indicesBottom;this._origins.push(s.origin);for(let e=0;e<o.length;e++)r.push(s.positions[3*(o[e]-1)]),r.push(s.positions[3*(o[e]-1)+1]),r.push(s.positions[3*(o[e]-1)+2]);const i=s.indicesExtruded;for(let e=0;e<i.length;e++)r.push(s.positions[3*i[e]]),r.push(s.positions[3*i[e]+1]),r.push(s.positions[3*i[e]+2]);const a=new Float32Array(r),h=new l(this.renderingContext,n,new Map([["geometry",c]]),new Map([["geometry",p.createVertex(this.renderingContext,_.STATIC_DRAW,a)]]));this._vaos?.push(h),this._count.push(o.length+i.length)}}};e([t()],E.prototype,"consumes",void 0),e([t()],E.prototype,"produces",void 0),e([t({constructOnly:!0})],E.prototype,"techniques",void 0),e([t()],E.prototype,"focusAreaGeometries",void 0),e([t()],E.prototype,"effect",void 0),E=e([s("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaRenderNode")],E);class T{constructor(e,t,s,r,o){this.positions=e,this.indicesBottom=t,this.indicesExtruded=s,this.height=r,this.origin=o}}var b;!function(e){e[e.NONE=0]="NONE",e[e.BRIGHT=1]="BRIGHT",e[e.DARK=2]="DARK"}(b||(b={}));const C={none:b.NONE,bright:b.BRIGHT,dark:b.DARK};export{b as FocusAreaEffect,T as FocusAreaGeometry,E as FocusAreaRenderNode,C as effectsMapping};
