/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{disposeMaybe as r}from"../../../../../core/maybe.js";import{throwIfAborted as t}from"../../../../../core/promiseUtils.js";import{watch as s,syncAndInitial as a}from"../../../../../core/reactiveUtils.js";import{property as i}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as o}from"../../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as n}from"../../../../../support/requestImageUtils.js";import{InternalRenderCategory as c,RenderCategory as l}from"../../../webgl.js";import{ColorFormat as u}from"../../../webgl/formats.js";import m from"../../../webgl/RenderNode.js";import{SMAABlendWeightsTechnique as h}from"./SMAABlendWeightsTechnique.js";import{SMAABlurTechnique as d}from"./SMAABlurTechnique.js";import{SMAAEdgeDetectTechnique as p}from"./SMAAEdgeDetectTechnique.js";import{SMAAPassParameters as f}from"./SMAAPassParameters.js";import{RenderRequestType as b}from"../../lib/basicInterfaces.js";import{PixelFormat as T,TextureSamplingMode as x,FramebufferBit as _,TextureWrapMode as A}from"../../../../webgl/enums.js";import{Texture as g}from"../../../../webgl/Texture.js";import{TextureDescriptor as C}from"../../../../webgl/TextureDescriptor.js";let q=class extends m{constructor(e){super(e),this.produces="disabled",this.consumes={required:[c.ANTIALIASING],optional:[l.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new f,e.techniques.precompile(p),e.techniques.precompile(h),e.techniques.precompile(d)}initialize(){this.addHandles([s((()=>this.isEnabled()),(e=>e?this.enable():this.disable()),a)])}async enable(){if(this.produces=c.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;const e=this._abortController.signal;try{const r=await import("./SMAAData.js");await this._loadTextures(r,e),this.requestRender(b.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,r){t(r);const[s,a]=await Promise.allSettled([n(e.areaTexture,{signal:r}),n(e.searchTexure,{signal:r})]);if(t(r),"fulfilled"!==s.status||"fulfilled"!==a.status)return;const i=this.renderingContext;this._areaTexture=w(i,x.LINEAR,T.RGB,s.value),this._searchTexture=w(i,x.NEAREST,T.LUMINANCE,a.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=r(this._searchTexture),this._areaTexture=r(this._areaTexture)}render(e){const r=e.find((({name:e})=>e===c.ANTIALIASING));if(!this._areaTexture||!this._searchTexture)return this.requestRender(b.UPDATE),r;const t=this.techniques.acquire(p),s=this.techniques.acquire(h),a=this.techniques.acquire(d);if(!t.compiled||!s.compiled||!a.compiled)return t.release(),s.release(),a.release(),this.requestRender(b.UPDATE),r;const i=e.find((({name:e})=>e===l.COMPOSITE));if(!i)return r;const o=i.fbo.width,n=i.fbo.height,m=this.renderingContext;m.setViewport(0,0,o,n);const f=this.fboCache.acquire(o,n,"smaa edges",u.RG);m.bindFramebuffer(f.fbo),m.setClearColor(0,0,0,1),m.clear(_.COLOR),this._smaaParameters.color=i.getTexture();const T=this.bindParameters;m.bindTechnique(t,T,this._smaaParameters),m.screen.draw(),t.release();const x=this.fboCache.acquire(o,n,"smaa blend");return m.bindFramebuffer(x.fbo),m.setClearColor(0,0,1,1),m.clear(_.COLOR),this._smaaParameters.inputTexture=f.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,m.bindTechnique(s,T,this._smaaParameters),m.screen.draw(),s.release(),f.release(),m.bindFramebuffer(r.fbo),m.setClearColor(0,1,0,1),m.clear(_.COLOR),this._smaaParameters.inputTexture=x.getTexture(),m.bindTechnique(a,T,this._smaaParameters),m.screen.draw(),a.release(),x.release(),r}};function w(e,r,t,s){const a=new C;return a.pixelFormat=t,a.wrapMode=A.CLAMP_TO_EDGE,a.width=s.width,a.height=s.height,a.samplingMode=r,new g(e,a,s)}e([i()],q.prototype,"produces",void 0),e([i()],q.prototype,"consumes",void 0),e([i({constructOnly:!0})],q.prototype,"isEnabled",void 0),e([i({constructOnly:!0})],q.prototype,"techniques",void 0),e([i()],q.prototype,"_abortController",void 0),q=e([o("esri.views.3d.webgl-engine.effects.smaa.SMAA")],q);export{q as SMAA};
