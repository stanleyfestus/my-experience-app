/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../../chunks/tslib.es6.js";import{property as t}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as o}from"../../../../../core/accessorSupport/decorators/subclass.js";import{RenderCategory as r}from"../../../webgl.js";import s from"../../../webgl/RenderNode.js";import{a as i,B as a}from"../../../../../chunks/BloomComposition.glsl.js";import{BloomCompositionTechniqueConfiguration as l}from"./BloomCompositionTechniqueConfiguration.js";import{BloomCompositionTechnique as m}from"./BloomTechnique.js";import{RenderRequestType as u}from"../../lib/basicInterfaces.js";import{ColorAttachment as c,FramebufferBit as n}from"../../../../webgl/enums.js";let h=class extends s{constructor(e){super(e),this.consumes={required:[r.COMPOSITE,"emissive"]},this.produces=r.COMPOSITE,this._configuration=new l,this._bloomParameters=new i,this._blurScale=3.06,this._bloomResults=new Array}destroy(){}precompile(){this._configuration.bloomStage=a.BlurHorizontal,this.techniques.precompile(m,this._configuration),this._configuration.bloomStage=a.BlurVertical,this.techniques.precompile(m,this._configuration),this._configuration.bloomStage=a.Composite,this.techniques.precompile(m,this._configuration)}render(e){const t=e.find((({name:e})=>e===r.COMPOSITE)),o=t.getAttachment(c.COLOR_ATTACHMENT1)?.attachment;if(!o)return t;this._configuration.bloomStage=a.BlurHorizontal;const s=this.techniques.acquire(m,this._configuration);this._configuration.bloomStage=a.BlurVertical;const i=this.techniques.acquire(m,this._configuration);this._configuration.bloomStage=a.Composite;const l=this.techniques.acquire(m,this._configuration);if(!(s.compiled&&i.compiled&&l.compiled))return s.release(),i.release(),l.release(),this.requestRender(u.UPDATE),t;const h=t.getTexture(),b=this.renderingContext,p=this.fboCache,_=this.bindParameters,{fullWidth:g,fullHeight:f}=this.bindParameters.camera,T=(e,t,o,r,s)=>{b.bindFramebuffer(e.fbo),b.setViewport(0,0,o,r),b.setClearColor(0,0,0,0),b.clear(n.COLOR),b.bindTechnique(t,_,s),b.screen.draw()};let d=g/2,C=f/2;const P=5,R=this._bloomParameters.blurRadius;let x=o;for(let r=0;r<P;r++){const e=p.acquire(d,C,"bloomHorizontal");this._bloomParameters.colorTexture=x,T(e,s,d,C,this._bloomParameters);const t=p.acquire(d,C,"bloomVertical");this._bloomParameters.colorTexture=e.getTexture(),T(t,i,d,C,this._bloomParameters),e.release(),this._bloomResults[r]=t,d/=2,C/=2,x=this._bloomResults[r].getTexture(),this._bloomParameters.blurRadius*=this._blurScale}s.release(),i.release();const q=this.acquireOutputFramebuffer();this._bloomParameters.colorTexture=h;for(let r=0;r<P;r++)this._bloomParameters.bloomTexture0=this._bloomResults[0].getTexture(),this._bloomParameters.bloomTexture1=this._bloomResults[1].getTexture(),this._bloomParameters.bloomTexture2=this._bloomResults[2].getTexture(),this._bloomParameters.bloomTexture3=this._bloomResults[3].getTexture(),this._bloomParameters.bloomTexture4=this._bloomResults[4].getTexture();return this._bloomParameters.blurRadius=R,T(q,l,g,f,this._bloomParameters),this._bloomResults.forEach((e=>e.release())),l.release(),q.attachDepth(t.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),q.attachColor(t.getAttachment(c.COLOR_ATTACHMENT1),c.COLOR_ATTACHMENT1),q}};e([t()],h.prototype,"consumes",void 0),e([t()],h.prototype,"produces",void 0),e([t({constructOnly:!0})],h.prototype,"techniques",void 0),h=e([o("esri.views.3d.webgl-engine.effects.bloom.BloomRenderNode")],h);export{h as BloomRenderNode};
