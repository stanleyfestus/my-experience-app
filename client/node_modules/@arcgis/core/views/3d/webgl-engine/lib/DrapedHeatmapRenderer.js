/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import{disposeMaybe as e}from"../../../../core/maybe.js";import{watch as r}from"../../../../core/reactiveUtils.js";import{property as a}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as i}from"../../../../core/accessorSupport/decorators/subclass.js";import{releaseTechniques as s}from"../effects/RenderPlugin.js";import{createQuadVAO as o}from"./glUtil3D.js";import{SortedRenderGeometryRenderer as n}from"./SortedRenderGeometryRenderer.js";import{HeatmapPassParameters as m,HeatmapTechnique as p}from"../shaders/HeatmapTechnique.js";import{HeatmapTechniqueConfiguration as h}from"../shaders/HeatmapTechniqueConfiguration.js";import{TextureWrapMode as c,PixelType as l,FramebufferBit as d}from"../../../webgl/enums.js";import{FramebufferObject as u}from"../../../webgl/FramebufferObject.js";import{Texture as y}from"../../../webgl/Texture.js";import{TextureDescriptor as _}from"../../../webgl/TextureDescriptor.js";import{vertexCount as f}from"../../../webgl/Util.js";let g=class extends n{constructor(t){super(t),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new m,this._configuration=new h;const e=new _;e.pixelFormat=t.pixelFormat,e.internalFormat=t.internalFormat,e.dataType=t.dataType,e.samplingMode=t.samplingMode,e.wrapMode=c.CLAMP_TO_EDGE;const r=t.rendererContext.rctx;this._densityMap=new u(r,e),this._quad=o(r),this._configuration.usesHalfFloat=t.dataType!==l.FLOAT,t.rendererContext.pluginContext.techniques.precompile(p,this._configuration)}initialize(){const t=this._colorRampData,e=new _(t.length/4,1);e.wrapMode=c.CLAMP_TO_EDGE,this._colorRamp=new y(this.rctx,e,t),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles(r((()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius]),(()=>this.rendererContext.notifyContentChanged())))}destroy(){this._densityMap=e(this._densityMap),this._quad=e(this._quad),this._colorRamp=e(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(t){t!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=t,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(t){t!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=t,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(t){t!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=t,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(t){this._heatmapParameters.fieldTotal=t,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(t){const{colorRamp:e}=this._heatmapParameters;if(null!=e&&t!==this._colorRampData){const r=e.descriptor.width,a=t.length/4;a!==r&&e.resize(a,1),e.setData(t)}this._colorRampData=t}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(t){this._heatmapParameters.colorRamp=t}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccludedDraped(){return!1}render(t){const e=this.sortedRenderers;if(0===e.length)return;const r=this.rctx.getBoundFramebufferObject(),a=this.rctx.getViewport(),{pixelRatio:i}=this,o=Math.ceil(a.width*i),n=Math.ceil(a.height*i);this._densityMap.resize(o,n),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,o,n),this.rctx.clear(d.COLOR);let m=!1;if(e.forAll((e=>{const r=e.acquireTechniques(t);r&&(e.render(t,r),s(r),m=!0)})),this.rctx.bindFramebuffer(r),this.rctx.setViewport(a.x,a.y,a.width,a.height),!m)return;this.rctx.bindVAO(this._quad);const h=this.rendererContext.pluginContext.techniques.acquire(p,this._configuration);this.rctx.bindTechnique(h,t.bind,this._heatmapParameters),this.rctx.drawArrays(h.primitiveType,0,f(this._quad,"geometry")),h.release()}};t([a()],g.prototype,"searchRadius",null),t([a()],g.prototype,"minDensity",null),t([a()],g.prototype,"maxDensity",null),t([a()],g.prototype,"fieldTotal",null),t([a()],g.prototype,"pixelRatio",void 0),t([a()],g.prototype,"colorRampData",null),t([a({constructOnly:!0})],g.prototype,"dataType",void 0),t([a({constructOnly:!0})],g.prototype,"samplingMode",void 0),t([a({constructOnly:!0})],g.prototype,"pixelFormat",void 0),t([a({constructOnly:!0})],g.prototype,"internalFormat",void 0),t([a()],g.prototype,"_colorRampData",void 0),g=t([i("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],g);export{g as DrapedHeatmapRenderer};
