/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import t from"../../../../core/PooledArray.js";import{multiply as e,copy as r}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as i}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{t as n}from"../../../../chunks/vec32.js";import{l as s}from"../../../../chunks/vec42.js";import{create as a}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{intersectsSphere as o,create as h,copy as f}from"../../../../geometry/support/frustum.js";import{a as c,c as l}from"../../../../chunks/sphere.js";import{maxScale as _}from"../../support/mathUtils.js";import{empty as u,union as d,set as m,DepthRange as g}from"./depthRange.js";import p from"./Octree.js";import{assert as b}from"./Util.js";const w=1e4,v=100,R=500,j=500,C=.1;function A(t,e,r){let i=0;if(!e.some((t=>!!t.material&&(i+=t.numGeometries,i>=w))))return G.compute(t,e);const n=u();return r.forAll((e=>d(n,M(t,e)))),n}function M(t,e){if(!e.visible)return;const r=u(),i=e.getSpatialQueryAccelerator();return i?O(r,t,i):B(r,t,e.objects),r}function O(t,e,r){const i=e.eye,n=e.viewForward,s=e.frustum,a=t=>t.visible,o=r.objectCount;if(o<R)m(V,e.near,Math.min(t.near,e.far)),r.forEachInDepthRange(i,n,p.DepthOrder.FRONT_TO_BACK,V,((r,i)=>{x(t,e,r),V.far=t.near,i.setRange(V)}),s,a),m(V,Math.max(t.far,e.near),e.far),r.forEachInDepthRange(i,n,p.DepthOrder.BACK_TO_FRONT,V,((r,i)=>{x(t,e,r),V.near=t.far,i.setRange(V)}),s,a);else{const i=Math.max(Math.min(o,j),Math.ceil(o*C)),h=r.findClosest(n,p.DepthOrder.FRONT_TO_BACK,s,a,i),f=r.findClosest(n,p.DepthOrder.BACK_TO_FRONT,s,a,i);h&&f&&(T(t,e,h.boundingVolumeWorldSpace.bounds),T(t,e,f.boundingVolumeWorldSpace.bounds))}}function B(t,e,r){k.clear(),r.forAll((t=>{t.visible&&0!==t.geometries.length&&k.add(t)})),k.empty||(k.sort(e),m(V,e.near,Math.min(t.near,e.far)),k.forEachInDepthRange(V,p.DepthOrder.FRONT_TO_BACK,((r,i)=>{i<t.near&&x(t,e,r)})),m(V,Math.max(t.far,e.near),e.far),k.forEachInDepthRange(V,p.DepthOrder.BACK_TO_FRONT,((e,r,i)=>{t.far=Math.max(t.far,i)})))}function x(t,r,i){if(!i.visible)return;if(!o(r.frustum,i.boundingVolumeWorldSpace.bounds))return;const n=i.transformation,s=S;i.geometries.forEach((i=>{e(s,n,i.transformation);const a=_(s);D(t,r,i.boundingInfo,s,a)}))}function D(t,e,r,i,s){if(null==r)return;n(c(K),r.center,i);const{eye:a,viewForward:h}=e,f=h[0]*(K[0]-a[0])+h[1]*(K[1]-a[1])+h[2]*(K[2]-a[2]);if(K[3]=r.radius*s,!(f-K[3]>t.near&&f+K[3]<t.far)&&o(e.frustum,K))if(r.radius>v&&r.getChildren())for(const n of r.getChildren())D(t,e,n,i,s);else U.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function T(t,e,r){const i=e.eye,n=e.viewForward,s=(r[0]-i[0])*n[0]+(r[1]-i[1])*n[1]+(r[2]-i[2])*n[2];t.near=Math.min(t.near,s-r[3]),t.far=Math.max(t.far,s+r[3])}class F{constructor(){this._items=new t({allocator:t=>t||{object:null,distance:0,near:0,far:0},deallocator:t=>(t.object=null,t.distance=0,t.near=0,t.far=0,t)})}get length(){return this._items.length}get empty(){return 0===this._items.length}clear(){this._items.clear()}add(t){this._items.pushNew().object=t}sort(t){const e=t.eye,r=t.viewForward;this._items.forAll((t=>{const i=t.object.boundingVolumeWorldSpace.bounds,n=(i[0]-e[0])*r[0]+(i[1]-e[1])*r[1]+(i[2]-e[2])*r[2];t.distance=n,t.near=n-i[3],t.far=n+i[3]})),this._items.sort(((t,e)=>t.distance-e.distance))}forEachInDepthRange(t,e,r){if(e===p.DepthOrder.FRONT_TO_BACK)for(let i=0;i<this._items.length;++i){const e=this._items.data[i];e.far<t.near||e.near>t.far||r(e.object,e.near,e.far)}else for(let i=this._items.length-1;i>=0;--i){const e=this._items.data[i];e.far<t.near||e.near>t.far||r(e.object,e.near,e.far)}}}class I{constructor(){this._view=i(),this._viewProj=i(),this._frustum=h(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(t,i){this._reset(),r(this._view,t.viewMatrix),e(this._viewProj,t.projectionMatrix,this._view),f(this._frustum,t.frustum);const n=this._view,s=n[2],a=n[6],o=n[10],h=n[14];i.forAll((t=>{t.forEachGeometry((t=>{if(!t.visible||!t.castShadow)return;const e=t.boundingSphere,r=s*e[0]+a*e[1]+o*e[2]+h,i=r-e[3],n=r+e[3];this._geometries.push(t),this._near.push(-n),this._far.push(-i)}))}));const c=new g;if(0===this._geometries.length)return c;for(let e=0;e<this._geometries.length;++e)this._near[e]>c.far&&(c.far=this._near[e]),this._near[e]>2&&this._far[e]<c.near&&(c.near=this._far[e]);const l=this._looseRange;l.near=Math.max(.5*c.near,2),l.far=2*c.far;let _=0,u=0;for(let e=0;e<this._geometries.length;++e)this._near[e]<c.near&&(this._near[e]>=l.near?c.near=this._near[e]:this._nearCandidates[_++]=e),this._far[e]>c.far&&(this._far[e]<=l.far?c.far=this._far[e]:this._farCandidates[u++]=e);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return c;this._nearCandidates.sort(((t,e)=>this._near[t]<this._near[e]?-1:this._near[t]>this._near[e]?1:0)),this._farCandidates.sort(((t,e)=>this._far[t]<this._far[e]?1:this._far[t]>this._far[e]?-1:0));for(let e=0;e<this._nearCandidates.length;++e){const t=this._nearCandidates[e];if(this._near[t]<c.near){const e=this._geometries[t],r=e.boundingInfo;this._includeNearBoundingInfoRec(r,e.shaderTransformation,c)}}for(let e=0;e<this._farCandidates.length;++e){const t=this._farCandidates[e];if(this._far[t]>c.far){const e=this._geometries[t],r=e.boundingInfo;this._includeFarBoundingInfoRec(r,e.shaderTransformation,c)}}return this._reset(),c}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(t,e,r){if(null==t)return;const i=t.center;n(c(K),i,e);const s=_(e),a=K[0],o=K[1],h=K[2],f=t.radius*s,l=this._frustum;if(l[0][0]*a+l[0][1]*o+l[0][2]*h+l[0][3]>f||l[1][0]*a+l[1][1]*o+l[1][2]*h+l[1][3]>f||l[2][0]*a+l[2][1]*o+l[2][2]*h+l[2][3]>f||l[3][0]*a+l[3][1]*o+l[3][2]*h+l[3][3]>f)return;const u=this._view[2]*a+this._view[6]*o+this._view[10]*h+this._view[14],d=u+f;if(!(-(u-f)<2||-d>=r.near))if(-d>this._looseRange.near)r.near=-d;else{if(f>v){const i=t.getChildren();if(void 0!==i){for(const t of i)this._includeNearBoundingInfoRec(t,e,r);return}}U.unionDepthRangeWithAABB(r,this._viewProj,e,t.bbMin,t.bbMax)}}_includeFarBoundingInfoRec(t,e,r){if(null==t)return;let i=t.radius;const s=t.center;n(c(K),s,e);const a=_(e),o=K[0],h=K[1],f=K[2];i*=a;const l=this._frustum;if(l[0][0]*o+l[0][1]*h+l[0][2]*f+l[0][3]>i||l[1][0]*o+l[1][1]*h+l[1][2]*f+l[1][3]>i||l[2][0]*o+l[2][1]*h+l[2][2]*f+l[2][3]>i||l[3][0]*o+l[3][1]*h+l[3][2]*f+l[3][3]>i)return;const u=this._view[2]*o+this._view[6]*h+this._view[10]*f+this._view[14]-i;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(i>v){const i=t.getChildren();if(void 0!==i){for(const t of i)this._includeFarBoundingInfoRec(t,e,r);return}}U.unionDepthRangeWithAABB(r,this._viewProj,e,t.bbMin,t.bbMax)}}}class P{constructor(){this._modelViewProj=i(),this._clipPosition=[a(),a(),a(),a(),a(),a(),a(),a()]}unionDepthRangeWithAABB(t,r,i,n,s){const a=this._modelViewProj;e(a,r,i);let o=!1;for(let e=0;e<8;++e){const t=this._clipPosition[e],r=0===e||3===e||4===e||7===e?n[0]:s[0],i=0===e||1===e||4===e||5===e?n[1]:s[1],o=e<4?n[2]:s[2];t[0]=a[0]*r+a[4]*i+a[8]*o+a[12],t[1]=a[1]*r+a[5]*i+a[9]*o+a[13],t[2]=a[2]*r+a[6]*i+a[10]*o+a[14],t[3]=a[3]*r+a[7]*i+a[11]*o+a[15]}for(let e=0;e<12;++e){const r=y(this._clipPosition[E[e][0]],this._clipPosition[E[e][1]],this._clipPosition[E[e][2]]);let i=!0;for(let t=0;t<r.length;++t){if(r[t][3]>=2){i=!1;break}}if(!i){o=!0;for(let e=0;e<r.length;++e){const i=r[e][3];Number.isFinite(i)&&(t.near=Math.min(i,t.near),t.far=Math.max(i,t.far))}}}return o}}function y(t,e,r){let i=[t,e,r];for(let n=0;n<4;++n){const t=i;i=[];for(let e=0;e<t.length;++e){const r=t[e],s=t[(e+1)%t.length];N(s,n)?(N(r,n)||i.push(W(r,s,n)),i.push(s)):N(r,n)&&i.push(W(r,s,n))}}return i}function N(t,e){return 0===e?t[0]>=-t[3]:1===e?t[1]>=-t[3]:2===e?t[0]<=t[3]:3===e?t[1]<=t[3]:void b(!1)}function W(t,e,r){let i=0;return 0===r?i=(-t[3]-t[0])/(e[0]-t[0]+e[3]-t[3]):1===r?i=(-t[3]-t[1])/(e[1]-t[1]+e[3]-t[3]):2===r?i=(t[3]-t[0])/(e[0]-t[0]-e[3]+t[3]):3===r&&(i=(t[3]-t[1])/(e[1]-t[1]-e[3]+t[3])),s(a(),t,e,i)}const E=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],K=l(),S=i(),V=u(),k=new F,G=new I,U=new P;export{I as DepthRangeFromRenderGeometries,A as depthRangeFromScene};
