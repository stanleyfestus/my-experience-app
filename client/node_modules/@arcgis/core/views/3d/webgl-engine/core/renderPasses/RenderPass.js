/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../../../../core/PooledArray.js";import{RenderPassIdentifier as t}from"./AllRenderPasses.js";import{OITPass as r}from"../../lib/OITPass.js";import{DataType as i}from"../../../../webgl/enums.js";var s;!function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"}(s||(s={}));class o{constructor(t,r,i=s.FrontToBack){this._rctx=t,this._techniques=r,this._sorting=i,this._draws=new e({initialSize:32,allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,i,s){const o=this._draws.pushNew();o.geometry=t,o.geometryRanges=r,o.material=e,o.depthSquaredHint=i,o.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,o.highlightGroupName=s}acquire(e,t){return this._draws.map((r=>r.material.acquireTechnique(this._techniques,e,t,r.geometry.parameters)))}dispatch(e,i,s){const o=this._rctx;this._previouslyBoundDraw.clear();let a=null;const h=this._draws.length;for(let l=0;l<h;l++){const h=this._draws.data[l];if(e.identifier===t.Highlight){const{highlightGroupName:e}=h;if(e){if((i.highlightGroupIndices.get(e)??0)!==i.highlightLevel)continue}}const u=s[l];u===a&&i.oitPass===r.NONE||(o.bindTechnique(u,i,e),a=u);const{geometryRanges:c,indexType:d,geometry:g,material:m}=h;o.bindVAO(g.vao),this._previouslyBoundDraw.get(u)!==m&&(u.program.bindDraw(i,e,m),this._previouslyBoundDraw.set(u,m));const p=c.length,{primitiveType:w}=g;for(let e=0;e<p;e+=2){const t=c[e],r=c[e+1];if(0!==d){const e=n.get(d);o.drawElements(w,r,d,t*e)}else o.drawArrays(w,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===s.FrontToBack?1:-1;this._draws.sort(((t,r)=>{const i=e*(t.depthSquaredHint-r.depthSquaredHint);return 0!==i?i:t.geometry.vao.byteSize-r.geometry.vao.byteSize}))}get count(){return this._draws.length}}const n=new Map;n.set(i.UNSIGNED_BYTE,1),n.set(i.UNSIGNED_SHORT,2),n.set(i.UNSIGNED_INT,4);export{o as RenderPass,s as RenderPassSorting};
