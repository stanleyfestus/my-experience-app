/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{ViewingMode as t}from"../../../ViewingMode.js";import{GamepadKeyboardController as i}from"../../state/controllers/GamepadKeyboardController.js";import{InputHandler as e}from"../../../input/InputHandler.js";import{onVisibilityChange as o}from"../../../input/VisibilityChange.js";var r;!function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.FORWARD=2]="FORWARD",t[t.BACKWARD=3]="BACKWARD",t[t.UP=4]="UP",t[t.DOWN=5]="DOWN",t[t.HEADINGLEFT=6]="HEADINGLEFT",t[t.HEADINGRIGHT=7]="HEADINGRIGHT",t[t.TILTUP=8]="TILTUP",t[t.TILTDOWN=9]="TILTDOWN",t[t.ZOOMIN=10]="ZOOMIN",t[t.ZOOMOUT=11]="ZOOMOUT"}(r||(r={}));class n extends e{constructor(i,e){super(!0),this._view=i,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:t.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._keyToNumber={[e.left]:r.LEFT,[e.right]:r.RIGHT,[e.forward]:r.FORWARD,[e.backward]:r.BACKWARD,[e.up]:r.UP,[e.down]:r.DOWN,[e.headingLeft]:r.HEADINGLEFT,[e.headingRight]:r.HEADINGRIGHT,[e.tiltUp]:r.TILTUP,[e.tiltDown]:r.TILTDOWN,[e.zoomIn]:r.ZOOMIN,[e.zoomOut]:r.ZOOMOUT},this.registerIncoming("key-down",null,(t=>this._handleKeyDown(t))),this.registerIncoming("key-up",null,(t=>this._handleKeyUp(t))),this.registerIncoming("blur",null,(()=>this._handleStop())),this._visibilityHandle=o((t=>t?null:this._handleStop()))}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(t){this._stickyKeyDuration=t}_handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const e=this._keyToNumber[t.data.key];if(null!=e&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new i({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(t.stopPropagation(),this._cameraControllerKeyboard.directionActive(e))return;if(this._cameraControllerKeyboard.activateDirection(e),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(e))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout((()=>{this._stickyKeyTimeoutHandle=void 0,null!=this._stickyDirection&&void 0!==this._stickyDirection&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)}),this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const i=this._keyToNumber[t.data.key];if(null!=i&&this._cameraControllerKeyboard?.running){t.stopPropagation();const e=void 0===this._stickyKeyTimeoutHandle;if(void 0!==this._stickyKeyTimeoutHandle&&1===this._cameraControllerKeyboard?.countActiveDirections())return void(this._stickyDirection=i);this._cameraControllerKeyboard?.deactivateDirection(i),e&&(this._stickyDirection=void 0)}}_isPanning(t){return t<=3}}export{n as KeyboardNavigation};
