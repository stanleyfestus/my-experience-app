/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{pt2px as e}from"../../../../../../core/screenUtils.js";import r from"../../../../../../layers/support/OrderByInfo.js";import{TechniqueType as t}from"../../../../engine/webgl/shaderGraph/techniques/TechniqueType.js";import{createLabelMatcherSchema as i}from"./LabelMatcherSchema.js";import{createMatcherSchema as s}from"./MatcherSchema.js";import{createStorageSchema as n}from"./StorageSchema.js";import{createVisualVariableUniforms as l}from"./VisualVariablesSchema.js";async function a(e,r){const t=r.renderer,n=l(t);return{symbology:await s(e,t),labels:await i(e,r,n)}}async function o(e,r,t,i){const s=t.featureReduction;if(s)switch(s.type){case"binning":return f(s,e,r,t,i);case"cluster":return d(s,e,r,t,i)}const l=y(t.orderBy,t.renderer,t.objectIdField),o=n(t.renderer,r.filters),u=await a(e,t),c=m(u.symbology);return{storage:o,mesh:{properties:{sortKey:l,timeZone:r.timeZone,returnMeshObjectId:c,displayRefreshVersion:i},strategy:{type:"feature"},factory:u}}}function u(e,r){return e.fields.map((e=>({...e.toJSON(),type:c(e,r)})))}function c(e,r){const{onStatisticExpression:t,onStatisticField:i,statisticType:s}=e;switch(s){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:e}=t;return e?"string"===e?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const e=r.find((e=>e.name===i));return e?e.type:"esriFieldTypeString"}}}async function f(r,t,a,o,c){const f=u(r,o.fields),d=r.renderer,y=await s(t,d),p=n(d,[null,null]),g=l(d),b=await i(t,{geometryType:"polygon",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},g),h=m(y),v="geohash"===r.binType?{type:"geohash",fixBinLevel:r.fixedBinLevel??3}:{type:"grid",size:e(r.size),fixedBinLevel:r.fixedBinLevel};return{storage:p,mesh:{properties:{sortKey:null,timeZone:a.timeZone,returnMeshObjectId:h,displayRefreshVersion:c},strategy:{type:"binning",fields:f,index:v,featureFilter:a.filters[0]},factory:{labels:b,symbology:y}}}}async function d(r,t,a,o,c){const f=u(r,o.fields),d={type:"cluster",feature:await s(t,r.effectiveFeatureRenderer),cluster:await s(t,r.effectiveClusterRenderer)},y=l(r.effectiveFeatureRenderer),p={type:"cluster",feature:await i(t,o,y),cluster:await i(t,{geometryType:"point",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},y)},g=n(r.effectiveFeatureRenderer,[null,null]),b=m(d);return{storage:g,mesh:{properties:{sortKey:null,timeZone:a.timeZone,displayRefreshVersion:c,returnMeshObjectId:b},strategy:{type:"cluster",fields:f,featureFilter:a.filters[0],clusterRadius:e(r.clusterRadius/2)},factory:{labels:p,symbology:d}}}}function y(e,t,i){const s=null!=t&&"unique-value"===t.type&&t.orderByClassesEnabled;if("default"!==e||s||(e=[new r({field:i,order:"descending"})]),"default"!==e&&e?.length){e.length;const r=e[0],t="ascending"===r.order?"asc":"desc";return r.field?{field:r.field,order:t}:r.valueExpression?{expression:r.valueExpression,order:t}:null}if(s){return{byRenderer:!0,order:"asc"}}return null}function p(e){return e.techniqueType===t.AnimatedMarker}function m(e){if("simple"===e.type&&e.meshes.some(p))return!0;if("interval"===e.type){if(e.intervals.some((e=>e.meshes.some(p))))return!0;if(e.backgroundFill.some(p))return!0}if("map"===e.type){if(e.map.some((e=>e.symbol.some(p))))return!0;if(e.backgroundFill.some(p))return!0}return!1}export{o as createSimpleProcessorSchema,u as getAggregateFields};
