/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import has from"../../../../../core/has.js";import{clone as e}from"../../../../../core/lang.js";import{isHostedAgolService as t}from"../../../../../layers/support/arcgisLayerUrl.js";import{getEffectiveFeatureReduction as r}from"./featureReductionUtils.js";import{exceedsMinimumSnapshotCoverage as o}from"./featureServiceUtils.js";import{hasFloorFilter as s,addFloorFilter as i}from"./floorFilterUtils.js";import{getServiceGeometryType as a}from"./geometryUtils.js";import{getFeatureReductionDeconflictionEnabled as n,getLayerDeconflictionEnabled as l,createLabelVVEvaluator as p}from"./labelingUtils.js";import{createFeatureSourceSchema as d}from"../schema/SourceSchema.js";import{createSimpleProcessorSchema as u}from"../schema/processor/SimpleProcessorSchema.js";import{isRendererSupported as y}from"../support/rendererUtils.js";class c{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,r=n(t,e)??l(t);return[{vvEvaluators:{0:p(t.renderer)},deconflictionEnabled:r}]}async createServiceOptions(r){const s=this.layer,{capabilities:i,editingInfo:n,objectIdField:l,typeIdField:p,globalIdField:d,datesInUnknownTimezone:u,orderBy:y,subtypeField:c,refreshInterval:m}=s,f=s.fieldsIndex.toJSON(),h=a(s),b=s.timeInfo?.toJSON(),g=s.spatialReference.toJSON(),S=s.types?.map((e=>e.toJSON())),F=e(this.layer.parsedUrl);this.layer.dynamicDataSource&&(F.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let I=this.layer.objectIdField;if(y?.length){const e=!y[0].valueExpression&&y[0].field;e&&(I=e)}const x=!(null!=n?.lastEditDate)&&m>0,j=!!has("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!x,R=j&&o(r,s.fullExtent);return{type:"feature-service",source:F,isSourceHosted:t(F.path),orderByFields:I,outSpatialReference:r.spatialReference.toJSON(),metadata:{typeIdField:p??void 0,types:S,timeReferenceUnknownClient:u,subtypeField:c,globalIdField:d,fieldsIndex:f,geometryType:h,objectIdField:l,timeInfo:b,spatialReference:g,subtypes:this.layer.subtypes?.map((e=>e.toJSON()))},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:n?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:j,supportsSnapshotMaxThreshold:R,snapshotCountThresholds:{min:has("featurelayer-snapshot-point-min-threshold"),max:has("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:r,customParameters:o,gdbVersion:s,historicMoment:i,subtypeCode:a,subtypeField:n,timeExtent:l,apiKey:p}=this.layer;return d({definitionExpression:r,customParameters:o,gdbVersion:s,historicMoment:i,subtypeCode:a,subtypeField:n,timeExtent:l},e,t,p)}createProcessorSchema(e,t,o){const{fields:s,renderer:i,geometryType:a,labelingInfo:n,labelsVisible:l,orderBy:p,objectIdField:d}=this.layer,y={fields:s.map((e=>e.toJSON())),renderer:i?.clone(),featureReduction:r(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:l,objectIdField:d,orderBy:p??"default"};return u(e,t,y,o)}get hasRequiredSupport(){return y(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return s(this.layer,e)}addFilters(e,t){return i(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:o,renderer:i,gdbVersion:a,apiKey:n,subtypeCode:l}=t,p=this.layer.labelsVisible?this.layer.labelingInfo:null,d=t.historicMoment?.getTime()??void 0,u=JSON.stringify(t.customParameters),y=r(t,e),c=JSON.stringify(t.orderBy),m=s(this.layer,e)?e.floors:null;return{outFields:this.layer.outFields,apiKey:n,customParameters:u,definitionExpression:o,featureReduction:y,floors:m,gdbVersion:a,historicMoment:d,labelingInfo:p,orderBy:c,renderer:i,subtypeCode:l}}}export{c as FeatureLayerAdapter};
