/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{clone as e}from"../../../../../core/lang.js";import{isHostedAgolService as r}from"../../../../../layers/support/arcgisLayerUrl.js";import{getServiceGeometryType as t}from"./geometryUtils.js";import{getLayerDeconflictionEnabled as o,createLabelVVEvaluator as s}from"./labelingUtils.js";import{createFeatureSourceSchema as i}from"../schema/SourceSchema.js";import{createSimpleProcessorSchema as a}from"../schema/processor/SimpleProcessorSchema.js";import{isRendererSupported as n}from"../support/rendererUtils.js";class l{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,t=o(r);return[{vvEvaluators:{0:s(r.renderer)},deconflictionEnabled:t}]}async createServiceOptions(o){const s=this.layer,{capabilities:i,editingInfo:a,objectIdField:n,globalIdField:l,datesInUnknownTimezone:p,orderBy:u,parsedUrl:c}=s,d=s.fieldsIndex.toJSON(),m=t(s),y=s.timeInfo?.toJSON(),f=s.spatialReference.toJSON(),g=e(c);let h=n;if(u?.length){const e=!u[0].valueExpression&&u[0].field;e&&(h=e)}return{type:"feature-service",source:g,isSourceHosted:r(g.path),orderByFields:h,outSpatialReference:o.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:p,globalIdField:l,fieldsIndex:d,geometryType:m,objectIdField:n,timeInfo:y,spatialReference:f,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:a?.lastEditDate?.getTime(),snapshotInfo:null}}}createSourceSchema(e,r){const{definitionExpression:t,customParameters:o,timeExtent:s,apiKey:a}=this.layer;return i({definitionExpression:t,customParameters:o,timeExtent:s},e,r,a)}createProcessorSchema(e,r,t){const{fields:o,geometryType:s,orderBy:i,objectIdField:n,renderer:l,labelingInfo:p,labelsVisible:u}=this.layer,c={featureReduction:null,fields:o.map((e=>e.toJSON())),geometryType:s,labelingInfo:p,labelsVisible:u,objectIdField:n,orderBy:i??"default",renderer:l?.clone()};return a(e,r,c,t)}get hasRequiredSupport(){return n(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:t,apiKey:o,renderer:s}=r,i=this.layer.labelsVisible?this.layer.labelingInfo:null,a=JSON.stringify(r.customParameters),n=JSON.stringify(r.orderBy);return{outFields:this.layer.outFields,apiKey:o,customParameters:a,definitionExpression:t,labelingInfo:i,orderBy:n,renderer:s}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer}}}export{l as CatalogFootprintLayerAdapter};
