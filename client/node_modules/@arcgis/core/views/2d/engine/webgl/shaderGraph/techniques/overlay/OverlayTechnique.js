/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{destroyMaybe as e}from"../../../../../../../core/maybe.js";import{Mesh as t}from"../../../meshing/Mesh.js";import{simplePipelineState as s}from"../../utils.js";import{Technique as i}from"../Technique.js";import{TechniqueType as o}from"../TechniqueType.js";import{OverlayShader as r}from"../shaders/OverlayShader.js";import{CompareFunction as n,StencilOperation as a,DataType as p,PrimitiveType as h}from"../../../../../../webgl/enums.js";class u extends i{constructor(){super(...arguments),this.type=o.Overlay,this._mesh=null,this.shaders={overlay:new r}}render(e,t){const{context:i,painter:o}=e,r=this._getMesh(e,t);o.setPipelineState(s);const{isWrapAround:p,wrapAroundShift:h}=t.config,u={...t.config,wrapAroundShift:0},m={shader:this.shaders.overlay,uniforms:{transform:t.transform,config:u},defines:null,optionalAttributes:null,useComputeBuffer:!1};o.setPipelineState({...s,stencil:{write:!1,test:{compare:n.EQUAL,op:{fail:a.KEEP,zFail:a.KEEP,zPass:a.REPLACE},ref:0,mask:255}}}),o.submitDrawMeshUntyped(i,m,r),p&&(u.wrapAroundShift=h,o.submitDrawMeshUntyped(i,m,r))}shutdown(){e(this._mesh)}_getMesh(e,s){const{context:i}=e;if(this._mesh){const e=this._mesh.vertexBuffers.get("positions");if(!e)throw new Error("Buffer not found");e.setData(s.position)}else{const e=null!=s.index?s.index.length:s.position.length/2;this._mesh=new t(i,{vertex:{positions:s.position,uvs:s.tex},index:null!=s.index?{index:s.index}:void 0,groups:[{attributes:[{name:"pos",count:2,type:p.FLOAT,location:0,vertex:"positions",stride:8,offset:0},{name:"tex",count:2,type:p.UNSIGNED_SHORT,location:1,vertex:"uvs",stride:4,offset:0}],index:null!=s.index?"index":void 0,primitive:h.TRIANGLE_STRIP}],parts:[{group:0,start:0,count:e}]})}return this._mesh}}export{u as OverlayTechnique};
