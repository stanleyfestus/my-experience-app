/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Graphic.js";import r from"../../core/Error.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as a}from"../../core/accessorSupport/decorators/subclass.js";import{combineTimeExtent as i}from"../../layers/support/timeSupport.js";import{getDefaultDatumTransformationForDataset as o,projectDatasetExtent as n}from"../../layers/support/rasterFunctions/rasterProjectionHelper.js";import{getFetchPopupTemplate as l}from"./support/popupUtils.js";const u=u=>{let p=class extends u{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return i(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?o(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(e){try{return!this.layer.loaded||!!n(this.layer.serviceRasterInfo,e)}catch{return!1}}async fetchPopupFeaturesAtLocation(e,s){const{layer:a}=this;if(!e)throw new r("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:a});const{popupEnabled:i}=a,o=l(a,s);if(!i||null==o)return[];const n=[],{value:u,magdirValue:p,processedValue:c}=await a.identify(e,{timeExtent:this.timeExtent,signal:s?.signal});let m="";if(u?.length){m="imagery-tile"===a.type&&a.hasStandardTime()&&null!=u[0]?u.map((e=>a.getStandardTimeValue(e))).join(", "):u.join(", ");const e={ObjectId:0},r="Raster.ServicePixelValue";e[r]="imagery-tile"===a.type&&"Function"===a.raster.datasetFormat?c?.join(", "):m,e[r+".Raw"]=m;const s=a.raster?.rasterInfo??a.serviceRasterInfo,i=s?.attributeTable;if(null!=i){const{fields:t,features:s}=i,a=t.find((({name:e})=>"value"===e.toLowerCase())),o=e[r],n=a?s.find((e=>String(e.attributes[a.name])===o)):null;if(n)for(const r in n.attributes)if(n.attributes.hasOwnProperty(r)){e[this._rasterFieldPrefix+r]=n.attributes[r]}}const o=s?.dataType;"vector-magdir"!==o&&"vector-uv"!==o||(e["Raster.Magnitude"]=p?.[0],e["Raster.Direction"]=p?.[1]);const l=new t({geometry:this.fullExtent?.clone(),attributes:e,layer:a,sourceLayer:a});n.push(l)}return n}_getFullExtent(){return n(this.layer.serviceRasterInfo,this.view.spatialReference)}};return e([s()],p.prototype,"fullExtent",null),e([s()],p.prototype,"layer",void 0),e([s({readOnly:!0})],p.prototype,"timeExtent",null),e([s()],p.prototype,"tileInfo",void 0),e([s({readOnly:!0})],p.prototype,"hasTilingEffects",null),e([s()],p.prototype,"datumTransformation",null),p=e([a("esri.views.layers.ImageryTileLayerView")],p),p};export{u as default};
