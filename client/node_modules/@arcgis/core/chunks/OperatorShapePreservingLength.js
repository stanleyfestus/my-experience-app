/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{t as e,G as t,c as s,e as n}from"./Geometry.js";import{O as o,au as a,t as r,e as i,v as c,G as g,a as m,b as u,ad as h,a2 as y,an as p}from"./QuadraticBezier.js";import{j as l,P as _}from"./Transformation2D.js";function x(){return{m_pGcs:new _,m_xyz:new p,m_factor:Number.NaN,m_geoLength:Number.NaN,setValues:f,setLength:d,assign:S}}function f(e,t,s,n){this.m_factor=e,this.m_pGcs.assign(t),this.m_xyz.assign(n),this.m_geoLength=s}function d(e){this.m_geoLength=e}function S(e){this.m_pGcs.assign(e.m_pGcs),this.m_xyz.assign(e.m_xyz),this.m_factor=e.m_factor,this.m_geoLength=e.m_geoLength}class w{getOperatorType(){return 10315}supportsCurves(){return!0}accelerateGeometry(e,t,s){return!1}canAccelerateGeometry(e){return!1}_ExecuteShapePreservingLength(e,t,s,n,g){if(e.hasNonLinearSegments()){e=(new o).execute(e,0,t.getTolerance(0),0,g)}if(t.isPannable()){let n=90,o=-90;if(1===s.getUnit().getUnitToBaseFactor()&&(n*=Math.PI/180,o*=Math.PI/180),2===t.getCoordinateSystemType()){let e=null;const s=[0,0,0,0];e=t.getPECoordSys(),s[0]=0,s[1]=n,s[2]=0,s[3]=o,a.geogToProj(e,2,s),n=s[1],o=s[3]}const c=new r;e.queryEnvelope(c),c.ymin=o,c.ymax=n,e=(new i).execute(e,c,t,g)}else{const s=t.getPCSHorizon();if((e=(new c).execute(e,s,t,g))===s){const t=e.clone();e=t}}return e.isEmpty()?0:this._ExecuteIterativeApproach(e,t,s,n,1,g)}_ExecuteIterativeApproach(e,t,s,o,r,i){const c=y();s.querySpheroidData(c);const g=c.majorSemiAxis,m=c.e2,u=s.getUnit().getUnitToBaseFactor(),h=40,f=l(x,h),d=new Array(h),S=x(),w=x();let G;const E=[0,0,0,0],N=t.getPECoordSys(),L=new _,T=new _,v=new _,b=new _,z=new _;let D=0;const j=e.querySegmentIterator();for(;j.nextPath();)for(;j.hasNextSegment();){const e=j.nextSegment();L.assign(e.getStartXY()),T.assign(e.getEndXY()),2===t.getCoordinateSystemType()?(E[0]=L.x,E[1]=L.y,E[2]=T.x,E[3]=T.y,a.projToGeog(N,2,E),v.x=E[0]*u,v.y=E[1]*u,b.x=E[2]*u,b.y=E[3]*u):(v.setCoordsPoint2D(L),b.setCoordsPoint2D(T),v.scale(u),b.scale(u));const s=new p,o=new p;P(g,m,v,s),P(g,m,b,o);let i=C(g,s,o);S.setValues(0,v,Number.NaN,s),w.setValues(1,b,i,o),G=r,f[0].assign(w),d[0]=r;let c=0;for(;;){c>128&&n("iterations exceeded");const s=.5*(S.m_factor+w.m_factor),o=e.getCoord2D(s);2===t.getCoordinateSystemType()?(E[0]=o.x,E[1]=o.y,a.projToGeog(N,1,E),z.x=E[0]*u,z.y=E[1]*u):(z.setCoordsPoint2D(o),z.scale(u)),v.setCoordsPoint2D(S.m_pGcs),b.setCoordsPoint2D(w.m_pGcs);const y=new p;P(g,m,z,y);const l=C(g,S.m_xyz,y),_=C(g,w.m_xyz,y);i=w.m_geoLength,Number.isNaN(i)&&(i=C(g,S.m_xyz,w.m_xyz));const x=l+_,L=G===r&&x>=20&&Math.abs(x-i)>1e-8*(i+x);if(c+2<h&&(L||Math.abs(x-i)>0&&G>0))w.setLength(_),f[c].assign(w),w.setValues(s,z,l,y),f[++c].assign(w),L?(G=r,d[c]=r):(G--,d[c-1]=G,d[c]=G);else{if(D+=x,0===c)break;S.assign(w),w.assign(f[--c]),G=d[c]}}}return D}execute(n,o,a){if(o&&0!==o.getCoordinateSystemType()||e(""),n.isEmpty()||n.getDimension()<1)return 0;let r=null;const i=o.getGCS();i!==o&&(r=g(o,i,null));const c=n.getGeometryType();if(c===t.enumEnvelope){const e=new m;return e.addEnvelope(n,!1),this._ExecuteShapePreservingLength(e,o,i,r,a)}if(s(c)){const e=new u;return e.addSegment(n,!0),this._ExecuteShapePreservingLength(e,o,i,r,a)}return this._ExecuteShapePreservingLength(n,o,i,r,a)}}function P(e,t,s,n){n.assign(h(e,t,s))}function C(e,t,s){const n=e,o=new p;o.setSub(t,s);const a=o.length();return 2*n*Math.asin(a/(2*n))}export{w as O};
