/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import t from"../../core/Logger.js";import{animationDebugFlags as r}from"./animationDebugFlags.js";import{defaultCIMValues as e}from"./defaultCIMValues.js";import{AnimatedSymbolRepeatType as n,AnimatedSymbolEasingType as o}from"./enums.js";import{getProcessParam as i,getValue as a,getSize as s}from"./utils.js";import{TimeOrigin as m}from"../../views/2d/engine/webgl/animations/instructions.js";function l(t,r,e){return{transform:A(t,r,e.transform),fromColor:d(t,r,e.fromColor),toColor:b(t,r,e.toColor),colorMix:P(t,r,e.colorMix),toOpacity:g(t,r,e.toOpacity),opacityMix:I(t,r,e.opacityMix),hasAnimations:e.hasAnimations||!!r.animations&&r.animations.length>0}}function c(t){return!r.forceStaticPath&&(r.forceAnimatedPath||t.hasAnimations)}function f(r,e,n){if("CIMCharacterMarker"===e.type)return t.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),n;const o=i(r,e,"OffsetX"),a=i(r,e,"OffsetY");if("CIMPictureMarker"===e.type)return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:v([o,a]),rotation:v(0),scale:v(i(r,e,"Size")),parent:n.transform}};const s=e.frame,m=s.ymax-s.ymin;return{...n,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:v([o,a]),rotation:v(0),scale:v({type:"Process",op:"Divide",left:i(r,e,"Size"),right:m}),parent:n.transform}}}function p(t,r){let e=0,n=0;const o="Absolute"!==t.anchorPointUnits;return t.anchorPoint&&(e=-t.anchorPoint.x,n=-t.anchorPoint.y),{...r,transform:{type:"AnimatedTransform",relativeTranslation:o,absoluteScale:!1,translation:v([e,n]),rotation:v(0),scale:v(1),parent:r.transform}}}function u(t,r){return"Absolute"===t.anchorPointUnits?r:p(t,r)}function y(t,r){return"Absolute"!==t.anchorPointUnits?r:p(t,r)}function C(t,r,e){return{...t,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:v([r,e]),rotation:v(0),scale:v(1),parent:t.transform}}}function M(t,r){switch(r.type){case"CIMPictureMarker":case"CIMVectorMarker":return i(t,r,"Rotation")}return 0}function S(t,r){switch(r.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return i(t,r,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return i(t,r,"TintColor")}return[1,1,1,1]}function A(t,r,e){return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:k(t,r),rotation:O(t,r),scale:h(t,r),parent:e}}function d(t,r,e){return{type:"AnimatedColor",color:v(S(t,r)),opacity:v(1),parent:e}}function b(t,r,e){const{animations:n}=r;let o=S(t,r);const a=n?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return a&&(o=i(t,a,"ToColor")),{type:"AnimatedColor",color:v(o),opacity:v(1),parent:e}}function P(t,r,e){const{animations:n}=r,o=n?.filter((t=>"CIMSymbolAnimationColor"===t.type))[0];return o?{type:"AnimatedColor",color:v([1,1,1,1]),opacity:{from:0,to:1,timing:T(t,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:e}function g(t,r,e){const{animations:n}=r;let o=v(1);const a=n?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];if(a){o=v({type:"Process",op:"Transparency",value:i(t,a,"ToTransparency")})}return{type:"AnimatedColor",color:v([1,1,1,1]),opacity:o,parent:e}}function I(t,r,e){const{animations:n}=r,o=n?.filter((t=>"CIMSymbolAnimationTransparency"===t.type))[0];return o?{type:"AnimatedColor",color:v([1,1,1,1]),opacity:{from:0,to:1,timing:T(t,o?.animatedSymbolProperties)},parent:[1,1,1,1]}:e}function T(t,r){if(!r)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:m.Local,repeatType:n.Loop,easing:o.Linear,playAnimation:1,reverseAnimation:0};const s=i(t,r,"Duration");let l;if(i(t,r,"RandomizeStartTime")){l={type:"Process",op:"Random",min:0,max:s,seed:i(t,r,"RandomizeStartSeed")}}else l=i(t,r,"StartTimeOffset");const c=i(t,r,"RepeatDelay"),f=i(t,r,"PlayAnimation"),p=i(t,r,"ReverseAnimation"),u=a(r.repeatType,e.CIMAnimatedSymbolProperties.repeattype);return{duration:s,startTimeOffset:l,repeatDelay:c,timeOriginSelector:u===n.None?m.Local:m.Global,repeatType:u,easing:a(r.easing,e.CIMAnimatedSymbolProperties.easing),playAnimation:f,reverseAnimation:p}}function h(t,r){const{animations:e}=r;if("CIMPictureMarker"!==r.type&&"CIMVectorMarker"!==r.type&&"CIMPointSymbol"!==r.type)return v(1);let n;n="CIMPictureMarker"===r.type||"CIMVectorMarker"===r.type?i(t,r,"Size"):s(r)||10;const o=e?.filter((t=>"CIMSymbolAnimationScale"===t.type))[0];if(!o){const r=e?.filter((t=>"CIMSymbolAnimationSize"===t.type))[0];if(!r)return v(1);return{from:1,to:{type:"Process",op:"Divide",left:i(t,r,"ToSize"),right:n},timing:T(t,r.animatedSymbolProperties)}}return{from:1,to:i(t,o,"ScaleFactor"),timing:T(t,o.animatedSymbolProperties)}}function k(t,r){const{animations:e}=r,n=e?.filter((t=>"CIMSymbolAnimationOffset"===t.type))[0];if(!n)return v([0,0]);return{from:[0,0],to:[i(t,n,"OffsetX"),i(t,n,"OffsetY")],timing:T(t,n.animatedSymbolProperties)}}function O(t,r){const{animations:e}=r,n=M(t,r),o=e?.filter((t=>"CIMSymbolAnimationRotation"===t.type))[0];if(!o)return v(n);return{from:n,to:i(t,o,"ToRotation"),timing:T(t,o.animatedSymbolProperties)}}function v(t){return{from:t,to:t,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:m.Local,repeatType:n.Loop,easing:o.Linear,playAnimation:1,reverseAnimation:0}}}function L(t){if(null==t)return!1;if("object"!=typeof t)return!1;if(t.animations&&Array.isArray(t.animations)&&t.animations.length>0)return!0;for(const r in t)if(L(t[r]))return!0;return!1}export{L as checkForAnimations,l as getAnimationParams,v as getStaticParam,y as handleAbsoluteAnchor,p as handleAnchor,f as handleMarker,u as handleRelativeAnchor,c as shouldUseAnimatedPath,C as translate};
