/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{isRGB as e}from"../../core/colorUtils.js";import{getFontFamily as r}from"../../core/fontUtils.js";import{clone as t}from"../../core/lang.js";import i from"../../core/Logger.js";import{pt2px as o,px2pt as a}from"../../core/screenUtils.js";import{numericHash as s}from"../../core/string.js";import{checkForAnimations as l,getAnimationParams as n,handleAbsoluteAnchor as p,handleMarker as c,handleRelativeAnchor as m,translate as y,getStaticParam as f,shouldUseAnimatedPath as h}from"./animationUtils.js";import{CIMSymbolHelper as d}from"./CIMSymbolHelper.js";import{defaultCIMValues as u}from"./defaultCIMValues.js";import{Alignment as v}from"./enums.js";import{OverrideHelper as O}from"./OverrideHelper.js";import{getExtent as _,getSDFMetrics as S,getSDFDimensions as g}from"./SDFHelper.js";import{colorToArray as M,normalizeAlpha as k,getSize as b,isCIMMarkerStrokePlacement as C,getTintColor as P,getNumericValue as x,normalizePrimitiveOverrideProps as z,getDefaultCIMValue as L,getEnum as I,getStrokeWidth as E,getFillColor as V,getStrokeColor as N,fromCIMFontDecoration as R,fromCIMFontStyle as w,fromCIMHorizontalAlignment as A,fromCIMVerticalAlignment as G,isValidCIMValue as X,uncapitalize as F}from"./utils.js";import{CIMEffectHelper as T}from"./effects/CIMEffectHelper.js";import{randomInsidePolygonTextureSize as Y}from"../../views/2d/engine/webgl/definitions.js";const j=()=>i.getLogger("esri.symbols.cim.cimAnalyzer");function W(e){const r=e.markerPlacement;return r&&r.angleToLine?v.MAP:v.SCREEN}class D{constructor(e){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],e&&(this._resourceManager=e)}analyzeSymbolReference(r,t,i){if(this._cimLayers=i??[],!r)return this._cimLayers;if(this._reset(),r.primitiveOverrides){this._primitiveOverrides=r.primitiveOverrides;for(const r of this._primitiveOverrides){const t=r.valueExpressionInfo;if(t)this._setPoMap(r.primitiveName,r.propertyName,t);else if(null!=r.value){let t=r.value;r.propertyName.includes("Color")&&(e(t)&&(t=M(t)),t=k(t)),this._setPoMap(r.primitiveName,r.propertyName,t)}}}return this._analyzeSymbol(r.symbol,t),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(e,r){switch(e?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(e,r)}}_analyzeMultiLayerSymbol(e,r){const t=e?.symbolLayers;if(!t)return;const i=e.effects;let o=v.SCREEN;const a=b(e)??0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(o=v.MAP);let s={transform:[0,0,0,1],fromColor:[1,1,1,1],toColor:[1,1,1,1],colorMix:[0,0,0,0],toOpacity:[1,1,1,1],opacityMix:[0,0,0,0],hasAnimations:l(e)};s=n(this._poMap,e,s);const p="CIMPolygonSymbol"===e.type;let c=t.length;for(;c--;){const l=t[c];if(!l||!1===l.enable)continue;let n;i?.length&&(n=[...i]);const m=l.effects;m?.length&&(i?n.push(...m):n=[...m]);let y=null;if(n){y=[];for(const e of n){const r=O.findEffectOverrides(e,this._primitiveOverrides);r&&y.push(r)}}const f=[];switch(O.findApplicableOverrides(l,this._primitiveOverrides,f),l.type){case"CIMSolidFill":this._analyzeSolidFill(l,y);break;case"CIMPictureFill":this._analyzePictureFill(l,y);break;case"CIMHatchFill":this._analyzeHatchFill(l,y);break;case"CIMGradientFill":this._analyzeGradientFill(l,y);break;case"CIMSolidStroke":this._analyzeSolidStroke(l,y,p,a);break;case"CIMPictureStroke":this._analyzePictureStroke(l,y,p,a);break;case"CIMGradientStroke":this._analyzeGradientStroke(l,y,p,a);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==e.type&&"CIMPolygonSymbol"!==e.type||(o=W(l));const t=[],i=l.primitiveName;i&&t.push(i);const n=p&&C(l.markerPlacement);this._analyzeMarker(l,y,null,t,o,a,r,[],s,!1,n);break}default:j().error("Cannot analyze CIM layer",l.type)}}}_analyzeSolidFill(e,r){const{primitiveName:t,type:i}=e,o=k(e.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,color:this._getValueOrOverrideExpression(i,t,"Color",o),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:r,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(e,r){const{primitiveName:t,type:i}=e,o=P(e),a=x(e.height,u.CIMPictureFill.height);let s=x(e.scaleX,1);if("width"in e&&"number"==typeof e.width){const r=e.width;let t=1;const i=this._resourceManager.getResource(e.url);null!=i&&(t=i.width/i.height),s/=t*(a/r)}const l={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(t,i)};this._cimLayers.push({type:"fill",spriteRasterizationParam:l,colorLocked:!!e.colorLocked,effects:r,color:this._getValueOrOverrideExpression(i,t,"TintColor",o),height:this._getValueOrOverrideExpression(i,t,"Height",a),scaleX:this._getValueOrOverrideExpression(i,t,"ScaleX",s),angle:this._getValueOrOverrideExpression(i,t,"Rotation",x(e.rotation)),offsetX:this._getValueOrOverrideExpression(i,t,"OffsetX",x(e.offsetX)),offsetY:this._getValueOrOverrideExpression(i,t,"OffsetY",x(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(e,r){const{primitiveName:t,type:i}=e,o=this._analyzeMaterialOverrides(t,["Rotation","OffsetX","OffsetY"]),a=z(o);let s=[255,255,255,1],l=!1;if(e.lineSymbol?.symbolLayers)for(const p of e.lineSymbol.symbolLayers){if("CIMSolidStroke"!==p.type)continue;const e=p.primitiveName??t;l||!e||p.colorLocked||null==this._poMap[e]?.Color&&null==this._poMap[e]?.StrokeColor||(s=k(p.color),s=this._maybeGetValueOrOverrideExpression(e,"StrokeColor")??this._getValueOrOverrideExpression(i,e,"Color",s),l=!0);const r=this._maybeGetValueOrOverrideExpression(e,"StrokeWidth");if(r){let t=null,o=null;"number"==typeof r?t=r:o=r.valueExpressionInfo;let s=a.find((e=>"strokeWidth"===e.propertyName));s?s.propertyName="width":(s={type:"CIMPrimitiveOverride",primitiveName:e,propertyName:"width",valueExpressionInfo:o,value:t,defaultValue:L(i,"width")},a.push(s))}}const n={type:"sprite-rasterization-param",resource:e,overrides:a};this._cimLayers.push({type:"fill",spriteRasterizationParam:n,colorLocked:!!e.colorLocked,effects:r,color:s,height:this._getValueOrOverrideExpression(i,t,"Separation",x(e.separation,u.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(i,t,"Rotation",x(e.rotation)),offsetX:this._getValueOrOverrideExpression(i,t,"OffsetX",x(e.offsetX)),offsetY:this._getValueOrOverrideExpression(i,t,"OffsetY",x(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!l})}_analyzeGradientFill(e,r){this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,effects:r,color:[128,128,128,1],height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeSolidStroke(e,r,t,i){const{primitiveName:o,type:a}=e,s=k(e.color),l=x(e.width,u.CIMSolidStroke.width),n=I(e.capStyle,u.CIMSolidStroke.capstyle),p=I(e.joinStyle,u.CIMSolidStroke.joinstyle),c=e.miterLimit;let m,y,f,h,d=[];if(this._analyzePrimitiveOverrides(o,r,null,null)&&(d=this._getPrimitiveMaterialOverrides(o,a)),r&&Array.isArray(r)&&r.length>0){const e=r[r.length-1].effect;e&&"CIMGeometricEffectDashes"===e.type&&"NoConstraint"===e.lineDashEnding&&(m=e.dashTemplate,y=e.scaleDash,f=e.offsetAlongLine,h=e.primitiveName,(r=[...r]).pop())}null!=h&&d.push(...this._getPrimitiveMaterialOverrides(h,a).filter((e=>"dashTemplate"===e.propertyName)));const v=void 0!==m?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:m,primitiveName:h},overrides:d}:null;this._cimLayers.push({type:"line",spriteRasterizationParam:v,isOutline:t,colorLocked:!!e.colorLocked,effects:r,color:this._getValueOrOverrideExpression(a,o,"Color",s),width:this._getValueOrOverrideExpression(a,o,"Width",l),cap:this._getValueOrOverrideExpression(a,o,"CapStyle",n),join:this._getValueOrOverrideExpression(a,o,"JoinStyle",p),miterLimit:c&&this._getValueOrOverrideExpression(a,o,"MiterLimit",c),referenceWidth:i,zOrder:U(e.name),dashTemplate:this._maybeGetValueOrOverrideExpression(h,"DashTemplate")??m,offsetAlongLine:this._getValueOrOverrideExpression(a,h,"OffsetAlongLine",f??0),scaleDash:y,sampleAlphaOnly:!0})}_analyzePictureStroke(e,r,t,i){const{primitiveName:o,type:a}=e,s=P(e),l=x(e.width,u.CIMPictureStroke.width),n=I(e.capStyle,u.CIMPictureStroke.capstyle),p=I(e.joinStyle,u.CIMPictureStroke.joinstyle),c=e.miterLimit,m={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(o,a)};this._cimLayers.push({type:"line",spriteRasterizationParam:m,isOutline:t,colorLocked:!!e.colorLocked,effects:r,color:this._getValueOrOverrideExpression(a,o,"TintColor",s),width:this._getValueOrOverrideExpression(a,o,"Width",l),cap:this._getValueOrOverrideExpression(a,o,"CapStyle",n),join:this._getValueOrOverrideExpression(a,o,"JoinStyle",p),miterLimit:c&&this._getValueOrOverrideExpression(a,o,"MiterLimit",c),referenceWidth:i,zOrder:U(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(e,r,t,i){const{primitiveName:o,type:a}=e,s=x(e.width,u.CIMSolidStroke.width),l=I(e.capStyle,u.CIMGradientStroke.capstyle),n=I(e.joinStyle,u.CIMGradientStroke.joinstyle),p=e.miterLimit;this._cimLayers.push({type:"line",spriteRasterizationParam:null,isOutline:t,colorLocked:!!e.colorLocked,effects:r,color:[128,128,128,1],width:this._getValueOrOverrideExpression(a,o,"Width",s),cap:this._getValueOrOverrideExpression(a,o,"CapStyle",l),join:this._getValueOrOverrideExpression(a,o,"JoinStyle",n),miterLimit:p&&this._getValueOrOverrideExpression(a,o,"MiterLimit",p),referenceWidth:i,zOrder:U(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(e,r,t,i,o,a,s,l,y,f=!1,h=!1){if(f||=!!e.colorLocked,this._analyzeMarkerInsidePolygon(e,r,f))return;const d=x(e.size,u.CIMVectorMarker.size),v=x(e.rotation),O=x(e.offsetX),_=x(e.offsetY),{primitiveName:S,type:g}=e,M=this._getValueOrOverrideExpression(g,S,"Size",d),k=this._getValueOrOverrideExpression(g,S,"Rotation",v),b=this._getValueOrOverrideExpression(g,S,"OffsetX",O),C=this._getValueOrOverrideExpression(g,S,"OffsetY",_);let P=y;switch(P=p(e,P),P=c(this._poMap,e,P),P=m(e,P),P=n(this._poMap,e,P),e.type){case"CIMPictureMarker":this._analyzePictureMarker(e,r,t,i,o,a,M,k,b,C,l,P,f,h);break;case"CIMVectorMarker":this._analyzeVectorMarker(e,r,t,i,o,a,M,k,b,C,l,P,s,f,h)}}_analyzeMarkerInsidePolygon(e,r,t){const{markerPlacement:i,type:o}=e;if(!i||"CIMMarkerPlacementInsidePolygon"!==i.type)return!1;if("CIMVectorMarker"===o||"CIMPictureMarker"===o){const t=e.primitiveName;if(t&&this._analyzePrimitiveOverrides([t],r,null,null))return!1;const a=i.primitiveName;if(a&&this._analyzePrimitiveOverrides([a],r,null,null))return!1;if("CIMVectorMarker"===o){const{markerGraphics:r}=e;if(r)for(const e of r){const{symbol:r}=e;if("CIMPolygonSymbol"===r?.type&&r.symbolLayers){const{symbolLayers:e}=r;for(const r of e)if("CIMSolidStroke"===r.type)return!1}}}else{const{animatedSymbolProperties:r}=e;if(r)return!1}}const s=Math.abs(i.stepX),l=Math.abs(i.stepY);if(0===s||0===l)return!0;let n,p;if("Random"===i.gridType){const e=a(Y),r=Math.max(Math.floor(e/s),1);n=l*Math.max(Math.floor(e/l),1);p=r*s/n}else i.shiftOddRows?(n=2*l,p=s/l*.5):(n=l,p=s/l);const c=P(e),m="CIMCharacterMarker"===e.type?null:{type:"sprite-rasterization-param",resource:e,overrides:[]};return this._cimLayers.push({type:"fill",spriteRasterizationParam:m,colorLocked:t,effects:r,color:c,height:n,scaleX:p,angle:i.gridAngle,offsetX:x(i.offsetX),offsetY:x(i.offsetY),applyRandomOffset:"Random"===i.gridType,sampleAlphaOnly:"CIMPictureMarker"!==e.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(e,r,i,o,a,l,n,p,c,m,y,f,h,d){const{animatedSymbolProperties:u,primitiveName:v,type:O}=e;let _=x(e.scaleX,1);const S=P(e);i||(i=this._createMarkerPlacementOverrideExpression(e.markerPlacement));const g=this._createGIFAnimatedSymbolPropertiesOverrideExpression(u),M=e.anchorPoint??{x:0,y:0};if("width"in e&&"number"==typeof e.width){const r=e.width;let t=1;const i=this._resourceManager.getResource(e.url);null!=i&&(t=i.width/i.height);_/=t*(x(e.size)/r)}const k=[...o];let b;e.primitiveName&&k.push(e.primitiveName),u||g?b={type:"animated",url:e.url,urlHash:"H"+s(e.url),playAnimation:e.animatedSymbolProperties?.playAnimation,reverseAnimation:e.animatedSymbolProperties?.reverseAnimation,randomizeStartTime:e.animatedSymbolProperties?.randomizeStartTime,randomizeStartSeed:e.animatedSymbolProperties?.randomizeStartSeed,startTimeOffset:e.animatedSymbolProperties?.startTimeOffset,duration:e.animatedSymbolProperties?.duration,repeatType:e.animatedSymbolProperties?.repeatType,repeatDelay:e.animatedSymbolProperties?.repeatDelay}:(b=t(e),b.markerPlacement=null);const C={type:"sprite-rasterization-param",resource:b,overrides:this._getMaterialOverrides(k,O)};g&&C.overrides.push(...g.overrides);const z=n;this._cimLayers.push({type:"marker",spriteRasterizationParam:C,colorLocked:h,effects:r,scaleSymbolsProportionally:!1,alignment:a,size:n,scaleX:this._getValueOrOverrideExpression(O,v,"ScaleX",_),rotation:p,offsetX:c,offsetY:m,transform:{type:"cim-marker-transform-param",params:y},color:this._getValueOrOverrideExpression(O,v,"TintColor",S),anchorPoint:{x:M.x,y:M.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:l,sizeRatio:1,isOutline:d,markerPlacement:i,animationParams:Q(f),baseSize:z})}_analyzeVectorMarker(e,r,t,i,o,a,s,l,p,c,m,h,d,u,v){const O=e.markerGraphics;if(!O)return;const _=e.frame;let S=0;S=_?_.ymax-_.ymin:a;const g=!!e.scaleSymbolsProportionally;if(S){const r={offsetX:p,offsetY:c,rotation:l,size:s,frameHeight:S,rotateClockWise:!!e.rotateClockwise,absoluteAnchorPoint:!1,scaleSymbolsProportionally:g};m=[...m,r]}t||(t=this._createMarkerPlacementOverrideExpression(e.markerPlacement));for(const M of O)if(M){const s=M.symbol;if(!s)continue;const l=M.primitiveName;l&&i.push(l);let p,c=h;if(("CIMPointSymbol"===s.type||"CIMTextSymbol"===s.type)&&_){let r=0,t=0;const i=M.geometry;"x"in i&&"y"in i&&(r+=i.x-.5*(_.xmin+_.xmax),t+=i.y-.5*(_.ymin+_.ymax));const o=e.anchorPoint;let a=!1;o&&("Absolute"===e.anchorPointUnits?(r-=o.x,t-=o.y,a=!0):_&&(r-=(_.xmax-_.xmin)*o.x,t-=(_.ymax-_.ymin)*o.y));const s={offsetX:r,offsetY:t,rotation:0,size:0,frameHeight:0,rotateClockWise:!1,absoluteAnchorPoint:a,scaleSymbolsProportionally:g};p=[...m,s]}if("CIMPointSymbol"===s.type||"CIMTextSymbol"===s.type){const e=M.geometry;if("x"in e&&"y"in e){const{x:r,y:t}=e,i=_?.5*-(_.xmin+_.xmax):0,o=_?.5*-(_.ymin+_.ymax):0;r+i===0&&t+o===0||(c=y(c,r+i,t+o))}}switch("CIMPointSymbol"===s.type&&(c=n(this._poMap,s,c)),s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":d||q(s)?(c={...c,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:f([0,0]),rotation:f(0),scale:f(S),parent:h.transform}},this._analyzeMultiLayerGraphicNonSDF(e,r,t,M,i,o,a,p??m,c,S,u,v)):this._analyzeMultiLayerGraphic(e,r,t,M,i,o,a,p??m,c,S,u,v);break;case"CIMTextSymbol":this._analyzeTextGraphic(r,t,M,i,o,a,p??m,u)}l&&i.pop()}}_analyzeMultiLayerGraphic(e,r,t,i,o,a,s,l,p,c,m,y){const f=i.symbol,d=f.symbolLayers;if(!d)return;let v=d.length;if(B(d)&&!h(p))return void this._analyzeCompositeMarkerGraphic(e,r,t,i,d,a,s,l,c,m,y);const O=this._resourceManager.geometryEngine,M=T.applyEffects(f.effects,i.geometry,O);if(M)for(;v--;){const f=d[v];if(!f||!1===f.enable)continue;const h=f.primitiveName;switch(h&&o.push(h),f.type){case"CIMSolidFill":case"CIMSolidStroke":{const o=T.applyEffects(f.effects,M,O),d=_(o);if(!d)continue;const v="Relative"!==e.anchorPointUnits,b=E(f)??0,{frameSizeRatio:C,anchorX:P,anchorY:z,widthRatio:L,sdfPaddingRatio:I}=S(d,e.frame,e.size,e.anchorPoint,v,b,e.scaleSymbolsProportionally),R="CIMSolidFill"===f.type,w={type:"sdf",geom:o,sdfPaddingRatio:I,asFill:R},{path:A}=f,G=R?k(V(f)):null==A?k(N(f)):[0,0,0,0],X=R?[0,0,0,0]:k(N(f));if(!R&&!b)break;const F=i.primitiveName;let Y=null;R&&!f.colorLocked&&(Y=this._maybeGetValueOrOverrideExpression(F,"FillColor"));let j=null;R||f.colorLocked||(j=this._maybeGetValueOrOverrideExpression(F,"StrokeColor"));const W=Y??this._getValueOrOverrideExpression(f.type,h,"Color",G),D=j??this._getValueOrOverrideExpression(f.type,h,"Color",X),H=this._maybeGetValueOrOverrideExpression(F,"StrokeWidth")??this._getValueOrOverrideExpression(f.type,h,"Width",b),U=A?{type:"sprite-rasterization-param",resource:{type:"path",path:A,asFill:R},overrides:[]}:{type:"sprite-rasterization-param",resource:w,overrides:[]},J=n(this._poMap,f,p),B=x(e.size,u.CIMVectorMarker.size),q=this._getValueOrOverrideExpression(e.type,e.primitiveName,"Size",B);this._cimLayers.push({type:"marker",spriteRasterizationParam:U,colorLocked:!!f.colorLocked||!!m,effects:r,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:a,anchorPoint:{x:P,y:z},isAbsoluteAnchorPoint:v,size:c,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:l},frameHeight:c,widthRatio:L,rotateClockwise:!1,referenceSize:s,sizeRatio:C,color:W,outlineColor:D,outlineWidth:H,isOutline:y,markerPlacement:t,animationParams:Q(J),isStroke:"CIMSolidFill"!==f.type,baseSize:q,...g(o,I)});break}case"CIMPictureMarker":case"CIMVectorMarker":f.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(e,r,t,i,o,a,s,l,p,c,!!f.colorLocked||!!m,y):this._analyzeMarker(f,r,t,o,a,s,!1,l,p,m,y);break;default:this._analyzeMultiLayerGraphicNonSDF(e,r,t,i,o,a,s,l,p,c,!!f.colorLocked||!!m,y)}h&&o.pop()}}_analyzeTextGraphic(e,t,i,o,a,s,l,n){const p=[];O.findApplicableOverrides(i,this._primitiveOverrides,p);const c=i.geometry;if(!("x"in c)||!("y"in c))return;const m=i.symbol,y=R(m),f=w(m.fontStyleName),h=r(m.fontFamilyName);m.font={family:h,decoration:y,...f};const d=x(m.height,u.CIMTextSymbol.height),v=x(m.angle),_=x(m.offsetX),S=x(m.offsetY),{haloSymbol:g}=m,M=x(m.haloSize,0);let b=[0,0,0,0];if(g?.symbolLayers?.length){const e=g.symbolLayers;for(const r of e)if(r.color){b=this._getValueOrOverrideExpression(m?.haloSymbol?.type??"CIMPolygonSymbol",r.primitiveName,"Color",k(r.color));break}}const C=i.primitiveName;let P=[0,0,0,1],z=[0,0,0,0],L=0,I=!1;if(m.symbol?.symbolLayers)for(const r of m.symbol.symbolLayers){const e=r.primitiveName;if("CIMSolidStroke"===r.type)z=this._getValueOrOverrideExpression("CIMSolidStroke",e,"Color",k(r.color)),L=this._getValueOrOverrideExpression("CIMSolidStroke",e,"Width",E(r)??0);else if("CIMSolidFill"===r.type){const t=k(r.color);I=I??!!r.colorLocked,P=this._getValueOrOverrideExpression("CIMSolidFill",e??C,"Color",t)}}let V=null,N=null,X=null,F=null,T=null;C&&(V=this._maybeGetValueOrOverrideExpression(C,"TextSize"),N=this._maybeGetValueOrOverrideExpression(C,"TextAngle"),X=this._maybeGetValueOrOverrideExpression(C,"TextOffsetX"),F=this._maybeGetValueOrOverrideExpression(C,"TextOffsetY"),I||(T=this._maybeGetValueOrOverrideExpression(C,"FillColor")));const Y=T??P;let j=null,W=null,D=0;if(m.callout&&"CIMBackgroundCallout"===m.callout.type){const e=m.callout;if(e.backgroundSymbol){const r=e.backgroundSymbol.symbolLayers;if(r)for(const e of r)"CIMSolidFill"===e.type?j=k(e.color):"CIMSolidStroke"===e.type&&(W=k(e.color),D=x(e.width,u.CIMSolidStroke.width))}}const H=this._getValueOrOverrideExpression(m.type,i.primitiveName,"TextString",i.textString??"");if(null==H)return;const{fontStyleName:U}=m,J=h+(U?"-"+U.toLowerCase():"-regular"),B=this._getMaterialOverrides(o,m.type);B.push(...this._getPrimitiveMaterialOverrides(i.primitiveName,m.type));const q={type:"text-rasterization-param",resource:{type:"text",textString:i.textString??"",font:m.font,symbol:m,primitiveName:i.primitiveName},overrides:B};this._cimLayers.push({type:"text",lineWidth:m.lineWidth,textRasterizationParam:q,colorLocked:!!n||!!I,effects:e,alignment:a,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:J,decoration:y,haloSize:M,haloColor:b,weight:f.weight,style:f.style,size:V??d,angle:N??v,offsetX:X??_,offsetY:F??S,transform:{type:"cim-marker-transform-param",params:l},horizontalAlignment:A(m.horizontalAlignment),verticalAlignment:G(m.verticalAlignment),text:H,color:Y,outlineColor:z,outlineSize:L,backgroundColor:j,borderLineColor:W,borderLineWidth:D,referenceSize:s,sizeRatio:1,markerPlacement:t})}_analyzeMultiLayerGraphicNonSDF(e,r,t,i,a,s,l,n,p,c,m,y){const f=H(e,i),h=e.primitiveName,v=this._analyzeMaterialOverrides(h,["Rotation","OffsetX","OffsetY"]),O=z(v),[_,S,g]=d.getTextureAnchor(f,this._resourceManager),M=this._getMaterialOverrides(a,e.type);M.push(...O);const k={type:"sprite-rasterization-param",resource:{...f,avoidSDFRasterization:!0},overrides:M},b=x(e.size,u.CIMVectorMarker.size),C=this._getValueOrOverrideExpression(e.type,h,"Size",b);this._cimLayers.push({type:"marker",spriteRasterizationParam:k,colorLocked:m,effects:r,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:s,anchorPoint:{x:_,y:S},isAbsoluteAnchorPoint:!1,size:c,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:n},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:c,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:l,sizeRatio:g/o(e.size),isOutline:y,markerPlacement:t,animationParams:Q(p),baseSize:C})}_createMarkerPlacementOverrideExpression(e){if(!e)return null;const r=[];return O.findApplicableOverrides(e,this._primitiveOverrides,r),{type:"cim-marker-placement-param",placement:e,overrides:K(r)}}_createGIFAnimatedSymbolPropertiesOverrideExpression(e){if(!e)return null;const r=[];return O.findApplicableOverrides(e,this._primitiveOverrides,r),{type:"cim-gif-animation-params",animation:e,overrides:K(r)}}_analyzeCompositeMarkerGraphic(e,r,t,i,o,a,s,l,n,p,c){const m=i.geometry,y=o[0],f=o[1],h=_(m);if(!h)return;const d="Relative"!==e.anchorPointUnits,v=x(y.width,u.CIMSolidStroke.width),{frameSizeRatio:O,anchorX:g,anchorY:M,widthRatio:b,sdfPaddingRatio:C}=S(h,e.frame,e.size,e.anchorPoint,d,v,e.scaleSymbolsProportionally),{path:P}=f,z=f.primitiveName,L=y.primitiveName,I=i.primitiveName;let E=null;f.colorLocked||p||(E=this._maybeGetValueOrOverrideExpression(I,"FillColor"));const V=E??this._getValueOrOverrideExpression(f.type,z,"Color",k(f.color));let N=null;y.colorLocked||p||(N=this._maybeGetValueOrOverrideExpression(I,"StrokeColor"));const R=N??this._getValueOrOverrideExpression(y.type,L,"Color",k(y.color)),w=this._maybeGetValueOrOverrideExpression(I,"StrokeWidth")??this._getValueOrOverrideExpression(y.type,L,"Width",v),A={type:"sprite-rasterization-param",resource:P?{type:"path",path:P,asFill:!0}:{type:"sdf",geom:m,sdfPaddingRatio:C,asFill:!0},overrides:[]};this._cimLayers.push({type:"marker",spriteRasterizationParam:A,colorLocked:p,effects:r,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:a,anchorPoint:{x:g,y:M},isAbsoluteAnchorPoint:d,size:n,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:l},frameHeight:n,widthRatio:b,rotateClockwise:!1,referenceSize:s,sizeRatio:O,color:V,outlineColor:R,outlineWidth:w,isOutline:c,markerPlacement:t})}_setPoMap(e,r,t){let i;this._poMap[e]?i=this._poMap[e]:(i={},this._poMap[e]=i),i[r]=t}_maybeGetValueOrOverrideExpression(e,r,t){return this._getValueOrOverrideExpression("",e,r,t,!1)}_getValueOrOverrideExpression(e,r,t,i,o=!0){if(o&&!X(i)&&(i=L(e,t.toLowerCase())),null==r)return i;const a=this._poMap[r];if(null==a)return i;const s=a[t];return"string"==typeof s||"number"==typeof s||Array.isArray(s)?s:s?{valueExpressionInfo:s,defaultValue:i}:i}_analyzePrimitiveOverrides(e,r,t,i){if(null==e)return!1;"string"==typeof e&&(e=[e]);for(const o of this._primitiveOverrides)if(e.includes(o.primitiveName)&&o.valueExpressionInfo)return!0;if(null!=r)for(const o of r)if(o?.overrides.length>0)return!0;if(null!=t)for(const o of t)if(o?.overrides.length>0)return!0;if(null!=i)for(const o of i)if(o?.overrides.length>0)return!0;return!1}_getMaterialOverrides(e,r){if(!e)return[];const t=[];for(const i of e)t.push(...this._getPrimitiveMaterialOverrides(i,r));return t}_getPrimitiveMaterialOverrides(e,r){if(!e)return[];const t=z(this._primitiveOverrides.filter((r=>r.primitiveName===e)));return t.forEach((e=>e.defaultValue=L(r,e.propertyName.toLowerCase()))),t}_analyzeMaterialOverrides(e,r){return this._primitiveOverrides.filter((t=>t.primitiveName!==e||!r.includes(t.propertyName)))}}function H(e,r){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[r],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function U(e){if(e&&0===e.indexOf("Level_")){const r=parseInt(e.slice(6),10);if(!isNaN(r))return r}return 0}function J(e,r){if(!r||0===r.length)return e;const i=t(e);return O.applyOverrides(i,r),i}const B=e=>e&&2===e.length&&e[0].enable&&e[1].enable&&"CIMSolidStroke"===e[0].type&&"CIMSolidFill"===e[1].type&&null==e[0].path&&null==e[1].path&&!e[0].effects&&!e[1].effects&&!e[0].animations&&!e[1].animations;function q(e){const r=e.symbolLayers;if(!r)return!1;const t=r.find((e=>e.effects?.find((e=>"CIMGeometricEffectDashes"===e.type&&null!=e.dashTemplate)))),i=r.find((e=>e.effects?.find((e=>"CIMGeometricEffectAddControlPoints"===e.type))));return!!t||!!i}function K(e){return t(e).map((e=>({...e,propertyName:F(e.propertyName)})))}function Q(e){return h(e)?{type:"animation-params",params:e}:null}export{D as CIMAnalyzer,J as analyzeCIMResource};
