/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../Color.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import r from"../../renderers/HeatmapRenderer.js";import"../../renderers/PieChartRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../core/Logger.js";import{createUniqueColors as a}from"../../core/colorUtils.js";import t from"../../core/Error.js";import o from"../../renderers/support/AuthoringInfo.js";import s from"../../renderers/support/HeatmapColorStop.js";import{gaussianBlurRadiusPxToKernelDensityRadiusPt as n}from"../../renderers/support/heatmapUtils.js";import{verifyBasicFieldValidity as i,getBasemapInfo as m}from"./support/utils.js";import p from"../statistics/heatmapStatistics.js";import{getFieldsList as l}from"../support/utils.js";import{LayerType as d,createLayerAdapter as u,getLayerTypeLabels as c}from"../support/adapters/support/layerUtils.js";import{cloneScheme as f,getSchemes as h}from"../symbology/heatmap.js";const w=.01;async function y(e){if(!e?.layer||!e.view)throw new t("heatmap-renderer:missing-parameters","'layer' and 'view' parameters are required");const r={...e,layer:e.layer,view:e.view};r.radius??=null==r.blurRadius?18:n(r.blurRadius),r.minRatio??=.01,r.maxRatio??=1,r.fadeRatio??=.2,r.fadeToTransparent??=!0;const a=[d.CSVLayer,d.FeatureLayer,d.GeoJSONLayer,d.KnowledgeGraphSublayer,d.OGCFeatureLayer,d.OrientedImageryLayer,d.StreamLayer,d.WFSLayer],o=u(r.layer,a);if(!o)throw new t("heatmap-renderer:invalid-parameters","'layer' must be one of these types: "+c(a).join(", "));r.layer=o;const s=null!=r.signal?{signal:r.signal}:null;await o.load(s);const m=await l({field:r.field}),p=i(o,m,"heatmap-renderer:invalid-parameters");if(p)throw p;return r}async function b(e){let r=e.scheme,a=null,t=null;const o=await m(e.basemap,e.view);if(a=null!=o.basemapId?o.basemapId:null,t=null!=o.basemapTheme?o.basemapTheme:null,r)return{scheme:f(r),basemapId:a,basemapTheme:t};const s=h({basemapTheme:t});return s&&(r=s.primaryScheme,a=s.basemapId,t=s.basemapTheme),{scheme:r,basemapId:a,basemapTheme:t}}async function j(t,n){const{field:i,basemap:m,radius:p,fadeToTransparent:l,heatmapScheme:d,view:u}=n,{scheme:c,basemapId:h,basemapTheme:y}=await b({basemap:m,scheme:d,view:u}),j=c.colors,R=j.length,I=null==t.min,S=I?[0,.04]:[t.min,t.max];let T;const v=n.fadeRatio??0,L=n.maxRatio??0,x=n.minRatio??0,C=(L-x)/(R-1),U=j[0],D=l?x:w,E=[new s({ratio:0,color:new e([U.r,U.g,U.b,0])}),new s({ratio:w,color:new e([U.r,U.g,U.b,0])}),new s({ratio:D,color:new e([U.r,U.g,U.b,D])})];a(j,R).forEach(((e,r)=>{const a=x+C*r;E.push(new s({ratio:a,color:e}))})),l&&(g(E,v),T=new o({fadeRatio:v}));return{renderer:new r({authoringInfo:T,radius:p,colorStops:E,field:i,minDensity:S[0],maxDensity:S[1]}),statistics:t,defaultValuesUsed:I,scheme:f(c),basemapId:h,basemapTheme:y}}function g(e,r){const a=10*(1-r)+1,t=e.length-3,o=e[2].color.a;e.forEach(((e,s)=>{if(s<=2)return;const{color:n}=e,i=(s-3)/t;n.a=0===r?1:Math.min(Math.max(i*a+i+o,o),1)}))}async function R(e){const r=await y(e);return j(r.statistics??await p({layer:r.layer,field:r.field,radius:r.radius,view:r.view,filter:r.filter,signal:r.signal}),r)}function I(e){const{fadeRatio:r,renderer:a}=e,t=a.clone(),s=r??(t?.authoringInfo?.fadeRatio||0);return g(t.colorStops,s),t.authoringInfo?t.authoringInfo.fadeRatio=s:t.authoringInfo=new o({fadeRatio:s}),t}export{R as createRenderer,I as updateRenderer};
