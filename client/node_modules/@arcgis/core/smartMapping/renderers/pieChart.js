/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../Color.js";import"../../renderers/ClassBreaksRenderer.js";import"../../renderers/DictionaryRenderer.js";import"../../renderers/DotDensityRenderer.js";import"../../renderers/HeatmapRenderer.js";import r from"../../renderers/PieChartRenderer.js";import"../../renderers/Renderer.js";import"../../renderers/SimpleRenderer.js";import"../../renderers/UniqueValueRenderer.js";import"../../renderers/support/jsonUtils.js";import"../../core/Logger.js";import"../../symbols.js";import{isSome as a}from"../../core/arrayUtils.js";import{createUniqueColors as t}from"../../core/colorUtils.js";import i from"../../core/Error.js";import{toPt as n}from"../../core/screenUtils.js";import{fetchMessageBundle as s}from"../../intl/messages.js";import o from"../../layers/support/AggregateField.js";import l from"../../layers/support/ExpressionInfo.js";import p from"../../renderers/support/AttributeColorInfo.js";import{OthersCategory as u}from"../../renderers/support/OthersCategory.js";import m from"../heuristics/outline.js";import c from"../heuristics/sizeRange.js";import{createVisualVariables as d}from"./size.js";import{errorCallback as f,createSymbol as h,getSymbolOutlineFromScheme as b,verifyBasicFieldValidity as y,getBasemapInfo as w}from"./support/utils.js";import g from"../statistics/predominantCategories.js";import{getSumOfAttributesExpr as v}from"../statistics/support/utils.js";import{verifyBinningParams as S}from"../support/binningUtils.js";import{getFieldsList as z}from"../support/utils.js";import{LayerType as E,binningCapableLayerTypes as j,createLayerAdapter as C,getLayerTypeLabels as x,getLayerTypes as V}from"../support/adapters/support/layerUtils.js";import{cloneScheme as $,getSchemes as T}from"../symbology/pieChart.js";import{getCIMSymbolColor as I}from"../../symbols/support/cimSymbolUtils.js";import k from"../../symbols/SimpleLineSymbol.js";const O=[E.CSVLayer,E.FeatureLayer,E.GeoJSONLayer,E.OGCFeatureLayer,E.OrientedImageryLayer,E.StreamLayer,E.WFSLayer];async function q(e){if(!(e?.layer&&e.view&&e.attributes?.length))throw new i("pie-chart-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(e.attributes.length>10)throw new i("pie-chart-renderer:invalid-parameters","PieChart renderer does not support more than 10 attributes");e.forBinning&&S(e,"pie-chart-renderer");const r={...e,layer:e.layer,view:e.view,attributes:e.attributes};r.shape=r.shape||"pie",r.othersCategoryEnabled??=!0,r.includeSizeVariable=e.includeSizeVariable||!1;const a=e.forBinning?j:O,t=C(r.layer,a,e.forBinning);if(!t)throw new i("pie-chart-renderer:invalid-parameters","'layer' must be one of these types: "+x(a).join(", "));r.layer=t;const n=null!=r.signal?{signal:r.signal}:null;await Promise.all([e.view.when(),t.load(n)]);const s=t.geometryType,o="polygon"===s,l="point"===s||"multipoint"===s||o;if(r.outlineOptimizationEnabled=!!o&&r.outlineOptimizationEnabled,r.sizeOptimizationEnabled=!!l&&r.sizeOptimizationEnabled,!l)throw new i("pie-chart-renderer:not-supported","PieChart renderer is only supported for point and polygon layers");const p=[],u=r.attributes;for(const i of u){const e=await z({field:i.field,valueExpression:i.valueExpression});p.push(...e)}const m=y(t,p.filter(Boolean),"pie-chart-renderer:invalid-parameters");if(m)throw m;return r}async function L(e){let r=e.pieChartScheme,a=null,t=null;const i=await w(e.basemap,e.view);if(a=null!=i.basemapId?i.basemapId:null,t=null!=i.basemapTheme?i.basemapTheme:null,r)return{scheme:$(r),basemapId:a,basemapTheme:t};const n=T({numColors:e.attributes.length,geometryType:e.layer.geometryType,basemapTheme:t});return n&&(r=n.primaryScheme,a=n.basemapId,t=n.basemapTheme),{scheme:r,basemapId:a,basemapTheme:t}}async function B(e,r){const{valueExpression:a,sqlExpression:t,sqlWhere:i}=v(e.attributes),n=await s("esri/smartMapping/t9n/smartMapping");return d({layer:e.layer,basemap:e.basemap,valueExpression:a,sqlExpression:t,sqlWhere:i,sizeScheme:r,sizeOptimizationEnabled:e.sizeOptimizationEnabled,legendOptions:{title:n.sumOfCategories},view:e.view,signal:e.signal})}async function R(e){const[o,l]=await Promise.all([q(e),s("esri/smartMapping/t9n/smartMapping")]),d=await L(o),y=d?.scheme;if(!y)throw new i("pie-chart-renderer:insufficient-info","Unable to find pie-chart scheme");const w=o.layer,{includeSizeVariable:v,sizeOptimizationEnabled:S,outlineOptimizationEnabled:z,view:E,signal:j,filter:C}=o,x=y.sizeScheme,V=o.attributes,T=V.map((e=>e.field)).filter(a),[I,O,R,U]=await Promise.all([T.length>1?g({layer:w,fields:T,view:E,signal:j,filter:C}):null,v?B(o,x):null,!v&&S?c({layer:w,view:E,signal:j,filter:C}).catch(f):null,z?m({layer:w,view:E,signal:j,filter:C}).catch(f):null]),P=I?.predominantCategoryInfos?{uniqueValueInfos:I.predominantCategoryInfos}:{uniqueValueInfos:T.map((e=>({value:e,count:0})))},F=t(y.colors,V.length),M=V.map(((e,r)=>new p({field:e.field,valueExpression:e.valueExpression,label:e.label,valueExpressionTitle:e.valueExpressionTitle,color:F[r]}))),N=w.geometryType,_=null!=x&&"background"in x&&x.background,A=new r({attributes:M,othersCategory:new u({label:l.other,color:o.othersCategoryEnabled?y.colorForOthersCategory:null,threshold:.04}),holePercentage:"donut"===o.shape?.45:0,backgroundFillSymbol:_?h(N,{type:"2d",color:_.color,outline:b(_,N,U?.opacity)}):null,size:n(y.size),outline:new k(b(y,"point",U?.opacity)),legendOptions:o.legendOptions});if(O&&(S||O.visualVariables.forEach((e=>{"number"==typeof e.minSize&&"number"==typeof e.maxSize&&(e.minSize*=2.5,e.maxSize*=1.8)})),S&&"point"===N&&O.visualVariables.forEach((e=>{e?.minSize&&"object"==typeof e.minSize&&e.minSize?.stops?.forEach((e=>{e.size*=1.8}))})),A.authoringInfo=O.authoringInfo.clone(),A.visualVariables=O.visualVariables?.map((e=>e.clone()))),U?.visualVariables?.length){const e=U.visualVariables.map((e=>e.clone())).filter((e=>"color"!==e.type&&"rotation"!==e.type));A.visualVariables?A.visualVariables.push(...e):A.visualVariables=e}return R?.minSize&&("point"===N&&R.minSize.stops?.forEach((e=>{e.size*=2.5})),"polygon"===N&&R.minSize.stops?.forEach((e=>{e.size*=1.8})),A.visualVariables?A.visualVariables.push(R.minSize):A.visualVariables=[R.minSize]),{renderer:A,pieChartScheme:$(y),size:O,basemapId:d.basemapId,basemapTheme:d.basemapTheme,statistics:P}}const U=new Set(["unique-value","class-breaks"]),P=new e("#aaaaaa"),F=new e("#5c5c5c"),M=[new e("#e60049"),new e("#0bb4ff"),new e("#50e991"),new e("#e6d800"),new e("#9b19f5"),new e("#ffa300"),new e("#dc0ab4"),new e("#b3d4ff"),new e("#00bfa0"),new e("#f0cccc")];async function N(e){if(!e||!e.layer)throw new i("pie-chart-cluster-renderer:missing-parameters","'layer' parameter is required");const r={...e};r.shape=r.shape||"pie",r.defaultSymbolEnabled??=!0;const a=e.layer;if(!V(O).includes(a.type))throw new i("pie-chart-cluster-renderer:invalid-parameters","'layer' must be one of these types: "+x(O).join(", "));const t=null!=r.signal?{signal:r.signal}:null;await a.load(t);if(!("point"===a.geometryType))throw new i("pie-chart-cluster-renderer:invalid-parameters","Cluster renderers are only supported for point layers");const{renderer:n}=a;if(!n)throw new i("pie-chart-cluster-renderer:invalid-parameters","input layer does not have a renderer.");if(!U.has(n.type))throw new i("pie-chart-cluster-renderer:invalid-parameters",`Cannot create a pie chart renderer for clusters based on a ${n.type} renderer.`);if("valueExpression"in n&&n.valueExpression)throw new i("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer whose renderer contains a valueExpression.");if("unique-value"===n.type){if(n.field2)throw new i("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a UniqueValueRenderer using more than one field.");if(null!=n.uniqueValueInfos&&n.uniqueValueInfos.length>10)throw new i("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer cannot be created from a UniqueValueRenderer with more than 10 unique value infos.")}if("class-breaks"===n.type){if(n.classBreakInfos.length<2)throw new i("pie-chart-cluster-renderer:invalid-parameters","Cannot create a pie chart renderer for clusters from a layer renderer with a continuous color or size gradient.");if(n.classBreakInfos.length>10)throw new i("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with more than 10 class break infos.");if("class-breaks-size"===n?.authoringInfo?.type)throw new i("pie-chart-cluster-renderer:invalid-parameters","PieChart cluster renderer can not be created from a ClassBreaksRenderer with breaks varied by size instead of color.")}return r}async function _(e){const a=await N(e),{layer:t,shape:i,defaultSymbolEnabled:n,legendOptions:o}=a,{renderer:l}=t,u=(await s("esri/smartMapping/t9n/smartMapping")).other;let m=[];"unique-value"===l?.type&&(m=A({renderer:l,defaultSymbolEnabled:n,defaultLabelBackup:u})),"class-breaks"===l?.type&&(m=D({renderer:l,defaultSymbolEnabled:n,defaultLabelBackup:u}));const c=[],d=[];for(const r of m){const{field:e,color:a}=r;c.push(e),d.push(new p({color:a,field:e.name,label:e.alias}))}return{fields:c,renderer:new r({attributes:d,legendOptions:o,holePercentage:"donut"===i?.45:0,outline:null,size:9,othersCategory:null})}}function A(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:i}=e,{field:n,defaultSymbol:s,defaultLabel:p}=r,u=r.uniqueValueInfos??[],m=s&&a,c=m?9:10,d=t(M,c),f=(n?u.slice(0,c).map(((e,r)=>{const a=e.label,t=d[r];return{field:new o({name:W(e.value?.toString()),alias:a,onStatisticExpression:new l({title:`Field definition - ${a}`,expression:H(n,e),returnType:"number"}),statisticType:"sum"}),color:G(e.symbol,t)}})):null)??[];if(m){const e="cluster_default",r=p||i;f.push({field:new o({name:W(e),alias:r,onStatisticExpression:new l({title:`Field definition - ${r}`,expression:J(n,u),returnType:"number"}),statisticType:"sum"}),color:G(s,F)})}return f}function D(e){const{renderer:r,defaultSymbolEnabled:a,defaultLabelBackup:i}=e,{field:n,classBreakInfos:s,defaultSymbol:p,defaultLabel:u}=r,m=p&&a,c=m?9:10,d=t(M,c),f=s.slice(0,c).map(((e,r)=>{const a=e.label||`${e.minValue} - ${e.maxValue}`,t=d[r];return{field:new o({name:W(a),alias:a,onStatisticExpression:new l({title:`Field definition - ${a}`,expression:Z(n,e),returnType:"number"}),statisticType:"sum"}),color:G(e.symbol,t)}}));if(m){const e="cluster_default",r=u||i;f.push({field:new o({name:W(e),alias:r,onStatisticExpression:new l({title:`Field definition - ${r}`,expression:K(n,s),returnType:"number"}),statisticType:"sum"}),color:G(p,F)})}return f}function W(e){return"SUM_"+(e+"").replaceAll(/[^a-zA-Z0-9_]/g,"_")}function G(e,r){if("simple-marker"===e?.type&&e.color)return e.color.clone();if("cim"===e?.type){const r=I(e);if(r)return r.clone()}return r?r.clone():P.clone()}function H(e,r){return`Number(Text($feature["${e}"]) == "${r.value+""}")`}function J(e,r){return`Number(!(${r.map((r=>`(Text($feature["${e}"]) == "${r.value+""}")`)).join(" || ")}))`}function Z(e,r){return`Number($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`}function K(e,r){return`Number(!(${r.map((r=>`($feature["${e}"] >= ${r.minValue} && $feature["${e}"] < ${r.maxValue})`)).join(" || ")}))`}export{R as createRenderer,_ as createRendererForClustering};
