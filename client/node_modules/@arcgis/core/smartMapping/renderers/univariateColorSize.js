/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import i from"../../renderers/support/AuthoringInfo.js";import s from"../../renderers/support/ClassBreakInfo.js";import a from"../../renderers/visualVariables/support/SizeStop.js";import{getSize as o}from"../../renderers/visualVariables/support/visualVariableUtils.js";import{createVisualVariable as l}from"./color.js";import{createVisualVariables as n,createContinuousRenderer as t}from"./size.js";import{verifyBasicFieldValidity as r,createStopValuesForAboveBelow as u,clampAboveAndBelowStopValues as m,createDefaultStopValues as p}from"./support/utils.js";import{verifyBinningParams as c}from"../support/binningUtils.js";import{isAnyDateField as d,getFieldsList as v}from"../support/utils.js";import{binningCapableLayerTypes as f,featureCapableLayerTypes as b,createLayerAdapter as y,getLayerTypeLabels as h}from"../support/adapters/support/layerUtils.js";import{getAboveAndBelowSymbols as w}from"../symbology/support/aboveAndBelowUtils.js";import{applyCIMSymbolColor as z}from"../../symbols/support/cimSymbolUtils.js";import{Symbol3DMaterial as g}from"../../symbols/support/Symbol3DMaterial.js";const V=2**53-1;async function O(i){if(!i?.layer||!(i.field||i.valueExpression||i.sqlExpression))throw new e("univariate-colorsize-visual-variables:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(i.valueExpression&&!i.sqlExpression&&!i.view)throw new e("univariate-colorsize-visual-variables:missing-parameters","View is required when 'valueExpression' is specified");if("above-and-below"===i.theme&&i.sizeOptions?.sizeOptimizationEnabled)throw new e("univariate-colorsize-visual-variables:invalid-parameters","sizeOptimizationEnabled cannot be true for 'above-and-below' theme");i.forBinning&&c(i,"univariate-colorsize-visual-variables");const s={...i,layer:i.layer},a=i.forBinning?f:b,o=y(s.layer,a,i.forBinning);if(!o)throw new e("univariate-colorsize-visual-variables:invalid-parameters","'layer' must be one of these types: "+h(a).join(", "));s.layer=o,s.theme=s.theme||s.colorOptions?.theme?s.theme:"high-to-low";const l=null!=s.signal?{signal:s.signal}:null;await o.load(l);const n=await v({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),t=r(o,n,"univariate-colorsize-visual-variables:invalid-parameters");if(t)throw t;return s}function x(e,i){const s={...e},{sizeOptions:a,theme:o}=s,l=s.legendOptions||s.sizeOptions?.legendOptions;return delete s.sizeOptions,delete s.colorOptions,{...s,...a,statistics:i||s.statistics,theme:"above-and-below"===o?null:o,legendOptions:l}}function S(e,i){const s={...e},a=s.colorOptions,o=s.theme||a?.theme,l=s.legendOptions||s.colorOptions?.legendOptions;return delete s.sizeOptions,delete s.colorOptions,{...s,...a,statistics:i||s.statistics,theme:o,legendOptions:l}}async function E(i){if(!i?.layer||!(i.field||i.valueExpression||i.sqlExpression))throw new e("univariate-colorsize-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(i.valueExpression&&!i.sqlExpression&&!i.view)throw new e("univariate-colorsize-continuous-renderer:missing-parameters","View is required when 'valueExpression' is specified");i.forBinning&&c(i,"univariate-colorsize-continuous-renderer");const s={...i,layer:i.layer};s.symbolType=s.symbolType||"2d",s.colorOptions||(s.colorOptions={}),s.colorOptions.isContinuous=s.colorOptions.isContinuous??!1;const a=i.forBinning?f:b,o=y(s.layer,a,i.forBinning);if(!o)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+h(a).join(", "));s.layer=o;const l=null!=s.signal?{signal:s.signal}:null;if(await o.load(l),"above-and-below"===s.theme&&s.symbolOptions){if(s.symbolType.includes("3d-volumetric"))throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' is applicable for '2d' and '3d-flat' 'symbolType' only");if("point"!==o.geometryType&&"polygon"!==o.geometryType)throw new e("univariate-colorsize-continuous-renderer:invalid-parameters","'symbolOptions' only apply to layers with 'point' or 'polygon' geometryType")}const n=await v({field:s.field,normalizationField:s.normalizationField,valueExpression:s.valueExpression}),t=r(o,n,"univariate-colorsize-continuous-renderer:invalid-parameters");if(t)throw t;return s}function j(e){const i={...e},s={...i.sizeOptions};return delete i.sizeOptions,delete i.colorOptions,delete s.sizeOptimizationEnabled,{...i,...s}}function I(e,i){if("type"in e&&"cim"===e.type)z(e,i);else if("type"in e&&e.type.includes("3d")){e.symbolLayers.forEach((e=>{"material"in e&&null!=e.material&&"color"in e.material&&(e.material?e.material.color=i:e.material=new g({color:i}))}))}else"color"in e&&(e.color=i)}function T(e,i,s){if((i?.symbolStyle||i?.symbols)&&("point"===s||"polygon"===s))return i.symbols||w(i.symbolStyle);const a=e.classBreakInfos[0].symbol;return{above:a.clone(),below:a.clone()}}function q(e,i,a){const o=a.symbolOptions,l=a.layer,n=o?.symbols?"custom":o?.symbolStyle,t=a.colorOptions?.isContinuous;if(B(e,i,t),n||!t){const a=i.size.visualVariables[0].stops,{above:r,below:u}=T(e,o,l.geometryType);if(!t){const e=i.color.colorScheme.colors,s=e[0];I(r,e[e.length-1]),I(u,s)}e.classBreakInfos=[new s({minValue:-V,maxValue:a[2].value,symbol:u}),new s({minValue:a[2].value,maxValue:V,symbol:r})],n&&e.authoringInfo&&(e.authoringInfo.univariateSymbolStyle=n)}}function B(e,i,s=!0){const a=i?.authoringInfo?.clone(),o=a?.visualVariables?.some((e=>"reference-size"===e.theme)),l=o?[]:i.size.visualVariables.map((e=>e.clone()));s?l.push(i.color.visualVariable.clone()):a.visualVariables=a.visualVariables?.filter((e=>"size"===e.type)),e.visualVariables&&l.push(...e.visualVariables.filter((e=>"target"in e&&"outline"===e.target)).map((e=>e.clone()))),e.authoringInfo=a,e.visualVariables=l}function D(e){const i={...e},s=i.symbolType,a=!!s?.includes("3d-volumetric");delete i.symbolType,delete i.defaultSymbolEnabled;const o=i;return o.worldScale=a,a&&(o.sizeOptions={...o.sizeOptions},o.sizeOptions.axis="3d-volumetric-uniform"===s?"all":"height"),o}async function U(e,i,s,l){const n=i[0],t=i[1],r=Math.round((t-n)/2)+n,u=e.clone();u.stops=[new a({value:s[0],size:t}),new a({value:s[1],size:r}),new a({value:s[2],size:n}),new a({value:s[3],size:r}),new a({value:s[4],size:t})],e.stops=[new a({value:l[0],size:o(u,l[0])}),new a({value:l[1],size:o(u,l[1])}),new a({value:l[2],size:o(u,l[2])}),new a({value:l[3],size:o(u,l[3])}),new a({value:l[4],size:o(u,l[4])})]}async function C(e,i,s,a,o){const l=e.find((e=>"width-and-depth"!==e.axis&&!e.target)),n="number"==typeof l?.minSize?l?.minSize:null,t="number"==typeof l?.maxSize?l?.maxSize:null;if(null!=l?.minDataValue&&null!=n&&null!=t)if(a)if("above-and-below"===a){l.minDataValue=null,l.maxDataValue=null,l.minSize=null,l.maxSize=null;const e=u(s,o),a=m(e,s);await U(l,[n,t],e,a),i.stops.forEach(((e,i)=>e.value=a[i]))}else{const{minDataValue:e,maxDataValue:s}=l,a=p(e,s,5);i.stops.forEach(((e,i)=>e.value=a[i])),l.minDataValue=a[0],l.maxDataValue=a[a.length-1]}else l.minDataValue=i.stops[0].value,l.maxDataValue=i.stops[i.stops.length-1].value}function F(e,s,a){const{theme:o,minValue:l,maxValue:n}=e,t=s.authoringInfo.visualVariables[0].clone(),r=a.authoringInfo.visualVariables[0].clone(),{stops:u}=s.visualVariable;return"above-and-below"===o?(t.minSliderValue=r.minSliderValue=l??u[0].value,t.maxSliderValue=r.maxSliderValue=n??u.at(-1)?.value,r.theme="above-and-below"):o&&"high-to-low"!==o||"reference-size"!==r.theme||2!==r.sizeStops?.length||(r.sizeStops[0].value=u[0].value,r.sizeStops[1].value=u.at(-1)?.value),new i({type:"univariate-color-size",univariateTheme:o,visualVariables:[t,r]})}async function k(e){const i=await O(e),s=await l(S(i)),{visualVariable:a,statistics:o}=s,t=await n(x(i,o)),r=t.visualVariables,u=e.layer,m=e.field?u.getField(e.field):null;return await C(r,a,o,i.theme,d(m)),{basemapId:t.basemapId,basemapTheme:t.basemapTheme,statistics:o,defaultValuesUsed:s.defaultValuesUsed,color:{visualVariable:a,colorScheme:s.colorScheme},size:{visualVariables:r,sizeScheme:t.sizeScheme},authoringInfo:F(i,s,t)}}async function A(e){return M(e)}async function M(e){const i=await E(e),{renderer:s,statistics:a,defaultValuesUsed:o}=await t(j(i)),l=D(i);l.statistics=a;const n=await k(l);return"above-and-below"===i.theme?q(s,n,i):B(s,n),{renderer:s,statistics:a,defaultValuesUsed:o,color:i.colorOptions?.isContinuous||"above-and-below"!==i.theme?n.color:null,size:n.size,basemapId:n.basemapId,basemapTheme:n.basemapTheme}}export{A as createContinuousRenderer,M as createRenderer,k as createVisualVariables};
