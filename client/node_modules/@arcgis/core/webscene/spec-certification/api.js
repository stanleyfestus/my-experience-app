/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import e from"../../Basemap.js";import t from"../../Ground.js";import n from"../../WebScene.js";import"../../core/has.js";import{isLongFormType as r,Integer as a,Null as y}from"../../core/accessorSupport/ensureType.js";import{isCollection as o}from"../../core/accessorSupport/extensions/serializableProperty/type.js";import p from"../../layers/GroupLayer.js";import s from"../../layers/KMLLayer.js";import{typeModuleMap as l}from"../../layers/mixins/operationalLayerModuleMap.js";import{supportedTypes as u}from"../../layers/mixins/operationalLayers.js";import i from"../../layers/support/Sublayer.js";import{JoinTableDataSource as c,DataLayerSource as m}from"../../layers/support/source/DataLayerSource.js";import{MapLayerSource as f}from"../../layers/support/source/MapLayerSource.js";import{ScanContext as d}from"./utils.js";async function b(e){return C(null,{typeName:"json",type:e},new d)}async function w(e,t,n){switch(t.typeName){case"array":await g(e,t,n);break;case"union":await k(e,t,n);break;case"json":await C(e,t,n);break;case"native":await N(e,t,n);break;case"enum":await v(e,t,n)}}async function N(e,t,n){n.addProperty({name:e,type:$(t),default:t.default})}function j(e){const t=e.slice();return t.sort(),t}async function v(e,t,n){const r=t.values.slice();t.nullable&&r.push(null),n.currentClass?.typeValue&&"type"===e?n.addProperty({name:e,type:"string",enum:`"${n.currentClass.typeValue}"`}):n.addProperty({name:e,type:$(t),enum:j(r).map((e=>"string"==typeof e?`"${e}"`:`${e}`)).join("|"),default:t.default})}async function g(e,t,n){await w(`${e}[]`,t.elementType,n)}function T(e,t){if("json"===e.typeName){const t=e.type.__accessorMetadata__,n=t?.type,r=n&&K(n),a=r?.type,y=a||n?.type;if(y&&Array.isArray(y)&&1===y.length&&"string"==typeof y[0])return a?y[0]:J(n,y[0])}return t}async function k(e,t,n){const r=[];for(const a of t.types)if("native"!==a.type.typeName&&t.key){const t=`${e}<${T(a.type,a.value)}>`;await w(t,a.type,n)}else r.push(a.type);if(r.length){const a=r.map($);t.nullable&&a.push("null"),a.sort(),n.addProperty({type:a.join("|"),name:e,default:t.default})}}async function h(r,a){return r.type===n&&"layers"===a?P("web-scene/operational-layers","operational-layers"):r.type===n&&"tables"===a?P("web-scene/tables","tables"):r.type!==e||"baseLayers"!==a&&"baseMapLayers"!==a?r.type===e&&"elevationLayers"===a||r.type===t&&"layers"===a?P("web-scene/ground","ground"):r.type===p&&"layers"===a?P("web-scene/operational-layers","operational-layers",(e=>e!==p)):r.type!==c||"leftTableSource"!==a&&"rightTableSource"!==a?null:G({key:"type",base:null,typeMap:{"data-layer":m,"map-layer":f}}):P("web-scene/basemap","basemap")}async function M(e,t,n){const r=await h(e,t);return r||x(n)}function S(e){return e.prototype.declaredClass.replaceAll(".","/")}async function C(e,t,n){const r=t.type.__accessorMetadata__,a=S(t.type);if(!r)return e&&n.addProperty({name:e,type:"unknown"}),null;let y=a,o=null;t.layerContainerType&&(y+=`--${t.layerContainerType}`);const p=e?.match(/<([^>]+)>$/);p&&(y+=`--${p[1]}`,o=p[1]),t.type===i&&(y+=`--${n.currentClass?.name}`,o=n.currentClass?.name);const s=n.seen.get(y);if(s&&e)return n.addProperty({name:e,type:s}),s;const l={type:t.type,name:a,id:y,properties:[]};e&&(n.addProperty({name:e,type:l}),l.typeValue=o),n.push(e,l);for(const u in r){const e=r[u],a=q(e);if(!a?.enabled)continue;if(a.layerContainerTypes&&t.layerContainerType&&!a.layerContainerTypes.includes(t.layerContainerType))continue;if(t.type===i){const e="esri/layers/TileLayer"===n.stack[n.stack.length-2].klass.name;if(e&&i.test.isMapImageLayerOverridePolicy(a.overridePolicy)||!e&&i.test.isTileImageLayerOverridePolicy(a.overridePolicy))continue}const y=a.target;if("string"==typeof y||null==y){const r=await M(t,u,e);if(!r)continue;await w("string"==typeof y?y:u,r,n)}else await L(t,y,n)}return n.pop()}async function L(e,t,n){for(const r in t){let a=await h(e,r);if(!a){const e=t[r];a=e.types?G(e.types):W(e.type),a.default=e.default,a=O(a)}await w(r,a,n)}}async function P(e,t,n){const r={typeName:"union",key:"layerType",types:[]};for(const a in u[e]){if("web-scene/operational-layers"===e&&"ArcGISTiledElevationServiceLayer"===a)continue;const y=await l[a]();y&&(n&&!n(y)||y!==s&&r.types.push({type:{typeName:"json",layerContainerType:t,type:y},value:a}))}if(0===r.types.length)return null;return{typeName:"array",elementType:1===r.types.length?r.types[0].type:r}}function $(e){switch(e.typeName){case"array":return`${$(e.elementType)}[]`;case"union":{const t=e.types.map((e=>$(e.type)));return e.nullable&&t.push("null"),t.sort(),`${t.join(" | ")}`}case"native":switch(e.type){case Number:return"number";case a:return"integer";case String:return"string";case Boolean:return"boolean";case Object:return"object";case y:return"null";default:return"unknown"}case"json":return e.type.prototype.declaredClass;case"enum":return"string"}}function _(e){const t=e.prototype.itemType?.Type;if(!t)return{typeName:"array",elementType:{typeName:"native",type:null}};if("function"==typeof t)return{typeName:"array",elementType:W(t)};if(t.typeMap){const e=[];for(const n in t.typeMap){const r=t.typeMap[n];e.push({type:W(r),value:E(r)?null:n})}return{typeName:"array",elementType:{typeName:"union",key:"string"==typeof t.key?t.key:"type",types:e}}}}function A(e){if("json"!==e.typeName)return null;const t=e.type.__accessorMetadata__,n=t?.type,r=n&&K(n),a=r?.type,y=a||n?.type;return y&&Array.isArray(y)&&"string"==typeof y[0]?a||n.type.map((e=>J(n,e))):null}function O(e){if("array"===e.typeName)return e.elementType=O(e.elementType),e;const t=A(e);return t?{typeName:"union",key:"type",nullable:e.nullable,types:t.map((t=>({value:t,type:e})))}:e}function x(e){const t=K(e);return t?.types?G(t.types):!t?.type&&e.types?G(e.types):B(O(V(e)))}function B(e){return e.nullable&&"native"===e.typeName?{typeName:"union",key:null,types:[{value:null,type:e}],nullable:!0}:e}function G(e){if(Array.isArray(e))return{typeName:"array",elementType:G(e[0])};const t=[];for(const n in e.typeMap){const r=e.typeMap[n];t.push({type:W(r),value:E(r)?null:n})}return{typeName:"union",key:"string"==typeof e.key?e.key:"type",types:t}}function I(e){return null!=e&&e.isJSONMapWriter}function J(e,t){const n=q(e);if(n&&I(n.writer)){const e={value:""};return n.writer?.(t,e,"value"),e.value}return t}function V(e){const t=K(e),n=q(e),r=t?.type,a=W(r||e.type);return t&&void 0!==t.default&&"function"!=typeof t.default&&(a.default=J(e,t.default)),n?.allowNull&&(a.nullable=!0),a}function W(e){return e?r(e)?z(e):Array.isArray(e)?"string"==typeof e[0]||"number"==typeof e[0]?{typeName:"enum",values:e}:e.length>1?{typeName:"union",key:null,types:e.map((e=>({type:W(e),value:null})))}:{typeName:"array",elementType:W(e[0])}:o(e)?_(e):E(e)?{typeName:"native",type:e}:D(e)?{typeName:"json",type:e}:{typeName:"native",type:null}:{typeName:"native",type:null}}function z(e){switch(e.type){case"native":return{typeName:"native",type:e.value};case"array":return{typeName:"array",elementType:W(e.value)};case"one-of":return{typeName:"union",key:null,types:e.values.map((e=>({type:z(e),value:null})))}}}function D(e){let t=e;for(;t;){if(t.prototype&&("esri.core.JSONSupport"===t.prototype.declaredClass||"esri.core.MultiOriginJSONSupport"===t.prototype.declaredClass))return!0;t=Object.getPrototypeOf(t)}return!1}function E(e){return e===String||e===Boolean||e===Number||e===a||e===Object||e===y}function K(e){if(!e.json)return null;const t=e.json.origins,n=e.json,r=t?.["web-scene"],a=t?.["web-document"];return r||a||n||null}function q(e){if(!e.json)return null;const t=e.json.origins,n=e.json.write,r=t?.["web-scene"]?.write,a=t?.["web-document"]?.write;return r||a||n||null}export{b as scan};
