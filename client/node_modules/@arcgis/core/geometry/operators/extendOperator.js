/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{t as e,k as t,G as n,d as r}from"../../chunks/Geometry.js";import{t as o,h as s,S as a,P as i,aM as g,aN as u,aO as m}from"../../chunks/QuadraticBezier.js";import{getSpatialReference as c,fromPolyline as l,fromSpatialReference as d,toPolyline as p}from"./support/converterAPI.js";function h(t,n,r,a,i){if(t.isEmpty()||n.isEmpty())return null;if(8&a&&16&a)return null;2&a&&4&a&&e("");const g=new o,u=new o;t.queryEnvelope(g),n.queryEnvelope(u),g.mergeEnvelope2D(u);return f(t,n,s(r,g,!0).total(),a)}function f(e,o,s,u){t(e),t(o);let m,c=!1;const l=e.querySegmentIterator(),d=o.querySegmentIterator();let p=0;const h=new a,f=new i({vd:e.getDescription()}),P=new i({vd:e.getDescription()}),S=[],x=[];for(y(e,S,x);l.nextPath();){let t=!0,o=0;for(;2!==o;){if(0===o){l.nextSegment().getGeometryType()!==n.enumLine&&r(""),o++}else{l.resetToLastSegment();if(l.previousSegment().getGeometryType()!==n.enumLine&&r(""),c&&t){const n=l.getPathIndex();m.addSegmentsFromPath(e,n,0,e.getSegmentCountPath(n),!0),t=!1}o++}let a=!1;if(p<x.length){const e=x[S[p]],t=l.getPathIndex();if(e.m_path===t){const t=1===o?l.getStartPointIndex():l.getEndPointIndex();e.m_pointIndex===t&&(a=!0,p++)}}if(1===o){if(8&u)continue}else if(16&u)continue;if(!a){1===o?l.previousSegment():l.nextSegment();const a=1===o?l.nextSegment():l.previousSegment(),i=a,p=i.calculateLength2D();d.resetToFirstPath();let y=!1,S=Number.NaN;for(;d.nextPath();){for(;d.hasNextSegment();){const e=d.nextSegment();e.getGeometryType()!==n.enumLine&&r("");const t=e,{bIntersect:a,t1:u,t2:m}=g(i,t);if(a){const e=t.calculateLength2D();if(m*e>=-s&&(1-m)*e>=-s)if(1===o){if(u*p<=-s)(Number.isNaN(S)||u>S)&&(S=u);else if(u*p<=s){S=Number.NaN,y=!0;break}}else if((1-u)*p<=-s)(Number.isNaN(S)||u<S)&&(S=u);else if((1-u)*p<=s){S=Number.NaN,y=!0;break}}}if(y)break}if(!Number.isNaN(S)){if(!c){m=e.createInstance();for(let t=0;t<l.getPathIndex();t++)m.addPath(e,t,!0)}if(1===o){a.queryCoord(S,f);const n=l.getPathIndex();if(2&u?e.getPointByVal(e.getPathStart(n),P):4&u&&P.setEmpty(),1&u||(h.create(a.getGeometryType()),a.copyTo(h.get()),h.get().setEnd(f),h.get().reverse(),m.addSegment(h.get(),!0),t=!1),m.addSegmentsFromPath(e,n,0,e.getSegmentCountPath(n),t),1&u){const e=m.getPathStart(n);m.setPointByVal(e,f)}if(2&u||4&u){const e=m.getPathStart(n),t=f.getXY();P.setXY(t),m.setPointByVal(e,P)}c=!0,t=!1}else{const n=l.getPathIndex();if(t&&(m.addSegmentsFromPath(e,n,0,e.getSegmentCountPath(n),!0),t=!1),2&u?e.getPointByVal(e.getPathEnd(n)-1,P):4&u&&P.setEmpty(),a.queryCoord(S,f),1&u){const e=m.getPathEnd(n);m.setPointByVal(e-1,f)}else h.create(a.getGeometryType()),a.copyTo(h.get()),h.get().setEnd(f),m.addSegment(h.get(),!1);if(2&u||4&u){const e=m.getPathEnd(n),t=f.getXY();P.setXY(t),m.setPointByVal(e-1,P)}c=!0}}}}}return c?m:null}function P(e,t){return{m_path:e,m_pointIndex:t}}function y(e,t,n){const r=[],o=[],s=e.querySegmentIterator();for(;s.nextPath();){s.resetToFirstSegment();const e=s.nextSegment().getStartXY(),t=s.getPathIndex(),n=s.getStartPointIndex();r.push(e),o.push(P(t,n)),s.resetToLastSegment();const a=s.previousSegment().getEndXY(),i=s.getPathIndex(),g=s.getEndPointIndex();r.push(a),o.push(P(i,g))}const a=new u(0);for(let g=0;g<r.length;g++)a.add(g);const i={userSort(e,t,n){n.sort(e,t,((e,t)=>r[e].compare(r[t])))},getValue:e=>r[e].y};(new m).sort(a,0,a.size(),i);for(let g=0;g<a.size()-1;g++){const e=r[a.read(g)];if(e.equals(r[a.read(g+1)])){do{const e=o[a.read(g)];n.push(e),g++}while(g<a.size()&&e.equals(r[a.read(g)]));g--}}t.length=n.length;for(let g=0;g<n.length;g++)t[g]=g;t.sort(((e,t)=>{const r=n[e],o=n[t];return r.m_path<o.m_path?-1:r.m_path>o.m_path?1:r.m_pointIndex<o.m_pointIndex?-1:1}))}class S{getOperatorType(){return 10007}supportsCurves(){return!1}accelerateGeometry(e,t,n){return!1}canAccelerateGeometry(e){return!1}execute(e,t,n,r,o){return h(e,t,n,r)}}const x=new S;function I(e,t,n){let r=0;n&&(n.relocateEnds&&(r|=1),n.keepEndAttributes&&(r|=2),n.noEndAttributes&&(r|=4),n.noExtendAtFrom&&(r|=8),n.noExtendAtTo&&(r|=16));const o=c(e),s=x.execute(l(e),l(t),d(o),r,null);return s?p(s,o):null}function E(){return x.supportsCurves()}export{I as execute,E as supportsCurves};
