/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{createFieldInfos as e}from"../../support/popupUtils.js";import t from"../../tables/AttributeTableTemplate.js";import l from"../../tables/elements/AttributeTableAttachmentElement.js";import i from"../../tables/elements/AttributeTableFieldElement.js";import s from"../../tables/elements/AttributeTableRelationshipElement.js";import r from"../../widgets/FeatureTable/support/AttachmentsColumnTemplate.js";import o from"../../widgets/FeatureTable/support/FieldColumnTemplate.js";import a from"../../widgets/FeatureTable/support/RelationshipColumnTemplate.js";import n from"../../widgets/FeatureTable/support/TableTemplate.js";import{isIFeatureTableSupportedLayerWithAttachments as m,isIFeatureTableSupportedLayerWithRelationships as d,hasTemplateForField as p}from"../../widgets/FeatureTable/support/tableUtils.js";import{createAttributeTableElements as u,createColumnTemplates as f}from"../../widgets/FeatureTable/support/templateUtils.js";function c(e,t,l=!0){const{allColumns:i,columns:s}=e,r=[],o=u(s.toArray());e.activeSortOrders.forEach((({fieldName:e,direction:t})=>{e&&t&&r.push({field:e,order:t})}));return i.filter((e=>null!=e.direction&&(!e.hidden||l))).forEach((({fieldName:e,direction:t})=>{const l=r.find((t=>t.field===e));t&&!l&&r.push({field:e,order:t})})),t.elements=o,t.orderByFields=r,t}async function b(r){const{excludeAttachments:o,excludeRelationships:a,layer:n}=r,p=[],u=[];n||Promise.resolve(new t),await n.load();const f=e(n,{sortDisabled:!0});for(const{visible:e,fieldName:t,label:l}of f)e&&p.push(new i({fieldName:t,label:l}));return m(n)&&!0!==o&&p.push(new l),d(n)&&!0!==a&&n.relationships?.forEach((e=>{p.push(new s({relationshipId:e.id,label:e.name}))})),new t({elements:p,orderByFields:u})}async function h(t){const{excludeAttachments:l,excludeRelationships:i,layer:s}=t,p=[];await s.load();return e(s,{sortDisabled:!0}).forEach((({fieldName:e,format:t,label:l,visible:i})=>{null!=e&&p.push(new o({fieldName:e,format:t,label:l,visible:i}))})),m(s)&&!0!==l&&p.push(new r),d(s)&&!0!==i&&s.relationships?.forEach((({id:e})=>{p.push(new a({relationshipId:e}))})),new n({columnTemplates:p})}async function w(t){const{layer:l,template:i,includeHiddenFields:s}=t,u=i.orderByFields??[],c=f(i.elements,u);if(s){await l.load();e(l,{sortDisabled:!0}).forEach((e=>{if(!e.fieldName)return;const{fieldName:t,label:l}=e;if(!p(t,c)){const e=u.findIndex((e=>e.field&&e.field===t)),i=e>-1?u.at(e)?.order:void 0;c.push(new o({direction:i,fieldName:t,initialSortPriority:e,label:l,visible:!1}))}})),m(l)&&!c.some((e=>"attachment"===e.type))&&c.push(new r({visible:!1})),d(l)&&l.relationships?.forEach((({id:e})=>{c.some((t=>"relationship"===t.type&&t.relationshipId===e))||c.push(new a({relationshipId:e,visible:!1}))}))}return new n({columnTemplates:c})}export{b as createDefaultAttributeTableTemplateFromLayer,h as createDefaultTableTemplateFromLayer,w as createTableTemplateFromAttributeTableTemplate,c as syncAttributeTableTemplate};
