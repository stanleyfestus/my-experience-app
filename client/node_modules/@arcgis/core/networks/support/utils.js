/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import t from"../../request.js";import e from"../../core/Error.js";import{queryAllJSON as r}from"../../layers/support/featureQueryAll.js";import a from"../../portal/PortalItem.js";import o from"../../rest/support/FeatureSet.js";async function n(t,e){const a=t.layers,n=t.layerInfos,i=t.returnGeometry||!1,l=t.outSpatialReference;await Promise.all(a.map((async t=>{await t.load()})));return(await Promise.all(a.map((async t=>{const a=n.find((e=>e.layerUrl===t.parsedUrl?.path));if(!a?.objectIds?.length)return{layer:t,featureSet:void 0};const s=t.createQuery();s.returnGeometry=i,s.outFields=a.outFields||["*"],s.outSpatialReference=l,s.gdbVersion=t.gdbVersion,s.objectIds=a.objectIds,e&&(s.where="1=1");const p=o.fromJSON(await r(t,s));return{layer:t,featureSet:p}})))).filter((t=>void 0!==t.featureSet))}async function i(t,e){if("Utility Network Layer"===t){const{default:t}=await import("../UtilityNetwork.js");return new t({layerUrl:e})}return null}async function l(r){let o="portalItem"in r?r:{portalItem:r};!o.portalItem||o.portalItem instanceof a||(o={...o,portalItem:new a(o.portalItem)});const n=o.portalItem;if(await n.load(),"Feature Service"!==n.type)throw new e("portal:unknown-item-type","Unknown item type '${type}'",{type:n.type});const l=n.url,s=await t(l,{responseType:"json",query:{f:"json"}}),p="Network Layer";if(s.data.type?.includes(p))return i(s.data.type,l);if(s.data.layers){const t=s.data.layers.find((t=>t.type.includes(p)));if(t){const e=`${l}/${t.id}`;return i(t.type,e)}}return null}export{n as getFeaturesFromLayers,l as networkFromPortalItem};
