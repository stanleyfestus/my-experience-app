/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import{toSymbolId as e}from"./arcadeEnvironment.js";import{ArcadeModule as n}from"./ArcadeModule.js";import{ArcadeModuleLoader as t}from"./ArcadeModuleLoader.js";import{geometryMember as o,getNestedOptionalValue as l}from"./containerUtils.js";import r from"./Dictionary.js";import{ArcadeExecutionError as a,ExecutionErrorCodes as s,ArcadeCompilationError as i,ArcadeUncompilableError as c}from"./executionError.js";import u from"./Feature.js";import{NativeFunction as p,ArcadeFunction as m,ScopeMarshalledFunction as g,wrapModuleScopedResponse as d}from"./FunctionWrapper.js";import{i as f,x as h,y,R as b,I as w,z as S,A as v,B as x,C as F,b as M,o as C,q as I,r as A,c as _,v as O,p as $,j as k,a as E,g as G,D as B,E as j,F as N}from"../chunks/languageUtils.js";import{addFunctionDeclaration as R}from"./treeAnalysis.js";import{A as D}from"../chunks/array.js";import{registerFunctions as L}from"./functions/date.js";import{registerFunctions as U}from"./functions/geometry.js";import{registerFunctions as Z}from"./functions/geomsync.js";import{registerFunctions as K}from"./functions/maths.js";import{registerFunctions as P}from"./functions/stats.js";import{registerFunctions as W}from"./functions/string.js";import{isPromiseLike as T}from"../core/promiseUtils.js";import q from"../geometry/Geometry.js";import z from"../geometry/SpatialReference.js";class V extends m{constructor(e,n){super(),this.paramCount=n,this.fn=e}createFunction(e){return(...n)=>{if(n.length!==this.paramCount)throw new a(e,s.WrongNumberOfParameters,null);return this.fn(...n)}}call(e,n){return this.fn(...n.arguments)}marshalledCall(e,n,t,o){return o(e,n,((n,l,r)=>{r=r.map((n=>!f(n)||n instanceof g?n:d(n,e,o)));const a=this.call(t,{arguments:r});return T(a)?a.then((e=>d(e,t,o))):a}))}}function J(e,n){const t=[];for(let o=0;o<n.arguments.length;o++)t.push(H(e,n.arguments[o]));return t}function Y(e,n,t){try{return t(e,null,n.arguments)}catch(o){throw o}}function H(e,n){switch(n.type){case"AssignmentExpression":return le(e,n);case"UpdateExpression":return te(e,n);case"TemplateLiteral":return we(e,n);case"Identifier":return xe(e,n);case"MemberExpression":return he(e,n);case"Literal":return null===n.value||void 0===n.value?"null":JSON.stringify(n.value);case"CallExpression":return Fe(e,n);case"UnaryExpression":return ye(e,n);case"BinaryExpression":return Se(e,n);case"LogicalExpression":return ve(e,n);case"ArrayExpression":return be(e,n);case"ObjectExpression":return X(e,n);default:throw new i(e,s.Unrecognized,n)}}function Q(e,n){switch(n.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclaration":return de(e,n);case"BlockStatement":return ie(e,n);case"FunctionDeclaration":return ge(e,n);case"ImportDeclaration":return ue(e,n);case"ExportNamedDeclaration":return pe(e,n);case"ReturnStatement":return ce(e,n);case"IfStatement":return se(e,n);case"ExpressionStatement":return re(e,n);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"ForStatement":return ne(e,n);case"ForInStatement":return ee(e,n);case"WhileStatement":return oe(e,n);default:throw new i(e,s.Unrecognized,n)}}function X(e,n){let t="lang.dictionary([";for(let o=0;o<n.properties.length;o++){const l=n.properties[o];let r;"Identifier"===l.key.type?(me(l.key.name),r="'"+l.key.name+"'"):r=H(e,l.key);o>0&&(t+=","),t+="lang.strCheck("+r+",'ObjectExpression'),lang.aCheck("+H(e,l.value)+", 'ObjectExpression')"}return t+="])",t}function ee(n,t){const o=$e(n),l=$e(n),r=$e(n);let a="var "+o+" = "+H(n,t.right)+";\n";"VariableDeclaration"===t.left.type&&(a+=Q(n,t.left));const s=e("VariableDeclaration"===t.left.type?t.left.declarations[0].id:t.left);me(s);let i="";null!==n.localScope&&(void 0!==n.localScope[s]?i="lscope['"+s+"']":void 0!==n.localScope._SymbolsMap[s]&&(i="lscope['"+n.localScope._SymbolsMap[s]+"']"));let c="";if(""===i)if(void 0!==n.globalScope[s])i="gscope['"+s+"']";else if(void 0!==n.globalScope._SymbolsMap[s])i="gscope['"+n.globalScope._SymbolsMap[s]+"']";else if(null!==n.localScope)if(n.undeclaredGlobalsInFunctions.has(s))i="gscope['"+n.undeclaredGlobalsInFunctions.get(s).manglename+"']",c=n.undeclaredGlobalsInFunctions.get(s).manglename;else{const e={manglename:Oe(n),node:t.left};n.undeclaredGlobalsInFunctions.set(s,e),i="gscope['"+e.manglename+"']",c=e.manglename}return c&&(a+="lang.chkAssig('"+c+"',runtimeCtx); \n"),a+="if ("+o+"===null) {  lastStatement = lc.voidOperation; }\n ",a+="else if (lc.isArray("+o+") || lc.isString("+o+")) {",a+="var "+l+"="+o+".length; \n",a+="for(var "+r+"=0; "+r+"<"+l+"; "+r+"++) {\n",a+=i+"="+r+";\n",a+=Q(n,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (lc.isImmutableArray("+o+")) {",a+="var "+l+"="+o+".length(); \n",a+="for(var "+r+"=0; "+r+"<"+l+"; "+r+"++) {\n",a+=i+"="+r+";\n",a+=Q(n,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",a+="else if (( "+o+" instanceof lang.Dictionary) || ( "+o+" instanceof lang.Feature)) {",a+="var "+l+"="+o+".keys(); \n",a+="for(var "+r+"=0; "+r+"<"+l+".length; "+r+"++) {\n",a+=i+"="+l+"["+r+"];\n",a+=Q(n,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n",n.isAsync&&(a+="else if (lc.isFeatureSet("+o+")) {",a+="var "+l+"="+o+".iterator(runtimeCtx.abortSignal); \n",a+="for(var "+r+"=lang. graphicToFeature( yield "+l+".next(),"+o+", runtimeCtx); "+r+"!=null; "+r+"=lang. graphicToFeature( yield "+l+".next(),"+o+", runtimeCtx)) {\n",a+=i+"="+r+";\n",a+=Q(n,t.body),a+="\n}\n",a+=" lastStatement = lc.voidOperation; \n",a+=" \n}\n"),a+="else { lastStatement = lc.voidOperation; } \n",a}function ne(e,n){let t="lastStatement = lc.voidOperation; \n";null!==n.init&&("VariableDeclaration"===n.init.type?t+=Q(e,n.init):t+=H(e,n.init)+"; ");const o=$e(e),l=$e(e);return t+="var "+o+" = true; ",t+="\n do { ",null!==n.update&&(t+=" if ("+o+"===false) {\n "+H(e,n.update)+"  \n}\n "+o+"=false; \n"),null!==n.test&&(t+="var "+l+" = "+H(e,n.test)+"; ",t+="if ("+l+"===false) { break; } else if ("+l+"!==true) { lang.error('"+s.BooleanConditionRequired+"');   }\n"),t+=Q(e,n.body),null!==n.update&&(t+="\n "+H(e,n.update)),t+="\n"+o+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",t}function te(n,t){if("CallExpression"===t.argument.type)throw new i(n,s.NeverReach,t);let o;if("MemberExpression"===t.argument.type){const e=H(n,t.argument.object);return!0===t.argument.computed?o=H(n,t.argument.property):(me(t.argument.property.name),o="'"+t.argument.property.name+"'"),"lang.memberupdate("+e+","+o+",'"+t.operator+"',"+t.prefix+")"}const l=e(t.argument);if(me(l),null!==n.localScope){if(void 0!==n.localScope[l])return"lang.update(lscope, '"+l+"','"+t.operator+"',"+t.prefix+")";if(void 0!==n.localScope._SymbolsMap[l])return"lang.update(lscope, '"+n.localScope._SymbolsMap[l]+"','"+t.operator+"',"+t.prefix+")"}if(void 0!==n.globalScope[l])return"lang.update(gscope, '"+l+"','"+t.operator+"',"+t.prefix+")";if(void 0!==n.globalScope._SymbolsMap[l])return"lang.update(gscope, '"+n.globalScope._SymbolsMap[l]+"','"+t.operator+"',"+t.prefix+")";if(null!==n.localScope){if(n.undeclaredGlobalsInFunctions.has(l))return"lang.update(gscope,lang.chkAssig( '"+n.undeclaredGlobalsInFunctions.get(l).manglename+"',runtimeCtx),'"+t.operator+"',"+t.prefix+")";const e={manglename:Oe(n),node:t.argument};return n.undeclaredGlobalsInFunctions.set(l,e),"lang.update(gscope, lang.chkAssig('"+e.manglename+"',runtimeCtx),'"+t.operator+"',"+t.prefix+")"}throw new a(n,s.InvalidIdentifier,t)}function oe(e,n){let t="lastStatement = lc.voidOperation; \n";const o=$e(e);return t+=`\n  var ${o} = true;\n    do {\n      ${o} = ${H(e,n.test)};\n      if (${o}==false) {\n        break;\n      }\n      if (${o}!==true) {\n        lang.error('${s.BooleanConditionRequired}');\n      }\n      ${Q(e,n.body)}\n    }\n    while (${o} !== false);\n    lastStatement = lc.voidOperation;\n  `,t}function le(n,t){const o=H(n,t.right);if("MemberExpression"===t.left.type){let e;const l=H(n,t.left.object);return!0===t.left.computed?e=H(n,t.left.property):(e="'"+t.left.property.name+"'",me(t.left.property.name)),"lang.assignmember("+l+","+e+",'"+t.operator+"',"+o+")"}const l=e(t.left);if(me(l),null!==n.localScope){if(void 0!==n.localScope[l])return"lscope['"+l+"']=lang.assign("+o+",'"+t.operator+"', lscope['"+l+"'])";if(void 0!==n.localScope._SymbolsMap[l])return"lscope['"+n.localScope._SymbolsMap[l]+"']=lang.assign("+o+",'"+t.operator+"', lscope['"+n.localScope._SymbolsMap[l]+"'])"}if(void 0!==n.globalScope[l])return"gscope['"+l+"']=lang.assign("+o+",'"+t.operator+"', gscope['"+l+"'])";if(void 0!==n.globalScope._SymbolsMap[l])return"gscope['"+n.globalScope._SymbolsMap[l]+"']=lang.assign("+o+",'"+t.operator+"', gscope['"+n.globalScope._SymbolsMap[l]+"'])";if(null!==n.localScope){if(n.undeclaredGlobalsInFunctions.has(l))return"gscope[lang.chkAssig('"+n.undeclaredGlobalsInFunctions.get(l).manglename+"',runtimeCtx)]=lang.assign("+o+",'"+t.operator+"', gscope['"+n.undeclaredGlobalsInFunctions.get(l).manglename+"'])";const e={manglename:Oe(n),node:t.left};return n.undeclaredGlobalsInFunctions.set(l,e),"gscope[lang.chkAssig('"+e.manglename+"',runtimeCtx)]=lang.assign("+o+",'"+t.operator+"', gscope['"+e.manglename+"'])"}throw new a(n,s.InvalidIdentifier,t)}function re(e,n){return"AssignmentExpression"===n.expression.type?"lastStatement = lc.voidOperation; "+H(e,n.expression)+"; \n ":"lastStatement = "+H(e,n.expression)+"; "}function ae(e,n){return"BlockStatement"===n.type?Q(e,n):"ReturnStatement"===n.type||"BreakStatement"===n.type||"ContinueStatement"===n.type?Q(e,n)+"; ":"ExpressionStatement"===n.type?Q(e,n):Q(e,n)+"; "}function se(e,n){return`if (lang.mustBoolean(${H(e,n.test)}, runtimeCtx) === true) {\n    ${ae(e,n.consequent)}\n  } `+(null!==n.alternate?"IfStatement"===n.alternate.type?" else "+se(e,n.alternate):` else {\n      ${ae(e,n.alternate)}\n    }\n`:" else {\n      lastStatement = lc.voidOperation;\n    }\n")}function ie(e,n){let t="";for(let o=0;o<n.body.length;o++)"EmptyStatement"!==n.body[o].type&&("ReturnStatement"===n.body[o].type||"BreakStatement"===n.body[o].type||"ContinueStatement"===n.body[o].type?t+=Q(e,n.body[o])+"; \n":t+=Q(e,n.body[o])+" \n");return t}function ce(e,n){if(null===n.argument)return"return lc.voidOperation";return"return "+H(e,n.argument)}function ue(n,t){const o=e(t.specifiers[0].local);me(o);const l=n.libraryResolver?.loadLibrary(o),r=Oe(n);void 0===n.moduleFactory[l.uri]&&(n.moduleFactory[l.uri]=qe(l.syntax,{interceptor:n.interceptor,services:n.services,moduleFactory:n.moduleFactory,lrucache:n.lrucache,timeZone:n.timeZone??null,libraryResolver:n.libraryResolver,customfunctions:n.customfunctions,vars:{}},n.isAsync)),n.moduleFactoryMap[r]=l.uri;let a,s="";return s=n.isAsync?"(yield lang.loadModule('"+r+"', runtimeCtx) ); ":"lang.loadModule('"+r+"', runtimeCtx); ",void 0!==n.globalScope[o]?"gscope['"+o+"']="+s:void 0!==n.globalScope._SymbolsMap[o]?"gscope['"+n.globalScope._SymbolsMap[o]+"']="+s:(n.undeclaredGlobalsInFunctions.has(o)?(a=n.undeclaredGlobalsInFunctions.get(o).manglename,n.undeclaredGlobalsInFunctions.delete(o)):a=Oe(n),n.globalScope._SymbolsMap[o]=a,n.mangleMap[o]=a,"gscope[lang.setAssig('"+a+"', runtimeCtx)]="+s)}function pe(n,t){const o=Q(n,t.declaration);if("FunctionDeclaration"===t.declaration.type)n.exports[e(t.declaration.id)]="function";else if("VariableDeclaration"===t.declaration.type)for(const l of t.declaration.declarations)n.exports[e(l.id)]="variable";return o}function me(e){if("iif"===e)throw new c;if("decode"===e)throw new c;if("when"===e)throw new c;if("defaultvalue"===e)throw new c}function ge(n,t){const o=e(t.id);let l;me(o);let r=!1;void 0!==n.globalScope[o]?l=o:void 0!==n.globalScope._SymbolsMap[o]?l=n.globalScope._SymbolsMap[o]:n.undeclaredGlobalsInFunctions.has(o)?(l=n.undeclaredGlobalsInFunctions.get(o).manglename,n.globalScope._SymbolsMap[o]=l,n.mangleMap[o]=l,n.undeclaredGlobalsInFunctions.delete(o),r=!0):(l=Oe(n),n.globalScope._SymbolsMap[o]=l,n.mangleMap[o]=l);const a={isAsync:n.isAsync,console:n.console,exports:n.exports,undeclaredGlobalsInFunctions:n.undeclaredGlobalsInFunctions,customfunctions:n.customfunctions,moduleFactory:n.moduleFactory,moduleFactoryMap:n.moduleFactoryMap,libraryResolver:n.libraryResolver,lrucache:n.lrucache,interceptor:n.interceptor,services:n.services,symbols:n.symbols,mangleMap:n.mangleMap,localScope:{_SymbolsMap:{}},depthCounter:n.depthCounter,globalScope:n.globalScope};let s="new lang.UserDefinedCompiledFunction( lang.functionDepthchecker(function() { var lastStatement = lc.voidOperation; \n   var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];\n";for(let i=0;i<t.params.length;i++){const o=e(t.params[i]);me(o);const l=Oe(n);a.localScope._SymbolsMap[o]=l,a.mangleMap[o]=l,s+="lscope['"+l+"']=arguments["+i.toString()+"];\n"}return!0===n.isAsync?(s+="return lang.__awaiter(this, void 0, void 0, function* () {\n",s+=ie(a,t.body)+"\n return lastStatement; ",s+="});  }",s+=", runtimeCtx),"+t.params.length+")",s+="\n lastStatement = lc.voidOperation; \n"):(s+=ie(a,t.body)+"\n return lastStatement; }, runtimeCtx),"+t.params.length+")",s+="\n lastStatement = lc.voidOperation; \n"),r?"gscope[lang.setAssig('"+l+"', runtimeCtx)]="+s:"gscope['"+l+"']="+s}function de(e,n){const t=[];for(let o=0;o<n.declarations.length;o++)t.push(fe(e,n.declarations[o]));return t.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}function fe(n,t){const o=null===t.init?null:H(n,t.init),l=e(t.id);if(me(l),null!==n.localScope){if(void 0!==n.localScope[l])return"lscope['"+l+"']="+o+"; ";if(void 0!==n.localScope._SymbolsMap[l])return"lscope['"+n.localScope._SymbolsMap[l]+"']="+o+"; ";const e=Oe(n);return n.localScope._SymbolsMap[l]=e,n.mangleMap[l]=e,"lscope['"+e+"']="+o+"; "}if(void 0!==n.globalScope[l])return"gscope['"+l+"']="+o+"; ";if(void 0!==n.globalScope._SymbolsMap[l])return"gscope['"+n.globalScope._SymbolsMap[l]+"']="+o+"; ";if(n.undeclaredGlobalsInFunctions.has(l)){const e=n.undeclaredGlobalsInFunctions.get(l).manglename;return n.globalScope._SymbolsMap[l]=e,n.mangleMap[l]=e,n.undeclaredGlobalsInFunctions.delete(l),"gscope[lang.setAssig('"+e+"', runtimeCtx)]="+o+"; "}const r=Oe(n);return n.globalScope._SymbolsMap[l]=r,n.mangleMap[l]=r,"gscope['"+r+"']="+o+"; "}function he(e,n){try{let t;return!0===n.computed?t=H(e,n.property):(me(n.property.name),t="'"+n.property.name+"'"),"lang.member("+H(e,n.object)+","+t+")"}catch(t){throw t}}function ye(e,n){try{return"lang.unary("+H(e,n.argument)+",'"+n.operator+"')"}catch(t){throw t}}function be(e,n){try{const t=[];for(let o=0;o<n.elements.length;o++)"Literal"===n.elements[o].type?t.push(H(e,n.elements[o])):t.push("lang.aCheck("+H(e,n.elements[o])+",'ArrayExpression')");return"["+t.join(",")+"]"}catch(t){throw t}}function we(e,n){try{const t=[];let o=0;for(const l of n.quasis)t.push(l.value?JSON.stringify(l.value.cooked):JSON.stringify("")),!1===l.tail&&(t.push(n.expressions[o]?"lang.castString(lang.aCheck("+H(e,n.expressions[o])+", 'TemplateLiteral'))":""),o++);return"(["+t.join(",")+"]).join('')"}catch(t){throw t}}function Se(e,n){try{return"lang.binary("+H(e,n.left)+","+H(e,n.right)+",'"+n.operator+"')"}catch(t){throw t}}function ve(e,n){try{if("AssignmentExpression"===n.left.type||"UpdateExpression"===n.left.type)throw new i(e,s.LogicalExpressionOnlyBoolean,n);if("AssignmentExpression"===n.right.type||"UpdateExpression"===n.right.type)throw new i(e,s.LogicalExpressionOnlyBoolean,n);if("&&"===n.operator||"||"===n.operator)return"(lang.logicalCheck("+H(e,n.left)+") "+n.operator+" lang.logicalCheck("+H(e,n.right)+"))";throw new i(null,s.LogicExpressionOrAnd,null)}catch(t){throw t}}function xe(n,t){try{const o=e(t);if(me(o),null!==n.localScope){if(void 0!==n.localScope[o])return"lscope['"+o+"']";if(void 0!==n.localScope._SymbolsMap[o])return"lscope['"+n.localScope._SymbolsMap[o]+"']"}if(void 0!==n.globalScope[o])return"gscope['"+o+"']";if(void 0!==n.globalScope._SymbolsMap[o])return"gscope['"+n.globalScope._SymbolsMap[o]+"']";if(null!==n.localScope){if(n.undeclaredGlobalsInFunctions.has(o))return"gscope[lang.chkAssig('"+n.undeclaredGlobalsInFunctions.get(o).manglename+"',runtimeCtx)]";const e={manglename:Oe(n),node:t};return n.undeclaredGlobalsInFunctions.set(o,e),"gscope[lang.chkAssig('"+e.manglename+"',runtimeCtx)]"}throw new i(n,s.InvalidIdentifier,t)}catch(o){throw o}}function Fe(n,t){try{if("MemberExpression"===t.callee.type){let e;!0===t.callee.computed?e=H(n,t.callee.property):(me(t.callee.property.name),e="'"+t.callee.property.name+"'");let o="[";for(let l=0;l<t.arguments.length;l++)l>0&&(o+=", "),o+=H(n,t.arguments[l]);return o+="]",n.isAsync?"(yield lang.callModuleFunction("+H(n,t.callee.object)+","+o+","+e+",runtimeCtx))":"lang.callModuleFunction("+H(n,t.callee.object)+","+o+","+e+",runtimeCtx)"}if("Identifier"!==t.callee.type)throw new i(n,s.FunctionNotFound,t);const o=e(t.callee);if("iif"===o)return Me(n,t);if("when"===o)return Ie(n,t);if("defaultvalue"===o)return Ce(n,t);if("decode"===o)return Ae(n,t);let l="";if(null!==n.localScope&&(void 0!==n.localScope[o]?l="lscope['"+o+"']":void 0!==n.localScope._SymbolsMap[o]&&(l="lscope['"+n.localScope._SymbolsMap[o]+"']")),""===l)if(void 0!==n.globalScope[o])l="gscope['"+o+"']";else if(void 0!==n.globalScope._SymbolsMap[o])l="gscope['"+n.globalScope._SymbolsMap[o]+"']";else if(null!==n.localScope)if(n.undeclaredGlobalsInFunctions.has(o))l="gscope[lang.chkAssig('"+n.undeclaredGlobalsInFunctions.get(o).manglename+"',runtimeCtx)]";else{const e={manglename:Oe(n),node:t.callee};n.undeclaredGlobalsInFunctions.set(o,e),l="gscope[lang.chkAssig('"+e.manglename+"',runtimeCtx)]"}if(""!==l){let e="[";for(let o=0;o<t.arguments.length;o++)o>0&&(e+=", "),e+=H(n,t.arguments[o]);return e+="]",n.isAsync?"(yield lang.callfunc("+l+","+e+",runtimeCtx) )":"lang.callfunc("+l+","+e+",runtimeCtx)"}throw new i(n,s.FunctionNotFound,t)}catch(o){throw o}}function Me(e,n){try{if(3!==n.arguments.length)throw new i(e,s.WrongNumberOfParameters,n);const t=$e(e);return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${H(e,n.arguments[0])};\n\n        if (${t} === true) {\n          return  ${H(e,n.arguments[1])};\n        }\n        else if (${t} === false) {\n          return ${H(e,n.arguments[2])};\n        }\n        else {\n          lang.error('ExecutionErrorCodes.BooleanConditionRequired');\n        }\n      ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Ce(e,n){try{if(n.arguments.length<2||n.arguments.length>3)throw new i(e,s.WrongNumberOfParameters,n);const t=$e(e),o=$e(e);return 3===n.arguments.length?`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n      var ${t} = ${H(e,n.arguments[0])};\n      var ${o} = ${H(e,n.arguments[1])};\n      ${t} = lang.getNestedOptionalValue(${t}, ${o});\n      return ${t} != null && ${t} !== "" ? ${t} : ${H(e,n.arguments[2])};\n      ${e.isAsync?"})}()))":"}()"}`:`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${H(e,n.arguments[0])};\n        if (${t} === null) {\n          return  ${H(e,n.arguments[1])};\n        }\n        if (${t} === "") {\n          return  ${H(e,n.arguments[1])};\n        }\n        if (${t} === undefined) {\n          return  ${H(e,n.arguments[1])};\n        }\n        return ${t};\n      ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Ie(e,n){try{if(n.arguments.length<3)throw new i(e,s.WrongNumberOfParameters,n);if(n.arguments.length%2==0)throw new i(e,s.WrongNumberOfParameters,n);const t=$e(e);let o="var ";for(let l=0;l<n.arguments.length-1;l+=2)o+=`${t} = lang.mustBoolean(${H(e,n.arguments[l])}, runtimeCtx);\n      if (${t} === true ) {\n        return ${H(e,n.arguments[l+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        ${o}\n        return ${H(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Ae(e,n){try{if(n.arguments.length<2)throw new i(e,s.WrongNumberOfParameters,n);if(2===n.arguments.length)return`(${H(e,n.arguments[1])})`;if((n.arguments.length-1)%2==0)throw new i(e,s.WrongNumberOfParameters,n);const t=$e(e),o=$e(e);let l="var ";for(let r=1;r<n.arguments.length-1;r+=2)l+=`${o} = ${H(e,n.arguments[r])};\n      if (lang.binary(${o}, ${t}, "==") === true ) {\n        return ${H(e,n.arguments[r+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${H(e,n.arguments[0])};\n        ${l}\n        return ${H(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}const _e={};function Oe(e){return e.symbols.symbolCounter++,`_T${e.symbols.symbolCounter}`}function $e(e){return e.symbols.symbolCounter++,`_Tvar${e.symbols.symbolCounter}`}L(_e,Y),W(_e,Y),K(_e,Y),U(_e,Y),P(_e,Y),_e.iif=function(e,n){try{return Y(e,n,((t,o,l)=>{throw new a(e,s.Unrecognized,n)}))}catch(t){throw t}},_e.decode=function(e,n){try{return Y(e,n,((t,o,l)=>{throw new a(e,s.Unrecognized,n)}))}catch(t){throw t}},_e.when=function(e,n){try{return Y(e,n,((t,o,l)=>{throw new a(e,s.Unrecognized,n)}))}catch(t){throw t}},_e.defaultvalue=function(e,n){try{return Y(e,n,((t,o,l)=>{throw new a(e,s.Unrecognized,n)}))}catch(t){throw t}};const ke={};for(const ze in _e)ke[ze]=new p(_e[ze]);Z(_e,Y);for(const ze in _e)_e[ze]=new p(_e[ze]);const Ee=function(){};Ee.prototype=_e;const Ge=function(){};function Be(e,n,t){const o={_SymbolsMap:{}};e||(e={}),t||(t={}),o.textformatting=1,o.infinity=1,o.pi=1;for(const l in n)o[l]=1;for(const l in t)o[l]=1;for(const l in e)o[l]=1;return o}function je(e,n,t,o){const l=t?new Ge:new Ee;e||(e={}),n||(n={});const a=new r({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});a.immutable=!1,l._SymbolsMap={textformatting:1,infinity:1,pi:1},l.textformatting=a,l.infinity=Number.POSITIVE_INFINITY,l.pi=Math.PI;for(const r in n)l[r]=n[r],l._SymbolsMap[r]=1;for(const r in e){const n=e[r];l._SymbolsMap[r]=1,F(n)?l[r]=u.createFromGraphic(n,o??null):l[r]=n}return l}Ge.prototype=ke;const Ne={fixSpatialReference:h,parseArguments:J,standardFunction:Y};function Re(e,n){const t={mode:n,compiled:!0,functions:{},signatures:[],standardFunction:Y,standardFunctionAsync:Y,evaluateIdentifier:Le};for(let o=0;o<e.length;o++)e[o].registerFunctions(t);if("sync"===n){for(const e in t.functions)_e[e]=new p(t.functions[e]),Ee.prototype[e]=_e[e];for(let e=0;e<t.signatures.length;e++)R(t.signatures[e],"sync")}else{for(const e in t.functions)ke[e]=new p(t.functions[e]),Ge.prototype[e]=ke[e];for(let e=0;e<t.signatures.length;e++)R(t.signatures[e],"async")}}function De(e,n){return e(n)}function Le(e,n){const t=n.name;if("_SymbolsMap"===t)throw new a(e,s.InvalidIdentifier,null);if(e.localStack.length>0){if(!t.toLowerCase().startsWith("_t")&&void 0!==e.localStack[e.localStack.length-1][t])return e.localStack[e.localStack.length-1][t];const n=e.mangleMap[t];if(void 0!==n&&void 0!==e.localStack[e.localStack.length-1][n])return e.localStack[e.localStack.length-1][n]}if(!t.toLowerCase().startsWith("_t")&&void 0!==e.globalScope[t])return e.globalScope[t];if(1===e.globalScope._SymbolsMap[t])return e.globalScope[t];const o=e.mangleMap[t];return void 0!==o?e.globalScope[o]:void 0}Re([D],"sync"),Re([D],"async");let Ue=0;const Ze={isNumber:e=>M(e),isArray:e=>C(e),isImmutableArray:e=>I(e),isFeature:e=>A(e),isString:e=>_(e),isDictionary:e=>O(e),isGeometry:e=>$(e),geometryMember:(e,n,t,l,r=1)=>o(e,n,t,l,r),error(e){throw new a(null,e,null)},__awaiter:(e,n,t,o)=>new Promise(((t,l)=>{function r(e){try{s(o.next(e))}catch(n){l(n)}}function a(e){try{s(o.throw(e))}catch(n){l(n)}}function s(e){e.done?t(e.value):e.value?.then?e.value.then(r,a):(Ue++,Ue%100==0?setTimeout((()=>{Ue=0,r(e.value)}),0):r(e.value))}s((o=o.apply(e,n||[])).next())})),functionDepthchecker:(e,n)=>function(){if(n.depthCounter.depth++,n.localStack.push({}),n.depthCounter.depth>64)throw new a(null,s.MaximumCallDepth,null);const t=e.apply(this,arguments);return T(t)?t.then((e=>(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,e))):(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,t)},chkAssig(e,n){if(void 0===n.gdefs[e])throw new a(n,s.InvalidIdentifier,null);return e},mustBoolean(e,n){if(!0===e||!1===e)return e;throw new a(n,s.BooleanConditionRequired,null)},setAssig:(e,n)=>(n.gdefs[e]=1,e),castString:e=>k(e),aCheck(e,n){if(f(e)){if("ArrayExpression"===n)throw new a(null,s.NoFunctionInArray,null);if("ObjectExpression"===n)throw new a(null,s.NoFunctionInDictionary,null);throw new a(null,s.NoFunctionInTemplateLiteral,null)}return e===S?null:e},Dictionary:r,Feature:u,UserDefinedCompiledFunction:V,dictionary(e){const n={},t=new Map;for(let l=0;l<e.length;l+=2){if(f(e[l+1]))throw new a(null,s.NoFunctionInDictionary,null);if(!1===_(e[l]))throw new a(null,s.KeyMustBeString,null);let o=e[l].toString();const r=o.toLowerCase();t.has(r)?o=t.get(r):t.set(r,o),e[l+1]===S?n[o]=null:n[o]=e[l+1]}const o=new r(n);return o.immutable=!1,o},strCheck(e){if(!1===_(e))throw new a(null,s.KeyMustBeString,null);return e},unary(e,n){if(E(e)){if("!"===n)return!e;if("-"===n)return-1*G(e);if("+"===n)return 1*G(e);if("~"===n)return~G(e);throw new a(null,s.UnsupportedUnaryOperator,null)}if("-"===n)return-1*G(e);if("+"===n)return 1*G(e);if("~"===n)return~G(e);throw new a(null,s.UnsupportedUnaryOperator,null)},logicalCheck(e){if(!1===E(e))throw new a(null,s.LogicExpressionOrAnd,null);return e},logical(e,n,t){if(E(e)&&E(n))switch(t){case"||":return e||n;case"&&":return e&&n;default:throw new a(null,s.LogicExpressionOrAnd,null)}throw new a(null,s.LogicExpressionOrAnd,null)},binary(e,n,t){switch(t){case"|":case"<<":case">>":case">>>":case"^":case"&":return N(G(e),G(n),t);case"==":case"=":return j(e,n);case"!=":return!j(e,n);case"<":case">":case"<=":case">=":return B(e,n,t);case"+":return _(e)||_(n)?k(e)+k(n):G(e)+G(n);case"-":return G(e)-G(n);case"*":return G(e)*G(n);case"/":return G(e)/G(n);case"%":return G(e)%G(n);default:throw new a(null,s.UnsupportedOperator,null)}},assign(e,n,t){switch(n){case"=":return e===S?null:e;case"/=":return G(t)/G(e);case"*=":return G(t)*G(e);case"-=":return G(t)-G(e);case"+=":return _(t)||_(e)?k(t)+k(e):G(t)+G(e);case"%=":return G(t)%G(e);default:throw new a(null,s.UnsupportedOperator,null)}},update(e,n,t,o){const l=G(e[n]);return e[n]="++"===t?l+1:l-1,!1===o?l:"++"===t?l+1:l-1},graphicToFeature:(e,n,t)=>null===e?null:u.createFromGraphicLikeObject(e.geometry,e.attributes,n,t.timeZone),memberupdate(e,n,t,o){let l;if(C(e)){if(!M(n))throw new a(null,s.ArrayAccessorMustBeNumber,null);if(n<0&&(n=e.length+n),n<0||n>=e.length)throw new a(null,s.OutOfBounds,null);l=G(e[n]),e[n]="++"===t?l+1:l-1}else if(e instanceof r){if(!1===_(n))throw new a(null,s.KeyAccessorMustBeString,null);if(!0!==e.hasField(n))throw new a(null,s.FieldNotFound,null,{key:n});l=G(e.field(n)),e.setField(n,"++"===t?l+1:l-1)}else if(A(e)){if(!1===_(n))throw new a(null,s.KeyAccessorMustBeString,null);if(!0!==e.hasField(n))throw new a(null,s.FieldNotFound,null);l=G(e.field(n)),e.setField(n,"++"===t?l+1:l-1)}else{if(I(e))throw new a(null,s.Immutable,null);if(!(e instanceof Te))throw new a(null,s.InvalidIdentifier,null);if(!1===_(n))throw new a(null,s.ModuleAccessorMustBeString,null);if(!0!==e.hasGlobal(n))throw new a(null,s.ModuleExportNotFound,null);l=G(e.global(n)),e.setGlobal(n,"++"===t?l+1:l-1)}return!1===o?l:"++"===t?l+1:l-1},assignmember(e,n,t,o){if(C(e)){if(!M(n))throw new a(null,s.ArrayAccessorMustBeNumber,null);if(n<0&&(n=e.length+n),n<0||n>e.length)throw new a(null,s.OutOfBounds,null);if(n===e.length){if("="!==t)throw new a(null,s.OutOfBounds,null);e[n]=this.assign(o,t,e[n])}else e[n]=this.assign(o,t,e[n])}else if(e instanceof r){if(!1===_(n))throw new a(null,s.KeyAccessorMustBeString,null);if(!0===e.hasField(n))e.setField(n,this.assign(o,t,e.field(n)));else{if("="!==t)throw new a(null,s.FieldNotFound,null);e.setField(n,this.assign(o,t,null))}}else if(A(e)){if(!1===_(n))throw new a(null,s.KeyAccessorMustBeString,null);if(!0===e.hasField(n))e.setField(n,this.assign(o,t,e.field(n)));else{if("="!==t)throw new a(null,s.FieldNotFound,null);e.setField(n,this.assign(o,t,null))}}else{if(I(e))throw new a(null,s.Immutable,null);if(!(e instanceof Te))throw new a(null,s.InvalidIdentifier,null);if(!1===_(n))throw new a(null,s.ModuleAccessorMustBeString,null);if(!e.hasGlobal(n))throw new a(null,s.ModuleExportNotFound,null);e.setGlobal(n,this.assign(o,t,e.global(n)))}},member(e,n){if(null===e)throw new a(null,s.MemberOfNull,null);if(e instanceof r||A(e)){if(_(n))return e.field(n);throw new a(null,s.InvalidMemberAccessKey,null)}if(e instanceof q){if(_(n))return o(e,n,null,null);throw new a(null,s.InvalidMemberAccessKey,null)}if(C(e)){if(M(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new a(null,s.OutOfBounds,null);return e[n]}throw new a(null,s.InvalidMemberAccessKey,null)}if(_(e)){if(M(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new a(null,s.OutOfBounds,null);return e[n]}throw new a(null,s.InvalidMemberAccessKey,null)}if(I(e)){if(M(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length()+n),n>=e.length()||n<0)throw new a(null,s.OutOfBounds,null);return e.get(n)}throw new a(null,s.InvalidMemberAccessKey,null)}if(e instanceof Te){if(_(n))return e.global(n);throw new a(null,s.InvalidMemberAccessKey,null)}throw new a(null,s.InvalidMemberAccessKey,null)},callfunc:(e,n,t)=>e.call(t,{arguments:n,preparsed:!0}),loadModule(e,n){const t=n.moduleFactoryMap[e];if(n.moduleSingletons[t])return n.moduleSingletons[t];const o=n.moduleFactory[t]({vars:{},moduleSingletons:n.moduleSingletons,depthCounter:n.depthCounter,console:n.console,abortSignal:n.abortSignal,isAsync:n.isAsync,services:n.services,lrucache:n.lrucache,timeZone:n.timeZone??null,interceptor:n.interceptor},n.spatialReference);return n.moduleSingletons[t]=o,o},callModuleFunction(e,n,t,o){if(!(e instanceof Te))throw new a(null,s.FunctionNotFound,null);const l=e.global(t);if(!1===f(l))throw new a(null,s.CallNonFunction,null);return l.call(o,{preparsed:!0,arguments:n})},getNestedOptionalValue:(e,n)=>l(e,n)};function Ke(e){console.log(e)}function Pe(e,n,o=!1){null===n&&(n={vars:{},customfunctions:{}});let l=null;e.usesModules&&(l=new t(null,e.loadedModules));const r={isAsync:o,globalScope:Be(n.vars,o?ke:_e,n.customfunctions),moduleFactory:{},moduleFactoryMap:{},undeclaredGlobalsInFunctions:new Map,customfunctions:n.customfunctions,libraryResolver:l,localScope:null,mangleMap:{},depthCounter:{depth:1},exports:{},console:Ke,lrucache:n.lrucache,timeZone:n.timeZone??null,interceptor:n.interceptor,services:n.services,symbols:{symbolCounter:0}};let c=ie(r,e);""===c&&(c="lc.voidOperation; "),r.undeclaredGlobalsInFunctions.size>0&&r.undeclaredGlobalsInFunctions.forEach((e=>{throw new i(n,s.InvalidIdentifier,e.node)}));let u="";u=o?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+c+"\n return lastStatement; }); } \n return this.postProcess(yield mainBody()); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+c+"\n return lastStatement; } \n return this.postProcess(mainBody()); ";const p=r.moduleFactory,m=r.moduleFactoryMap,g=r.exports,d={};let h;for(h in g)d[h]=r.mangleMap[h]??h;const F={lc:y,lang:Ze,mangles:r.mangleMap,postProcess(e){if(e instanceof b&&(e=e.value),e instanceof w&&(e=e.value),e===S&&(e=null),e===v)throw new a(null,s.IllegalResult,null);if(e===x)throw new a(null,s.IllegalResult,null);if(f(e))throw new a(null,s.IllegalResult,null);return e},prepare(e,n){let t=e.spatialReference;null==t&&(t=z.WebMercator);const o=je(e.vars,e.customfunctions,n,e.timeZone);return{localStack:[],isAsync:n,moduleFactory:p,moduleFactoryMap:m,mangleMap:this.mangles,moduleSingletons:{},exports:g,gdefs:{},exportmangle:d,spatialReference:t,globalScope:o,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console??Ke,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:{depth:1}}}};return new Function("context","spatialReference",u).bind(F)}async function We(){return Re([await import("./functions/geomasync.js")],"async"),!0}class Te extends n{constructor(e){super(),this.moduleContext=e}hasGlobal(e){return void 0===this.moduleContext.exports[e]&&(e=e.toLowerCase()),void 0!==this.moduleContext.exports[e]}setGlobal(e,n){const t=this.moduleContext.globalScope,o=e.toLowerCase();if(f(n))throw new a(null,s.AssignModuleFunction,null);t[this.moduleContext.exportmangle[o]]=n}global(e){const n=this.moduleContext.globalScope,t=e.toLowerCase(),o=n[this.moduleContext.exportmangle[t]];if(void 0===o)throw new a(null,s.InvalidIdentifier,null);if(f(o)&&!(o instanceof g)){const e=new g;return e.fn=o,e.parameterEvaluator=Y,e.context=this.moduleContext,n[this.moduleContext.exportmangle[t]]=e,e}return o}}function qe(e,n,o=!1){const l={isAsync:o,moduleFactory:n.moduleFactory,moduleFactoryMap:{},libraryResolver:new t(null,e.loadedModules),globalScope:Be(n.vars,o?ke:_e,n.customfunctions),customfunctions:n.customfunctions,localScope:null,mangleMap:{},undeclaredGlobalsInFunctions:new Map,depthCounter:{depth:1},exports:{},console:Ke,lrucache:n.lrucache,timeZone:n.timeZone??null,interceptor:n.interceptor,services:n.services,symbols:{symbolCounter:0}};let r=ie(l,e);""===r&&(r="lc.voidOperation; ");let a="";a=o?"var runtimeCtx=this.prepare(context, true);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \nreturn lang.__awaiter(this, void 0, void 0, function* () {\n\n function mainBody() {\n var lastStatement=lc.voidOperation;\n return lang.__awaiter(this, void 0, void 0, function* () {\n"+r+"\n return lastStatement; }); } \n yield mainBody(); \n return this.prepareModule(runtimeCtx); }); ":"var runtimeCtx=this.prepare(context, false);\n var lc = this.lc;  var lang = this.lang; var gscope=runtimeCtx.globalScope; \n function mainBody() {\n var lastStatement=lc.voidOperation;\n "+r+"\n return lastStatement; } \n mainBody(); \n return this.prepareModule(runtimeCtx); ";const s=l.moduleFactory,i=l.moduleFactoryMap,c=l.exports,u={};let p;for(p in c)u[p]=l.mangleMap[p]??p;const m={lc:y,lang:Ze,mangles:l.mangleMap,prepareModule:e=>new Te(e),prepare(e,n){let t=e.spatialReference;null==t&&(t=new z({wkid:102100}));const o=je(e.vars,e.customfunctions,n,e.timeZone);return{localStack:[],isAsync:n,exports:c,exportmangle:u,gdefs:{},moduleFactory:s,moduleFactoryMap:i,moduleSingletons:e.moduleSingletons,mangleMap:this.mangles,spatialReference:t,globalScope:o,abortSignal:void 0===e.abortSignal||null===e.abortSignal?{aborted:!1}:e.abortSignal,localScope:null,services:e.services,console:e.console??Ke,lrucache:e.lrucache,timeZone:e.timeZone??null,interceptor:e.interceptor,symbols:{symbolCounter:0},depthCounter:e.depthCounter}}};return new Function("context","spatialReference",a).bind(m)}export{V as UserDefinedCompiledFunction,Pe as compileScript,We as enableAsyncSupport,De as executeScript,Re as extend,Ne as functionHelper};
