/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import"../../../geometry.js";import{deepClone as e}from"../../../arcade/deepClone.js";import"../../../core/Error.js";import"../../../core/has.js";import"../../../core/Logger.js";import{create as t}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{fromPoints as r,intersectLine as a}from"../../../geometry/support/plane.js";import n from"./updateElevation.js";import{pointToArray as o,or as i}from"./utils.js";import{worldToImage as c,worldToImagePanoramic as s}from"./worldToImage.js";import p from"../../../geometry/Point.js";import f from"../../../geometry/Polygon.js";async function m(e,n,c,s=h){const{cameraLocation:f,farPlaneVertices:m}=c,l=o(f),w=new Array;await u(m,c,w);let j=r(w[0],w[1],w[2]),b=e.clone();for(let h=0;h<s;h++){const e=t();if(!a(j,l,o(b),e))break;let s=0,m=null;if(({error:s,imagePoint:m,pointWithZ:b}=await y(n,new p(e,f.spatialReference),c)),s<=1)break;const[h,u]=g(f.spatialReference,w);if(i(h<=1,u<=1))break;w.splice(0,w.length,...await x(h,u,new p(e,f.spatialReference),c)),j=r(w[0],w[1],w[2])}return o(b)}async function l(e,n,c,s=h){const{cameraLocation:f,farPlaneVertices:m}=c,l=o(f),w=new Array;await u(m,c,w);let y=r(w[0],w[1],w[2]),b=e.clone();for(let h=0;h<s;h++){const e=t();if(!a(y,l,o(b),e))break;let s,m=0;if(({error:m,imagePoint:s,pointWithZ:b}=await j(n,new p(e,f.spatialReference),c)),m<=1)break;const[h,u]=g(f.spatialReference,w);if(i(h<=1,u<=1))break;w.splice(0,w.length,...await x(h,u,new p(e,f.spatialReference),c)),y=r(w[0],w[1],w[2])}return o(b)}const h=10,w=10;function g(e,t){const r=new f({spatialReference:e});r.addRing(t);return[r.extent?.width?r.extent.width/w:1,r.extent?.height?r.extent.width/w:1]}async function u(t,r,a){const i=e(t),c=await n(i,r);a.push(...c.map(o))}async function y(e,t,r){const a=await n(t,r),o=c(a,r);return{error:b(o,e),imagePoint:o,pointWithZ:a}}async function j(e,t,r){const a=await n(t,r),o=s(a,r);return{error:d(o,e),imagePoint:o,pointWithZ:a}}const b=(e,t)=>Math.abs(e.x-t.x)+Math.abs(e.y-t.y),d=(e,t)=>Math.abs(e.heading-t.heading)+Math.abs(e.pitch-t.pitch);async function x(e,t,r,a){const o=[[-e,-t],[e,-t],[e,t],[-e,t]].map((([e,t])=>new p([r.x+e,r.y+t],r.spatialReference)));return n(o,a).then((e=>e.map((e=>e.toArray()))))}export{m as rectifyMapPoint,l as rectifyMapPointPanoramic};
