/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.31/esri/copyright.txt for details.
*/
import has from"../../core/has.js";import{parse as t,isHostedAgolService as s}from"./arcgisLayerUrl.js";import{readBoolean as e,readNumber as r}from"../../rest/support/jsonUtils.js";const p={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"};function o(t){const s=t?.supportedSpatialAggregationStatistics?.map((t=>t.toLowerCase()));return{envelope:!!s?.includes("envelopeaggregate"),centroid:!!s?.includes("centroidaggregate"),convexHull:!!s?.includes("convexhullaggregate")}}function u(t,s){const e=t?.supportedOperationsWithCacheHint?.map((t=>t.toLowerCase()));return!!e?.includes(s.toLowerCase())}function n(t){const s=t?.supportedStatisticTypes?.map((t=>t.toLowerCase()));return{count:!!s?.includes("count"),sum:!!s?.includes("sum"),min:!!s?.includes("min"),max:!!s?.includes("max"),avg:!!s?.includes("avg"),var:!!s?.includes("var"),stddev:!!s?.includes("stddev"),percentileContinuous:!!s?.includes("percentile_continuous"),percentileDiscrete:!!s?.includes("percentile_discrete"),envelope:!!s?.includes("envelopeaggregate"),centroid:!!s?.includes("centroidaggregate"),convexHull:!!s?.includes("convexhullaggregate")}}function i(t,s){return{analytics:a(t),attachment:c(t),data:d(t),metadata:l(t),operations:y(t.capabilities,t,s),query:m(t,s),queryBins:C(t),queryRelated:g(t),queryTopFeatures:h(t),editing:v(t)}}function a(t){return{supportsCacheHint:u(t.advancedQueryCapabilities,"queryAnalytics")}}function c(t){const s=t.attachmentProperties,r={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:u(t.advancedQueryCapabilities,"queryAttachments"),supportsResize:e(t,"supportsAttachmentsResizing",!1)};return s&&Array.isArray(s)&&s.forEach((t=>{const s=p[t.name];s&&(r[s]=!!t.isEnabled)})),r}function d(t){return{isVersioned:e(t,"isDataVersioned",!1),isBranchVersioned:e(t,"isDataBranchVersioned",!1),supportsAttachment:e(t,"hasAttachments",!1),supportsM:e(t,"hasM",!1),supportsZ:e(t,"hasZ",!1)}}function l(t){return{supportsAdvancedFieldProperties:e(t,"supportsFieldDescriptionProperty",!1)}}function y(s,r,p){const o=s?s.toLowerCase().split(",").map((t=>t.trim())):[],u=p?t(p):null,n=o.includes(null!=u&&"MapServer"===u.serverType?"data":"query"),i=o.includes("editing")&&!r.datesInUnknownTimezone;let a=i&&o.includes("create"),c=i&&o.includes("delete"),d=i&&o.includes("update");const l=o.includes("changetracking"),y=r.advancedQueryCapabilities;return i&&!(a||c||d)&&(a=c=d=!0),{supportsCalculate:e(r,"supportsCalculate",!1),supportsTruncate:e(r,"supportsTruncate",!1),supportsValidateSql:e(r,"supportsValidateSql",!1),supportsAdd:a,supportsDelete:c,supportsEditing:i,supportsChangeTracking:l,supportsQuery:n,supportsQueryAnalytics:e(y,"supportsQueryAnalytic",!1),supportsQueryAttachments:e(y,"supportsQueryAttachments",!1),supportsQueryBins:e(y,"supportsQueryBins",!1),supportsQueryTopFeatures:e(y,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:e(r,"supportsAttachmentsResizing",!1),supportsSync:o.includes("sync"),supportsUpdate:d,supportsExceedsLimitStatistics:e(r,"supportsExceedsLimitStatistics",!1),supportsAsyncConvert3D:e(r,"supportsAsyncConvert3D",!1)}}function m(t,p){const n=t.advancedQueryCapabilities,i=t.ownershipBasedAccessControlForFeatures,a=t.archivingInfo,c=t.currentVersion,d=p?.includes("MapServer"),l=!d||c>=has("mapserver-pbf-version-support"),y=s(p),m=new Set((t.supportedQueryFormats??"").split(",").map((t=>t.toLowerCase().trim())));return{maxRecordCount:r(t,"maxRecordCount",void 0),maxRecordCountFactor:r(t,"maxRecordCountFactor",void 0),standardMaxRecordCount:r(t,"standardMaxRecordCount",void 0),supportedSpatialAggregationStatistics:o(n),supportsCacheHint:e(n,"supportsQueryWithCacheHint",!1)||u(n,"query"),supportsCentroid:e(n,"supportsReturningGeometryCentroid",!1),supportsCompactGeometry:y,supportsDefaultSpatialReference:e(n,"supportsDefaultSR",!1),supportsDisjointSpatialRelationship:e(n,"supportsDisjointSpatialRel",!1),supportsDistance:e(n,"supportsQueryWithDistance",!1),supportsDistinct:e(n,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:e(n,"supportsReturningQueryExtent",!1),supportsFormatPBF:l&&m.has("pbf"),supportsFullTextSearch:e(n,"supportsFullTextSearch",!1),supportsGeometryProperties:e(n,"supportsReturningGeometryProperties",!1),supportsHavingClause:e(n,"supportsHavingClause",!1),supportsHistoricMoment:e(a,"supportsQueryWithHistoricMoment",!1),supportsMaxRecordCountFactor:e(n,"supportsMaxRecordCountFactor",!1),supportsOrderBy:e(n,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:e(n,"supportsPagination",!1),supportsPercentileStatistics:e(n,"supportsPercentileStatistics",!1),supportsQuantization:e(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:e(t,"supportsQuantizationEditMode",!1),supportsQueryByAnonymous:e(i,"allowAnonymousToQuery",!0),supportsQueryByOthers:e(i,"allowOthersToQuery",!0),supportsQueryGeometry:e(t,"supportsReturningQueryGeometry",!1),supportsResultType:e(n,"supportsQueryWithResultType",!1),supportsSpatialAggregationStatistics:e(n,"supportsSpatialAggregationStatistics",!1),supportsSqlExpression:e(n,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:e(t,"useStandardizedQueries",!1),supportsStatistics:e(n,"supportsStatistics",t.supportsStatistics),supportsTopFeaturesQuery:e(n,"supportsTopFeaturesQuery",!1),tileMaxRecordCount:r(t,"tileMaxRecordCount",void 0)}}function g(t){const s=t.advancedQueryCapabilities,r=e(s,"supportsAdvancedQueryRelated",!1);return{supportsPagination:e(s,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r,supportsCacheHint:u(s,"queryRelated")}}function h(t){return{supportsCacheHint:u(t.advancedQueryCapabilities,"queryTopFilter")}}function C(t){const s=t?t.queryBinsCapabilities:void 0;return{supportsDate:e(s,"supportsDateBin",!1),supportsFixedInterval:e(s,"supportsFixedIntervalBin",!1),supportsAutoInterval:e(s,"supportsAutoIntervalBin",!1),supportsFixedBoundaries:e(s,"supportsFixedBoundariesBin",!1),supportedStatistics:n(s)}}function v(t){const s=t.ownershipBasedAccessControlForFeatures,p=t?t.advancedEditingCapabilities:void 0;return{supportsGeometryUpdate:e(t,"allowGeometryUpdates",!0),supportsGlobalId:e(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:e(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:e(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:e(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:e(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:e(s,"allowAnonymousToDelete",!0),supportsDeleteByOthers:e(s,"allowOthersToDelete",!0),supportsUpdateByAnonymous:e(s,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:e(s,"allowOthersToUpdate",!0),supportsAsyncApplyEdits:e(p,"supportsAsyncApplyEdits",!1),zDefault:r(t,"zDefault",void 0)}}function A(t){return{operations:{supportsAppend:e(t,"supportsAppend",!1),supportsCoverageQuery:t?.playbackInfo?.klv["0601"]??!1,supportsExportClip:e(t,"supportsExportClip",!1),supportsExportFrameset:e(t,"supportsExportFrameset",!1),supportsMensuration:e(t,"supportsMensuration",!1),supportsUpdate:e(t,"supportsUpdate",!1)}}}export{i as getFeatureLayerCapabilities,A as getVideoLayerCapabilities};
