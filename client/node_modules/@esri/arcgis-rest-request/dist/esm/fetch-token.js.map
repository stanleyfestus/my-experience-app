{"version":3,"file":"fetch-token.js","sourceRoot":"","sources":["../../src/fetch-token.ts"],"names":[],"mappings":"AAAA;gBACgB;AAEhB,OAAO,EAAE,OAAO,EAAE,MAAM,cAAc,CAAC;AAIvC,MAAM,4BAA4B,GAAG,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC;AAyBnD,MAAM,UAAU,UAAU,CACxB,GAAW,EACX,cAAoC;IAEpC,MAAM,OAAO,GAAoB,cAAc,CAAC;IAEhD,8DAA8D;IAC9D,OAAO,CAAC,WAAW,GAAG,KAAK,CAAC;IAE5B,OAAO,OAAO,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC,IAAI,CAC/B,CAAC,QAAyD,EAAE,EAAE;QAC5D,4GAA4G;QAC5G,IAAI,OAAO,IAAI,QAAQ,IAAI,SAAS,IAAI,QAAQ,EAAE;YAChD,OAAO;gBACL,KAAK,EAAE,QAAQ,CAAC,KAAK;gBACrB,QAAQ,EAAE,cAAc,CAAC,MAAM,CAAC,QAAQ;gBACxC,OAAO,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC;aACpC,CAAC;SACH;QAED,MAAM,mBAAmB,GAAwB;YAC/C,KAAK,EAAE,QAAQ,CAAC,YAAY;YAC5B,QAAQ,EAAE,QAAQ,CAAC,QAAQ;YAC3B,OAAO,EAAE,IAAI,IAAI;YACf,+HAA+H;YAC/H,qGAAqG;YACrG,IAAI,CAAC,GAAG,EAAE,GAAG,QAAQ,CAAC,UAAU,GAAG,IAAI,GAAG,4BAA4B,CACvE;YACD,GAAG,EAAE,QAAQ,CAAC,GAAG,KAAK,IAAI;SAC3B,CAAC;QAEF,IAAI,QAAQ,CAAC,aAAa,EAAE;YAC1B,mBAAmB,CAAC,YAAY,GAAG,QAAQ,CAAC,aAAa,CAAC;SAC3D;QAED,IAAI,QAAQ,CAAC,wBAAwB,EAAE;YACrC,mBAAmB,CAAC,mBAAmB,GAAG,IAAI,IAAI;YAChD,+HAA+H;YAC/H,qGAAqG;YACrG,IAAI,CAAC,GAAG,EAAE;gBACR,QAAQ,CAAC,wBAAwB,GAAG,IAAI;gBACxC,4BAA4B,CAC/B,CAAC;SACH;QAED,OAAO,mBAAmB,CAAC;IAC7B,CAAC,CACF,CAAC;AACJ,CAAC","sourcesContent":["/* Copyright (c) 2017 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { request } from \"./request.js\";\nimport { IRequestOptions } from \"./utils/IRequestOptions.js\";\nimport { ITokenRequestOptions } from \"./utils/ITokenRequestOptions.js\";\n\nconst FIVE_MINUTES_IN_MILLISECONDS = 5 * 60 * 1000;\n\ninterface IoAuthTokenResponse {\n  access_token: string;\n  expires_in: number;\n  username: string;\n  ssl?: boolean;\n  refresh_token?: string;\n  refresh_token_expires_in?: number;\n}\n\ninterface IGenerateTokenRawResponse {\n  token: string;\n  expires: number;\n}\n\nexport interface IFetchTokenResponse {\n  token: string;\n  expires: Date;\n  username: string;\n  ssl?: boolean;\n  refreshToken?: string;\n  refreshTokenExpires?: Date;\n}\n\nexport function fetchToken(\n  url: string,\n  requestOptions: ITokenRequestOptions\n): Promise<IFetchTokenResponse> {\n  const options: IRequestOptions = requestOptions;\n\n  // we generate a response, so we can't return the raw response\n  options.rawResponse = false;\n\n  return request(url, options).then(\n    (response: IGenerateTokenRawResponse | IoAuthTokenResponse) => {\n      // Typescript uses the \"in\" keyword to determine we have a generateToken response or an oauth token response\n      if (\"token\" in response && \"expires\" in response) {\n        return {\n          token: response.token,\n          username: requestOptions.params.username,\n          expires: new Date(response.expires)\n        };\n      }\n\n      const portalTokenResponse: IFetchTokenResponse = {\n        token: response.access_token,\n        username: response.username,\n        expires: new Date(\n          // convert seconds in response to milliseconds and add the value to the current time to calculate a static expiration timestamp\n          // we subtract 5 minutes here to make sure that we refresh the token early if the user makes requests\n          Date.now() + response.expires_in * 1000 - FIVE_MINUTES_IN_MILLISECONDS\n        ),\n        ssl: response.ssl === true\n      };\n\n      if (response.refresh_token) {\n        portalTokenResponse.refreshToken = response.refresh_token;\n      }\n\n      if (response.refresh_token_expires_in) {\n        portalTokenResponse.refreshTokenExpires = new Date(\n          // convert seconds in response to milliseconds and add the value to the current time to calculate a static expiration timestamp\n          // we subtract 5 minutes here to make sure that we refresh the token early if the user makes requests\n          Date.now() +\n            response.refresh_token_expires_in * 1000 -\n            FIVE_MINUTES_IN_MILLISECONDS\n        );\n      }\n\n      return portalTokenResponse;\n    }\n  );\n}\n"]}