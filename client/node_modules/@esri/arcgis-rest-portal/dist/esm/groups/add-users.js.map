{"version":3,"file":"add-users.js","sourceRoot":"","sources":["../../../src/groups/add-users.ts"],"names":[],"mappings":"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","sourcesContent":["/* Copyright (c) 2017-2018 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport {\n  request,\n  IRequestOptions,\n  ArcGISRequestError\n} from \"@esri/arcgis-rest-request\";\n\nimport { getPortalUrl } from \"../util/get-portal-url.js\";\nimport { chunk } from \"../util/array.js\";\n\nexport interface IAddGroupUsersOptions extends IRequestOptions {\n  /**\n   * Group ID\n   */\n  id: string;\n  /**\n   * An array of usernames to be added to the group as group members\n   */\n  users?: string[];\n  /**\n   * An array of usernames to be added to the group as group admins\n   */\n  admins?: string[];\n}\n\nexport interface IAddGroupUsersResult {\n  /**\n   * An array of usernames that were not added\n   */\n  notAdded?: string[];\n  /**\n   * An array of request errors\n   */\n  errors?: ArcGISRequestError[];\n}\n\n/**\n * Add users to a group. See the [REST Documentation](https://developers.arcgis.com/rest/users-groups-and-items/add-users-to-group.htm) for more information.\n *\n * ```js\n * import { addGroupUsers } from \"@esri/arcgis-rest-portal\";\n * //\n * addGroupUsers({\n *   id: groupId,\n *   users: [\"username1\", \"username2\"],\n *   admins: [\"username3\"],\n *   authentication\n * })\n * .then(response);\n * ```\n *\n * @param requestOptions  - Options for the request\n * @returns A Promise\n */\nexport function addGroupUsers(\n  requestOptions: IAddGroupUsersOptions\n): Promise<IAddGroupUsersResult> {\n  const id = requestOptions.id;\n  const url = `${getPortalUrl(requestOptions)}/community/groups/${id}/addUsers`;\n  const baseOptions = Object.assign({}, requestOptions, {\n    admins: undefined,\n    users: undefined\n  });\n\n  const batchRequestOptions = [\n    ..._prepareRequests(\"users\", requestOptions.users, baseOptions),\n    ..._prepareRequests(\"admins\", requestOptions.admins, baseOptions)\n  ];\n\n  const promises = batchRequestOptions.map((options) =>\n    _sendSafeRequest(url, options)\n  );\n\n  return Promise.all(promises).then(_consolidateRequestResults);\n}\n\nfunction _prepareRequests(\n  type: \"admins\" | \"users\",\n  usernames: string[],\n  baseOptions: IAddGroupUsersOptions\n): IAddGroupUsersOptions[] {\n  if (!usernames || usernames.length < 1) {\n    return [];\n  }\n\n  // the ArcGIS REST API only allows to add no more than 25 users per request,\n  // see https://developers.arcgis.com/rest/users-groups-and-items/add-users-to-group.htm\n  const userChunks: string[][] = chunk<string>(usernames, 25);\n\n  return userChunks.map((users) =>\n    _generateRequestOptions(type, users, baseOptions)\n  );\n}\n\nfunction _generateRequestOptions(\n  type: \"admins\" | \"users\",\n  usernames: string[],\n  baseOptions: IAddGroupUsersOptions\n) {\n  return Object.assign({}, baseOptions, {\n    [type]: usernames,\n    params: {\n      ...baseOptions.params,\n      [type]: usernames\n    }\n  });\n}\n\n// this request is safe since the request error will be handled\nfunction _sendSafeRequest(\n  url: string,\n  requestOptions: IAddGroupUsersOptions\n): Promise<IAddGroupUsersResult> {\n  return request(url, requestOptions).catch((error) => {\n    return {\n      errors: [error]\n    };\n  });\n}\n\nfunction _consolidateRequestResults(\n  results: IAddGroupUsersResult[]\n): IAddGroupUsersResult {\n  const notAdded = results\n    .filter((result) => result.notAdded)\n    .reduce((collection, result) => collection.concat(result.notAdded), []);\n\n  const errors = results\n    .filter((result) => result.errors)\n    .reduce((collection, result) => collection.concat(result.errors), []);\n\n  const consolidated: IAddGroupUsersResult = { notAdded };\n\n  if (errors.length > 0) {\n    consolidated.errors = errors;\n  }\n\n  return consolidated;\n}\n"]}